<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetAGS Pro - Análisis de ROI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --bet-green: #10b981; 
            --bet-yellow: #fbbf24; 
            --deep-black: #020617; 
            --card-bg: #0f172a;    
            --border-color: rgba(255, 255, 255, 0.05);
            --neon-blue: #00f2ff;
        }
        
        body { 
            background-color: var(--deep-black); 
            color: #f8fafc; 
            font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(circle at top right, #064e3b20, transparent);
        }

        .glass-card { 
            background: rgba(15, 23, 42, 0.95); 
            border: 1px solid var(--border-color); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        
        .excel-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .excel-table th { 
            background: #1e293b; 
            color: #10b981; 
            text-transform: uppercase; 
            padding: 12px 10px; 
            text-align: left; 
            border-bottom: 2px solid rgba(16, 185, 129, 0.3); 
        }
        .excel-table td { padding: 12px 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.02); vertical-align: middle; }
        
        .row-win { background: rgba(16, 185, 129, 0.08) !important; border-left: 4px solid #10b981; }
        .row-win td { color: #4ade80 !important; font-weight: 500; }
        
        .row-loss { background: rgba(239, 68, 68, 0.08) !important; border-left: 4px solid #ef4444; }
        .row-loss td { color: #f87171 !important; font-weight: 500; }
        
        .row-pending { background: rgba(251, 191, 36, 0.1) !important; border-left: 4px solid var(--bet-yellow); }
        .row-pending td { color: var(--bet-yellow) !important; font-weight: 500; }
        
        @keyframes glowing-profitable {
            0% { box-shadow: inset 0 0 5px rgba(16, 185, 129, 0.2); background: rgba(16, 185, 129, 0.1); }
            50% { box-shadow: inset 0 0 20px rgba(16, 185, 129, 0.4); background: rgba(16, 185, 129, 0.2); }
            100% { box-shadow: inset 0 0 5px rgba(16, 185, 129, 0.2); background: rgba(16, 185, 129, 0.1); }
        }

        @keyframes blue-flash {
            0% { box-shadow: 0 0 5px var(--neon-blue); opacity: 0.8; }
            50% { box-shadow: 0 0 20px var(--neon-blue), 0 0 30px var(--neon-blue); opacity: 1; }
            100% { box-shadow: 0 0 5px var(--neon-blue); opacity: 0.8; }
        }

        .combo-top-flash {
            background: #00e5ff !important;
            color: #000 !important;
            animation: blue-flash 1.5s infinite ease-in-out;
            border: none;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
        }

        .profitable-alert {
            animation: glowing-profitable 2s infinite ease-in-out;
            border-left: 4px solid #10b981 !important;
        }

        .btn-action { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 9px; transition: all 0.2s; }
        .btn-action:hover { transform: translateY(-1px); filter: brightness(1.2); }
        .btn-win { background: #059669; color: white; }
        .btn-loss { background: #dc2626; color: white; }
        .btn-pending { background: #d97706; color: white; }
        
        .btn-export { background: #3b82f6; color: white; padding: 4px 6px; border-radius: 4px; font-size: 9px; }

        .scroll-custom::-webkit-scrollbar { width: 6px; height: 6px; }
        .scroll-custom::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .scroll-custom::-webkit-scrollbar-thumb:hover { background: #10b981; }

        #filter-container { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); max-height: 0; overflow: hidden; opacity: 0; }
        #filter-container.show { max-height: 2000px; opacity: 1; margin-top: 1rem; padding-bottom: 1rem; }
        
        .filter-mini { background: #020617; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 4px 6px; color: #10b981; font-size: 10px; width: 48%; outline: none; }
        .filter-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .filter-label { font-size: 9px; color: #94a3b8; text-transform: uppercase; font-weight: 600; width: 60px; }
        
        .dot-active { height: 8px; width: 8px; background-color: var(--bet-yellow); border-radius: 50%; display: inline-block; box-shadow: 0 0 8px var(--bet-yellow); }
        .rotate-icon { transition: transform 0.3s ease; }
        .rotate-icon.active { transform: rotate(180deg); }

        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; -webkit-appearance: none; -moz-appearance: none; appearance: none; }

        .market-checkbox-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
            background: #020617;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .market-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .market-item input[type="checkbox"], .select-bet-checkbox {
            appearance: none;
            width: 14px;
            height: 14px;
            border: 1px solid #10b981;
            border-radius: 3px;
            background: transparent;
            position: relative;
            cursor: pointer;
        }
        .market-item input[type="checkbox"]:checked, .select-bet-checkbox:checked {
            background: #10b981;
        }
        .market-item input[type="checkbox"]:checked::after, .select-bet-checkbox:checked::after {
            content: "✓";
            color: black;
            font-size: 10px;
            font-weight: bold;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .market-item span {
            font-size: 10px;
            color: #cbd5e1;
            text-transform: uppercase;
            font-weight: 600;
        }

        .top-performance-badge {
            background: linear-gradient(90deg, #10b981, #059669);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
        }
        .kelly-badge {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 9px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            margin-left: 4px;
        }
        .pid-badge {
            background: rgba(0, 242, 255, 0.15);
            color: #00f2ff;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 9px;
            border: 1px solid rgba(0, 242, 255, 0.3);
            margin-left: 4px;
        }

        /* Estilo para el selector dinámico de Profit */
        .profit-switcher {
            background: #1e293b;
            border: 1px solid rgba(16, 185, 129, 0.2);
            font-size: 8px;
            padding: 2px 4px;
            border-radius: 4px;
            color: #94a3b8;
            margin-bottom: 4px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
        }
        .profit-switcher:hover {
            border-color: var(--bet-green);
            color: white;
        }
    </style>
</head>
<body>
    <nav class="p-4 bg-black/60 border-b border-emerald-500/10 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tighter">BETAGS <span class="text-emerald-500">ROI LAB</span></h1>
            <div class="flex flex-wrap gap-2">
                <a href="index.html" class="px-4 py-1.5 text-xs font-semibold bg-slate-900 rounded-full border border-slate-800 hover:border-emerald-500/50 transition">Poisson</a>
                <a href="roi2.html" class="px-4 py-1.5 text-xs font-semibold bg-emerald-500/10 text-emerald-400 rounded-full border border-emerald-500/30">ROI Pre</a>
                <a href="xg.html" class="px-4 py-1.5 text-xs font-semibold bg-blue-500/10 text-blue-400 rounded-full border border-blue-500/30 hover:bg-blue-500/20 transition">XG ANALYTICS ⭐</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 lg:p-8">
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <div class="glass-card p-4 rounded-xl text-center relative">
                <select id="profit-type-selector" class="profit-switcher" onchange="updateStats()">
                    <option value="REAL">PROFIT REAL</option>
                    <option value="KELLY">PROFIT KELLY</option>
                    <option value="PID">PROFIT PID</option>
                </select>
                <p id="stat-profit" class="text-xl font-black text-white">$0.00</p>
            </div>
            <div class="glass-card p-4 rounded-xl text-center">
                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mb-1">Yield</p>
                <p id="stat-yield" class="text-xl font-black text-emerald-400">0%</p>
            </div>
            <div class="glass-card p-4 rounded-xl text-center">
                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mb-1">Hit Rate</p>
                <p id="stat-hit" class="text-xl font-black text-blue-400">0%</p>
            </div>
            <div class="glass-card p-4 rounded-xl text-center">
                <p class="text-[10px] text-red-500/80 uppercase font-bold tracking-widest mb-1">Max Drawdown</p>
                <p id="stat-dd" class="text-xl font-black text-red-500">0.00u</p>
            </div>
            <div class="glass-card p-4 rounded-xl text-center">
                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mb-1">Total Picks</p>
                <p id="stat-count" class="text-xl font-black text-white">0</p>
            </div>
            <div class="glass-card p-4 rounded-xl text-center border-emerald-500/30">
                <p class="text-[10px] text-emerald-500 uppercase font-bold tracking-widest mb-1">P-Value</p>
                <p id="stat-pvalue" class="text-xl font-black text-emerald-400">--</p>
            </div>
        </div>

        <div class="glass-card p-6 rounded-2xl mb-8 border-emerald-500/20">
            <div class="flex items-center gap-3 mb-6">
                <i class="fa-solid fa-ranking-star text-emerald-500"></i>
                <h2 class="text-xs font-black uppercase text-white tracking-widest">League Performance Analytics & Teams</h2>
            </div>
            <div class="overflow-x-auto scroll-custom">
                <table class="excel-table mb-6">
                    <thead>
                        <tr>
                            <th>Liga</th>
                            <th>Principal Mercado</th>
                            <th>Prob % Prom.</th>
                            <th>Cuota Casa Prom.</th>
                            <th>Valor % Prom.</th>
                            <th>Yield</th>
                            <th>ROI</th>
                            <th>P-Value</th>
                        </tr>
                    </thead>
                    <tbody id="league-performance-body"></tbody>
                </table>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4 pt-4 border-t border-slate-800">
                <div>
                    <h3 class="text-[10px] font-black text-emerald-400 uppercase mb-3">Ranking Equipos: Más Rentables</h3>
                    <div id="top-teams-profit" class="space-y-2 max-h-[250px] overflow-y-auto pr-2 scroll-custom"></div>
                </div>
                <div>
                    <h3 class="text-[10px] font-black text-red-400 uppercase mb-3">Ranking Equipos: Menos Rentables</h3>
                    <div id="bottom-teams-profit" class="space-y-2 max-h-[250px] overflow-y-auto pr-2 scroll-custom"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="glass-card p-4 rounded-xl border-blue-500/20">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fa-solid fa-calculator text-blue-400"></i>
                    <p class="text-[10px] text-blue-400 uppercase font-black tracking-widest">Simulación 1/4 Kelly</p>
                </div>
                <div class="flex justify-between items-end">
                    <p id="kelly-quarter-profit" class="text-2xl font-black text-white">$0.00</p>
                    <p id="kelly-quarter-yield" class="text-xs font-bold text-slate-500">Yield: 0%</p>
                </div>
            </div>
            <div class="glass-card p-4 rounded-xl border-purple-500/20">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fa-solid fa-calculator text-purple-400"></i>
                    <p class="text-[10px] text-purple-400 uppercase font-black tracking-widest">Simulación 1/8 Kelly</p>
                </div>
                <div class="flex justify-between items-end">
                    <p id="kelly-eighth-profit" class="text-2xl font-black text-white">$0.00</p>
                    <p id="kelly-eighth-yield" class="text-xs font-bold text-slate-500">Yield: 0%</p>
                </div>
            </div>
            <div class="glass-card p-4 rounded-xl border-emerald-500/20">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fa-solid fa-trophy text-emerald-400"></i>
                    <p class="text-[10px] text-emerald-400 uppercase font-black tracking-widest">Top Rendimiento</p>
                </div>
                <div class="grid grid-cols-1 gap-2">
                    <div id="top-leagues-list" class="text-[10px] text-slate-300">Cargando ligas...</div>
                    <div id="top-markets-list" class="text-[10px] text-slate-300">Cargando mercados...</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div class="lg:col-span-1 space-y-6">
                <div class="glass-card p-5 rounded-2xl">
                    <button onclick="toggleFilters()" class="w-full flex justify-between items-center group">
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-black uppercase text-emerald-500 tracking-tighter">Panel de Filtros</span>
                            <div id="active-indicator" class="hidden"><span class="dot-active"></span></div>
                        </div>
                        <i id="filter-chevron" class="fa-solid fa-chevron-down text-slate-500 group-hover:text-emerald-500 rotate-icon"></i>
                    </button>

                    <div id="filter-container">
                        <div class="space-y-4 pt-6">
                            <div>
                                <label class="text-[10px] text-slate-400 uppercase font-bold mb-2 block">Filtrar por Liga</label>
                                <select id="f_league" class="w-full bg-slate-950 p-2.5 text-[11px] rounded-lg border border-slate-800 text-slate-200" onchange="updateStats()">
                                    <option value="">Todas las Ligas</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-[10px] text-slate-400 uppercase font-bold mb-2 block">Mercados (Multiselección)</label>
                                <div class="market-checkbox-group" id="f_market_group">
                                    <label class="market-item"><input type="checkbox" value="OVER 2.5 FT" onchange="updateStats()"> <span>Over 2.5 Ft</span></label>
                                    <label class="market-item"><input type="checkbox" value="UNDER 2.5 FT" onchange="updateStats()"> <span>Under 2.5 Ft</span></label>
                                    <label class="market-item"><input type="checkbox" value="BTTS YES" onchange="updateStats()"> <span>BTTS Yes</span></label>
                                    <label class="market-item"><input type="checkbox" value="BTTS NO" onchange="updateStats()"> <span>BTTS No</span></label>
                                    <label class="market-item"><input type="checkbox" value="OVER 0.5 HT" onchange="updateStats()"> <span>Over 0.5 Ht</span></label>
                                </div>
                            </div>

                            <div>
                                <label class="text-[10px] text-slate-400 uppercase font-bold mb-2 block">Algoritmo</label>
                                <select id="f_source" class="w-full bg-slate-950 p-2.5 text-[11px] rounded-lg border border-slate-800 text-slate-200" onchange="updateStats()">
                                    <option value="">Cualquier Origen</option>
                                    <option value="XG">Basado en xG</option>
                                    <option value="GOLES">Basado en Goles</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-[10px] text-slate-400 uppercase font-bold mb-2 block">Estado</label>
                                <select id="f_status" class="w-full bg-slate-950 p-2.5 text-[11px] rounded-lg border border-slate-800 text-slate-200" onchange="updateStats()">
                                    <option value="">Cualquier Resultado</option>
                                    <option value="win">W - Ganadas</option>
                                    <option value="loss">L - Perdidas</option>
                                    <option value="pending">P - Pendientes</option>
                                </select>
                            </div>

                            <div class="pt-4 border-t border-slate-800 space-y-3">
                                <p class="text-[10px] text-emerald-500 font-black uppercase">Rangos de Valor</p>
                                <div class="filter-row">
                                    <span class="filter-label">Prob %</span>
                                    <input type="number" id="f_p_min" placeholder="Min" class="filter-mini" oninput="updateStats()">
                                    <input type="number" id="f_p_max" placeholder="Max" class="filter-mini" oninput="updateStats()">
                                </div>
                                <div class="filter-row">
                                    <span class="filter-label">VAL %</span>
                                    <input type="number" id="f_v_min" placeholder="Min" class="filter-mini" oninput="updateStats()">
                                    <input type="number" id="f_v_max" placeholder="Max" class="filter-mini" oninput="updateStats()">
                                </div>
                                <div class="filter-row">
                                    <span class="filter-label">C. Justa</span>
                                    <input type="number" id="f_fj_min" placeholder="Min" class="filter-mini" oninput="updateStats()">
                                    <input type="number" id="f_fj_max" placeholder="Max" class="filter-mini" oninput="updateStats()">
                                </div>
                                <div class="filter-row">
                                    <span class="filter-label">C. Casa</span>
                                    <input type="number" id="f_oc_min" placeholder="Min" class="filter-mini" oninput="updateStats()">
                                    <input type="number" id="f_oc_max" placeholder="Max" class="filter-mini" oninput="updateStats()">
                                </div>
                                <div class="filter-row">
                                    <span class="filter-label">Edge %</span>
                                    <input type="number" id="f_e_min" placeholder="Min" class="filter-mini" oninput="updateStats()">
                                    <input type="number" id="f_e_max" placeholder="Max" class="filter-mini" oninput="updateStats()">
                                </div>
                                <div class="filter-row">
                                    <span class="filter-label">Stake</span>
                                    <input type="number" id="f_s_min" placeholder="Min" class="filter-mini" oninput="updateStats()">
                                    <input type="number" id="f_s_max" placeholder="Max" class="filter-mini" oninput="updateStats()">
                                </div>
                            </div>

                            <button onclick="resetFilters()" class="w-full text-[9px] text-slate-500 hover:text-white underline py-2 transition-colors">Limpiar filtros aplicados</button>

                            <div class="pt-4 border-t border-slate-800 space-y-2">
                                <button onclick="sendToBacktesting()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-black rounded-lg uppercase shadow-lg shadow-blue-900/20 transition-all">
                                    <i class="fa-solid fa-vial-circle-check mr-2"></i>Enviar a Backtesting
                                </button>
                                <button onclick="exportToExcel()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white text-[10px] font-black rounded-lg uppercase shadow-lg shadow-emerald-900/20 transition-all">
                                    <i class="fa-solid fa-file-excel mr-2"></i>Exportar CSV
                                </button>
                                <button onclick="clearHistory()" class="w-full py-2 bg-transparent text-red-500 hover:bg-red-500/10 text-[10px] font-bold rounded-lg uppercase transition-all">Borrar Historial</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="glass-card p-5 rounded-2xl">
                    <p class="text-[10px] text-slate-500 font-black uppercase mb-4 text-center tracking-widest">Equity Curve (u)</p>
                    <div class="h-[150px]">
                        <canvas id="bankrollChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="flex justify-between items-center mb-4 px-2">
                    <h3 class="text-[10px] font-black text-emerald-500 uppercase tracking-widest">Historial de Operaciones</h3>
                    <div class="flex items-center gap-3">
                        <div id="selection-summary" class="hidden bg-emerald-500/10 border border-emerald-500/30 px-3 py-1 rounded-full">
                            <span class="text-[10px] font-bold text-emerald-400">Seleccionado: <span id="selected-profit">0.00u</span></span>
                        </div>
                        <button id="btn-delete-bulk" onclick="deleteSelectedBets()" class="hidden bg-red-500/10 border border-red-500/40 text-red-500 px-3 py-1 rounded-full text-[10px] font-black hover:bg-red-500 hover:text-white transition-all">
                            <i class="fa-solid fa-trash-can mr-1"></i> ELIMINAR SELECCIONADOS
                        </button>
                    </div>
                </div>
                <div class="glass-card rounded-2xl overflow-hidden shadow-2xl">
                    <div class="overflow-x-auto scroll-custom">
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th class="w-8">
                                        <input type="checkbox" id="master-checkbox" onchange="toggleSelectAll(this)" class="select-bet-checkbox">
                                    </th>
                                    <th>Evento / Fecha</th>
                                    <th>Mercado</th>
                                    <th>Prob %</th>
                                    <th>Justa</th>
                                    <th>Casa</th>
                                    <th>VAL %</th>
                                    <th>Edge</th>
                                    <th>Stake (Plano vs Kelly vs PID)</th>
                                    <th>Resolución</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="history-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'betags_pre_match'; 
        let bets = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let bChart;

        // Configuración PID
        const PID_CONFIG = {
            Kp: 0.1, Ki: 0.01, Kd: 0.05, TargetBank: 150, integral: 0, lastError: 0
        };

        function calculatePIDStake(currentBank, edge) {
            const error = PID_CONFIG.TargetBank - currentBank;
            PID_CONFIG.integral += error;
            const derivative = error - PID_CONFIG.lastError;
            let output = (PID_CONFIG.Kp * error) + (PID_CONFIG.Ki * PID_CONFIG.integral) + (PID_CONFIG.Kd * derivative);
            const edgeFactor = Math.max(0.5, edge / 5); 
            let finalStake = Math.abs(output) * edgeFactor;
            PID_CONFIG.lastError = error;
            return Math.min(Math.max(finalStake, 0.5), 5).toFixed(2);
        }

        // Simulación de Profit para Kelly o PID de forma secuencial
        function simulateProfitType(resolvedBets, type) {
            let totalProfit = 0;
            let currentBank = 100;
            const sorted = [...resolvedBets].sort((a,b) => new Date(a.date) - new Date(b.date));
            
            // Reset PID local para simulación
            let localIntegral = 0;
            let localLastError = 0;

            sorted.forEach(b => {
                const p = Number(b.prob); 
                const decimalOdd = Number(b.odd);
                const edgeVal = parseFloat(b.edge?.toString().replace('%','')) || 0;
                let appliedStake = 0;

                if (type === 'KELLY') {
                    if (decimalOdd > 1 && p > (1/decimalOdd)) {
                        const b_f = decimalOdd - 1;
                        const fullKelly = (b_f * p - (1-p)) / b_f;
                        appliedStake = fullKelly * 0.25 * 100; // 1/4 Kelly sobre bank de 100u
                    }
                } else if (type === 'PID') {
                    const error = PID_CONFIG.TargetBank - currentBank;
                    localIntegral += error;
                    const derivative = error - localLastError;
                    let output = (PID_CONFIG.Kp * error) + (PID_CONFIG.Ki * localIntegral) + (PID_CONFIG.Kd * derivative);
                    appliedStake = Math.min(Math.max(Math.abs(output) * Math.max(0.5, edgeVal/5), 0.5), 5);
                    localLastError = error;
                }

                const betResult = b.status === 'win' ? appliedStake * (decimalOdd - 1) : -appliedStake;
                totalProfit += betResult;
                currentBank += betResult;
            });
            return totalProfit;
        }

        function extractLeagueName(teamsStr) {
            if (!teamsStr) return 'General';
            if (teamsStr.includes('[') && teamsStr.includes(']')) {
                const match = teamsStr.match(/\[(.*?)\]/);
                return match ? match[1].trim() : 'General';
            }
            if (teamsStr.includes('-')) {
                const parts = teamsStr.split(' ');
                if (parts[0].includes('-')) return parts[0].trim();
            }
            if (teamsStr.includes(':')) {
                return teamsStr.split(':')[0].trim();
            }
            return 'General';
        }

        function extractTeams(teamsStr) {
            let matchText = teamsStr;
            if (matchText.includes(']')) matchText = matchText.split(']')[1].trim();
            let teams = [];
            if (matchText.includes(' vs ')) teams = matchText.split(' vs ');
            else if (matchText.includes(' - ')) teams = matchText.split(' - ');
            return teams.map(t => t.trim());
        }

        function updateLeagueFilter() {
            const leagueSelect = document.getElementById('f_league');
            const currentValue = leagueSelect.value;
            const leagues = new Set();
            bets.forEach(b => { leagues.add(extractLeagueName(b.teams)); });
            leagueSelect.innerHTML = '<option value="">Todas las Ligas</option>';
            Array.from(leagues).sort().forEach(league => {
                if(league !== 'General') {
                    const opt = document.createElement('option');
                    opt.value = league; opt.innerText = league;
                    if(league === currentValue) opt.selected = true;
                    leagueSelect.appendChild(opt);
                }
            });
        }

        function updateLeaguePerformanceTable() {
            const resolved = bets.filter(b => b.status === 'win' || b.status === 'loss');
            const leagueAnalysis = {};
            const teamAnalysis = {};
            resolved.forEach(b => {
                const league = extractLeagueName(b.teams);
                const teams = extractTeams(b.teams);
                const profit = Number(b.profit) || 0;
                const stake = Number(b.stake) || 0;
                const prob = Number(b.prob) * 100;
                const odd = Number(b.odd) || 0;
                const market = b.market || 'Unknown';
                const val = prob - (odd > 0 ? (1/odd)*100 : 0);
                if (!leagueAnalysis[league]) {
                    leagueAnalysis[league] = { profit: 0, staked: 0, count: 0, markets: {}, totalProb: 0, totalOdd: 0, totalVal: 0 };
                }
                const l = leagueAnalysis[league];
                l.profit += profit; l.staked += stake; l.count += 1; l.totalProb += prob; l.totalOdd += odd; l.totalVal += val;
                l.markets[market] = (l.markets[market] || 0) + 1;
                teams.forEach(t => {
                    if (!teamAnalysis[t]) teamAnalysis[t] = { profit: 0, count: 0 };
                    teamAnalysis[t].profit += (profit / 2); teamAnalysis[t].count += 1;
                });
            });
            const tbody = document.getElementById('league-performance-body');
            tbody.innerHTML = '';
            Object.entries(leagueAnalysis).forEach(([name, data]) => {
                const yieldVal = data.staked > 0 ? (data.profit / data.staked * 100) : 0;
                const roi = data.staked > 0 ? ((data.staked + data.profit) / data.staked * 100) : 0;
                const avgOdd = data.totalOdd / data.count;
                const mainMarket = Object.entries(data.markets).sort((a,b) => b[1]-a[1])[0][0];
                const pVal = calculatePValue(data.count, yieldVal, avgOdd);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="font-bold text-white">${name}</td><td class="text-emerald-400 font-bold text-[9px]">${mainMarket}</td><td>${(data.totalProb / data.count).toFixed(1)}%</td><td>${avgOdd.toFixed(2)}</td><td class="${data.totalVal/data.count > 0 ? 'text-blue-400' : 'text-slate-500'}">${(data.totalVal/data.count).toFixed(1)}%</td><td class="font-bold ${yieldVal >= 0 ? 'text-emerald-400' : 'text-red-400'}">${yieldVal.toFixed(1)}%</td><td class="text-slate-300">${roi.toFixed(1)}%</td><td class="font-mono ${pVal < 0.05 ? 'text-emerald-500' : 'text-slate-500'}">${pVal ? (pVal*100).toFixed(2)+'%' : '--'}</td>`;
                tbody.appendChild(tr);
            });
            const sortedTeams = Object.entries(teamAnalysis).sort((a,b) => b[1].profit - a[1].profit);
            const topContainer = document.getElementById('top-teams-profit');
            const bottomContainer = document.getElementById('bottom-teams-profit');
            topContainer.innerHTML = ''; bottomContainer.innerHTML = '';
            sortedTeams.slice(0, 10).forEach(([name, data]) => {
                topContainer.innerHTML += `<div class="flex justify-between items-center bg-emerald-500/5 p-2 rounded border border-emerald-500/10"><span class="text-[10px] font-bold text-slate-200">${name}</span><span class="text-[10px] font-black text-emerald-400">+${data.profit.toFixed(2)}u</span></div>`;
            });
            [...sortedTeams].reverse().slice(0, 10).forEach(([name, data]) => {
                bottomContainer.innerHTML += `<div class="flex justify-between items-center bg-red-500/5 p-2 rounded border border-red-500/10"><span class="text-[10px] font-bold text-slate-200">${name}</span><span class="text-[10px] font-black text-red-400">${data.profit.toFixed(2)}u</span></div>`;
            });
        }

        function updatePerformanceTops() {
            const resolved = bets.filter(b => b.status === 'win' || b.status === 'loss');
            const leagueStats = {}; const marketStats = {};
            resolved.forEach(b => {
                const league = extractLeagueName(b.teams); const market = b.market || 'Unknown';
                const profit = Number(b.profit) || 0;
                if (!leagueStats[league]) leagueStats[league] = { profit: 0, count: 0 };
                leagueStats[league].profit += profit; leagueStats[league].count += 1;
                if (!marketStats[market]) marketStats[market] = { profit: 0, count: 0 };
                marketStats[market].profit += profit; marketStats[market].count += 1;
            });
            const topLeagues = Object.entries(leagueStats).filter(([n, s]) => s.profit > 1 && s.count >= 5).sort((a, b) => b[1].profit - a[1].profit).slice(0, 3);
            const topMarkets = Object.entries(marketStats).filter(([n, s]) => s.profit > 1 && s.count >= 5).sort((a, b) => b[1].profit - a[1].profit).slice(0, 3);
            document.getElementById('top-leagues-list').innerHTML = topLeagues.length > 0 ? '<i class="fa-solid fa-flag mr-1"></i> ' + topLeagues.map(l => `<span class="font-bold text-emerald-400">${l[0]}</span>`).join(', ') : 'Sin datos top';
            document.getElementById('top-markets-list').innerHTML = topMarkets.length > 0 ? '<i class="fa-solid fa-chart-line mr-1"></i> ' + topMarkets.map(m => `<span class="font-bold text-blue-400">${m[0]}</span>`).join(', ') : 'Sin datos top';
            return { leagues: topLeagues.map(l => l[0]), markets: topMarkets.map(m => m[0]) };
        }

        function toggleFilters() { document.getElementById('filter-container').classList.toggle('show'); document.getElementById('filter-chevron').classList.toggle('active'); }
        function resetFilters() { document.querySelectorAll('.filter-mini, select').forEach(i => i.value = ''); document.querySelectorAll('#f_market_group input').forEach(c => c.checked = false); updateStats(); }

        function calculatePValue(n, yieldVal, avgOdd) {
            if (n < 5 || avgOdd <= 1) return null;
            try {
                const z = (yieldVal/100) / (Math.sqrt(avgOdd - 1) / Math.sqrt(n));
                const t = 1 / (1 + 0.5 * Math.abs(z));
                const ans = 1 - t * Math.exp(-z * z - 1.26551223 + t * (1.00002368 + t * (0.37409196 + t * (0.09678418 + t * (-0.18628806 + t * (0.27886807 + t * (-1.13520398 + t * (1.48851587 + t * (-0.82215223 + t * 0.17087277)))))))));
                return z >= 0 ? 1 - (ans + 1) / 2 : (ans + 1) / 2;
            } catch (e) { return null; }
        }

        function simulateKelly(resolvedBets, fraction) {
            let totalProfit = 0; let totalStaked = 0;
            const sorted = [...resolvedBets].sort((a,b) => new Date(a.date) - new Date(b.date));
            sorted.forEach(b => {
                const p = Number(b.prob); const decimalOdd = Number(b.odd);
                if (decimalOdd > 1 && p > (1/decimalOdd)) {
                    const f = ((decimalOdd-1) * p - (1-p)) / (decimalOdd-1);
                    const s = f * fraction * 100;
                    totalProfit += b.status === 'win' ? s * (decimalOdd - 1) : -s;
                    totalStaked += s;
                }
            });
            return { profit: totalProfit, yield: totalStaked > 0 ? (totalProfit/totalStaked)*100 : 0 };
        }

        function updateStats() {
            updateLeagueFilter();
            const tops = updatePerformanceTops();
            updateLeaguePerformanceTable();
            
            const selectedMarkets = Array.from(document.querySelectorAll('#f_market_group input:checked')).map(cb => cb.value.toUpperCase());
            const f_status = document.getElementById('f_status').value;
            const f_source = document.getElementById('f_source').value;
            const f_league = document.getElementById('f_league').value;
            const profitType = document.getElementById('profit-type-selector').value;

            let filtered = bets.filter(b => {
                const matchM = selectedMarkets.length === 0 || (b.market && selectedMarkets.includes(b.market.toString().toUpperCase()));
                const matchS = !f_status || (b.status === f_status);
                const matchSource = !f_source || (b.teams && b.teams.toUpperCase().includes(f_source.toUpperCase()));
                const matchLeague = !f_league || (extractLeagueName(b.teams) === f_league);
                return matchM && matchS && matchSource && matchLeague;
            });

            let currentBankTotal = 100;
            bets.filter(b => b.status === 'win' || b.status === 'loss').forEach(b => currentBankTotal += Number(b.profit));

            renderHistory(filtered, tops, currentBankTotal);

            const checkedIds = Array.from(document.querySelectorAll('.bet-item-checkbox:checked')).map(cb => cb.getAttribute('data-id'));
            let statsData = (checkedIds.length > 0) ? filtered.filter(b => checkedIds.includes(b.id.toString())) : filtered;

            const resolved = statsData.filter(b => b.status === 'win' || b.status === 'loss');
            const sortedResolved = [...resolved].sort((a,b) => new Date(a.date) - new Date(b.date));
            
            // Lógica de Profit Dinámico
            let displayProfit = 0;
            if (profitType === 'REAL') {
                displayProfit = sortedResolved.reduce((a, b) => a + (Number(b.profit) || 0), 0);
            } else {
                displayProfit = simulateProfitType(sortedResolved, profitType);
            }

            const staked = sortedResolved.reduce((a, b) => a + (Number(b.stake) || 0), 0);
            const wins = sortedResolved.filter(b => b.status === 'win').length;
            const avgOdd = sortedResolved.length > 0 ? sortedResolved.reduce((a, b) => a + (Number(b.odd) || 0), 0) / sortedResolved.length : 0;
            
            document.getElementById('stat-profit').innerText = (displayProfit >= 0 ? "+" : "") + displayProfit.toFixed(2) + "u";
            document.getElementById('stat-profit').className = displayProfit >= 0 ? "text-xl font-black text-emerald-400" : "text-xl font-black text-red-400";
            document.getElementById('stat-yield').innerText = (staked > 0 ? (displayProfit/staked*100) : 0).toFixed(1) + "%";
            document.getElementById('stat-hit').innerText = (sortedResolved.length > 0 ? (wins/sortedResolved.length*100).toFixed(1) : 0) + "%";
            document.getElementById('stat-count').innerText = sortedResolved.length;

            const k14 = simulateKelly(sortedResolved, 0.25);
            const k18 = simulateKelly(sortedResolved, 0.125);
            document.getElementById('kelly-quarter-profit').innerText = (k14.profit >= 0 ? "+" : "") + k14.profit.toFixed(2) + "u";
            document.getElementById('kelly-eighth-profit').innerText = (k18.profit >= 0 ? "+" : "") + k18.profit.toFixed(2) + "u";
            
            const pVal = calculatePValue(sortedResolved.length, (staked > 0 ? (displayProfit/staked*100) : 0), avgOdd);
            document.getElementById('stat-pvalue').innerText = pVal !== null ? (pVal * 100).toFixed(2) + "%" : "--";
            
            renderBankrollChart(sortedResolved, profitType);
            calculateSelectedSummary();
        }

        function toggleSelectAll(master) { document.querySelectorAll('.bet-item-checkbox').forEach(cb => cb.checked = master.checked); updateStats(); }

        function calculateSelectedSummary() {
            const checkboxes = document.querySelectorAll('.bet-item-checkbox:checked');
            if (checkboxes.length > 0) {
                let total = 0; checkboxes.forEach(cb => { total += parseFloat(cb.getAttribute('data-profit')) || 0; });
                document.getElementById('selected-profit').innerText = (total >= 0 ? "+" : "") + total.toFixed(2) + "u";
                document.getElementById('selection-summary').classList.remove('hidden');
            } else { document.getElementById('selection-summary').classList.add('hidden'); }
        }

        function deleteSelectedBets() {
            const checkboxes = document.querySelectorAll('.bet-item-checkbox:checked');
            if (checkboxes.length > 0 && confirm('¿Eliminar seleccionados?')) {
                const ids = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
                bets = bets.filter(b => !ids.includes(b.id.toString()));
                saveAndRefresh();
            }
        }

        function renderHistory(data, tops, currentBankTotal) {
            const tbody = document.getElementById('history-body');
            const currentCheckedIds = Array.from(document.querySelectorAll('.bet-item-checkbox:checked')).map(cb => cb.getAttribute('data-id'));
            tbody.innerHTML = '';
            if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="11" class="p-10 text-center text-slate-600 font-bold italic">No hay registros</td></tr>'; return; }

            [...data].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(b => {
                const status = b.status || 'pending';
                const league = extractLeagueName(b.teams);
                const market = b.market || 'Unknown';
                const isTLeague = tops.leagues.includes(league);
                const isTMarket = tops.markets.includes(market);
                const tr = document.createElement('tr');
                tr.className = `row-${status} ${status === 'pending' && (isTLeague || isTMarket) ? 'profitable-alert' : ''}`;
                
                const oddNum = Number(b.odd) || 0;
                const edgeVal = parseFloat(b.edge?.toString().replace('%','')) || 0;
                const kelly = (oddNum > 1 && b.prob > (1/oddNum)) ? (((oddNum-1)*Number(b.prob)-(1-Number(b.prob)))/(oddNum-1)*0.25*100).toFixed(2) : "0.00";
                const pid = calculatePIDStake(currentBankTotal, edgeVal);

                tr.innerHTML = `
                    <td><input type="checkbox" class="select-bet-checkbox bet-item-checkbox" data-profit="${b.profit}" data-id="${b.id}" ${currentCheckedIds.includes(b.id.toString()) ? 'checked' : ''} onchange="updateStats()"></td>
                    <td><div class="font-bold text-slate-100">${b.teams}</div><div class="text-[9px] text-slate-500 uppercase">${b.date}</div></td>
                    <td class="font-bold text-emerald-500">${market}</td>
                    <td>${(Number(b.prob)*100).toFixed(1)}%</td>
                    <td>${b.fair_odd || (1/Number(b.prob)).toFixed(2)}</td>
                    <td class="font-black text-white">${oddNum.toFixed(2)}</td>
                    <td class="font-bold text-blue-400">${(Number(b.prob)*100 - (oddNum>0?(1/oddNum)*100:0)).toFixed(1)}%</td>
                    <td class="${edgeVal > 0 ? 'text-emerald-400 font-bold' : 'text-slate-500'}">${edgeVal.toFixed(1)}%</td>
                    <td><span class="font-bold">${b.stake}u</span><span class="kelly-badge">${kelly}u</span><span class="pid-badge">${pid}u</span></td>
                    <td><div class="flex gap-1"><button onclick="resolve('${b.id}', 'win')" class="btn-action btn-win">W</button><button onclick="resolve('${b.id}', 'loss')" class="btn-action btn-loss">L</button><button onclick="resolve('${b.id}', 'pending')" class="btn-action btn-pending">P</button></div></td>
                    <td><button onclick="deleteBet('${b.id}')" class="text-slate-700 hover:text-red-500 px-2"><i class="fa-solid fa-trash-can"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }

        function resolve(id, status) {
            const idx = bets.findIndex(x => x.id.toString() === id.toString());
            if(idx !== -1) {
                bets[idx].status = status;
                const stake = Number(bets[idx].stake) || 1;
                bets[idx].profit = status === 'win' ? stake * (Number(bets[idx].odd) - 1) : (status === 'loss' ? -stake : 0);
                saveAndRefresh();
            }
        }

        function renderBankrollChart(sortedResolved, type) {
            const ctx = document.getElementById('bankrollChart').getContext('2d');
            if(bChart) bChart.destroy();
            let current = 100; let chartData = [100];
            
            let localI = 0; let localLE = 0;
            sortedResolved.forEach(b => {
                let p = 0;
                if(type === 'REAL') p = Number(b.profit);
                else if(type === 'KELLY') {
                    const f = ((Number(b.odd)-1)*Number(b.prob)-(1-Number(b.prob)))/(Number(b.odd)-1);
                    const s = Math.max(0, f * 0.25 * 100);
                    p = b.status === 'win' ? s * (Number(b.odd)-1) : -s;
                } else {
                    const err = PID_CONFIG.TargetBank - current; localI += err;
                    const der = err - localLE;
                    const s = Math.min(Math.max(Math.abs(PID_CONFIG.Kp*err + PID_CONFIG.Ki*localI + PID_CONFIG.Kd*der) * Math.max(0.5, (parseFloat(b.edge)/5)), 0.5), 5);
                    p = b.status === 'win' ? s * (Number(b.odd)-1) : -s;
                    localLE = err;
                }
                current += p; chartData.push(current);
            });

            bChart = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: chartData.map((_,i)=>i), 
                    datasets: [{ data: chartData, borderColor: '#10b981', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0 }] 
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: 'rgba(255,255,255,0.03)' } } } }
            });
        }

        function deleteBet(id) { if(confirm('¿Eliminar?')) { bets = bets.filter(x => x.id.toString() !== id.toString()); saveAndRefresh(); } }
        function saveAndRefresh() { localStorage.setItem(STORAGE_KEY, JSON.stringify(bets)); updateStats(); }
        function clearHistory() { if(confirm('¿BORRAR TODO?')) { bets = []; saveAndRefresh(); } }
        function exportToExcel() { 
            const h = "Fecha,Evento,Mercado,Prob,Cuota,Stake,Estado,Profit\n";
            const csv = bets.map(b => `${b.date},${b.teams},${b.market},${b.prob},${b.odd},${b.stake},${b.status},${b.profit}`).join("\n");
            const blob = new Blob([h + csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'betags_roi.csv'; a.click();
        }
        window.onload = updateStats;
    </script>
</body>
</html>
