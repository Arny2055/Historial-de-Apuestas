<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador BTTS por Varianza (Desplegable)</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .data-input { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 4px; }
        .team-stats { background-color: #ecf0f1; padding: 15px; margin-top: 20px; border-radius: 4px; }
        input[type="file"], select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button.primary { background-color: #2ecc71; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; font-weight: bold; width: 100%; }
        button.primary:hover { background-color: #27ae60; }
        .recomendacion { margin-top: 20px; padding: 15px; border-left: 5px solid #ffc107; background-color: #fff3cd; }
        .recomendacion h4 { margin-top: 0; color: #ffc107; }
        .range-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .range-table th, .range-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .range-table th { background-color: #0056b3; color: white; }
        .error { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h2>‚öΩ Analizador de Varianza de Equipos para BTTS</h2>
        <p>Carga tu historial de partidos. La herramienta extraer√° los nombres de los equipos para el an√°lisis.</p>

        <div class="data-input">
            <h4>Paso 1: Carga el Archivo JSON</h4>
            <input type="file" id="jsonFile" accept=".json" onchange="extractTeams()">
            
            <div id="teamSelectionArea" style="margin-top: 15px; display: none;">
                <h4>Paso 2: Selecciona el Equipo a Analizar</h4>
                <label for="targetTeamSelect">Equipo:</label>
                <select id="targetTeamSelect" onchange="executeAnalysis()"></select>
                <small>Selecciona un equipo para ver su an√°lisis de varianza BTTS.</small>
            </div>
            
        </div>
        
        <div id="fileAnalysisOutput" class="team-stats">
            <h4>An√°lisis de Varianza del Equipo (Resultados)</h4>
            <p>Por favor, carga un archivo JSON para comenzar.</p>
        </div>
    </div>

    <script>
        // Variable global para guardar los datos del archivo
        let globalMatchData = [];

        // --- FUNCIONES DE C√ÅLCULO ESTAD√çSTICO ---
        
        function calcularMedia(datos) {
            if (datos.length === 0) return 0;
            const suma = datos.reduce((acc, val) => acc + val, 0);
            return suma / datos.length;
        }

        function calcularVarianza(datos) {
            const n = datos.length;
            if (n < 2) return 0;
            const media = calcularMedia(datos);
            
            const sumatoria = datos.reduce((acc, val) => {
                const diferencia = val - media;
                return acc + (diferencia * diferencia);
            }, 0);
            
            return sumatoria / (n - 1); // Varianza Muestral
        }

        // --- L√ìGICA DE EXTRACCI√ìN Y DESPLEGABLE ---

        function extractTeams() {
            const fileInput = document.getElementById('jsonFile');
            const outputDiv = document.getElementById('fileAnalysisOutput');
            
            outputDiv.innerHTML = '<h4>Analizando Archivo...</h4>';
            
            if (fileInput.files.length === 0) {
                outputDiv.innerHTML = '<p class="error">‚ùå Por favor, selecciona un archivo JSON.</p>';
                document.getElementById('teamSelectionArea').style.display = 'none';
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    globalMatchData = data;
                    populateTeamSelect(data, outputDiv);
                } catch (error) {
                    outputDiv.innerHTML = `<p class="error">‚ùå Error al parsear JSON: ${error.message}</p>`;
                    document.getElementById('teamSelectionArea').style.display = 'none';
                }
            };

            reader.onerror = function() {
                outputDiv.innerHTML = '<p class="error">‚ùå Error al leer el archivo.</p>';
                document.getElementById('teamSelectionArea').style.display = 'none';
            };

            reader.readAsText(file);
        }

        function populateTeamSelect(data, outputDiv) {
            const teams = new Set();
            
            data.forEach(item => {
                const match = item['Match'];
                if (match) {
                    // Asumimos el formato "Equipo Local - Equipo Visitante"
                    const parts = match.split('-');
                    if (parts.length >= 2) {
                        teams.add(parts[0].trim());
                        teams.add(parts[1].trim());
                    }
                }
            });

            const selectElement = document.getElementById('targetTeamSelect');
            selectElement.innerHTML = '<option value="">-- Selecciona un Equipo --</option>'; // Limpiar y a√±adir placeholder

            if (teams.size === 0) {
                outputDiv.innerHTML = '<p class="error">‚ùå No se encontraron nombres de equipos en el campo "Match". Verifica el formato.</p>';
                document.getElementById('teamSelectionArea').style.display = 'none';
                return;
            }
            
            Array.from(teams).sort().forEach(teamName => {
                selectElement.appendChild(new Option(teamName, teamName));
            });

            document.getElementById('teamSelectionArea').style.display = 'block';
            outputDiv.innerHTML = '<p>‚úÖ Archivo cargado. Selecciona un equipo para el an√°lisis BTTS.</p>';
        }

        // --- L√ìGICA PRINCIPAL DE AN√ÅLISIS ---

        function executeAnalysis() {
            const targetTeam = document.getElementById('targetTeamSelect').value;
            const outputDiv = document.getElementById('fileAnalysisOutput');
            
            if (!targetTeam) {
                outputDiv.innerHTML = '<p class="error">Por favor, selecciona un equipo para el an√°lisis.</p>';
                return;
            }

            const data = globalMatchData;
            
            const gaArray = []; // Goles Anotados
            const grArray = []; // Goles Recibidos
            const bttsOdds = []; // Cuotas BTTS ganadoras

            data.forEach(item => {
                const match = item['Match'];
                const resultFT = item['Result FT'];
                const result = item['Result']; // 'Winning' o 'Losing'

                if (!match || !resultFT) return;
                
                const [scoreLocalStr, scoreAwayStr] = resultFT.split('-').map(s => s.trim());
                const scoreLocal = parseInt(scoreLocalStr);
                const scoreAway = parseInt(scoreAwayStr);

                if (isNaN(scoreLocal) || isNaN(scoreAway)) return;
                
                // 1. Recopilar Goles para Varianza
                if (match.startsWith(targetTeam + ' -')) { 
                    // Si el equipo est√° al inicio y tiene el separador
                    gaArray.push(scoreLocal);
                    grArray.push(scoreAway);
                } else if (match.endsWith('- ' + targetTeam)) {
                    // Si el equipo est√° al final y tiene el separador
                    gaArray.push(scoreAway);
                    grArray.push(scoreLocal);
                }

                // 2. Recopilar Cuotas de Apuestas Ganadoras (BTTS)
                if (result === 'Winning') {
                    const odd = parseFloat(item['Odd']);
                    if (!isNaN(odd)) {
                        bttsOdds.push(odd);
                    }
                }
            });

            if (gaArray.length < 2) {
                outputDiv.innerHTML = `<p class="error">‚ùå No se encontraron suficientes partidos (N < 2) para calcular la varianza de "${targetTeam}".</p>`;
                return;
            }

            // 3. C√°lculos de Varianza y Estad√≠sticas
            const varGA = calcularVarianza(gaArray);
            const varGR = calcularVarianza(grArray);
            const mediaGA = calcularMedia(gaArray);
            const mediaGR = calcularMedia(grArray);
            const mediaOdd = calcularMedia(bttsOdds);
            // Asegura que la varianza es positiva antes de la ra√≠z cuadrada
            const varianzaOdd = calcularVarianza(bttsOdds);
            const desvEstOdd = varianzaOdd > 0 ? Math.sqrt(varianzaOdd) : 0;
            
            // 4. Mostrar Resultados y Recomendaci√≥n BTTS
            mostrarRecomendacion(targetTeam, gaArray.length, varGA, varGR, mediaGA, mediaGR, mediaOdd, desvEstOdd, outputDiv);
        }

        // --- FUNCI√ìN DE RECOMENDACI√ìN DE CUOTAS BTTS (Mejorada) ---

        function mostrarRecomendacion(teamName, N, varGA, varGR, mediaGA, mediaGR, mediaOdd, desvEstOdd, outputDiv) {
            const varGA_f = varGA.toFixed(3);
            const varGR_f = varGR.toFixed(3);
            const mediaOdd_f = mediaOdd.toFixed(3);
            const desvEstOdd_f = desvEstOdd.toFixed(3);

            const altaVarianzaOfensiva = varGA > 1.0;
            const altaVarianzaDefensiva = varGR > 1.0;
            
            // Rango de Oro de BTTS (donde el modelo es hist√≥ricamente fuerte)
            const rangoMin = mediaOdd - desvEstOdd;
            const rangoMax = mediaOdd + desvEstOdd;

            let conclusionVarianza = '';
            let estrategiaBTTS = '';
            
            if (altaVarianzaOfensiva && altaVarianzaDefensiva) {
                conclusionVarianza = `El equipo es **Altamente Vol√°til** (Ofensiva y Defensiva Inconsistentes).`;
                estrategiaBTTS = `Busca **BTTS S√ç** contra casi cualquier rival, ya que su alto promedio de goles (${mediaGA.toFixed(2)} GA) y su defensa inestable (${mediaGR.toFixed(2)} GR) lo hacen propenso al intercambio de goles. El valor est√° en la cuota BTTS S√ç.`;
            } else if (altaVarianzaOfensiva) {
                conclusionVarianza = `El equipo tiene una **Ofensiva Vol√°til** y una Defensa Consistente.`;
                estrategiaBTTS = `Prioriza **BTTS S√ç** contra rivales con defensas d√©biles (aunque la casa no lo espere). La volatilidad de su ataque puede generar goles inesperados.`;
            } else if (altaVarianzaDefensiva) {
                conclusionVarianza = `El equipo tiene una **Defensa Vol√°til** y una Ofensiva Consistente.`;
                estrategiaBTTS = `Es un candidato ideal para **BTTS S√ç**. Su ataque (${mediaGA.toFixed(2)} GA) asegura el gol propio, y su defensa inestable casi garantiza el gol del rival. El valor suele ser alto en el 'S√≠'.`;
            } else {
                conclusionVarianza = `El equipo es **Muy Consistente** (Ofensiva y Defensiva Estables).`;
                estrategiaBTTS = `Apuesta a **BTTS NO** cuando la cuota de 'BTTS NO' est√© sobrevalorada, o a **BTTS S√ç** solo si la cuota es excepcionalmente alta. La consistencia reduce las sorpresas.`;
            }

            outputDiv.innerHTML = `
                <h4>An√°lisis de Varianza de ${teamName} (${N} Partidos)</h4>
                <p><strong>Media Goles Anotados (GA):</strong> ${mediaGA.toFixed(2)} | <strong>Varianza Ofensiva:</strong> <strong>${varGA_f}</strong></p>
                <p><strong>Media Goles Recibidos (GR):</strong> ${mediaGR.toFixed(2)} | <strong>Varianza Defensiva:</strong> <strong>${varGR_f}</strong></p>
                <hr>
                
                <div class="recomendacion">
                    <h4>üéØ Estrategia BTTS para ${teamName}</h4>
                    <p><strong>Conclusi√≥n:</strong> ${conclusionVarianza}</p>
                    <p><strong>Estrategia Clave:</strong> ${estrategiaBTTS}</p>
                    
                    <h4 style="margin-top: 20px;">Rango de Cuotas BTTS Sugeridas (Tu Zona de Edge)</h4>
                    <p>Tu modelo tiene mayor ventaja hist√≥rica en cuotas alrededor de ${mediaOdd_f}.</p>
                    <p><strong>Media de Cuotas Ganadoras:</strong> ${mediaOdd_f}</p>
                    <p><strong>Desviaci√≥n Est√°ndar:</strong> ${desvEstOdd_f}</p>
                    
                    <table class="range-table">
                        <thead>
                            <tr>
                                <th>Rango Estad√≠stico</th>
                                <th>Cuotas Sugeridas</th>
                                <th>Acci√≥n Estrat√©gica</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>**Rango de Consistencia ($\pm 1s$)**</td>
                                <td>**${rangoMin.toFixed(2)}** a **${rangoMax.toFixed(2)}**</td>
                                <td>**Busca el Edge aqu√≠.** Este es tu rango de "Oro". El 68% de tus aciertos caen aqu√≠.</td>
                            </tr>
                            <tr>
                                <td>**Valor Superior (High Edge)**</td>
                                <td>Cuotas **superiores a ${rangoMax.toFixed(2)}**</td>
                                <td>Ideal para **BTTS S√ç** en partidos con alta varianza, buscando un alto retorno.</td>
                            </tr>
                            <tr>
                                <td>**Cuotas a Evitar**</td>
                                <td>Cuotas inferiores a **${rangoMin.toFixed(2)}**</td>
                                <td>Tu *backtesting* sugiere poco valor (*Edge* negativo) en este rango.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
        }
        
        window.onload = function() {
            // No hay inicializaci√≥n necesaria aparte del evento onchange del input file.
        };
    </script>
</body>
</html>