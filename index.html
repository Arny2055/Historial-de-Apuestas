<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BETAGS - Deep Analytics Pro</title>
    <style>
        :root {
            --bg-dark: #0b0e14;
            --bg-card: #151921;
            --primary: #4dabf7;
            --accent-green: #51cf66;
            --accent-red: #ff6b6b;
            --accent-yellow: #fcc419;
            --text-white: #e9ecef;
            --text-muted: #adb5bd;
            --border: #2c3440;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-white);
            margin: 0;
            padding: 0;
            display: flex; 
            justify-content: center;
            min-height: 100vh;
            text-align: center;
        }

        .container { 
            width: 100%; 
            max-width: 100%; 
            padding: 15px; 
            box-sizing: border-box;
            padding-bottom: 40px;
        }

        h1 { font-size: 1.4rem; color: var(--primary); text-align: center; margin: 20px 0; letter-spacing: 3px; font-weight: 900; }
        h1 span { color: var(--text-white); }

        .nav-header {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn-nav-roi, .btn-nav-xg {
            background: rgba(77, 171, 247, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 8px 15px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-nav-xg {
            border-color: var(--accent-green);
            color: var(--accent-green);
            background: rgba(81, 207, 102, 0.1);
        }

        .section-title { 
            font-size: 0.7rem; 
            color: var(--primary); 
            text-transform: uppercase; 
            margin: 20px 0 12px 0; 
            display: flex; 
            justify-content: center;
            align-items: center; 
            gap: 8px; 
            font-weight: bold; 
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .input-grid { width: 100%; display: grid; grid-template-columns: 1fr; gap: 12px; }
        
        select, input { 
            width: 100%; 
            padding: 14px; 
            border-radius: 10px; 
            border: 1px solid var(--border); 
            background: #0b0e14;
            color: white;
            font-size: 1rem;
            outline: none;
            box-sizing: border-box;
        }

        .add-league-box {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .input-new-sheet { flex: 1; font-size: 0.8rem; border: 1px dashed var(--primary); }

        .btn-add-sheet {
            background: var(--primary);
            color: var(--bg-dark);
            border: none;
            padding: 0 15px;
            border-radius: 8px;
            font-weight: 900;
            cursor: pointer;
        }

        .btn-analyze-day {
            width: 100%;
            background: linear-gradient(90deg, #4dabf7, #339af0);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-weight: 900;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(77, 171, 247, 0.3);
            margin-top: 10px;
        }

        /* Tabla de An√°lisis Global */
        .table-wrapper { width: 100%; overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; }
        th { background: #1a202c; color: var(--text-muted); padding: 10px 5px; text-transform: uppercase; border-bottom: 2px solid var(--border); }
        td { padding: 12px 5px; border-bottom: 1px solid var(--border); }
        
        .league-tag { font-size: 0.6rem; background: var(--border); padding: 2px 4px; border-radius: 4px; color: var(--primary); display: block; margin-bottom: 4px; }
        .team-cell { text-align: left; font-weight: bold; min-width: 100px; }
        
        .input-odds {
            width: 50px;
            padding: 5px;
            font-size: 0.75rem;
            border-radius: 5px;
            color: var(--accent-yellow);
            text-align: center;
        }

        .value-badge {
            padding: 3px 5px;
            border-radius: 4px;
            font-weight: 900;
            font-size: 0.65rem;
        }
        .pos { background: rgba(81, 207, 102, 0.2); color: var(--accent-green); }
        .neg { background: rgba(255, 107, 107, 0.15); color: var(--accent-red); }

        .btn-send {
            background: var(--primary);
            color: var(--bg-dark);
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.65rem;
            cursor: pointer;
        }

        /* Estilos originales de Gr√°ficos y xG */
        .chart-container { width: 100%; height: 150px; display: flex; align-items: flex-end; justify-content: space-around; margin: 15px 0; }
        .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end; }
        .bar { width: 70%; background: var(--primary); border-radius: 2px 2px 0 0; min-height: 2px; }
        .bar.away { background: var(--accent-green); }
        .xg-info-display { display: flex; justify-content: center; gap: 30px; margin-top: 10px; }
        .xg-badge .value { font-size: 1.2rem; font-weight: 900; }

        #loading { display: none; color: var(--primary); font-weight: bold; margin: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>BETA<span>GS</span> ANALYTICS</h1>
    
    <div class="nav-header">
        <a href="roi2.html" class="btn-nav-roi"><span>üßÆ</span> ROI CALC</a>
        <a href="xg.html" class="btn-nav-xg"><span>‚öΩ</span> XG ANALYTICS</a>
    </div>

    <div class="section-title"><span>‚öôÔ∏è</span> PANEL DE CONTROL</div>
    <div class="card">
        <div class="input-grid">
            <select id="leagueSelect" onchange="cargarDatosLiga()"></select>
            
            <div class="add-league-box">
                <input type="text" id="newSheetName" class="input-new-sheet" placeholder="A√ëADIR HOJA (EJ: EPL)...">
                <button class="btn-add-sheet" onclick="agregarNuevaLiga()">+</button>
                <button class="btn-add-sheet" style="background:var(--accent-red)" onclick="borrarLigaSeleccionada()">üóëÔ∏è</button>
            </div>

            <button class="btn-analyze-day" onclick="analizarTodaLaJornada()">
                üöÄ ANALIZAR TODAS LAS LIGAS
            </button>
        </div>
    </div>

    <div id="loading">PROCESANDO TODAS LAS HOJAS...</div>

    <div id="globalAnalysisPanel" class="hidden">
        <div class="section-title"><span>üìä</span> VALOR DETECTADO EN JORNADA</div>
        <div class="card" style="padding: 10px 5px;">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>PARTIDO</th>
                            <th>MERCADO</th>
                            <th>xG T.</th>
                            <th>PROB</th>
                            <th>CUOTA</th>
                            <th>VALUE</th>
                            <th>ACC</th>
                        </tr>
                    </thead>
                    <tbody id="globalTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="individualAnalysis">
        <div class="section-title"><span>üéØ</span> AN√ÅLISIS INDIVIDUAL</div>
        <div class="card">
            <div class="input-grid">
                <select id="homeTeamSelect" onchange="calcularXG()"><option value="">LOCAL...</option></select>
                <select id="awayTeamSelect" onchange="calcularXG()"><option value="">VISITA...</option></select>
            </div>
        </div>

        <div id="xgPanel" class="hidden">
            <div class="card">
                <div class="chart-container" id="golesChart"></div>
                <div class="xg-info-display">
                    <div class="xg-badge">
                        <div style="font-size:0.6rem">xG LOCAL</div>
                        <div class="value" id="xg_local_val" style="color:var(--primary)">0.00</div>
                    </div>
                    <div class="xg-badge">
                        <div style="font-size:0.6rem">xG VISITA</div>
                        <div class="value" id="xg_away_val" style="color:var(--accent-green)">0.00</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const DEFAULT_ID = '1lmUPv7SP0XYi9ns4jkj3RTCScxIN2pCfBJyMUp_kNRI';
    let ligasData = {}; // Cache para no repetir fetches

    // --- MANEJO DE LIGAS ---
    function getSavedLeagues() {
        const saved = localStorage.getItem('betags_custom_leagues');
        return saved ? JSON.parse(saved) : [];
    }

    function renderLeagueSelect() {
        const select = document.getElementById('leagueSelect');
        const leagues = getSavedLeagues();
        select.innerHTML = leagues.map(l => `<option value="${l.sheet}">${l.name}</option>`).join('');
    }

    function agregarNuevaLiga() {
        const input = document.getElementById('newSheetName');
        let name = input.value.trim().toUpperCase();
        if (!name) return;
        const leagues = getSavedLeagues();
        if (!leagues.find(l => l.sheet === name)) {
            leagues.push({ name: name, sheet: name });
            localStorage.setItem('betags_custom_leagues', JSON.stringify(leagues));
            renderLeagueSelect();
        }
        input.value = "";
    }

    function borrarLigaSeleccionada() {
        const sheet = document.getElementById('leagueSelect').value;
        let leagues = getSavedLeagues().filter(l => l.sheet !== sheet);
        localStorage.setItem('betags_custom_leagues', JSON.stringify(leagues));
        renderLeagueSelect();
    }

    // --- MATEM√ÅTICAS ---
    function poisson(k, lambda) { return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k); }
    function factorial(n) { if (n === 0) return 1; let res = 1; for (let i = 1; i <= n; i++) res *= i; return res; }

    // --- L√ìGICA DE CARGA ---
    async function fetchHoja(sheetName) {
        const url = `https://docs.google.com/spreadsheets/d/${DEFAULT_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
        try {
            const response = await fetch(url);
            const csvText = await response.text();
            const filas = csvText.split('\n').map(l => l.split(',').map(c => c.replace(/^"(.*)"$/, '$1').trim()));
            
            let locales = [], visitantes = [];
            filas.forEach((cols, i) => {
                if (i > 0 && cols[1] && !isNaN(parseFloat(cols[2]))) {
                    locales.push({ nombre: cols[1], gp: parseFloat(cols[2]), gf: parseFloat(cols[6]), ga: parseFloat(cols[7]) });
                    visitantes.push({ nombre: cols[13], gp: parseFloat(cols[14]), gf: parseFloat(cols[18]), ga: parseFloat(cols[19]) });
                }
            });

            let sGFL = 0, sGAL = 0, sPJL = 0, sGFV = 0, sGAV = 0, sPJV = 0;
            locales.forEach(e => { sGFL += e.gf; sGAL += e.ga; sPJL += e.gp; });
            visitantes.forEach(e => { sGFV += e.gf; sGAV += e.ga; sPJV += e.gp; });

            return {
                locales, visitantes,
                liga: { gfl: sGFL/sPJL, gal: sGAL/sPJL, gfv: sGFV/sPJV, gav: sGAV/sPJV }
            };
        } catch (e) { return null; }
    }

    // --- ANALIZAR TODAS LAS LIGAS ---
    async function analizarTodaLaJornada() {
        const loading = document.getElementById('loading');
        const leagues = getSavedLeagues();
        if (leagues.length === 0) return alert("Agrega ligas primero.");

        loading.style.display = 'block';
        document.getElementById('globalAnalysisPanel').classList.add('hidden');
        
        // 1. Cargar Partidos del D√≠a
        const resDia = await fetch(`https://docs.google.com/spreadsheets/d/${DEFAULT_ID}/gviz/tq?tqx=out:csv&sheet=PARTIDOS+DEL+DIA&range=D1:F100`);
        const csvDia = await resDia.text();
        const partidosHoy = csvDia.split('\n').map(l => l.split(',').map(c => c.replace(/^"(.*)"$/, '$1').trim()));

        // 2. Procesar cada liga guardada
        const tableBody = document.getElementById('globalTableBody');
        tableBody.innerHTML = '';
        let hallados = 0;

        for (let ligaObj of leagues) {
            const data = await fetchHoja(ligaObj.sheet);
            if (!data) continue;

            partidosHoy.forEach(partido => {
                const locName = partido[0];
                const visName = partido[2];
                
                const dLoc = data.locales.find(e => e.nombre.toUpperCase() === locName?.toUpperCase());
                const dVis = data.visitantes.find(e => e.nombre.toUpperCase() === visName?.toUpperCase());

                if (dLoc && dVis) {
                    hallados++;
                    const xGL = ((dLoc.gf/dLoc.gp)/data.liga.gfl) * ((dVis.ga/dVis.gp)/data.liga.gav) * data.liga.gfl;
                    const xGV = ((dVis.gf/dVis.gp)/data.liga.gfv) * ((dLoc.ga/dLoc.gp)/data.liga.gal) * data.liga.gfv;
                    
                    // C√°lculo de probabilidades (Poisson)
                    let pL = [], pV = [], u25 = 0;
                    for(let i=0; i<=6; i++) { pL[i] = poisson(i, xGL); pV[i] = poisson(i, xGV); }
                    for(let i=0; i<=2; i++) for(let j=0; j<=2; j++) if(i+j <= 2) u25 += pL[i]*pV[j];
                    const bttsY = 1 - (pL[0] + pV[0] - (pL[0]*pV[0]));

                    renderRow(tableBody, ligaObj.name, locName, visName, "O2.5", 1-u25, xGL+xGV);
                    renderRow(tableBody, ligaObj.name, locName, visName, "U2.5", u25, xGL+xGV);
                    renderRow(tableBody, ligaObj.name, locName, visName, "BTTS Y", bttsY, xGL+xGV);
                }
            });
        }

        loading.style.display = 'none';
        document.getElementById('globalAnalysisPanel').classList.remove('hidden');
        if (hallados === 0) alert("No se encontraron partidos de tus ligas en la hoja del d√≠a.");
    }

    function renderRow(container, liga, loc, vis, mercado, prob, totalXg) {
        const id = Math.random().toString(36).substr(2, 9);
        const row = document.createElement('tr');
        const justa = (1/prob).toFixed(2);
        
        row.innerHTML = `
            <td class="team-cell"><span class="league-tag">${liga}</span>${loc} vs ${vis}</td>
            <td><strong>${mercado}</strong></td>
            <td>${totalXg.toFixed(1)}</td>
            <td style="color:var(--primary)">${(prob*100).toFixed(0)}%</td>
            <td><input type="number" class="input-odds" id="in_${id}" placeholder="${justa}" oninput="calcValRow('${id}', ${prob})"></td>
            <td id="val_${id}">--</td>
            <td><button class="btn-send" onclick="sendGlobal('${liga}','${loc}','${vis}','${mercado}',${prob},'${id}')">SEND</button></td>
        `;
        container.appendChild(row);
    }

    function calcValRow(id, prob) {
        const cuota = parseFloat(document.getElementById('in_'+id).value);
        const cell = document.getElementById('val_'+id);
        if (!cuota) { cell.innerText = '--'; return; }
        const edge = (prob * cuota) - 1;
        const color = edge > 0 ? 'pos' : 'neg';
        cell.innerHTML = `<span class="value-badge ${color}">${(edge*100).toFixed(1)}%</span>`;
    }

    // --- FUNCIONES ORIGINALES (SIN CAMBIOS) ---
    async function cargarDatosLiga() {
        const sheet = document.getElementById('leagueSelect').value;
        const data = await fetchHoja(sheet);
        if (data) {
            ligasData[sheet] = data;
            const hS = document.getElementById('homeTeamSelect');
            const aS = document.getElementById('awayTeamSelect');
            hS.innerHTML = '<option value="">LOCAL...</option>';
            aS.innerHTML = '<option value="">VISITA...</option>';
            data.locales.map(e => e.nombre).sort().forEach(n => {
                hS.options.add(new Option(n, n));
                aS.options.add(new Option(n, n));
            });
        }
    }

    function calcularXG() {
        const sheet = document.getElementById('leagueSelect').value;
        const homeN = document.getElementById('homeTeamSelect').value;
        const awayN = document.getElementById('awayTeamSelect').value;
        const data = ligasData[sheet];
        if (!data || !homeN || !awayN) return;

        const dL = data.locales.find(e => e.nombre === homeN);
        const dV = data.visitantes.find(e => e.nombre === awayN);
        
        const xGL = ((dL.gf/dL.gp)/data.liga.gfl) * ((dV.ga/dV.gp)/data.liga.gav) * data.liga.gfl;
        const xGV = ((dV.gf/dV.gp)/data.liga.gfv) * ((dL.ga/dL.gp)/data.liga.gal) * data.liga.gfv;

        document.getElementById('xg_local_val').innerText = xGL.toFixed(2);
        document.getElementById('xg_away_val').innerText = xGV.toFixed(2);
        document.getElementById('xgPanel').classList.remove('hidden');

        // Renderizado de barras
        const chart = document.getElementById('golesChart');
        chart.innerHTML = '';
        for(let i=0; i<=5; i++) {
            const pL = poisson(i, xGL);
            const pV = poisson(i, xGV);
            chart.innerHTML += `
                <div class="bar-group">
                    <div style="display:flex; gap:2px; height:100%; align-items:flex-end;">
                        <div class="bar" style="height:${pL*100}%"></div>
                        <div class="bar away" style="height:${pV*100}%"></div>
                    </div>
                    <div style="font-size:0.6rem">${i}</div>
                </div>`;
        }
    }

    function sendGlobal(liga, loc, vis, mercado, prob, id) {
        const cuota = parseFloat(document.getElementById('in_'+id).value);
        if (!cuota) return alert("Pon una cuota.");
        
        const pick = {
            id: Date.now(),
            date: new Date().toLocaleDateString(),
            teams: `${liga}: ${loc} vs ${vis}`,
            market: mercado,
            prob: prob,
            odd: cuota,
            edge: ((prob * cuota - 1) * 100).toFixed(1) + '%',
            status: 'pending'
        };

        let current = JSON.parse(localStorage.getItem('betags_pre_match')) || [];
        current.push(pick);
        localStorage.setItem('betags_pre_match', JSON.stringify(current));
        alert("¬°Enviado a ROI CALC!");
    }

    window.onload = () => {
        renderLeagueSelect();
        if (getSavedLeagues().length > 0) cargarDatosLiga();
    };
</script>
</body>
</html>
