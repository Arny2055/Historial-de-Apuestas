<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Historial de Apuestas Profesional (Perfiles + Migraci√≥n + Fix Gr√°fica)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  *, *::before, *::after { box-sizing: border-box; }
  body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: #121214; color: #e1e1e6; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
  main { max-width: 1200px; width: 95%; margin: 20px auto 40px auto; flex-grow: 1; }
  h1, h2 { font-weight: 600; margin-bottom: 0.5rem; color: #8257e6; }

  /* Barra de perfiles */
  .perfiles { display:flex; gap:10px; align-items:center; margin: 8px 0 18px; flex-wrap:wrap; }
  .perfiles select, .perfiles button {
    background:#202024; color:#e1e1e6; border:none; border-radius:8px; padding:10px 12px;
    box-shadow: inset 0 0 5px rgb(255 255 255 / 0.08);
    font-weight:600; cursor:pointer;
  }
  .perfiles select { min-width: 180px; }
  .perfiles .danger { background:#ef4444; }
  .perfiles .primary { background:#8257e6; }

  /* Formulario */
  form#formApuesta{
    background-color:#202024; padding:25px 30px; border-radius:10px;
    box-shadow:0 6px 12px rgba(0,0,0,0.4);
    display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:20px 24px; margin-bottom:40px;
  }
  form#formApuesta label{display:block;font-weight:600;font-size:0.95rem;margin-bottom:6px;color:#c4c4cc;}
  form#formApuesta input[type="text"],
  form#formApuesta input[type="number"],
  form#formApuesta select{
    width:100%; padding:10px 14px; font-size:1rem; border-radius:8px; border:none;
    background-color:#121214; color:#e1e1e6; box-shadow:inset 0 0 5px rgb(255 255 255 / 0.1);
    transition: box-shadow 0.25s ease;
  }
  form#formApuesta input[type="text"]:focus,
  form#formApuesta input[type="number"]:focus,
  form#formApuesta select:focus{outline:none; box-shadow:inset 0 0 8px #8257e6;}
  form#formApuesta input[readonly]{background-color:#2a2a30; cursor:not-allowed;}
  form#formApuesta button[type="submit"]{
    grid-column:1 / -1; background-color:#8257e6; color:#fff; font-weight:700; font-size:1.2rem;
    padding:14px 20px; border:none; border-radius:10px; cursor:pointer; transition:background-color 0.3s ease;
    box-shadow:0 6px 10px #6a40d6;
  }
  form#formApuesta button[type="submit"]:hover{background-color:#6a40d6;}

  /* Filtros */
  section.filtros{ margin-bottom:30px; display:flex; flex-wrap:wrap; gap:15px 18px; align-items: center; }
  section.filtros input[type="text"],
  section.filtros input[type="number"],
  section.filtros input[type="date"],
  section.filtros select{
    min-width:160px; padding:9px 14px; border-radius:8px; border:none;
    background-color:#121214; color:#e1e1e6; box-shadow:inset 0 0 5px rgb(255 255 255 / 0.1);
    transition: box-shadow 0.25s ease;
  }
  section.filtros input:focus, section.filtros select:focus{outline:none; box-shadow:inset 0 0 8px #8257e6;}
  #btnLimpiarFiltros{
    background-color:#ef4444; color:#fff; font-weight:700; border:none; border-radius:10px;
    cursor:pointer; padding:8px 14px; transition:background-color 0.3s ease;
  }
  #btnLimpiarFiltros:hover{background-color:#dc2626;}

  /* Botones √∫tiles */
  .botones-utiles{margin-bottom:35px; display:flex; gap:18px; flex-wrap:wrap;}
  .botones-utiles button{
    background-color:#8257e6; color:#fff; font-weight:600; border:none; border-radius:10px;
    cursor:pointer; padding:12px 20px; box-shadow:0 4px 8px #6b45d9; transition:background-color 0.3s ease;
  }
  .botones-utiles button:hover{background-color:#6b45d9;}
  .botones-utiles .btn-danger{background-color:#ef4444; box-shadow:0 4px 8px rgba(239,68,68,.4);}
  .botones-utiles .btn-danger:hover{background-color:#dc2626;}
  input[type="file"]{display:none;}

  /* Tabla */
  #tablaWrapper{ overflow-x:auto; overflow-y:auto; max-height:580px; box-shadow:0 6px 12px rgba(0,0,0,0.4); border-radius:12px; }
  table#tablaHistorial{width:100%; border-collapse:separate; border-spacing:0 5px; min-width:900px; font-size:0.9rem;}
  thead th{ position:sticky; top:0; background-color:#29292e; color:#bbb; font-weight:700; text-align:left; padding:14px 18px; user-select:none; white-space:nowrap; }
  tbody tr{background-color:#202024; transition:background-color 0.3s ease;}
  tbody tr:hover{background-color:#333339;}
  tbody td{padding:14px 18px; color:#ddd; vertical-align:middle; white-space:nowrap;}
  .acciones button{background:none; border:none; font-size:1.2rem; margin:0 4px; cursor:pointer; color:#aaa; transition:color 0.2s ease;}
  .acciones button:hover{color:#8257e6;}
  .status-pendiente{color:#fbbf24; font-weight:600;}
  .status-ganada{color:#4caf50; font-weight:600;}
  .status-perdida{color:#ef4444; font-weight:600;}

  /* Resumen */
  #resumen{ margin-top:40px; background-color:#29292e; border-radius:10px; padding:22px 26px; color:#d4d4d8; font-size:1.05rem; font-weight:600; display:flex; flex-wrap:wrap; gap:28px; justify-content:space-around; }
  #resumen > div{min-width:140px;}
  #resumen > div strong{display:block; font-size:1.15rem; color:#8257e6; margin-bottom:6px;}

  /* Gr√°ficas */
  #graficas{margin-top:45px; display:flex; flex-direction:column; gap:40px;}
  canvas{background-color:#202024; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,0.5); max-width:100%; height:320px !important;}

  /* Responsive */
  @media (max-width: 900px){
    form#formApuesta{grid-template-columns:1fr !important;}
    section.filtros{flex-direction:column !important; gap:15px !important;}
    .botones-utiles{flex-direction:column; gap:15px;}
    #resumen{flex-direction:column; gap:20px; text-align:center;}
    tbody td, thead th{font-size:0.8rem; padding:10px 12px;}
  }
</style>
</head>
<body>
<main>
  <h1 style="text-align:center;">Historial Profesional de Apuestas</h1>

  <!-- ====== PERFILES / REGISTROS ====== -->
  <div class="perfiles" aria-label="Gesti√≥n de perfiles/registros">
    <strong>Perfil/Registro:</strong>
    <select id="selectPerfil" title="Selecciona un perfil"></select>
    <button id="btnNuevoPerfil" class="primary">Nuevo perfil</button>
    <button id="btnBorrarPerfil" class="danger">Borrar perfil actual</button>
  </div>

  <!-- ====== FORMULARIO ====== -->
  <form id="formApuesta" autocomplete="off" novalidate aria-label="Formulario para agregar apuesta">
    <div>
      <label for="liga">Liga *</label>
      <input type="text" id="liga" name="liga" placeholder="Ej: LaLiga" required />
    </div>
    <div>
      <label for="local">Equipo Local *</label>
      <input type="text" id="local" name="local" placeholder="Ej: Real Madrid" required />
    </div>
    <div>
      <label for="visita">Equipo Visitante *</label>
      <input type="text" id="visita" name="visita" placeholder="Ej: Barcelona" required />
    </div>
    <div>
      <label for="mercado">Mercado *</label>
      <select id="mercado" name="mercado" required>
        <option value="" disabled selected>Selecciona mercado</option>
        <option value="Over 2.5 FT">Over 2.5 FT</option>
        <option value="Under 2.5 FT">Under 2.5 FT</option>
        <option value="Ambos Anotan">Ambos Anotan</option>
        <option value="BTTS NO">BTTS NO</option>
        <option value="H√°ndicap">H√°ndicap</option>
      </select>
    </div>
    <div>
      <label for="probabilidad">Probabilidad (%) *</label>
      <input type="number" id="probabilidad" name="probabilidad" min="0.01" max="100" step="0.01" placeholder="Ej: 60" required />
      <small style="color:#c4c4cc; font-size:0.8rem;">Ingresa probabilidad estimada entre 0 y 100</small>
    </div>
    <div>
      <label for="cuotaImplicita">Cuota Impl√≠cita (auto)</label>
      <input type="number" id="cuotaImplicita" step="0.01" readonly placeholder="Ej: 1.66" />
    </div>
    <div>
      <label for="cuotaBookie">Cuota Bookie (decimal) *</label>
      <input type="number" id="cuotaBookie" name="cuotaBookie" min="1.01" step="0.01" placeholder="Ej: 1.80" required />
    </div>
    <div>
      <label for="bankroll">Bankroll *</label>
      <input type="number" id="bankroll" name="bankroll" min="0.01" step="0.01" placeholder="Ej: 100" value="100" required />
    </div>
    <div>
      <label for="kellyFrac">Fracci√≥n Kelly *</label>
      <select id="kellyFrac" name="kellyFrac" required>
        <option value="0.10">10%</option>
        <option value="0.25" selected>25%</option>
        <option value="0.33">33%</option>
        <option value="0.50">50%</option>
        <option value="1.00">100%</option>
      </select>
    </div>
    <div>
      <label for="stakePreview">Stake sugerido (preview)</label>
      <input type="number" id="stakePreview" readonly placeholder="0.00" />
    </div>
    <div style="align-self:end;">
      <button type="submit" aria-label="Agregar apuesta">Agregar apuesta</button>
    </div>
  </form>

  <!-- ====== FILTROS ====== -->
  <section class="filtros" aria-label="Filtros para el historial de apuestas">
    <input type="text" id="filtroLiga" placeholder="Filtrar por liga..." />
    <input type="text" id="filtroLocal" placeholder="Filtrar por local..." />
    <input type="text" id="filtroVisita" placeholder="Filtrar por visita..." />

    <select id="filtroMercado">
      <option value="">Todos los mercados</option>
      <option value="Over 2.5 FT">Over 2.5 FT</option>
      <option value="Under 2.5 FT">Under 2.5 FT</option>
      <option value="Ambos Anotan">Ambos Anotan</option>
      <option value="BTTS NO">BTTS NO</option>
      <option value="H√°ndicap">H√°ndicap</option>
    </select>

    <select id="filtroEstado">
      <option value="">Todos los estados</option>
      <option value="pendiente">Pendiente</option>
      <option value="ganada">Ganada</option>
      <option value="perdida">Perdida</option>
    </select>

    <input type="number" id="filtroProbMin" placeholder="Prob. m√≠n (%)" min="0" max="100" step="0.01" />
    <input type="number" id="filtroProbMax" placeholder="Prob. m√°x (%)" min="0" max="100" step="0.01" />
    <input type="date" id="filtroFechaInicio" />
    <input type="date" id="filtroFechaFin" />
    <button id="btnLimpiarFiltros" title="Limpiar filtros" aria-label="Limpiar filtros">‚úñ</button>
  </section>

  <!-- ====== BOTONES ====== -->
  <section class="botones-utiles" aria-label="Exportar o importar historial de apuestas">
    <button id="btnExportarCSV" title="Exportar historial a CSV">Exportar CSV</button>
    <button id="btnImportarJSON" title="Importar historial desde archivo JSON">Importar JSON</button>
    <input type="file" id="inputImportJSON" accept=".json" />
    <button onclick="location.href='historial_ligas.html'">Historial por Ligas</button>
    <button onclick="location.href='historial_equipos_rol.html'">Historial por Equipos (Rol)</button>
    <button onclick="location.href='probabilidades.html'">Probabilidades</button>
    <button id="btnEliminarTodo" class="btn-danger" title="Eliminar historial del perfil actual">Eliminar todo (perfil)</button>
  </section>

  <!-- ====== TABLA ====== -->
  <section aria-label="Historial de apuestas registradas">
    <div id="tablaWrapper">
      <table role="grid" aria-describedby="tableDescription" id="tablaHistorial" tabindex="0">
        <caption id="tableDescription" style="text-align:left; margin-bottom:12px; font-weight:700; font-size:1.2rem;">
          Historial de apuestas agregadas
        </caption>
        <thead>
          <tr>
            <th>#</th><th>Fecha</th><th>Liga</th><th>Local</th><th>Visita</th><th>Mercado</th>
            <th>Prob (%)</th><th>Cuota Impl√≠cita</th><th>Cuota Bookie</th><th>EV (%)</th>
            <th>Kelly FULL (%)</th><th>Stake sugerido</th><th>Estado</th><th>‚öô</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ====== RESUMEN ====== -->
  <section id="resumen" aria-label="Resumen estad√≠stico de apuestas">
    <div><strong>Bankroll inicial:</strong> <span id="resumenBankroll">-</span></div>
    <div><strong>N√∫mero apuestas:</strong> <span id="resumenNumApuestas">0</span></div>
    <div><strong>Apuestas ganadas:</strong> <span id="resumenGanadas">0</span></div>
    <div><strong>Apuestas perdidas:</strong> <span id="resumenPerdidas">0</span></div>
    <div><strong>Yield (%):</strong> <span id="resumenYield">0.00%</span></div>
    <div><strong>ROI (%):</strong> <span id="resumenROI">0.00%</span></div>
    <div><strong>Tasa de √©xito (%):</strong> <span id="resumenTasaExito">0.00%</span></div>
    <div><strong>Unidades ganadas:</strong> <span id="resumenUnidades">0.00</span></div>
  </section>

  <!-- ====== GR√ÅFICAS ====== -->
  <section id="graficas" aria-label="Gr√°ficas de evoluci√≥n del bankroll y Kelly">
    <canvas id="graficaBankroll" aria-label="Gr√°fica de evoluci√≥n de bankroll"></canvas>
    <canvas id="graficaKelly" aria-label="Gr√°fica de Kelly Full"></canvas>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  'use strict';

  /* ===================== CONSTANTES ===================== */
  const PROFILE_LIST_KEY = 'historialApuestas__perfiles';
  const DEFAULT_PROFILE = 'default';
  const OLD_KEY = 'historialApuestasProfesionalCompleto'; // clave vieja

  const selectPerfil = document.getElementById('selectPerfil');
  const btnNuevoPerfil = document.getElementById('btnNuevoPerfil');
  const btnBorrarPerfil = document.getElementById('btnBorrarPerfil');

  let perfiles = [];
  let perfilActual = DEFAULT_PROFILE;

  function loadProfiles() {
    try { perfiles = JSON.parse(localStorage.getItem(PROFILE_LIST_KEY) || '[]'); }
    catch { perfiles = []; }
    if (!Array.isArray(perfiles)) perfiles = [];
    if (!perfiles.includes(DEFAULT_PROFILE)) perfiles.unshift(DEFAULT_PROFILE);
    saveProfiles(false);
  }
  function saveProfiles(refresh = true) {
    localStorage.setItem(PROFILE_LIST_KEY, JSON.stringify(perfiles));
    if (refresh) renderProfilesSelect();
  }
  function renderProfilesSelect() {
    selectPerfil.innerHTML = '';
    perfiles.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p; opt.textContent = (p === DEFAULT_PROFILE ? 'default' : p);
      if (p === perfilActual) opt.selected = true;
      selectPerfil.appendChild(opt);
    });
  }
  function promptProfileName() {
    let name = prompt('Nombre del nuevo perfil (letras/n√∫meros/guiones bajos):', '');
    if (!name) return null;
    name = name.trim();
    if (!/^[a-zA-Z0-9_\- ]{1,24}$/.test(name)) { alert('Nombre inv√°lido'); return null; }
    return name;
  }
  function getStorageKey() { return `historialApuestas_${perfilActual}`; }
  function getDefaultStorageKey() { return `historialApuestas_${DEFAULT_PROFILE}`; }

  /* ===================== DOM APP ===================== */
  const form = document.getElementById('formApuesta');
  const cuotaImplicitaInput = document.getElementById('cuotaImplicita');

  const filtroLiga = document.getElementById('filtroLiga');
  const filtroLocal = document.getElementById('filtroLocal');
  const filtroVisita = document.getElementById('filtroVisita');
  const filtroMercado = document.getElementById('filtroMercado');
  const filtroEstado = document.getElementById('filtroEstado');
  const filtroProbMin = document.getElementById('filtroProbMin');
  const filtroProbMax = document.getElementById('filtroProbMax');
  const filtroFechaInicio = document.getElementById('filtroFechaInicio');
  const filtroFechaFin = document.getElementById('filtroFechaFin');
  const btnLimpiarFiltros = document.getElementById('btnLimpiarFiltros');

  const tablaBody = document.querySelector('#tablaHistorial tbody');

  const resumenBankroll = document.getElementById('resumenBankroll');
  const resumenNumApuestas = document.getElementById('resumenNumApuestas');
  const resumenGanadas = document.getElementById('resumenGanadas');
  const resumenPerdidas = document.getElementById('resumenPerdidas');
  const resumenYield = document.getElementById('resumenYield');
  const resumenROI = document.getElementById('resumenROI');
  const resumenTasaExito = document.getElementById('resumenTasaExito');
  const resumenUnidades = document.getElementById('resumenUnidades');

  const btnExportarCSV = document.getElementById('btnExportarCSV');
  const btnImportarJSON = document.getElementById('btnImportarJSON');
  const inputImportJSON = document.getElementById('inputImportJSON');
  const btnEliminarTodo = document.getElementById('btnEliminarTodo');

  const ctxBankroll = document.getElementById('graficaBankroll').getContext('2d');
  const ctxKelly = document.getElementById('graficaKelly').getContext('2d');

  let graficaBankroll = null;
  let graficaKelly = null;

  // Estado por perfil
  let historial = [];

  /* ===================== HELPERS N√öMERICOS ===================== */
  const n = (x, dflt = 0) => {
    const v = typeof x === 'string' ? parseFloat(x.replace(',', '.')) : parseFloat(x);
    return Number.isFinite(v) ? v : dflt;
  };

  function calcularCuotaImplicita(prob) { const p = n(prob); if (!(p > 0)) return ''; return (100 / p).toFixed(2); }
  function calcularEV(prob, cuotaBookie) { const p = n(prob)/100, q = n(cuotaBookie); if (!(p>0 && q>1)) return 0; return p*q - 1; }
  function calcularKelly(prob, cuotaBookie) {
    const p = n(prob)/100, q = n(cuotaBookie); if (!(p>0 && q>1)) return 0;
    const b = q - 1; return (p*b - (1 - p)) / b;
  }
  function stakeSugerido(bankroll, kellyFull, kellyFrac) {
    const br = n(bankroll), kf = n(kellyFull), frac = n(kellyFrac, 0.25);
    if (!(br>0 && kf>0 && frac>0)) return 0;
    const stake = br * kf * frac;
    return stake > br ? br : stake;
  }

  /* ===================== STORAGE POR PERFIL ===================== */
  function guardarHistorial() { localStorage.setItem(getStorageKey(), JSON.stringify(historial)); }
  function cargarHistorial() {
    const data = localStorage.getItem(getStorageKey());
    if (data) { try { historial = JSON.parse(data) || []; } catch { historial = []; } }
    else { historial = []; }
  }

  /* ===================== MIGRACI√ìN DESDE CLAVE VIEJA ===================== */
  function migrateFromOldKeyIfNeeded() {
    try {
      const oldRaw = localStorage.getItem(OLD_KEY);
      if (!oldRaw) return false;
      const newRaw = localStorage.getItem(getDefaultStorageKey());
      if (newRaw && JSON.parse(newRaw || '[]').length > 0) return false;

      let oldData = JSON.parse(oldRaw);
      if (!Array.isArray(oldData)) return false;

      oldData = oldData.map(item => ({
        id: item.id || Date.now() + Math.random(),
        fecha: item.fecha || new Date().toISOString(),
        liga: item.liga || 'Sin liga',
        local: item.local || '',
        visita: item.visita || '',
        mercado: item.mercado || '',
        probabilidad: n(item.probabilidad, 0),
        cuotaImplicita: (item.cuotaImplicita !== undefined && item.cuotaImplicita !== null && item.cuotaImplicita !== '') ? n(item.cuotaImplicita) : (n(item.probabilidad) ? n((100/n(item.probabilidad)).toFixed(2)) : ''),
        cuotaBookie: n(item.cuotaBookie, 0),
        ev: Number.isFinite(item.ev) ? item.ev : calcularEV(item.probabilidad, item.cuotaBookie),
        kellyFull: Number.isFinite(item.kellyFull) ? item.kellyFull : calcularKelly(item.probabilidad, item.cuotaBookie),
        bankroll: n(item.bankroll, 100),
        kellyFrac: n(item.kellyFrac, 0.25),
        estado: item.estado || 'pendiente'
      }));

      localStorage.setItem(getDefaultStorageKey(), JSON.stringify(oldData));
      alert(`Migramos ${oldData.length} apuestas al perfil "default".`);
      return true;
    } catch(e) {
      console.warn('Migraci√≥n fall√≥ o no necesaria:', e);
      return false;
    }
  }

  /* ===================== FILTROS ===================== */
  function limpiarFiltros() {
    filtroLiga.value = filtroLocal.value = filtroVisita.value = '';
    filtroMercado.value = filtroEstado.value = '';
    filtroProbMin.value = filtroProbMax.value = '';
    filtroFechaInicio.value = filtroFechaFin.value = '';
  }
  function filtrarHistorial() {
    return historial.filter(a => {
      if (filtroLiga.value && !String(a.liga||'').toLowerCase().includes(filtroLiga.value.toLowerCase())) return false;
      if (filtroLocal.value && !String(a.local||'').toLowerCase().includes(filtroLocal.value.toLowerCase())) return false;
      if (filtroVisita.value && !String(a.visita||'').toLowerCase().includes(filtroVisita.value.toLowerCase())) return false;
      if (filtroMercado.value && a.mercado !== filtroMercado.value) return false;
      if (filtroEstado.value && a.estado !== filtroEstado.value) return false;

      const pmin = filtroProbMin.value !== '' ? n(filtroProbMin.value) : null;
      const pmax = filtroProbMax.value !== '' ? n(filtroProbMax.value) : null;
      const p = n(a.probabilidad);
      if (pmin !== null && p < pmin) return false;
      if (pmax !== null && p > pmax) return false;

      if (filtroFechaInicio.value && new Date(a.fecha) < new Date(filtroFechaInicio.value)) return false;
      if (filtroFechaFin.value) {
        const fin = new Date(filtroFechaFin.value); fin.setHours(23,59,59,999);
        if (new Date(a.fecha) > fin) return false;
      }
      return true;
    });
  }

  /* ===================== TABLA ===================== */
  function renderizarTabla() {
    const apuestas = filtrarHistorial().slice().sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)); // m√°s reciente arriba
    tablaBody.innerHTML = '';
    apuestas.forEach((a, i) => {
      const tr = document.createElement('tr');
      const td = (txt)=>{const x=document.createElement('td'); x.textContent=txt; return x;};

      tr.appendChild(td(i + 1));
      tr.appendChild(td(new Date(a.fecha).toLocaleDateString()));
      const tdLiga = td(a.liga);
      tdLiga.addEventListener('dblclick', () => {
        const input = document.createElement('input'); input.type='text'; input.value=a.liga; input.style.width="100%";
        tdLiga.textContent=''; tdLiga.appendChild(input); input.focus();
        input.addEventListener('blur', ()=>{ a.liga = input.value.trim() || a.liga; guardarHistorial(); actualizarVista(); });
        input.addEventListener('keydown', e=>{ if(e.key==='Enter') input.blur(); });
      });
      tr.appendChild(tdLiga);
      tr.appendChild(td(a.local));
      tr.appendChild(td(a.visita));
      tr.appendChild(td(a.mercado));
      tr.appendChild(td((n(a.probabilidad)||0).toFixed(2)));

      const impl = (a.cuotaImplicita!=='' && a.cuotaImplicita!==null) ? n(a.cuotaImplicita) : n(calcularCuotaImplicita(a.probabilidad));
      tr.appendChild(td(Number.isFinite(impl) && impl>0 ? impl.toFixed(2) : '-'));
      tr.appendChild(td((n(a.cuotaBookie)||0).toFixed(2)));

      const evPct = (n(a.ev)*100).toFixed(2);
      const tdEV = td(evPct); tdEV.style.color=n(a.ev)>=0?'#4caf50':'#ef4444'; tr.appendChild(tdEV);

      const kfull = n(a.kellyFull);
      const tdKelly = td(kfull>0 ? (kfull*100).toFixed(2) : '-');
      tdKelly.style.color = kfull>0 ? '#4caf50' : '#c4c4cc'; tr.appendChild(tdKelly);

      const stake = stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac);
      tr.appendChild(td(n(stake).toFixed(2)));

      const tdEstado = td(a.estado); tdEstado.className=`status-${a.estado}`; tr.appendChild(tdEstado);

      const tdAcciones = document.createElement('td'); tdAcciones.className='acciones';
      const btn = (title, html, cb)=>{ const b=document.createElement('button'); b.title=title; b.innerHTML=html; b.addEventListener('click', cb); return b; };
      tdAcciones.append(btn('Marcar ganada','‚úÖ',()=>cambiarEstado(a.id,'ganada')),
                        btn('Marcar perdida','‚ùå',()=>cambiarEstado(a.id,'perdida')),
                        btn('Marcar pendiente','‚è≥',()=>cambiarEstado(a.id,'pendiente')),
                        btn('Eliminar','üóëÔ∏è',()=>eliminarApuesta(a.id)));
      tr.appendChild(tdAcciones);

      tablaBody.appendChild(tr);
    });
  }
  function cambiarEstado(id, nuevo) { const i=historial.findIndex(a=>a.id===id); if(i!==-1){ historial[i].estado=nuevo; guardarHistorial(); actualizarVista(); } }
  function eliminarApuesta(id) { if(!confirm('¬øEliminar esta apuesta?')) return; historial = historial.filter(a=>a.id!==id); guardarHistorial(); actualizarVista(); }

  btnEliminarTodo.addEventListener('click', () => {
    if (!confirm(`‚ö†Ô∏è Esto borrar√° TODO el historial del perfil "${perfilActual}". ¬øContinuar?`)) return;
    historial = [];
    localStorage.removeItem(getStorageKey());
    actualizarVista();
    inputImportJSON.value = '';
    alert('Historial del perfil eliminado ‚úÖ');
  });

  /* ===================== RESUMEN ===================== */
  function actualizarResumen() {
    const arr = filtrarHistorial();
    if (arr.length === 0) {
      resumenBankroll.textContent='-'; resumenNumApuestas.textContent='0';
      resumenGanadas.textContent='0'; resumenPerdidas.textContent='0';
      resumenYield.textContent='0.00%'; resumenROI.textContent='0.00%';
      resumenTasaExito.textContent='0.00%'; resumenUnidades.textContent='0.00';
      return;
    }
    // Orden cronol√≥gico para m√©tricas iniciales coherentes
    const ordered = arr.slice().sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
    const bank0 = n(ordered[0].bankroll, 0); resumenBankroll.textContent = bank0.toFixed(2);
    const nA = arr.length; resumenNumApuestas.textContent = nA;
    const g = arr.filter(a=>a.estado==='ganada').length;
    const p = arr.filter(a=>a.estado==='perdida').length;
    resumenGanadas.textContent=g; resumenPerdidas.textContent=p;
    const tasa = nA>0 ? (g/nA)*100 : 0; resumenTasaExito.textContent = tasa.toFixed(2)+'%';

    let totalGanado=0, totalApostado=0;
    arr.forEach(a=>{
      const st = stakeSugerido(a.bankroll,a.kellyFull,a.kellyFrac);
      totalApostado += st;
      if (a.estado==='ganada') totalGanado += st * n(a.cuotaBookie, 0);
    });
    const neto = totalGanado - totalApostado;
    const yieldPct = totalApostado>0 ? (neto/totalApostado)*100 : 0;
    const roiPct = bank0>0 ? (neto/bank0)*100 : 0;
    resumenYield.textContent = yieldPct.toFixed(2)+'%';
    resumenROI.textContent = roiPct.toFixed(2)+'%';
    resumenUnidades.textContent = neto.toFixed(2);
  }

  /* ===================== GR√ÅFICAS ===================== */
  function crearGradiente(ctx) {
    const h = ctx.canvas.clientHeight || ctx.canvas.height || 320;
    const grad = ctx.createLinearGradient(0, 0, 0, h);
    grad.addColorStop(0, 'rgba(130,87,230,0.18)');
    grad.addColorStop(1, 'rgba(130,87,230,0.00)');
    return grad;
  }

  function datosBankrollSanitizados(arr) {
    // Orden cronol√≥gico para que la l√≠nea siga el tiempo
    const ordered = arr.slice().sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));

    const labels = ['Inicio'];
    // Bankroll inicial del PRIMER registro cronol√≥gico (o 100 si falta)
    const bank0 = n(ordered[0]?.bankroll, 100);
    const data = [ bank0 ];

    for (let i=0;i<ordered.length;i++){
      const a = ordered[i];
      const st = stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac);
      const last = Number.isFinite(data[data.length-1]) ? data[data.length-1] : bank0;
      let nuevo = last;
      if (a.estado === 'ganada') nuevo = last + st * (n(a.cuotaBookie, 1) - 1);
      else if (a.estado === 'perdida') nuevo = last - st;
      // pendiente no altera bankroll
      data.push( Number.isFinite(nuevo) ? nuevo : last );
      labels.push(`Apuesta ${i+1}`);
    }
    return { labels, data };
  }

  function actualizarGraficas() {
    const arr = filtrarHistorial();

    if (graficaBankroll) { graficaBankroll.destroy(); graficaBankroll = null; }
    if (graficaKelly) { graficaKelly.destroy(); graficaKelly = null; }

    if (arr.length === 0) return;

    const { labels, data: bankData } = datosBankrollSanitizados(arr);
    const grad = crearGradiente(ctxBankroll);

    graficaBankroll = new Chart(ctxBankroll, {
      type:'line',
      data:{ 
        labels, 
        datasets:[{
          label:'Bankroll',
          // Mantener misma longitud que labels; usa NaN para huecos
          data: bankData.map(v => Number.isFinite(n(v)) ? n(v) : NaN),
          borderColor:'#8257e6',
          backgroundColor: grad,
          fill:true,
          borderWidth:2,
          tension:0.35,
          cubicInterpolationMode:'monotone',
          pointRadius:0,
          pointHoverRadius:4,
          spanGaps:true
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        parsing:false,
        interaction:{ mode:'index', intersect:false },
        plugins:{
          legend:{ labels:{ color:'#ddd', font:{ size:13, weight:'600'} } },
          tooltip:{ displayColors:false, callbacks:{ label:ctx=>`Bankroll: ${ctx.parsed.y.toFixed(2)}` } },
          decimation:{ enabled:true, algorithm:'lttb', samples:250 }
        },
        scales:{
          y:{ 
            beginAtZero:false, 
            ticks:{ 
              color:'#cfcfd6',
              // Ticks sin decimales en el eje Y
              callback: (val)=> Number(val).toLocaleString(undefined, {maximumFractionDigits:0, minimumFractionDigits:0})
            }, 
            grid:{ color:'rgba(255,255,255,0.06)'} 
          },
          x:{ 
            ticks:{ color:'#cfcfd6', autoSkip:true, maxTicksLimit:10 }, 
            grid:{ display:false } 
          }
        }
      }
    });

    // Kelly FULL (%)
    const ordered = arr.slice().sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
    const kellyData = ordered.map(a => {
      const k = n(a.kellyFull);
      return k>0 ? k*100 : 0;
    });

    graficaKelly = new Chart(ctxKelly, {
      type:'bar',
      data:{ 
        labels: labels.slice(1), 
        datasets:[{ label:'Kelly FULL (%)', data: kellyData, backgroundColor:'#ffba08', borderRadius:4 }]
      },
      options:{ 
        responsive:true, animation:false,
        scales:{ 
          y:{ beginAtZero:true, max:100, ticks:{ color:'#ddd', stepSize:20, callback:(v)=>`${v}%` }, grid:{ color:'#444' } }, 
          x:{ ticks:{ color:'#ddd' }, grid:{ color:'#444' } } 
        },
        plugins:{ legend:{ labels:{ color:'#ddd', font:{ size:14, weight:'600'} } } }
      }
    });
  }

  function actualizarVista(){ renderizarTabla(); actualizarResumen(); actualizarGraficas(); }

  /* ===================== FORM ===================== */
  form.addEventListener('submit', e=>{
    e.preventDefault();
    const fd = new FormData(form);
    try{
      const liga = String(fd.get('liga')||'').trim();
      const local = String(fd.get('local')||'').trim();
      const visita = String(fd.get('visita')||'').trim();
      const mercado = fd.get('mercado');
      const prob = n(fd.get('probabilidad'));
      const cuotaBookie = n(fd.get('cuotaBookie'));
      const bankroll = n(fd.get('bankroll'));
      const kellyFrac = n(fd.get('kellyFrac'), 0.25);

      if(!liga) throw new Error('La liga es requerida');
      if(!local) throw new Error('Equipo local es requerido');
      if(!visita) throw new Error('Equipo visitante es requerido');
      if(!mercado) throw new Error('Selecciona un mercado');
      if(!(prob>0 && prob<=100)) throw new Error('Probabilidad 0-100');
      if(!(cuotaBookie>1)) throw new Error('Cuota bookie > 1');
      if(!(bankroll>0)) throw new Error('Bankroll > 0');
      if(!(kellyFrac>0 && kellyFrac<=1)) throw new Error('Fracci√≥n Kelly inv√°lida');

      const cuotaImplicitaCalc = n(calcularCuotaImplicita(prob));
      const ev = calcularEV(prob, cuotaBookie);
      const kellyFull = calcularKelly(prob, cuotaBookie);

      const apuesta = {
        id: Date.now(),
        fecha: new Date().toISOString(),
        liga, local, visita, mercado,
        probabilidad: prob,
        cuotaImplicita: cuotaImplicitaCalc,
        cuotaBookie, ev, kellyFull,
        bankroll, kellyFrac,
        estado: 'pendiente'
      };

      historial.push(apuesta);
      guardarHistorial();
      form.reset(); cuotaImplicitaInput.value='';
      actualizarVista();
      alert('Apuesta agregada correctamente');
    }catch(err){ alert('Error: '+err.message); }
  });

  // Preview
  document.getElementById('probabilidad').addEventListener('input', e => {
    const v = n(e.target.value); cuotaImplicitaInput.value = calcularCuotaImplicita(v);
  });
  const cuotaBookieInput = document.getElementById('cuotaBookie');
  const bankrollInput = document.getElementById('bankroll');
  const kellyFracInput = document.getElementById('kellyFrac');
  const stakePreviewInput = document.getElementById('stakePreview');
  function actualizarStakePreview(){
    const prob = n(document.getElementById('probabilidad').value);
    const cuotaBookie = n(cuotaBookieInput.value);
    const bankroll = n(bankrollInput.value);
    const kellyFrac = n(kellyFracInput.value, 0.25);
    if(!(prob>0 && cuotaBookie>1 && bankroll>0 && kellyFrac>0)){ stakePreviewInput.value=""; return; }
    const kf = calcularKelly(prob,cuotaBookie); const stake = stakeSugerido(bankroll,kf,kellyFrac);
    stakePreviewInput.value = n(stake).toFixed(2);
  }
  ['input','change'].forEach(evt=>{
    document.getElementById('probabilidad').addEventListener(evt, actualizarStakePreview);
    cuotaBookieInput.addEventListener(evt, actualizarStakePreview);
    bankrollInput.addEventListener(evt, actualizarStakePreview);
    kellyFracInput.addEventListener(evt, actualizarStakePreview);
  });

  // Filtros eventos
  [filtroLiga, filtroLocal, filtroVisita, filtroMercado, filtroEstado, filtroProbMin, filtroProbMax, filtroFechaInicio, filtroFechaFin]
    .forEach(el => { el.addEventListener('input', actualizarVista); el.addEventListener('change', actualizarVista); });
  btnLimpiarFiltros.addEventListener('click', e=>{ e.preventDefault(); limpiarFiltros(); actualizarVista(); });

  // Exportar/Importar
  btnExportarCSV.addEventListener('click', ()=>{
    if(historial.length===0){ alert('No hay datos para exportar'); return; }
    const csvRows = [];
    csvRows.push(['id','fecha','liga','local','visita','mercado','probabilidad','cuotaImplicita','cuotaBookie','ev','kellyFull','bankroll','kellyFrac','estado'].join(','));
    historial.forEach(a=>{
      csvRows.push([a.id,a.fecha,`"${a.liga}"`,`"${a.local}"`,`"${a.visita}"`,`"${a.mercado}"`,n(a.probabilidad),a.cuotaImplicita,n(a.cuotaBookie),n(a.ev),n(a.kellyFull),n(a.bankroll),n(a.kellyFrac),a.estado].join(','));
    });
    const blob = new Blob([csvRows.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const link = document.createElement('a');
    link.href=url; link.download=`historial_${perfilActual}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
  });
  btnImportarJSON.addEventListener('click', ()=>inputImportJSON.click());
  inputImportJSON.addEventListener('change', e=>{
    const file = e.target.files && e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      try{
        let data = JSON.parse(ev.target.result); if(!Array.isArray(data)) data=[data];
        let count=0; data.forEach(item=>{
          if(item && typeof item==='object'){
            const normal = {
              id: item.id || Date.now()+Math.random(),
              fecha: item.fecha || new Date().toISOString(),
              liga: item.liga || 'Sin liga',
              local: item.local || '',
              visita: item.visita || '',
              mercado: item.mercado || '',
              probabilidad: n(item.probabilidad, 0),
              cuotaImplicita: (item.cuotaImplicita!==undefined && item.cuotaImplicita!=='') ? n(item.cuotaImplicita) : (n(item.probabilidad)? n((100/n(item.probabilidad)).toFixed(2)) : ''),
              cuotaBookie: n(item.cuotaBookie, 0),
              ev: Number.isFinite(item.ev) ? item.ev : calcularEV(item.probabilidad, item.cuotaBookie),
              kellyFull: Number.isFinite(item.kellyFull) ? item.kellyFull : calcularKelly(item.probabilidad, item.cuotaBookie),
              bankroll: n(item.bankroll, 100),
              kellyFrac: n(item.kellyFrac, 0.25),
              estado: item.estado || 'pendiente'
            };
            historial.push(normal); count++;
          }
        });
        guardarHistorial(); actualizarVista(); alert(`Importaci√≥n exitosa ‚úÖ Registros a√±adidos: ${count}`); inputImportJSON.value='';
      }catch(err){ console.error(err); alert('Error al importar JSON.'); }
    };
    reader.readAsText(file);
  });

  /* ====== Gesti√≥n de perfiles: UI ====== */
  btnNuevoPerfil.addEventListener('click', ()=>{
    const name = promptProfileName(); if(!name) return;
    if (perfiles.includes(name)) { alert('Ese perfil ya existe.'); return; }
    perfiles.push(name); saveProfiles();
    perfilActual = name; renderProfilesSelect();
    cargarHistorial(); actualizarVista();
    alert(`Perfil creado y seleccionado: ${name}`);
  });

  btnBorrarPerfil.addEventListener('click', ()=>{
    if (perfilActual === DEFAULT_PROFILE) { alert('El perfil "default" no puede eliminarse.'); return; }
    if (!confirm(`¬øBorrar el perfil "${perfilActual}" y todos sus datos?`)) return;
    localStorage.removeItem(getStorageKey());
    perfiles = perfiles.filter(p=>p!==perfilActual);
    perfilActual = DEFAULT_PROFILE; saveProfiles();
    renderProfilesSelect();
    cargarHistorial(); actualizarVista();
    alert('Perfil eliminado. Se ha vuelto a "default".');
  });

  selectPerfil.addEventListener('change', ()=>{
    guardarHistorial(); // guarda el actual por si acaso
    perfilActual = selectPerfil.value;
    cargarHistorial(); actualizarVista();
  });

  // Redibuja si cambia tama√±o
  let resizeTimer = null;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => { actualizarGraficas(); }, 120);
  });

  // ====== Init ======
  function init(){
    loadProfiles();
    perfilActual = perfiles[0] || DEFAULT_PROFILE;
    renderProfilesSelect();

    const migrated = migrateFromOldKeyIfNeeded();

    // Limpia filtros para no ocultar migrados por accidente
    limpiarFiltros();

    cargarHistorial();
    if (migrated && perfilActual !== DEFAULT_PROFILE) {
      perfilActual = DEFAULT_PROFILE;
      renderProfilesSelect();
      cargarHistorial();
    }
    actualizarVista();
  }
  init();

})();
</script>
</body>
</html>
