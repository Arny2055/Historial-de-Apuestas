<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Backtesting Apuestas – Dashboard SPA</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0b0e16; --panel:#121826; --card:#171e2a; --ink:#e6e9f0;
    --muted:#a6b0c3; --brand:#7a5af8; --brand-2:#22d3ee; --ok:#22c55e; --bad:#ef4444; --warn:#fbbf24;
    --grid:#243145; --chip:#2a3447; --shadow:0 10px 24px rgba(0,0,0,.35);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
    background: radial-gradient(1200px 800px at 10% -10%, #111638 0%, transparent 60%) ,
                radial-gradient(1200px 800px at 110% 10%, #0f173a 0%, transparent 60%) ,
                var(--bg);
    color:var(--ink); line-height:1.45;
  }
  header{
    max-width:1200px; margin:24px auto 10px; padding:0 16px;
    display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap;
  }
  h1{margin:0; font-size:clamp(22px,3vw,28px); letter-spacing:.3px}
  .toolbar{margin-left:auto; display:flex; flex-wrap:wrap; gap:10px}
  .btn{
    background:var(--brand); color:#fff; border:none; border-radius:10px; padding:10px 14px;
    font-weight:700; cursor:pointer; box-shadow:var(--shadow); transition:.2s;
  }
  .btn:hover{filter:brightness(1.05)}
  .btn.secondary{background:#263348; color:var(--ink); font-weight:600}
  .btn.danger{background:var(--bad)}
  .btn.ghost{background:transparent; border:1px solid #314058; color:#cbd5e1}
  input[type="file"]{display:none}
  .pill{display:inline-flex; align-items:center; gap:8px; background:var(--chip); padding:8px 10px; border-radius:999px; font-size:.9rem; color:var(--muted)}
  .pill input{width:110px; background:transparent; border:none; color:var(--ink); font-weight:700}
  .layout{max-width:1200px; margin:0 auto; padding:0 16px 80px}
  .grid{display:grid; gap:16px}
  .panel{background:linear-gradient(180deg,#121826, #101625); border:1px solid #253049; border-radius:var(--radius); box-shadow:var(--shadow)}
  .section{padding:18px}
  .section h3{margin:0 0 12px; font-size:1.05rem; color:#cfd6e5; letter-spacing:.2px}
  .filters{display:grid; grid-template-columns:repeat(8,1fr); gap:12px}
  .field{display:flex; flex-direction:column; gap:6px}
  .field label{color:#a7b3c9; font-size:.85rem}
  .field input,.field select{
    background:#0e1422; color:var(--ink); border:1px solid #2a3850; border-radius:10px; padding:10px 12px; outline:none;
  }
  .kpis{display:grid; grid-template-columns:repeat(8,1fr); gap:12px}
  .kpi{background:linear-gradient(180deg,#141d2e,#0e1422); border:1px solid #22304a; border-radius:12px; padding:14px}
  .kpi .label{font-size:.8rem; color:#9fb0c9}
  .kpi .value{font-weight:800; font-size:1.3rem; margin-top:6px}
  .kpi.good .value{color:var(--ok)}
  .kpi.bad .value{color:var(--bad)}
  .charts{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  canvas{background:linear-gradient(180deg,#121826,#0f1524); border:1px solid #253049; border-radius:12px; padding:8px}
  .tabs{display:flex; gap:8px; padding:12px}
  .tab{background:#1a2436; border:1px solid #27324a; color:#cbd5e1; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600}
  .tab.active{background:var(--brand); color:#fff; border-color:transparent}
  .tableWrap{overflow:auto; max-height:540px; border:1px solid #253049; border-radius:12px}
  table{width:100%; border-collapse:separate; border-spacing:0}
  thead th{position:sticky; top:0; background:#152038; color:#aebbd4; text-align:left; padding:12px; font-size:.9rem; border-bottom:1px solid #253049; cursor:pointer}
  tbody td{padding:10px 12px; border-bottom:1px solid #1f2b43; white-space:nowrap}
  tbody tr:hover{background:#0e1422}
  .status-ganada{color:var(--ok); font-weight:700}
  .status-perdida{color:var(--bad); font-weight:700}
  .status-push{color:#e7e7e7; font-weight:700}
  .pager{display:flex; gap:8px; align-items:center; padding:10px 0}
  .heatmap{display:grid; gap:2px; background:#22304a; padding:6px; border-radius:10px; grid-template-columns:80px repeat(10, 1fr)}
  .heatmap .cell{background:#0f1524; padding:8px; text-align:center; font-size:.8rem; border:1px solid #22304a}
  .legend{display:flex; align-items:center; gap:8px; font-size:.85rem; color:#9fb0c9}
  .legend .box{width:18px; height:12px; border-radius:3px; border:1px solid #253049}
  .hint{color:#9fb0c9; font-size:.9rem}
  dialog{border:none; border-radius:16px; background:#0e1422; color:var(--ink); width:min(720px,92%); padding:0; box-shadow:var(--shadow)}
  dialog .dlg-head{display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid #2a3850}
  dialog .dlg-body{padding:16px 18px}
  dialog .map-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .mini{font-size:.8rem; color:#90a1bc}
  @media (max-width: 980px){
    .filters{grid-template-columns:repeat(2,1fr)}
    .kpis{grid-template-columns:repeat(2,1fr)}
    .charts{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <header>
    <div>
      <h1>Dashboard de Backtesting</h1>
      <div class="hint">Carga un JSON, mapea campos y analiza tu histórico. Todo corre en tu navegador.</div>
    </div>
    <div class="toolbar">
      <label class="btn">
        Importar JSON
        <input id="fileInput" type="file" accept=".json" />
      </label>
      <button id="btnExample" class="btn secondary" title="Cargar un dataset de ejemplo">Cargar ejemplo</button>
      <button id="btnMapping" class="btn ghost">Configurar mapeo</button>
      <button id="btnReset" class="btn danger">Reiniciar</button>
      <span class="pill">Bankroll inicial: <input id="bankrollInput" type="number" min="1" step="0.01" value="100" /></span>
      <span class="pill"><input id="chkRememberMap" type="checkbox" />Guardar mapeo</span>
    </div>
  </header>

  <main class="layout grid" style="gap:16px;">
    <!-- FILTROS -->
    <section class="panel section">
      <h3>Filtros</h3>
      <div class="filters">
        <div class="field"><label>Fecha desde</label><input type="date" id="fDesde"></div>
        <div class="field"><label>Fecha hasta</label><input type="date" id="fHasta"></div>
        <div class="field"><label>Liga</label><input type="text" id="fLiga" placeholder="Ej: Premier League"></div>
        <div class="field"><label>Equipo (local o visita)</label><input type="text" id="fEquipo" placeholder="Ej: Arsenal"></div>
        <div class="field"><label>Mercado</label><input type="text" id="fMercado" placeholder="Ej: Over 2.5"></div>
        <div class="field"><label>Bookie</label><input type="text" id="fBookie" placeholder="Ej: Pinnacle"></div>
        <div class="field">
          <label>Resultado</label>
          <select id="fResultado">
            <option value="">Todos</option>
            <option value="ganada">Ganada</option>
            <option value="perdida">Perdida</option>
            <option value="push">Push</option>
          </select>
        </div>
        <div class="field"><label>Odds mín.</label><input type="number" id="fOddMin" step="0.01" min="1"></div>
        <div class="field"><label>Odds máx.</label><input type="number" id="fOddMax" step="0.01" min="1"></div>
        <div class="field"><label>Prob. modelo mín. (%)</label><input type="number" id="fPmin" step="0.01" min="0" max="100"></div>
        <div class="field"><label>Prob. modelo máx. (%)</label><input type="number" id="fPmax" step="0.01" min="0" max="100"></div>
        <div class="field"><label>Stake mín.</label><input type="number" id="fSmin" step="0.01" min="0"></div>
        <div class="field"><label>Stake máx.</label><input type="number" id="fSmax" step="0.01" min="0"></div>
        <div class="field"><label>&nbsp;</label><button id="btnClear" class="btn secondary">Limpiar filtros</button></div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="panel section">
      <h3>KPIs</h3>
      <div class="kpis" id="kpis"></div>
    </section>

    <!-- CHARTS -->
    <section class="panel section">
      <h3>Gráficas</h3>
      <div class="charts">
        <div>
          <div class="mini" style="margin:0 0 8px 6px">Evolución de bankroll (acum.)</div>
          <canvas id="chBankroll" height="240"></canvas>
        </div>
        <div>
          <div class="mini" style="margin:0 0 8px 6px">Distribución de odds (histograma)</div>
          <canvas id="chOdds" height="240"></canvas>
        </div>
        <div>
          <div class="mini" style="margin:0 0 8px 6px">Yield/ROI por mes</div>
          <canvas id="chMonthly" height="240"></canvas>
        </div>
        <div>
          <div class="mini" style="margin:0 0 8px 6px">Comparativa por mercado (unidades)</div>
          <canvas id="chMarkets" height="240"></canvas>
        </div>
      </div>
    </section>

    <!-- HEATMAP -->
    <section class="panel section">
      <h3>Heatmap Probabilidad vs. Odds</h3>
      <div class="hint" id="heatmapHint">Se muestra si existen <b>prob_modelo</b> y <b>odd</b>.</div>
      <div id="heatmap" class="heatmap" style="margin-top:10px"></div>
      <div class="legend" style="margin-top:8px">
        <span>Menor</span><span class="box" style="background:#0b3b4e"></span>
        <span class="box" style="background:#165a72"></span>
        <span class="box" style="background:#1f7c98"></span>
        <span class="box" style="background:#2aa6c5"></span>
        <span class="box" style="background:#37d0f3"></span><span>Mayor</span>
        <span class="mini">* color = beneficio promedio por celda</span>
      </div>
    </section>

    <!-- TABS + TABLES -->
    <section class="panel">
      <div class="tabs">
        <button class="tab active" data-tab="hist">Historial</button>
        <button class="tab" data-tab="mkt">Por mercado</button>
        <button class="tab" data-tab="liga">Por liga</button>
        <button class="tab" data-tab="equipo">Por equipo</button>
        <button class="tab" data-tab="bookie">Por bookie</button>
        <button class="tab" data-tab="rank">Top/Bottom</button>
        <span style="margin-left:auto"></span>
        <button id="btnExportHist" class="btn ghost">Exportar CSV (historial filtrado)</button>
      </div>
      <div class="section" id="tabContent"></div>
    </section>

    <!-- AYUDA -->
    <section class="panel section">
      <h3>Ayuda rápida</h3>
      <div class="hint">
        <b>Yield</b> = (Ganancia neta / Total apostado) * 100. &nbsp; 
        <b>ROI</b> = (Ganancia neta / Bankroll inicial) * 100. &nbsp;
        <b>EV</b> = p * odd - 1 (si hay prob_modelo). &nbsp;
        <b>CLV</b> = ((cuota_cierre - odd)/odd) * 100 (si hay cuota_cierre).
      </div>
    </section>
  </main>

  <!-- DIALOGO MAPEO -->
  <dialog id="dlgMap">
    <div class="dlg-head">
      <strong>Mapeo de campos del JSON</strong>
      <button id="dlgClose" class="btn ghost">Cerrar</button>
    </div>
    <div class="dlg-body">
      <p class="mini">Selecciona a qué clave del JSON corresponde cada campo estándar. Los opcionales pueden quedar vacíos.</p>
      <div class="map-grid" id="mapGrid"></div>
      <div style="display:flex; gap:10px; margin-top:12px">
        <button id="saveMap" class="btn">Guardar mapeo</button>
        <button id="clearMap" class="btn danger">Limpiar mapeo</button>
      </div>
    </div>
  </dialog>

<script type="module">
/* ============================
   Estado y utilidades
============================ */
const STORAGE_MAP = 'bt_map_fields_v1';
const STORAGE_LAST = 'bt_last_dataset_v1'; // sólo si el usuario lo permite
let RAW = [];            // registros originales del JSON
let DATA = [];           // registros normalizados
let MAP = {};            // mapeo {stdField -> jsonKey}
let FILTERS = {};        // estado de filtros
let SORT = { key:null, dir:1 }; // para tablas
let CHARTS = { bankroll:null, odds:null, monthly:null, markets:null };

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const fmt = n => (isFinite(n) ? (Math.abs(n) >= 1000 ? n.toFixed(0) : n.toFixed(2)) : '-');
const pct = n => isFinite(n) ? (n>=0?'+':'') + n.toFixed(2) + '%' : '-';
const asDate = v => (v instanceof Date ? v : (v ? new Date(v) : null));

/* Debounce para filtros de texto */
const debounce = (fn,ms=250)=>{ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); } };

/* ============================
   Dataset de ejemplo
============================ */
function sampleData(){
  const leagues=['Premier League','LaLiga','Serie A','Bundesliga'];
  const mkts=['1X2','Doble Oportunidad','Over 2.5 FT','Under 2.5 FT','BTTS','Hándicap Asiático'];
  const teams=['Arsenal','Chelsea','Barcelona','Real Madrid','Juventus','Inter','Bayern','Dortmund','City','Liverpool'];
  const bookies=['BookA','BookB','BookC'];
  const arr=[];
  const start= new Date(); start.setMonth(start.getMonth()-8);
  for(let i=0;i<1200;i++){
    const d=new Date(start.getTime()+Math.random()*(Date.now()-start.getTime()));
    const local=teams[Math.floor(Math.random()*teams.length)];
    let visita=teams[Math.floor(Math.random()*teams.length)];
    if(visita===local) visita=teams[(teams.indexOf(local)+1)%teams.length];
    const odd= +(1.4 + Math.random()*3.2).toFixed(2);
    const stake = +(0.5 + Math.random()*2.5).toFixed(2);
    const resRand=Math.random();
    const resultado = resRand<0.5?'ganada':(resRand<0.93?'perdida':'push');
    const prob_modelo = Math.random()<0.7 ? +(40+Math.random()*40).toFixed(2) : null;
    const cuota_cierre = Math.random()<0.55 ? +(odd*(0.9+Math.random()*0.2)).toFixed(2) : null;
    const mercado = mkts[Math.floor(Math.random()*mkts.length)];
    arr.push({
      fecha: d.toISOString().slice(0,10),
      liga: leagues[Math.floor(Math.random()*leagues.length)],
      local, visita, mercado,
      odd, stake, resultado,
      bookie: bookies[Math.floor(Math.random()*bookies.length)],
      prob_modelo, cuota_cierre
    });
  }
  return arr;
}

/* ============================
   Mapeo de campos (modo genérico)
============================ */
const FIELDS = [
  ['fecha', true], ['liga', true], ['local', true], ['visita', true], ['mercado', true],
  ['odd', true], ['stake', true], ['resultado', true],
  ['cuota_cierre', false], ['prob_modelo', false], ['bookie', false]
];

function openMapping(keys){
  const dlg = $('#dlgMap');
  const grid = $('#mapGrid');
  grid.innerHTML='';
  FIELDS.forEach(([f,req])=>{
    const wrap=document.createElement('div'); wrap.className='field';
    const label=document.createElement('label'); label.textContent = f + (req?' *':' (opcional)');
    const sel=document.createElement('select'); sel.dataset.field=f;
    const NONE = document.createElement('option'); NONE.value=''; NONE.textContent='— sin asignar —';
    sel.appendChild(NONE);
    keys.forEach(k=>{
      const opt=document.createElement('option'); opt.value=k; opt.textContent=k;
      if(MAP[f]===k) opt.selected=true;
      sel.appendChild(opt);
    });
    wrap.append(label, sel); grid.append(wrap);
  });
  dlg.showModal();
}

function saveMappingFromDialog(){
  const sels = $$('#mapGrid select');
  const m={};
  for(const s of sels){ const f=s.dataset.field; const v=s.value.trim(); if(v) m[f]=v; }
  // validar requeridos
  for(const [f,req] of FIELDS){ if(req && !m[f]){ alert('Falta mapear: '+f); return; } }
  MAP = m;
  if($('#chkRememberMap').checked) localStorage.setItem(STORAGE_MAP, JSON.stringify(MAP));
  $('#dlgMap').close();
  if(RAW.length) { normalizeGeneric(); refreshAll(); }
}

function clearMapping(){
  MAP={};
  localStorage.removeItem(STORAGE_MAP);
  $('#mapGrid select').forEach(s=>s.value='');
}

/* ============================
   Normalización (modo genérico)
============================ */
function normalizeGeneric(){
  DATA = RAW.map((r,i)=>{
    const get = f => MAP[f] ? r[MAP[f]] : null;
    const fecha = asDate(get('fecha'));
    const o = Number(get('odd'));
    const stake = Number(get('stake'));
    const res = (get('resultado')||'').toString().toLowerCase(); // ganada|perdida|push
    const benefit = res==='ganada' ? (o-1)*stake : (res==='perdida' ? -stake : 0);
    const liga = (get('liga')||'').toString();
    const local = (get('local')||'').toString();
    const visita = (get('visita')||'').toString();
    const mercado = (get('mercado')||'').toString();
    const bookie = (get('bookie')||'').toString();
    const prob_modelo = get('prob_modelo')!=null && get('prob_modelo')!=='' ? Number(get('prob_modelo')) : null;
    const cuota_cierre = get('cuota_cierre')!=null && get('cuota_cierre')!=='' ? Number(get('cuota_cierre')) : null;
    const y = fecha ? fecha.getFullYear() : null;
    const m = fecha ? String(fecha.getMonth()+1).padStart(2,'0') : null;
    return {
      _i:i,
      fecha, fechaStr: fecha? fecha.toISOString().slice(0,10) : '',
      liga, local, visita, equipoKey:`${local}|${visita}`,
      mercado, odd:o, stake, resultado:res, bookie,
      prob_modelo, cuota_cierre,
      beneficio: benefit,
      monthKey: (y && m) ? `${y}-${m}` : 'N/A'
    };
  }).filter(x=>x.fecha && x.odd>0 && x.stake>=0 && x.resultado);
}

/* ===================================================
   ESQUEMA ESPECIAL: Desired Outcome / Match / Result FT
=================================================== */

// Detecta si el JSON tiene el esquema pedido
function detectDesiredOutcomeSchema(rec){
  if(!rec || typeof rec!=='object') return false;
  const keys = Object.keys(rec);
  return keys.includes('Desired Outcome') && keys.includes('Match') && (keys.includes('Result FT') || keys.includes('Result'));
}

// Parsear fecha estilo "dom., 20 ago. 2023 18:30"
function parseSpanishDate(str){
  if(!str || typeof str!=='string') return null;
  let s = str.trim().toLowerCase()
    .replace(/^lun\.?,\s*|^mar\.?,\s*|^mié\.?,\s*|^jue\.?,\s*|^vie\.?,\s*|^sáb\.?,\s*|^dom\.?,\s*/,'')
    .replace(/\./g,'');
  const meses = { ene:'01', feb:'02', mar:'03', abr:'04', may:'05', jun:'06',
                  jul:'07', ago:'08', sep:'09', oct:'10', nov:'11', dic:'12' };
  const m = s.match(/(\d{1,2})\s+([a-z]{3})\s+(\d{4})\s+(\d{1,2}):(\d{2})/i);
  if(!m) return new Date(str);
  const dd = m[1].padStart(2,'0');
  const mm = meses[m[2]] || '01';
  const yyyy = m[3];
  const hh = m[4].padStart(2,'0');
  const mi = m[5];
  return new Date(`${yyyy}-${mm}-${dd}T${hh}:${mi}:00`);
}

// Separar "Match": "Chicago Fire - Orlando City"
function splitMatch(str){
  if(!str) return {local:'', visita:''};
  const parts = str.split(' - ');
  return { local: (parts[0]||'').trim(), visita:(parts[1]||'').trim() };
}

// Traducir Desired Outcome a mercado estándar + selector de 1X2
function mapDesiredOutcome(code){
  if(!code) return { mercado:'', oneXTwo:null };
  const c = code.toString().toUpperCase().trim();
  if(['1','H'].includes(c)) return { mercado:'1X2', oneXTwo:'1' };
  if(['X','D'].includes(c)) return { mercado:'1X2', oneXTwo:'X' };
  if(['2','A'].includes(c)) return { mercado:'1X2', oneXTwo:'2' };
  const overUnderMap = {
    'O05':'Over 0.5 FT','O15':'Over 1.5 FT','O25':'Over 2.5 FT','O35':'Over 3.5 FT','O45':'Over 4.5 FT',
    'U05':'Under 0.5 FT','U15':'Under 1.5 FT','U25':'Under 2.5 FT','U35':'Under 3.5 FT','U45':'Under 4.5 FT'
  };
  if(overUnderMap[c]) return { mercado: overUnderMap[c], oneXTwo:null };
  if(c==='BTTS' || c==='GG') return { mercado:'BTTS', oneXTwo:null };
  if(c==='BTTS NO' || c==='NG') return { mercado:'BTTS NO', oneXTwo:null };
  if(c==='1X') return { mercado:'Doble Oportunidad 1X', oneXTwo:null };
  if(c==='12') return { mercado:'Doble Oportunidad 12', oneXTwo:null };
  if(c==='X2') return { mercado:'Doble Oportunidad X2', oneXTwo:null };
  return { mercado: code, oneXTwo:null };
}

// Parsear marcador "1-3"
function parseScore(str){
  const m = (str||'').toString().trim().match(/(-?\d+)\s*[-:]\s*(-?\d+)/);
  if(!m) return null;
  return [parseInt(m[1],10), parseInt(m[2],10)];
}

// Calcular resultado por mercado + marcador FT
function resolveBet(mercado, oneXTwoPick, scoreFT){
  if(!scoreFT) return null;
  const [h,a] = scoreFT;
  const total = h + a;
  if(mercado==='1X2' && oneXTwoPick){
    const res = h>a ? '1' : (h<a ? '2' : 'X');
    return (res===oneXTwoPick) ? 'ganada' : 'perdida';
  }
  if(mercado.startsWith('Over ')){
    const m = mercado.match(/Over\s+([\d.]+)/i);
    const line = m ? parseFloat(m[1]) : NaN;
    if(!isFinite(line)) return null;
    return total>line ? 'ganada' : 'perdida';
  }
  if(mercado.startsWith('Under ')){
    const m = mercado.match(/Under\s+([\d.]+)/i);
    const line = m ? parseFloat(m[1]) : NaN;
    if(!isFinite(line)) return null;
    return total<line ? 'ganada' : 'perdida';
  }
  if(mercado==='BTTS')  return (h>0 && a>0) ? 'ganada' : 'perdida';
  if(mercado==='BTTS NO')return (h>0 && a>0) ? 'perdida' : 'ganada';
  if(mercado==='Doble Oportunidad 1X'){ return (h>=a) ? 'ganada' : 'perdida'; }
  if(mercado==='Doble Oportunidad 12'){ return (h!==a) ? 'ganada' : 'perdida'; }
  if(mercado==='Doble Oportunidad X2'){ return (h<=a) ? 'ganada' : 'perdida'; }
  return null;
}

// Elegir cuota correcta
function pickOddForRecord(rec, mercado, oneXTwoPick){
  if(mercado==='1X2' && oneXTwoPick){
    const m = {
      '1': Number(rec['Odd 1 PreMatch']),
      'X': Number(rec['Odd X PreMatch']),
      '2': Number(rec['Odd 2 PreMatch'])
    };
    if(isFinite(m[oneXTwoPick]) && m[oneXTwoPick]>0) return m[oneXTwoPick];
  }
  const o = Number(rec['Odd']);
  return isFinite(o) && o>0 ? o : NaN;
}

// Normalizar texto "Result"
function normalizeResultText(s){
  if(!s) return null;
  const v = s.toString().toLowerCase().trim();
  if(['win','winning','ganada','won'].includes(v)) return 'ganada';
  if(['lose','lost','perdida','loss'].includes(v)) return 'perdida';
  if(['void','push','anulada','nula'].includes(v)) return 'push';
  return null;
}

// Normalización específica para este esquema (stake=1)
function normalizeDesiredOutcomeSchema(){
  DATA = RAW.map((r,i)=>{
    const fecha = parseSpanishDate(r['Date']);
    const { local, visita } = splitMatch(r['Match']);
    const { mercado, oneXTwo } = mapDesiredOutcome(r['Desired Outcome']);
    const scoreFT = parseScore(r['Result FT']);
    const odd = pickOddForRecord(r, mercado, oneXTwo);
    const stake = 1; // fijo
    let resultado = resolveBet(mercado, oneXTwo, scoreFT);
    if(!resultado){
      const fromText = normalizeResultText(r['Result']);
      if(fromText) resultado = fromText;
    }
    let beneficio = 0;
    if(isFinite(odd) && odd>0){
      if(resultado==='ganada') beneficio = (odd-1)*stake;
      else if(resultado==='perdida') beneficio = -stake;
    }
    const liga = r['League'] || '';
    const bookie = r['Bookie'] || ''; // si no existe, queda vacío
    const prob_modelo = null;
    const cuota_cierre = null;
    const monthKey = fecha ? `${fecha.getFullYear()}-${String(fecha.getMonth()+1).padStart(2,'0')}` : 'N/A';
    return {
      _i:i,
      fecha, fechaStr: fecha? fecha.toISOString().slice(0,10) : '',
      liga, local, visita, equipoKey:`${local}|${visita}`,
      mercado: mercado || (r['Desired Outcome']||''),
      odd: isFinite(odd)? odd : 0,
      stake,
      resultado: resultado || 'push',
      bookie, prob_modelo, cuota_cierre,
      beneficio, monthKey
    };
  }).filter(x=> x.fecha && x.odd>0 && x.stake>=0 && x.resultado);
}

/* ============================
   Filtros
============================ */
function readFilters(){
  FILTERS = {
    desde: $('#fDesde').value ? new Date($('#fDesde').value) : null,
    hasta: $('#fHasta').value ? new Date($('#fHasta').value+'T23:59:59') : null,
    liga: $('#fLiga').value.trim().toLowerCase(),
    equipo: $('#fEquipo').value.trim().toLowerCase(),
    mercado: $('#fMercado').value.trim().toLowerCase(),
    bookie: $('#fBookie').value.trim().toLowerCase(),
    resultado: $('#fResultado').value,
    oddMin: parseFloat($('#fOddMin').value)||null,
    oddMax: parseFloat($('#fOddMax').value)||null,
    pMin: parseFloat($('#fPmin').value)||null,
    pMax: parseFloat($('#fPmax').value)||null,
    sMin: parseFloat($('#fSmin').value)||null,
    sMax: parseFloat($('#fSmax').value)||null,
  };
}
function applyFilters(list=DATA){
  readFilters();
  return list.filter(r=>{
    if(FILTERS.desde && r.fecha < FILTERS.desde) return false;
    if(FILTERS.hasta && r.fecha > FILTERS.hasta) return false;
    if(FILTERS.liga && !r.liga.toLowerCase().includes(FILTERS.liga)) return false;
    if(FILTERS.equipo && !(r.local.toLowerCase().includes(FILTERS.equipo)||r.visita.toLowerCase().includes(FILTERS.equipo))) return false;
    if(FILTERS.mercado && !r.mercado.toLowerCase().includes(FILTERS.mercado)) return false;
    if(FILTERS.bookie && !r.bookie.toLowerCase().includes(FILTERS.bookie)) return false;
    if(FILTERS.resultado && r.resultado!==FILTERS.resultado) return false;
    if(FILTERS.oddMin!=null && r.odd < FILTERS.oddMin) return false;
    if(FILTERS.oddMax!=null && r.odd > FILTERS.oddMax) return false;
    if(FILTERS.pMin!=null && (r.prob_modelo==null || r.prob_modelo < FILTERS.pMin)) return false;
    if(FILTERS.pMax!=null && (r.prob_modelo==null || r.prob_modelo > FILTERS.pMax)) return false;
    if(FILTERS.sMin!=null && r.stake < FILTERS.sMin) return false;
    if(FILTERS.sMax!=null && r.stake > FILTERS.sMax) return false;
    return true;
  });
}

/* ============================
   Métricas y agregados
============================ */
function sum(arr,fn){ let t=0; for(const x of arr) t+=fn(x)||0; return t; }
function mean(arr,fn){ const vals=arr.map(fn).filter(v=>v!=null && isFinite(v)); return vals.length? (sum(vals,v=>v)/vals.length) : null; }

function computeKPIs(rows){
  const bankrollIni = parseFloat($('#bankrollInput').value)||0;
  const n = rows.length;
  const resolves = rows.filter(r=>r.resultado==='ganada'||r.resultado==='perdida');
  const ganadas = rows.filter(r=>r.resultado==='ganada').length;
  const perdidas = rows.filter(r=>r.resultado==='perdida').length;
  const push = rows.filter(r=>r.resultado==='push').length;
  const apostado = sum(rows, r=>r.stake);
  const neto = sum(rows, r=>r.beneficio);
  const tasaExito = resolves.length ? (ganadas / resolves.length)*100 : 0;
  const yieldPct = apostado>0 ? (neto/apostado)*100 : 0;
  const roiPct = bankrollIni>0 ? (neto/bankrollIni)*100 : 0;
  const evMedio = mean(rows, r => (r.prob_modelo!=null ? (r.prob_modelo/100)*r.odd - 1 : null));
  const clvMedio = mean(rows, r => (r.cuota_cierre!=null ? ((r.cuota_cierre-r.odd)/r.odd)*100 : null));
  const clvPosPct = (()=>{
    const vals=rows.filter(r=>r.cuota_cierre!=null);
    if(!vals.length) return null;
    const pos=vals.filter(r=> (r.cuota_cierre-r.odd) > 0 ).length;
    return (pos/vals.length)*100;
  })();
  const stakeMedio = n? apostado/n : 0;
  return { n, ganadas, perdidas, push, apostado, neto, tasaExito, yieldPct, roiPct, evMedio, clvMedio, clvPosPct, stakeMedio };
}
function groupBy(rows, keyFn){
  const m=new Map();
  for(const r of rows){ const k=keyFn(r); if(!m.has(k)) m.set(k, []); m.get(k).push(r); }
  return m;
}
function aggregateRows(rows){
  const k = computeKPIs(rows);
  return { n:k.n, acierto:k.tasaExito, yield:k.yieldPct, roi:k.roiPct, profit:k.neto, apostado:k.apostado,
           oddMedio: mean(rows, r=>r.odd) ?? 0, stakeMedio:k.stakeMedio };
}

/* ============================
   Render KPIs
============================ */
function renderKPIs(rows){
  const k = computeKPIs(rows);
  const el = $('#kpis');
  el.innerHTML = `
    ${kpi('Apuestas', k.n)}
    ${kpi('Ganadas', k.ganadas, 'good')}
    ${kpi('Perdidas', k.perdidas, 'bad')}
    ${kpi('Push', k.push)}
    ${kpi('Apostado', fmt(k.apostado))}
    ${kpi('Unidades netas', fmt(k.neto), k.neto>=0?'good':'bad')}
    ${kpi('Yield', pct(k.yieldPct), k.yieldPct>=0?'good':'bad')}
    ${kpi('ROI', pct(k.roiPct), k.roiPct>=0?'good':'bad')}
    ${kpi('Acierto', pct(k.tasaExito))}
    ${kpi('EV medio', k.evMedio!=null ? fmt(k.evMedio) : '—')}
    ${kpi('CLV medio', k.clvMedio!=null ? pct(k.clvMedio) : '—')}
    ${kpi('% CLV > 0', k.clvPosPct!=null ? pct(k.clvPosPct) : '—')}
    ${kpi('Stake medio', fmt(k.stakeMedio))}
  `;
  function kpi(label, value, mood){ return `<div class="kpi ${mood||''}"><div class="label">${label}</div><div class="value">${value}</div></div>`; }
}

/* ============================
   Gráficas (Chart.js)
============================ */
function destroyCharts(){ Object.keys(CHARTS).forEach(k=>{ if(CHARTS[k]){ CHARTS[k].destroy(); CHARTS[k]=null; } }); }
function chartBankroll(rows){
  const bankrollIni = parseFloat($('#bankrollInput').value)||0;
  const sorted = [...rows].sort((a,b)=> a.fecha - b.fecha);
  const labels=['Inicio']; const series=[bankrollIni]; let acc=bankrollIni;
  for(const r of sorted){ acc += r.beneficio; series.push(acc); labels.push(r.fechaStr); }
  const ctx = $('#chBankroll').getContext('2d');
  CHARTS.bankroll = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ label:'Bankroll', data:series, borderWidth:2, fill:true }] },
                                     options:{ responsive:true, scales:{ y:{ beginAtZero:false } } }});
}
function chartOddsHist(rows){
  if(!rows.length){ return; }
  const odds = rows.map(r=>r.odd).filter(x=>isFinite(x));
  const min = Math.min(...odds), max = Math.max(...odds);
  const bins = 14; const step = (max-min)/bins || 1;
  const edges = Array.from({length:bins},(_,i)=> min + i*step);
  const counts = Array(bins).fill(0);
  odds.forEach(v=>{ let idx = Math.min(Math.floor((v-min)/step), bins-1); counts[idx]++; });
  const labels = edges.map((e,i)=> `${(e).toFixed(2)}–${(e+step).toFixed(2)}`);
  const ctx = $('#chOdds').getContext('2d');
  CHARTS.odds = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Frecuencia', data:counts }] },
                                 options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }});
}
function chartMonthly(rows){
  const g = groupBy(rows, r=>r.monthKey);
  const labels = [...g.keys()].sort();
  const yieldData = labels.map(k=> aggregateRows(g.get(k)).yield );
  const roiData   = labels.map(k=> aggregateRows(g.get(k)).roi );
  const ctx = $('#chMonthly').getContext('2d');
  CHARTS.monthly = new Chart(ctx, { type:'bar', data:{ labels, datasets:[ { label:'Yield %', data:yieldData }, { label:'ROI %', data:roiData } ] },
                                    options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }});
}
function chartMarkets(rows){
  const g = groupBy(rows, r=>r.mercado || 'N/A');
  const labels = [...g.keys()].sort();
  const profits = labels.map(k=> aggregateRows(g.get(k)).profit );
  const ctx = $('#chMarkets').getContext('2d');
  CHARTS.markets = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Unidades', data:profits }] },
                                    options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }});
}

/* ============================
   Heatmap (HTML/CSS)
============================ */
function renderHeatmap(rows){
  const box = $('#heatmap');
  const haveP = rows.some(r=>r.prob_modelo!=null);
  $('#heatmapHint').style.display = haveP ? 'none' : 'block';
  box.innerHTML='';
  if(!rows.length || !haveP){ return; }
  const pBins = Array.from({length:10},(_,i)=> [i*10, (i+1)*10]);
  const odds = rows.map(r=>r.odd);
  const oMin = Math.floor(Math.min(...odds)*10)/10;
  const oMax = Math.ceil(Math.max(...odds)*10)/10;
  const oStep = Math.max(0.2, ((oMax-oMin)/10) || 0.2);
  const oBins = Array.from({length:10},(_,i)=> [+(oMin + i*oStep).toFixed(2), +(oMin+(i+1)*oStep).toFixed(2)]);
  box.append(cell('Prob\\Odds','cell'));
  oBins.forEach(ob=> box.append(cell(`${ob[0]}–${ob[1]}`,'cell')));
  pBins.forEach(pb=>{
    box.append(cell(`${pb[0]}–${pb[1]}%`,'cell'));
    oBins.forEach(ob=>{
      const members = rows.filter(r=>{
        const p=r.prob_modelo; return p!=null && p>=pb[0] && p<=pb[1] && r.odd>=ob[0] && r.odd<=ob[1];
      });
      const profMed = mean(members, r=>r.beneficio);
      const n=members.length;
      const color = scaleColor(profMed||0);
      const el = cell(n? `${fmt(profMed)} (${n})` : '—', 'cell');
      el.style.background = color; el.title = `Beneficio medio: ${fmt(profMed||0)} | n=${n}`;
      box.append(el);
    });
  });
  function cell(text, cls){ const d=document.createElement('div'); d.className=cls; d.textContent=text; return d; }
  function scaleColor(v){
    const capped = Math.max(-1, Math.min(1, v));
    const t = (capped + 1)/2;
    const a=[11,59,78], b=[55,208,243];
    const c=[Math.round(a[0]+(b[0]-a[0])*t), Math.round(a[1]+(b[1]-a[1])*t), Math.round(a[2]+(b[2]-a[2])*t)];
    return `rgb(${c[0]},${c[1]},${c[2]})`;
  }
}

/* ============================
   Tablas (historial + agregados)
============================ */
function renderTables(rows){
  const container = $('#tabContent');
  const active = $('.tab.active')?.dataset.tab || 'hist';
  if(active==='hist'){ renderHistory(container, rows); }
  else if(active==='mkt'){ renderAgg(container, rows, r=>r.mercado || 'N/A', 'Mercado'); }
  else if(active==='liga'){ renderAgg(container, rows, r=>r.liga || 'N/A', 'Liga'); }
  else if(active==='equipo'){ renderAgg(container, rows, r=>r.local || r.visita, 'Equipo (local)'); }
  else if(active==='bookie'){ renderAgg(container, rows, r=>r.bookie || 'N/A', 'Bookie'); }
  else if(active==='rank'){ renderRank(container, rows); }
}
function renderHistory(container, rows){
  const pageSize = 25;
  let page = 1;
  const totalPages = Math.max(1, Math.ceil(rows.length/pageSize));
  const shell = html(`
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
      <div class="mini">Historial (${rows.length} filas)</div>
      <div class="pager">
        <button class="btn ghost" data-act="prev">◀</button>
        <span class="mini"><b class="pNow">1</b> / <b class="pMax">${totalPages}</b></span>
        <button class="btn ghost" data-act="next">▶</button>
      </div>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            ${th('Fecha','fecha')}
            ${th('Liga','liga')}
            ${th('Local','local')}
            ${th('Visita','visita')}
            ${th('Mercado','mercado')}
            ${th('Odd','odd')}
            ${th('Stake','stake')}
            ${th('Resultado','resultado')}
            ${th('Beneficio','beneficio')}
            ${th('EV','ev')}
            ${th('Bookie','bookie')}
            ${th('Prob. modelo','prob_modelo')}
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  `);
  container.innerHTML=''; container.append(shell);
  shell.querySelector('[data-act="prev"]').addEventListener('click', ()=>{ page=Math.max(1,page-1); draw(); });
  shell.querySelector('[data-act="next"]').addEventListener('click', ()=>{ page=Math.min(totalPages,page+1); draw(); });
  shell.querySelectorAll('th[data-key]').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k=th.dataset.key;
      if(SORT.key===k) SORT.dir*=-1; else { SORT.key=k; SORT.dir=1; }
      draw(true);
    });
  });
  function draw(resetPage=false){
    if(resetPage) page=1;
    const tBody = shell.querySelector('tbody');
    tBody.innerHTML='';
    let list = [...rows];
    if(SORT.key){
      list.sort((a,b)=>{
        const va = getVal(a, SORT.key), vb = getVal(b, SORT.key);
        if(va<vb) return -1*SORT.dir;
        if(va>vb) return 1*SORT.dir;
        return 0;
      });
    } else {
      list.sort((a,b)=> a.fecha - b.fecha);
    }
    const slice = list.slice((page-1)*pageSize, page*pageSize);
    shell.querySelector('.pNow').textContent = String(page);
    for(const r of slice){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${r.fechaStr}</td>
        <td>${esc(r.liga)}</td>
        <td>${esc(r.local)}</td>
        <td>${esc(r.visita)}</td>
        <td>${esc(r.mercado)}</td>
        <td>${fmt(r.odd)}</td>
        <td>${fmt(r.stake)}</td>
        <td class="status-${r.resultado}">${r.resultado}</td>
        <td style="color:${r.beneficio>=0?'#22c55e':'#ef4444'}">${fmt(r.beneficio)}</td>
        <td>${r.prob_modelo!=null ? fmt((r.prob_modelo/100)*r.odd - 1) : '—'}</td>
        <td>${esc(r.bookie||'')}</td>
        <td>${r.prob_modelo!=null ? r.prob_modelo.toFixed(2)+'%' : '—'}</td>
      `;
      tBody.append(tr);
    }
  }
  function th(label,key){ return `<th data-key="${key}">${label}</th>`; }
  function getVal(r,k){ return (k==='ev') ? ((r.prob_modelo!=null)? (r.prob_modelo/100)*r.odd - 1 : -Infinity) : (r[k]??''); }
  draw();
}
function renderAgg(container, rows, keyFn, label){
  const g = groupBy(rows, keyFn);
  const items = [...g.entries()].map(([k,list])=>{
    const a = aggregateRows(list);
    return { key:k, ...a };
  }).sort((a,b)=> b.profit - a.profit);
  const table = html(`
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
      <div class="mini">Agregados (${items.length}) por <b>${label}</b></div>
      <button class="btn ghost" id="btnExportAgg">Exportar CSV</button>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>${label}</th><th>Apuestas</th><th>Acierto %</th><th>Yield %</th><th>ROI %</th><th>Unidades</th><th>Apostado</th><th>Odd media</th><th>Stake medio</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  `);
  container.innerHTML=''; container.append(table);
  const tb = table.querySelector('tbody');
  for(const it of items){
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(it.key)}</td>
      <td>${it.n}</td>
      <td>${fmt(it.acierto)}</td>
      <td style="color:${it.yield>=0?'#22c55e':'#ef4444'}">${fmt(it.yield)}</td>
      <td style="color:${it.roi>=0?'#22c55e':'#ef4444'}">${fmt(it.roi)}</td>
      <td style="color:${it.profit>=0?'#22c55e':'#ef4444'}">${fmt(it.profit)}</td>
      <td>${fmt(it.apostado)}</td>
      <td>${fmt(it.oddMedio)}</td>
      <td>${fmt(it.stakeMedio)}</td>
    `;
    tb.append(tr);
  }
  table.querySelector('#btnExportAgg').addEventListener('click', ()=>{
    const rowsCsv = [
      [label,'Apuestas','Acierto %','Yield %','ROI %','Unidades','Apostado','Odd media','Stake medio'].join(',')
    ];
    items.forEach(it=>{
      rowsCsv.push([it.key,it.n, it.acierto, it.yield, it.roi, it.profit, it.apostado, it.oddMedio, it.stakeMedio].join(','));
    });
    downloadCSV(rowsCsv.join('\n'), `agregados_${label}.csv`);
  });
}
function renderRank(container, rows){
  const g = groupBy(rows, r=>r.local);
  const items = [...g.entries()].map(([k,list])=>{
    const a = aggregateRows(list);
    return { equipo:k, ...a };
  }).filter(it=>it.equipo && it.n>=1);
  const N = 10;
  const top = [...items].sort((a,b)=> b.profit - a.profit).slice(0,N);
  const bottom = [...items].sort((a,b)=> a.profit - b.profit).slice(0,N);
  const table = html(`
    <div class="grid" style="grid-template-columns:1fr 1fr; gap:16px">
      <div>
        <h3 style="margin:0 0 8px">Top ${N} equipos</h3>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Equipo</th><th>Apuestas</th><th>Unidades</th><th>Yield %</th><th>Acierto %</th></tr></thead>
            <tbody id="topBody"></tbody>
          </table>
        </div>
      </div>
      <div>
        <h3 style="margin:0 0 8px">Bottom ${N} equipos</h3>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Equipo</th><th>Apuestas</th><th>Unidades</th><th>Yield %</th><th>Acierto %</th></tr></thead>
            <tbody id="botBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  `);
  container.innerHTML=''; container.append(table);
  const fill = (tbody,list)=>{
    for(const it of list){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${esc(it.equipo)}</td><td>${it.n}</td>
      <td style="color:${it.profit>=0?'#22c55e':'#ef4444'}">${fmt(it.profit)}</td>
      <td>${fmt(it.yield)}</td><td>${fmt(it.acierto)}</td>`;
      tbody.append(tr);
    }
  };
  fill(table.querySelector('#topBody'), top);
  fill(table.querySelector('#botBody'), bottom);
}

/* ============================
   Export CSV
============================ */
function downloadCSV(text, name='export.csv'){
  const blob=new Blob([text],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove();
}

/* ============================
   Render raiz
============================ */
function refreshAll(){
  const rows = applyFilters(DATA);
  renderKPIs(rows);
  destroyCharts();
  chartBankroll(rows);
  chartOddsHist(rows);
  chartMonthly(rows);
  chartMarkets(rows);
  renderHeatmap(rows);
  renderTables(rows);
}

/* ============================
   Helpers UI
============================ */
function esc(s){ return (s??'').toString().replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }
function html(s){ const d=document.createElement('div'); d.innerHTML=s.trim(); return d.firstElementChild; }

/* ============================
   Eventos globales
============================ */
$('#btnClear').addEventListener('click', ()=>{
  ['fDesde','fHasta','fLiga','fEquipo','fMercado','fBookie','fResultado','fOddMin','fOddMax','fPmin','fPmax','fSmin','fSmax'].forEach(id=> $('#'+id).value='');
  refreshAll();
});
['#fLiga','#fEquipo','#fMercado','#fBookie'].forEach(sel=>{
  $(sel).addEventListener('input', debounce(()=>refreshAll(), 250));
});
['#fDesde','#fHasta','#fResultado','#fOddMin','#fOddMax','#fPmin','#fPmax','#fSmin','#fSmax'].forEach(sel=>{
  $(sel).addEventListener('input', ()=>refreshAll());
});
$('#bankrollInput').addEventListener('input', ()=>refreshAll());

$('.tabs').addEventListener('click', e=>{
  const btn = e.target.closest('.tab'); if(!btn) return;
  $$('.tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
  renderTables(applyFilters(DATA));
});

$('#btnExportHist').addEventListener('click', ()=>{
  const rows = applyFilters(DATA);
  const head = ['fecha','liga','local','visita','mercado','odd','stake','resultado','beneficio','bookie','prob_modelo','cuota_cierre'];
  const csv = [head.join(',')];
  rows.forEach(r=>{
    csv.push([r.fechaStr, `"${r.liga}"`, `"${r.local}"`, `"${r.visita}"`, `"${r.mercado}"`,
      r.odd, r.stake, r.resultado, r.beneficio, `"${r.bookie}"`, r.prob_modelo??'', r.cuota_cierre??''].join(','));
  });
  downloadCSV(csv.join('\n'), 'historial_filtrado.csv');
});

/* Mapping dialog */
$('#btnMapping').addEventListener('click', ()=>{
  const keys = RAW.length ? Object.keys(RAW[0]) : ['fecha','liga','local','visita','mercado','odd','stake','resultado','bookie','prob_modelo','cuota_cierre'];
  openMapping(keys);
});
$('#saveMap').addEventListener('click', saveMappingFromDialog);
$('#clearMap').addEventListener('click', clearMapping);
$('#dlgClose').addEventListener('click', ()=> $('#dlgMap').close());

/* Reset */
$('#btnReset').addEventListener('click', ()=>{
  if(!confirm('¿Reiniciar dashboard? Se borrará mapeo guardado y datos en memoria.')) return;
  RAW=[]; DATA=[]; MAP={}; FILTERS={}; SORT={key:null,dir:1};
  destroyCharts();
  localStorage.removeItem(STORAGE_MAP);
  localStorage.removeItem(STORAGE_LAST);
  location.reload();
});

/* Cargar ejemplo */
$('#btnExample').addEventListener('click', async ()=>{
  RAW = sampleData();
  MAP = Object.fromEntries(FIELDS.map(([f,req])=> [f,f])); // autogenerar mapeo
  normalizeGeneric();
  refreshAll();
});

/* Import JSON con detección del esquema especial */
$('#fileInput').addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  try{
    const txt = await file.text();
    const json = JSON.parse(txt);
    if(!Array.isArray(json)){ alert('El archivo debe contener un array JSON de registros'); return; }
    RAW = json;
    if($('#chkRememberMap').checked){ localStorage.setItem(STORAGE_LAST, txt); }

    // 1) Esquema "Desired Outcome / Match / Result FT" con stake=1
    if(RAW.length && detectDesiredOutcomeSchema(RAW[0])){
      normalizeDesiredOutcomeSchema();
      MAP = {}; // evitamos confusión visual
      refreshAll();
      alert('Archivo importado con el esquema “Desired Outcome/Match/Result FT”. Stake=1 aplicado.');
      return;
    }

    // 2) Si no es el esquema especial, usar mapeo genérico
    const saved = localStorage.getItem(STORAGE_MAP);
    if(saved){
      MAP = JSON.parse(saved);
      const keys = Object.keys(RAW[0]||{});
      const ok = Object.values(MAP).every(k=>!k || keys.includes(k));
      if(!ok){ openMapping(keys); return; }
      normalizeGeneric();
      refreshAll();
    } else {
      openMapping(Object.keys(RAW[0]||{}));
    }
  }catch(err){
    console.error(err);
    alert('No se pudo leer el JSON: ' + err.message);
  } finally {
    e.target.value='';
  }
});

/* Restaurar si había guardado (opcional) */
(function init(){
  try{
    const m = localStorage.getItem(STORAGE_MAP);
    if(m){ MAP = JSON.parse(m); $('#chkRememberMap').checked = true; }
    const last = localStorage.getItem(STORAGE_LAST);
    if(last){
      RAW = JSON.parse(last);
      if(RAW.length && detectDesiredOutcomeSchema(RAW[0])){
        normalizeDesiredOutcomeSchema(); refreshAll();
      } else if(MAP && Object.keys(MAP).length){
        normalizeGeneric(); refreshAll();
      }
    }
  }catch{}
})();
</script>
</body>
</html>