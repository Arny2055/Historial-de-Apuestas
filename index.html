<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Historial de Apuestas Profesional (Perfiles + Migración)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  *, *::before, *::after { box-sizing: border-box; }
  body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: #121214; color: #e1e1e6; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
  main { max-width: 1200px; width: 95%; margin: 20px auto 40px auto; flex-grow: 1; }
  h1, h2 { font-weight: 600; margin-bottom: 0.5rem; color: #8257e6; }

  /* Barra de perfiles */
  .perfiles { display:flex; gap:10px; align-items:center; margin: 8px 0 18px; flex-wrap:wrap; }
  .perfiles select, .perfiles button {
    background:#202024; color:#e1e1e6; border:none; border-radius:8px; padding:10px 12px;
    box-shadow: inset 0 0 5px rgb(255 255 255 / 0.08);
    font-weight:600; cursor:pointer;
  }
  .perfiles select { min-width: 180px; }
  .perfiles .danger { background:#ef4444; }
  .perfiles .primary { background:#8257e6; }

  /* Formulario */
  form#formApuesta{
    background-color:#202024; padding:25px 30px; border-radius:10px;
    box-shadow:0 6px 12px rgba(0,0,0,0.4);
    display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:20px 24px; margin-bottom:40px;
  }
  form#formApuesta label{display:block;font-weight:600;font-size:0.95rem;margin-bottom:6px;color:#c4c4cc;}
  form#formApuesta input[type="text"],
  form#formApuesta input[type="number"],
  form#formApuesta select{
    width:100%; padding:10px 14px; font-size:1rem; border-radius:8px; border:none;
    background-color:#121214; color:#e1e1e6; box-shadow:inset 0 0 5px rgb(255 255 255 / 0.1);
    transition: box-shadow 0.25s ease;
  }
  form#formApuesta input[type="text"]:focus,
  form#formApuesta input[type="number"]:focus,
  form#formApuesta select:focus{outline:none; box-shadow:inset 0 0 8px #8257e6;}
  form#formApuesta input[readonly]{background-color:#2a2a30; cursor:not-allowed;}
  form#formApuesta button[type="submit"]{
    grid-column:1 / -1; background-color:#8257e6; color:#fff; font-weight:700; font-size:1.2rem;
    padding:14px 20px; border:none; border-radius:10px; cursor:pointer; transition:background-color 0.3s ease;
    box-shadow:0 6px 10px #6a40d6;
  }
  form#formApuesta button[type="submit"]:hover{background-color:#6a40d6;}

  /* Filtros */
  section.filtros{ margin-bottom:30px; display:flex; flex-wrap:wrap; gap:15px 18px; align-items: center; }
  section.filtros input[type="text"],
  section.filtros input[type="number"],
  section.filtros input[type="date"],
  section.filtros select{
    min-width:160px; padding:9px 14px; border-radius:8px; border:none;
    background-color:#121214; color:#e1e1e6; box-shadow:inset 0 0 5px rgb(255 255 255 / 0.1);
    transition: box-shadow 0.25s ease;
  }
  section.filtros input:focus, section.filtros select:focus{outline:none; box-shadow:inset 0 0 8px #8257e6;}
  #btnLimpiarFiltros{
    background-color:#ef4444; color:#fff; font-weight:700; border:none; border-radius:10px;
    cursor:pointer; padding:8px 14px; transition:background-color 0.3s ease;
  }
  #btnLimpiarFiltros:hover{background-color:#dc2626;}

  /* Botones útiles */
  .botones-utiles{margin-bottom:35px; display:flex; gap:18px; flex-wrap:wrap;}
  .botones-utiles button{
    background-color:#8257e6; color:#fff; font-weight:600; border:none; border-radius:10px;
    cursor:pointer; padding:12px 20px; box-shadow:0 4px 8px #6b45d9; transition:background-color 0.3s ease;
  }
  .botones-utiles button:hover{background-color:#6b45d9;}
  .botones-utiles .btn-danger{background-color:#ef4444; box-shadow:0 4px 8px rgba(239,68,68,.4);}
  .botones-utiles .btn-danger:hover{background-color:#dc2626;}
  input[type="file"]{display:none;}

  /* Tabla */
  #tablaWrapper{ overflow-x:auto; overflow-y:auto; max-height:580px; box-shadow:0 6px 12px rgba(0,0,0,0.4); border-radius:12px; }
  table#tablaHistorial{width:100%; border-collapse:separate; border-spacing:0 5px; min-width:900px; font-size:0.9rem;}
  thead th{ position:sticky; top:0; background-color:#29292e; color:#bbb; font-weight:700; text-align:left; padding:14px 18px; user-select:none; white-space:nowrap; }
  tbody tr{background-color:#202024; transition:background-color 0.3s ease;}
  tbody tr:hover{background-color:#333339;}
  tbody td{padding:14px 18px; color:#ddd; vertical-align:middle; white-space:nowrap;}
  .acciones button{background:none; border:none; font-size:1.2rem; margin:0 4px; cursor:pointer; color:#aaa; transition:color 0.2s ease;}
  .acciones button:hover{color:#8257e6;}
  .status-pendiente{color:#fbbf24; font-weight:600;}
  .status-ganada{color:#4caf50; font-weight:600;}
  .status-perdida{color:#ef4444; font-weight:600;}

  /* Resumen */
  #resumen{ margin-top:40px; background-color:#29292e; border-radius:10px; padding:22px 26px; color:#d4d4d8; font-size:1.05rem; font-weight:600; display:flex; flex-wrap:wrap; gap:28px; justify-content:space-around; }
  #resumen > div{min-width:140px;}
  #resumen > div strong{display:block; font-size:1.15rem; color:#8257e6; margin-bottom:6px;}

  /* Gráficas */
  #graficas{margin-top:45px; display:flex; flex-direction:column; gap:40px;}
  canvas{background-color:#202024; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,0.5); max-width:100%; height:320px !important;}

  /* Responsive */
  @media (max-width: 900px){
    form#formApuesta{grid-template-columns:1fr !important;}
    section.filtros{flex-direction:column !important; gap:15px !important;}
    .botones-utiles{flex-direction:column; gap:15px;}
    #resumen{flex-direction:column; gap:20px; text-align:center;}
    tbody td, thead th{font-size:0.8rem; padding:10px 12px;}
  }
</style>
</head>
<body>
<main>
  <h1 style="text-align:center;">Historial Profesional de Apuestas</h1>

  <!-- ====== PERFILES / REGISTROS ====== -->
  <div class="perfiles" aria-label="Gestión de perfiles/registros">
    <strong>Perfil/Registro:</strong>
    <select id="selectPerfil" title="Selecciona un perfil"></select>
    <button id="btnNuevoPerfil" class="primary">Nuevo perfil</button>
    <button id="btnBorrarPerfil" class="danger">Borrar perfil actual</button>
  </div>

  <!-- ====== FORMULARIO ====== -->
  <form id="formApuesta" autocomplete="off" novalidate aria-label="Formulario para agregar apuesta">
    <div>
      <label for="liga">Liga *</label>
      <input type="text" id="liga" name="liga" placeholder="Ej: LaLiga" required />
    </div>
    <div>
      <label for="local">Equipo Local *</label>
      <input type="text" id="local" name="local" placeholder="Ej: Real Madrid" required />
    </div>
    <div>
      <label for="visita">Equipo Visitante *</label>
      <input type="text" id="visita" name="visita" placeholder="Ej: Barcelona" required />
    </div>
    <div>
      <label for="mercado">Mercado *</label>
      <select id="mercado" name="mercado" required>
        <option value="" disabled selected>Selecciona mercado</option>
        <option value="Over 2.5 FT">Over 2.5 FT</option>
        <option value="Under 2.5 FT">Under 2.5 FT</option>
        <option value="Ambos Anotan">Ambos Anotan</option>
        <option value="BTTS NO">BTTS NO</option>
        <option value="Hándicap">Hándicap</option>
      </select>
    </div>
    <div>
      <label for="probabilidad">Probabilidad (%) *</label>
      <input type="number" id="probabilidad" name="probabilidad" min="0.01" max="100" step="0.01" placeholder="Ej: 60" required />
      <small style="color:#c4c4cc; font-size:0.8rem;">Ingresa probabilidad estimada entre 0 y 100</small>
    </div>
    <div>
      <label for="cuotaImplicita">Cuota Implícita (auto)</label>
      <input type="number" id="cuotaImplicita" step="0.01" readonly placeholder="Ej: 1.66" />
    </div>
    <div>
      <label for="cuotaBookie">Cuota Bookie (decimal) *</label>
      <input type="number" id="cuotaBookie" name="cuotaBookie" min="1.01" step="0.01" placeholder="Ej: 1.80" required />
    </div>
    <div>
      <label for="bankroll">Bankroll *</label>
      <input type="number" id="bankroll" name="bankroll" min="0.01" step="0.01" placeholder="Ej: 100" value="100" required />
    </div>
    <div>
      <label for="kellyFrac">Fracción Kelly *</label>
      <select id="kellyFrac" name="kellyFrac" required>
        <option value="0.10">10%</option>
        <option value="0.25" selected>25%</option>
        <option value="0.33">33%</option>
        <option value="0.50">50%</option>
        <option value="1.00">100%</option>
      </select>
    </div>
    <div>
      <label for="stakePreview">Stake sugerido (preview)</label>
      <input type="number" id="stakePreview" readonly placeholder="0.00" />
    </div>
    <div style="align-self:end;">
      <button type="submit" aria-label="Agregar apuesta">Agregar apuesta</button>
    </div>
  </form>

  <!-- ====== FILTROS ====== -->
  <section class="filtros" aria-label="Filtros para el historial de apuestas">
    <input type="text" id="filtroLiga" placeholder="Filtrar por liga..." />
    <input type="text" id="filtroLocal" placeholder="Filtrar por local..." />
    <input type="text" id="filtroVisita" placeholder="Filtrar por visita..." />

    <select id="filtroMercado">
      <option value="">Todos los mercados</option>
      <option value="Over 2.5 FT">Over 2.5 FT</option>
      <option value="Under 2.5 FT">Under 2.5 FT</option>
      <option value="Ambos Anotan">Ambos Anotan</option>
      <option value="BTTS NO">BTTS NO</option>
      <option value="Hándicap">Hándicap</option>
    </select>

    <select id="filtroEstado">
      <option value="">Todos los estados</option>
      <option value="pendiente">Pendiente</option>
      <option value="ganada">Ganada</option>
      <option value="perdida">Perdida</option>
    </select>

    <input type="number" id="filtroProbMin" placeholder="Prob. mín (%)" min="0" max="100" step="0.01" />
    <input type="number" id="filtroProbMax" placeholder="Prob. máx (%)" min="0" max="100" step="0.01" />
    <input type="date" id="filtroFechaInicio" />
    <input type="date" id="filtroFechaFin" />
    <button id="btnLimpiarFiltros" title="Limpiar filtros" aria-label="Limpiar filtros">✖</button>
  </section>

  <!-- ====== BOTONES ====== -->
  <section class="botones-utiles" aria-label="Exportar o importar historial de apuestas">
    <button id="btnExportarCSV" title="Exportar historial a CSV">Exportar CSV</button>
    <button id="btnImportarJSON" title="Importar historial desde archivo JSON">Importar JSON</button>
    <input type="file" id="inputImportJSON" accept=".json" />
    <button onclick="location.href='historial_ligas.html'">Historial por Ligas</button>
    <button onclick="location.href='historial_equipos_rol.html'">Historial por Equipos (Rol)</button>
    <button onclick="location.href='probabilidades.html'">Probabilidades</button>
    <button id="btnEliminarTodo" class="btn-danger" title="Eliminar historial del perfil actual">Eliminar todo (perfil)</button>
  </section>

  <!-- ====== TABLA ====== -->
  <section aria-label="Historial de apuestas registradas">
    <div id="tablaWrapper">
      <table role="grid" aria-describedby="tableDescription" id="tablaHistorial" tabindex="0">
        <caption id="tableDescription" style="text-align:left; margin-bottom:12px; font-weight:700; font-size:1.2rem;">
          Historial de apuestas agregadas
        </caption>
        <thead>
          <tr>
            <th>#</th><th>Fecha</th><th>Liga</th><th>Local</th><th>Visita</th><th>Mercado</th>
            <th>Prob (%)</th><th>Cuota Implícita</th><th>Cuota Bookie</th><th>EV (%)</th>
            <th>Kelly FULL (%)</th><th>Stake sugerido</th><th>Estado</th><th>⚙</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ====== RESUMEN ====== -->
  <section id="resumen" aria-label="Resumen estadístico de apuestas">
    <div><strong>Bankroll inicial:</strong> <span id="resumenBankroll">-</span></div>
    <div><strong>Número apuestas:</strong> <span id="resumenNumApuestas">0</span></div>
    <div><strong>Apuestas ganadas:</strong> <span id="resumenGanadas">0</span></div>
    <div><strong>Apuestas perdidas:</strong> <span id="resumenPerdidas">0</span></div>
    <div><strong>Yield (%):</strong> <span id="resumenYield">0.00%</span></div>
    <div><strong>ROI (%):</strong> <span id="resumenROI">0.00%</span></div>
    <div><strong>Tasa de éxito (%):</strong> <span id="resumenTasaExito">0.00%</span></div>
    <div><strong>Unidades ganadas:</strong> <span id="resumenUnidades">0.00</span></div>
  </section>

  <!-- ====== GRÁFICAS ====== -->
  <section id="graficas" aria-label="Gráficas de evolución del bankroll y Kelly">
    <canvas id="graficaBankroll" aria-label="Gráfica de evolución de bankroll"></canvas>
    <canvas id="graficaKelly" aria-label="Gráfica de Kelly Full"></canvas>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  'use strict';

  /* ===================== CONSTANTES DE CLAVES ===================== */
  const PROFILE_LIST_KEY = 'historialApuestas__perfiles';
  const DEFAULT_PROFILE = 'default';
  const OLD_KEY = 'historialApuestasProfesionalCompleto';     // clave de tu versión anterior
  // Cada perfil nuevo usa: historialApuestas_<perfil>

  /* ===================== PERFILES ===================== */
  const selectPerfil = document.getElementById('selectPerfil');
  const btnNuevoPerfil = document.getElementById('btnNuevoPerfil');
  const btnBorrarPerfil = document.getElementById('btnBorrarPerfil');

  let perfiles = [];
  let perfilActual = DEFAULT_PROFILE;

  function loadProfiles() {
    try { perfiles = JSON.parse(localStorage.getItem(PROFILE_LIST_KEY) || '[]'); }
    catch { perfiles = []; }
    if (!Array.isArray(perfiles)) perfiles = [];
    if (!perfiles.includes(DEFAULT_PROFILE)) perfiles.unshift(DEFAULT_PROFILE);
    saveProfiles(false);
  }
  function saveProfiles(refresh = true) {
    localStorage.setItem(PROFILE_LIST_KEY, JSON.stringify(perfiles));
    if (refresh) renderProfilesSelect();
  }
  function renderProfilesSelect() {
    selectPerfil.innerHTML = '';
    perfiles.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p; opt.textContent = (p === DEFAULT_PROFILE ? 'default' : p);
      if (p === perfilActual) opt.selected = true;
      selectPerfil.appendChild(opt);
    });
  }
  function promptProfileName() {
    let name = prompt('Nombre del nuevo perfil (letras/números/guiones bajos):', '');
    if (!name) return null;
    name = name.trim();
    if (!/^[a-zA-Z0-9_\- ]{1,24}$/.test(name)) { alert('Nombre inválido'); return null; }
    return name;
  }
  function getStorageKey() { return `historialApuestas_${perfilActual}`; }
  function getDefaultStorageKey() { return `historialApuestas_${DEFAULT_PROFILE}`; }

  /* ===================== APP ===================== */
  // DOM
  const form = document.getElementById('formApuesta');
  const cuotaImplicitaInput = document.getElementById('cuotaImplicita');

  const filtroLiga = document.getElementById('filtroLiga');
  const filtroLocal = document.getElementById('filtroLocal');
  const filtroVisita = document.getElementById('filtroVisita');
  const filtroMercado = document.getElementById('filtroMercado');
  const filtroEstado = document.getElementById('filtroEstado');
  const filtroProbMin = document.getElementById('filtroProbMin');
  const filtroProbMax = document.getElementById('filtroProbMax');
  const filtroFechaInicio = document.getElementById('filtroFechaInicio');
  const filtroFechaFin = document.getElementById('filtroFechaFin');
  const btnLimpiarFiltros = document.getElementById('btnLimpiarFiltros');

  const tablaBody = document.querySelector('#tablaHistorial tbody');

  const resumenBankroll = document.getElementById('resumenBankroll');
  const resumenNumApuestas = document.getElementById('resumenNumApuestas');
  const resumenGanadas = document.getElementById('resumenGanadas');
  const resumenPerdidas = document.getElementById('resumenPerdidas');
  const resumenYield = document.getElementById('resumenYield');
  const resumenROI = document.getElementById('resumenROI');
  const resumenTasaExito = document.getElementById('resumenTasaExito');
  const resumenUnidades = document.getElementById('resumenUnidades');

  const btnExportarCSV = document.getElementById('btnExportarCSV');
  const btnImportarJSON = document.getElementById('btnImportarJSON');
  const inputImportJSON = document.getElementById('inputImportJSON');
  const btnEliminarTodo = document.getElementById('btnEliminarTodo');

  const ctxBankroll = document.getElementById('graficaBankroll').getContext('2d');
  const ctxKelly = document.getElementById('graficaKelly').getContext('2d');

  let graficaBankroll = null;
  let graficaKelly = null;

  // Estado por perfil:
  let historial = [];

  // ---------- Helpers de cálculo ----------
  function calcularCuotaImplicita(prob) { if (!(prob > 0)) return ''; return (100 / prob).toFixed(2); }
  function calcularEV(prob, cuotaBookie) { if (!(prob > 0 && cuotaBookie > 1)) return 0; const p = prob / 100; return p * cuotaBookie - 1; }
  function calcularKelly(prob, cuotaBookie) {
    if (!(prob > 0 && cuotaBookie > 1)) return 0;
    const p = prob / 100, b = cuotaBookie - 1;
    return (p * b - (1 - p)) / b;
  }
  function stakeSugerido(bankroll, kellyFull, kellyFrac) {
    if (!(bankroll > 0 && kellyFull > 0 && kellyFrac > 0)) return 0;
    const stake = bankroll * kellyFull * kellyFrac;
    return stake > bankroll ? bankroll : stake;
  }

  // ---------- Storage por perfil ----------
  function guardarHistorial() {
    localStorage.setItem(getStorageKey(), JSON.stringify(historial));
  }
  function cargarHistorial() {
    const data = localStorage.getItem(getStorageKey());
    if (data) { try { historial = JSON.parse(data); } catch { historial = []; } }
    else { historial = []; }
  }

  // ---------- MIGRACIÓN DESDE CLAVE VIEJA ----------
  function migrateFromOldKeyIfNeeded() {
    try {
      const oldRaw = localStorage.getItem(OLD_KEY);
      if (!oldRaw) return false; // no hay datos viejos

      // Si el perfil default ya tiene datos, no pisar.
      const newRaw = localStorage.getItem(getDefaultStorageKey());
      if (newRaw && JSON.parse(newRaw || '[]').length > 0) return false;

      let oldData = JSON.parse(oldRaw);
      if (!Array.isArray(oldData)) return false;

      // Normaliza ids y campos mínimos
      oldData = oldData.map(item => ({
        id: item.id || Date.now() + Math.random(),
        fecha: item.fecha || new Date().toISOString(),
        liga: item.liga || 'Sin liga',
        local: item.local || '',
        visita: item.visita || '',
        mercado: item.mercado || '',
        probabilidad: Number(item.probabilidad) || 0,
        cuotaImplicita: item.cuotaImplicita !== undefined ? item.cuotaImplicita : (Number(item.probabilidad) ? Number((100/Number(item.probabilidad)).toFixed(2)) : ''),
        cuotaBookie: Number(item.cuotaBookie) || 0,
        ev: (typeof item.ev === 'number') ? item.ev : calcularEV(Number(item.probabilidad)||0, Number(item.cuotaBookie)||0),
        kellyFull: (typeof item.kellyFull === 'number') ? item.kellyFull : calcularKelly(Number(item.probabilidad)||0, Number(item.cuotaBookie)||0),
        bankroll: Number(item.bankroll) || 100,
        kellyFrac: Number(item.kellyFrac) || 0.25,
        estado: item.estado || 'pendiente'
      }));

      localStorage.setItem(getDefaultStorageKey(), JSON.stringify(oldData));
      // No borramos la clave vieja automáticamente por seguridad
      alert(`Migramos ${oldData.length} apuestas desde tu versión anterior al perfil "default".`);
      return true;
    } catch (e) {
      console.warn('Migración falló o no necesaria:', e);
      return false;
    }
  }

  // ---------- Filtros ----------
  function limpiarFiltros() {
    filtroLiga.value = filtroLocal.value = filtroVisita.value = '';
    filtroMercado.value = filtroEstado.value = '';
    filtroProbMin.value = filtroProbMax.value = '';
    filtroFechaInicio.value = filtroFechaFin.value = '';
  }
  function filtrarHistorial() {
    return historial.filter(a => {
      if (filtroLiga.value && !a.liga.toLowerCase().includes(filtroLiga.value.toLowerCase())) return false;
      if (filtroLocal.value && !a.local.toLowerCase().includes(filtroLocal.value.toLowerCase())) return false;
      if (filtroVisita.value && !a.visita.toLowerCase().includes(filtroVisita.value.toLowerCase())) return false;
      if (filtroMercado.value && a.mercado !== filtroMercado.value) return false;
      if (filtroEstado.value && a.estado !== filtroEstado.value) return false;

      const p = Number(a.probabilidad) || 0;
      const min = filtroProbMin.value !== '' ? parseFloat(filtroProbMin.value) : null;
      const max = filtroProbMax.value !== '' ? parseFloat(filtroProbMax.value) : null;
      if (min !== null && p < min) return false;
      if (max !== null && p > max) return false;

      if (filtroFechaInicio.value && new Date(a.fecha) < new Date(filtroFechaInicio.value)) return false;
      if (filtroFechaFin.value) {
        const fin = new Date(filtroFechaFin.value); fin.setHours(23,59,59,999);
        if (new Date(a.fecha) > fin) return false;
      }
      return true;
    });
  }

  // ---------- Tabla ----------
  function renderizarTabla() {
    const apuestas = filtrarHistorial().slice().reverse();
    tablaBody.innerHTML = '';
    apuestas.forEach((a, i) => {
      const tr = document.createElement('tr');
      const td = (txt)=>{const x=document.createElement('td'); x.textContent=txt; return x;};

      tr.appendChild(td(i + 1));
      tr.appendChild(td(new Date(a.fecha).toLocaleDateString()));
      const tdLiga = td(a.liga);
      tdLiga.addEventListener('dblclick', () => {
        const input = document.createElement('input'); input.type='text'; input.value=a.liga; input.style.width="100%";
        tdLiga.textContent=''; tdLiga.appendChild(input); input.focus();
        input.addEventListener('blur', ()=>{ a.liga = input.value.trim() || a.liga; guardarHistorial(); actualizarVista(); });
        input.addEventListener('keydown', e=>{ if(e.key==='Enter') input.blur(); });
      });
      tr.appendChild(tdLiga);
      tr.appendChild(td(a.local));
      tr.appendChild(td(a.visita));
      tr.appendChild(td(a.mercado));
      tr.appendChild(td((Number(a.probabilidad)||0).toFixed(2)));

      const impl = a.cuotaImplicita !== '' && a.cuotaImplicita !== null ? a.cuotaImplicita : calcularCuotaImplicita(a.probabilidad);
      tr.appendChild(td(impl !== '' ? Number(impl).toFixed(2) : '-'));
      tr.appendChild(td((Number(a.cuotaBookie)||0).toFixed(2)));

      const tdEV = td(((a.ev||0)*100).toFixed(2)); tdEV.style.color=(a.ev||0)>=0?'#4caf50':'#ef4444'; tr.appendChild(tdEV);

      const tdKelly = td(a.kellyFull ? (a.kellyFull*100).toFixed(2) : '-');
      tdKelly.style.color = a.kellyFull && a.kellyFull > 0 ? '#4caf50' : '#c4c4cc'; tr.appendChild(tdKelly);

      const stake = stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac);
      tr.appendChild(td(stake.toFixed(2)));

      const tdEstado = td(a.estado); tdEstado.className=`status-${a.estado}`; tr.appendChild(tdEstado);

      const tdAcciones = document.createElement('td'); tdAcciones.className='acciones';
      const btn = (title, html, cb)=>{ const b=document.createElement('button'); b.title=title; b.innerHTML=html; b.addEventListener('click', cb); return b; };
      tdAcciones.append(btn('Marcar ganada','✅',()=>cambiarEstado(a.id,'ganada')),
                        btn('Marcar perdida','❌',()=>cambiarEstado(a.id,'perdida')),
                        btn('Marcar pendiente','⏳',()=>cambiarEstado(a.id,'pendiente')),
                        btn('Eliminar','🗑️',()=>eliminarApuesta(a.id)));
      tr.appendChild(tdAcciones);

      tablaBody.appendChild(tr);
    });
  }
  function cambiarEstado(id, nuevo) { const i=historial.findIndex(a=>a.id===id); if(i!==-1){ historial[i].estado=nuevo; guardarHistorial(); actualizarVista(); } }
  function eliminarApuesta(id) { if(!confirm('¿Eliminar esta apuesta?')) return; historial = historial.filter(a=>a.id!==id); guardarHistorial(); actualizarVista(); }

  // Eliminar TODO (solo este perfil)
  btnEliminarTodo.addEventListener('click', () => {
    if (!confirm(`⚠️ Esto borrará TODO el historial del perfil "${perfilActual}". ¿Continuar?`)) return;
    historial = [];
    localStorage.removeItem(getStorageKey());
    actualizarVista();
    inputImportJSON.value = '';
    alert('Historial del perfil eliminado ✅');
  });

  // ---------- Resumen ----------
  function actualizarResumen() {
    const arr = filtrarHistorial();
    if (arr.length === 0) {
      resumenBankroll.textContent='-'; resumenNumApuestas.textContent='0';
      resumenGanadas.textContent='0'; resumenPerdidas.textContent='0';
      resumenYield.textContent='0.00%'; resumenROI.textContent='0.00%';
      resumenTasaExito.textContent='0.00%'; resumenUnidades.textContent='0.00';
      return;
    }
    const bank0 = arr[0].bankroll || 0; resumenBankroll.textContent = bank0.toFixed(2);
    const n = arr.length; resumenNumApuestas.textContent = n;
    const g = arr.filter(a=>a.estado==='ganada').length;
    const p = arr.filter(a=>a.estado==='perdida').length;
    resumenGanadas.textContent=g; resumenPerdidas.textContent=p;
    const tasa = n>0 ? (g/n)*100 : 0; resumenTasaExito.textContent = tasa.toFixed(2)+'%';

    let totalGanado=0, totalApostado=0;
    arr.forEach(a=>{
      const st = stakeSugerido(a.bankroll,a.kellyFull,a.kellyFrac);
      totalApostado += st;
      if (a.estado==='ganada') totalGanado += st * a.cuotaBookie;
    });
    const neto = totalGanado - totalApostado;
    const yieldPct = totalApostado>0 ? (neto/totalApostado)*100 : 0;
    const roiPct = bank0>0 ? (neto/bank0)*100 : 0;
    resumenYield.textContent = yieldPct.toFixed(2)+'%';
    resumenROI.textContent = roiPct.toFixed(2)+'%';
    resumenUnidades.textContent = neto.toFixed(2);
  }

  // ---------- Gráficas ----------
  function actualizarGraficas() {
    const arr = filtrarHistorial();
    if (graficaBankroll) graficaBankroll.destroy();
    if (graficaKelly) graficaKelly.destroy();
    if (arr.length === 0) return;

    let bank0 = arr[0].bankroll || 100;
    let labels = ['Inicio'];
    let bankData = [bank0];
    arr.forEach((a,i)=>{
      const st = stakeSugerido(a.bankroll,a.kellyFull,a.kellyFrac);
      let last = bankData[bankData.length-1], nuevo = last;
      if (a.estado==='ganada') nuevo += st*(a.cuotaBookie-1);
      else if (a.estado==='perdida') nuevo -= st;
      bankData.push(nuevo);
      labels.push(`Apuesta ${i+1}`);
    });

    // versión estilizada (línea suave + relleno ligero + decimation)
    const g = ctxBankroll.createLinearGradient(0,0,0,ctxBankroll.canvas.height);
    g.addColorStop(0,'rgba(130,87,230,0.18)');
    g.addColorStop(1,'rgba(130,87,230,0.00)');

    graficaBankroll = new Chart(ctxBankroll, {
      type:'line',
      data:{ labels, datasets:[{ label:'Bankroll', data:bankData, borderColor:'#8257e6', backgroundColor:g, fill:true, borderWidth:2, tension:0.35, cubicInterpolationMode:'monotone', pointRadius:0, pointHoverRadius:4, spanGaps:true }]},
      options:{
        responsive:true, maintainAspectRatio:false, parsing:false,
        interaction:{ mode:'index', intersect:false },
        plugins:{ legend:{ labels:{ color:'#ddd', font:{ size:13, weight:'600'} } }, tooltip:{ displayColors:false, callbacks:{ label:ctx=>`Bankroll: ${ctx.parsed.y.toFixed(2)}` } }, decimation:{ enabled:true, algorithm:'lttb', samples:250 } },
        scales:{ y:{ beginAtZero:false, ticks:{ color:'#cfcfd6' }, grid:{ color:'rgba(255,255,255,0.06)'} }, x:{ ticks:{ color:'#cfcfd6', autoSkip:true, maxTicksLimit:10 }, grid:{ display:false } } }
      }
    });

    const kellyData = arr.map(a => a.kellyFull ? a.kellyFull*100 : 0);
    graficaKelly = new Chart(ctxKelly, {
      type:'bar',
      data:{ labels:labels.slice(1), datasets:[{ label:'Kelly FULL (%)', data:kellyData, backgroundColor:'#ffba08', borderRadius:4 }]},
      options:{ responsive:true, scales:{ y:{ beginAtZero:true, max:100, ticks:{ color:'#ddd' }, grid:{ color:'#444' } }, x:{ ticks:{ color:'#ddd' }, grid:{ color:'#444' } } },
        plugins:{ legend:{ labels:{ color:'#ddd', font:{ size:14, weight:'600'} } } } }
    });
  }

  function actualizarVista(){ renderizarTabla(); actualizarResumen(); actualizarGraficas(); }

  // ---------- Form ----------
  form.addEventListener('submit', e=>{
    e.preventDefault();
    const fd = new FormData(form);
    try{
      const liga = fd.get('liga').trim();
      const local = fd.get('local').trim();
      const visita = fd.get('visita').trim();
      const mercado = fd.get('mercado');
      const prob = parseFloat(fd.get('probabilidad'));
      const cuotaBookie = parseFloat(fd.get('cuotaBookie'));
      const bankroll = parseFloat(fd.get('bankroll'));
      const kellyFrac = parseFloat(fd.get('kellyFrac'));

      if(!liga) throw new Error('La liga es requerida');
      if(!local) throw new Error('Equipo local es requerido');
      if(!visita) throw new Error('Equipo visitante es requerido');
      if(!mercado) throw new Error('Selecciona un mercado');
      if(!(prob>0 && prob<=100)) throw new Error('Probabilidad 0-100');
      if(!(cuotaBookie>1)) throw new Error('Cuota bookie > 1');
      if(!(bankroll>0)) throw new Error('Bankroll > 0');
      if(!(kellyFrac>0 && kellyFrac<=1)) throw new Error('Fracción Kelly inválida');

      const cuotaImplicitaCalc = parseFloat(calcularCuotaImplicita(prob));
      const ev = calcularEV(prob, cuotaBookie);
      const kellyFull = calcularKelly(prob, cuotaBookie);

      const apuesta = { id: Date.now(), fecha: new Date().toISOString(), liga, local, visita, mercado, probabilidad: prob, cuotaImplicita: cuotaImplicitaCalc, cuotaBookie, ev, kellyFull, bankroll, kellyFrac, estado: 'pendiente' };
      historial.push(apuesta);
      guardarHistorial();
      form.reset(); cuotaImplicitaInput.value='';
      actualizarVista();
      alert('Apuesta agregada correctamente');
    }catch(err){ alert('Error: '+err.message); }
  });

  // Inputs auxiliares
  document.getElementById('probabilidad').addEventListener('input', e => {
    const v = parseFloat(e.target.value); cuotaImplicitaInput.value = calcularCuotaImplicita(v);
  });
  const cuotaBookieInput = document.getElementById('cuotaBookie');
  const bankrollInput = document.getElementById('bankroll');
  const kellyFracInput = document.getElementById('kellyFrac');
  const stakePreviewInput = document.getElementById('stakePreview');
  function actualizarStakePreview(){
    const prob = parseFloat(document.getElementById('probabilidad').value);
    const cuotaBookie = parseFloat(cuotaBookieInput.value);
    const bankroll = parseFloat(bankrollInput.value);
    const kellyFrac = parseFloat(kellyFracInput.value);
    if(!(prob>0 && cuotaBookie>1 && bankroll>0 && kellyFrac>0)){ stakePreviewInput.value=""; return; }
    const kf = calcularKelly(prob,cuotaBookie); const stake = stakeSugerido(bankroll,kf,kellyFrac);
    stakePreviewInput.value = stake.toFixed(2);
  }
  ['input','change'].forEach(evt=>{
    document.getElementById('probabilidad').addEventListener(evt, actualizarStakePreview);
    cuotaBookieInput.addEventListener(evt, actualizarStakePreview);
    bankrollInput.addEventListener(evt, actualizarStakePreview);
    kellyFracInput.addEventListener(evt, actualizarStakePreview);
  });

  // Filtros eventos
  [filtroLiga, filtroLocal, filtroVisita, filtroMercado, filtroEstado, filtroProbMin, filtroProbMax, filtroFechaInicio, filtroFechaFin]
    .forEach(el => { el.addEventListener('input', actualizarVista); el.addEventListener('change', actualizarVista); });
  btnLimpiarFiltros.addEventListener('click', e=>{ e.preventDefault(); limpiarFiltros(); actualizarVista(); });

  // Exportar/Importar
  btnExportarCSV.addEventListener('click', ()=>{
    if(historial.length===0){ alert('No hay datos para exportar'); return; }
    const csvRows = [];
    csvRows.push(['id','fecha','liga','local','visita','mercado','probabilidad','cuotaImplicita','cuotaBookie','ev','kellyFull','bankroll','kellyFrac','estado'].join(','));
    historial.forEach(a=>{
      csvRows.push([a.id,a.fecha,`"${a.liga}"`,`"${a.local}"`,`"${a.visita}"`,`"${a.mercado}"`,a.probabilidad,a.cuotaImplicita,a.cuotaBookie,a.ev,a.kellyFull,a.bankroll,a.kellyFrac,a.estado].join(','));
    });
    const blob = new Blob([csvRows.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const link = document.createElement('a');
    link.href=url; link.download=`historial_${perfilActual}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
  });
  btnImportarJSON.addEventListener('click', ()=>inputImportJSON.click());
  inputImportJSON.addEventListener('change', e=>{
    const file = e.target.files && e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      try{
        let data = JSON.parse(ev.target.result); if(!Array.isArray(data)) data=[data];
        let count=0; data.forEach(item=>{ if(item && typeof item==='object'){ historial.push({ ...item, id: item.id || Date.now()+Math.random() }); count++; } });
        guardarHistorial(); actualizarVista(); alert(`Importación exitosa ✅ Registros añadidos: ${count}`); inputImportJSON.value='';
      }catch(err){ console.error(err); alert('Error al importar JSON.'); }
    };
    reader.readAsText(file);
  });

  /* ====== Gestión de perfiles: UI ====== */
  btnNuevoPerfil.addEventListener('click', ()=>{
    const name = promptProfileName(); if(!name) return;
    if (perfiles.includes(name)) { alert('Ese perfil ya existe.'); return; }
    perfiles.push(name); saveProfiles();
    perfilActual = name; renderProfilesSelect();
    cargarHistorial(); actualizarVista();
    alert(`Perfil creado y seleccionado: ${name}`);
  });

  btnBorrarPerfil.addEventListener('click', ()=>{
    if (perfilActual === DEFAULT_PROFILE) { alert('El perfil "default" no puede eliminarse.'); return; }
    if (!confirm(`¿Borrar el perfil "${perfilActual}" y todos sus datos?`)) return;
    localStorage.removeItem(getStorageKey());
    perfiles = perfiles.filter(p=>p!==perfilActual);
    perfilActual = DEFAULT_PROFILE; saveProfiles();
    renderProfilesSelect();
    cargarHistorial(); actualizarVista();
    alert('Perfil eliminado. Se ha vuelto a "default".');
  });

  selectPerfil.addEventListener('change', ()=>{
    guardarHistorial(); // guarda el perfil actual por si acaso
    perfilActual = selectPerfil.value;
    cargarHistorial(); actualizarVista();
  });

  // ====== Init ======
  function init(){
    loadProfiles();
    perfilActual = perfiles[0] || DEFAULT_PROFILE;
    renderProfilesSelect();

    // 1) Intentamos migrar si es necesario (sólo una vez)
    const migrated = migrateFromOldKeyIfNeeded();

    // 2) Cargamos historial del perfil seleccionado
    cargarHistorial();

    // 3) Si migramos y estamos en otro perfil distinto, cambiamos a default para que lo veas
    if (migrated && perfilActual !== DEFAULT_PROFILE) {
      perfilActual = DEFAULT_PROFILE;
      renderProfilesSelect();
      cargarHistorial();
    }

    actualizarVista();
  }
  init();

})();
</script>
</body>
</html>