<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Analizador Profesional de Rentabilidad por Equipo</title>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; background: #f4f4f9; padding: 20px; }
.container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 8px; }
h1 { text-align: center; color: #4caf50; }
.controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
select, input, button { padding: 10px; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { border: 1px solid #ddd; padding: 10px; }
th { background: #4caf50; color: white; }
.rentable { color: green; font-weight: bold; }
.no-rentable { color: red; font-weight: bold; }
.neutral { color: gray; font-weight: bold; }
button { cursor: pointer; background: #4caf50; color: white; border: none; }
</style>
</head>

<body>
<div class="container">
<h1>⚽ Analizador Profesional de Equipos</h1>

<div class="controls">
<input type="file" id="fileInput" accept=".xlsx">
<select id="filtroPosicion">
    <option value="all">Local + Visitante</option>
    <option value="home">Solo Local</option>
    <option value="away">Solo Visitante</option>
</select>

<select id="filtroLiga">
    <option value="all">Todas las Ligas</option>
</select>

<select id="filtroLimite">
    <option value="0">Todos los partidos</option>
    <option value="15">Últimos 15 partidos</option>
</select>

<button onclick="exportarExcel()">Exportar a Excel</button>
</div>

<div id="resultados"></div>
</div>

<script>
let datosGlobales = [];
let rankingFinal = [];

document.getElementById('fileInput').addEventListener('change', cargarArchivo);
document.querySelectorAll('select').forEach(e => e.addEventListener('change', recalcular));

function cargarArchivo(e) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        datosGlobales = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        cargarLigas();
        recalcular();
    };
    reader.readAsArrayBuffer(e.target.files[0]);
}

function cargarLigas() {
    const ligas = [...new Set(datosGlobales.map(r => r.League))];
    const select = document.getElementById("filtroLiga");
    ligas.forEach(l => {
        const opt = document.createElement("option");
        opt.value = l;
        opt.textContent = l;
        select.appendChild(opt);
    });
}

function recalcular() {
    const posicion = document.getElementById("filtroPosicion").value;
    const liga = document.getElementById("filtroLiga").value;
    const limite = parseInt(document.getElementById("filtroLimite").value);

    let datos = [...datosGlobales];

    if (liga !== "all") datos = datos.filter(d => d.League === liga);
    if (limite > 0) datos = datos.slice(-limite);

    procesarDatos(datos, posicion);
}

function procesarDatos(data, posicion) {
    const resultados = {};

    data.forEach(row => {
        if (!row.Match.includes("-")) return;

        const [home, away] = row.Match.split("-").map(t => t.trim());
        const odd = parseFloat(row.Odd) || 1;
        const isWin = String(row.Result).toUpperCase() === "WIN";

        const aplicar = (team, tipo) => {
            if (posicion !== "all" && posicion !== tipo) return;

            if (!resultados[team]) resultados[team] = { partidos: 0, aciertos: 0, profit: 0 };
            resultados[team].partidos++;
            if (isWin) resultados[team].aciertos++;
            resultados[team].profit += isWin ? (odd - 1) : -1;
        };

        aplicar(home, "home");
        aplicar(away, "away");
    });

    rankingFinal = Object.entries(resultados).map(([name, d]) => ({
        Equipo: name,
        Partidos: d.partidos,
        Aciertos: d.aciertos,
        WinRate: ((d.aciertos / d.partidos) * 100).toFixed(1),
        Profit: d.profit.toFixed(2),
        ROI: ((d.profit / d.partidos) * 100).toFixed(2)
    })).sort((a, b) => b.Profit - a.Profit);

    mostrarTabla();
}

function mostrarTabla() {
    let html = `<table>
    <tr>
        <th>Equipo</th><th>Partidos</th><th>Aciertos</th><th>Win%</th>
        <th>Profit</th><th>ROI%</th><th>Estado</th>
    </tr>`;

    rankingFinal.forEach(e => {
        const estado = e.Profit > 0 ? "Rentable" : e.Profit < 0 ? "Pérdida" : "Neutro";
        const clase = e.Profit > 0 ? "rentable" : e.Profit < 0 ? "no-rentable" : "neutral";

        html += `
        <tr>
            <td>${e.Equipo}</td>
            <td>${e.Partidos}</td>
            <td>${e.Aciertos}</td>
            <td>${e.WinRate}%</td>
            <td class="${clase}">${e.Profit} u</td>
            <td class="${clase}">${e.ROI}%</td>
            <td class="${clase}">${estado}</td>
        </tr>`;
    });

    html += "</table>";
    document.getElementById("resultados").innerHTML = html;
}

function exportarExcel() {
    const ws = XLSX.utils.json_to_sheet(rankingFinal);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ranking Equipos");
    XLSX.writeFile(wb, "ranking_rentabilidad_equipos.xlsx");
}
</script>
</body>
</html>