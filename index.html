<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Poisson & Próximos Partidos</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --light: #ecf0f1; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 800px; margin-bottom: 20px; }
        h1, h2 { text-align: center; color: var(--primary); }
        .selectors { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        select, button { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 1rem; }
        button { background: var(--success); color: white; font-weight: bold; border: none; cursor: pointer; margin-top: 10px; }
        button:hover { background: #219150; }
        .results-container { margin-top: 20px; display: none; padding: 15px; background: var(--light); border-radius: 10px; text-align: center; }
        
        /* Estilos Tabla Próximos Partidos */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: var(--primary); color: white; }
        tr:hover { background-color: #f9f9f9; }
        .btn-predict { padding: 5px 10px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="card">
    <h1>Calculadora de Poisson</h1>
    <div class="selectors">
        <div><label>Local</label><select id="homeSelect"></select></div>
        <div><label>Visitante</label><select id="awaySelect"></select></div>
    </div>
    <button onclick="manualCalculation()">Calcular Probabilidades</button>
    <div id="results" class="results-container">
        <div id="probStats"></div>
        <strong id="resScore" style="font-size: 1.5rem; color: var(--accent);"></strong>
    </div>
</div>

<div class="card">
    <h2>Próximos Partidos</h2>
    <div id="loading-matches">Cargando encuentros desde la hoja...</div>
    <table id="matchesTable" style="display:none;">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Local</th>
                <th>Visitante</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody id="matchesBody"></tbody>
    </table>
</div>

<script>
    const sheetId = "1lmUPv7SP0XYi9ns4jkj3RTCScxIN2pCfBJyMUp_kNRI";
    // URL para la hoja de datos de equipos (asumiendo gid=0 o la primera)
    const teamsUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
    // URL para la hoja "proximos partidos" (usando el nombre de la hoja)
    const matchesUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=proximos%20partidos`;

    let leagueData = [];

    async function init() {
        try {
            // Cargar Datos de Equipos
            const resTeams = await fetch(teamsUrl);
            const csvTeams = await resTeams.text();
            parseTeams(csvTeams);

            // Cargar Próximos Partidos
            const resMatches = await fetch(matchesUrl);
            const csvMatches = await resMatches.text();
            parseMatches(csvMatches);
        } catch (e) {
            console.error("Error cargando datos:", e);
        }
    }

    function parseTeams(csv) {
        const rows = csv.split('\n').slice(1);
        const hSelect = document.getElementById('homeSelect');
        const aSelect = document.getElementById('awaySelect');
        
        rows.forEach(row => {
            const cols = row.split(',');
            if (cols.length < 5) return;
            const team = {
                name: cols[0].replace(/"/g, '').trim(),
                hAtt: parseFloat(cols[1]), hDef: parseFloat(cols[2]),
                aAtt: parseFloat(cols[3]), aDef: parseFloat(cols[4])
            };
            leagueData.push(team);
            hSelect.add(new Option(team.name, team.name));
            aSelect.add(new Option(team.name, team.name));
        });
    }

    function parseMatches(csv) {
        const rows = csv.split('\n').slice(1);
        const tbody = document.getElementById('matchesBody');
        document.getElementById('loading-matches').style.display = 'none';
        document.getElementById('matchesTable').style.display = 'table';

        rows.forEach(row => {
            const cols = row.split(',').map(c => c.replace(/"/g, '').trim());
            if (cols.length < 3) return;
            // Estructura esperada: [0]Fecha, [1]Local, [2]Visitante
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${cols[0]}</td>
                <td>${cols[1]}</td>
                <td>${cols[2]}</td>
                <td><button class="btn-predict" onclick="autoPredict('${cols[1]}', '${cols[2]}')">Analizar</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function poisson(k, lambda) {
        return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
    }

    function factorial(n) {
        let r = 1;
        for (let i = 2; i <= n; i++) r *= i;
        return r;
    }

    function autoPredict(home, away) {
        document.getElementById('homeSelect').value = home;
        document.getElementById('awaySelect').value = away;
        manualCalculation();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function manualCalculation() {
        const hName = document.getElementById('homeSelect').value;
        const aName = document.getElementById('awaySelect').value;
        const hTeam = leagueData.find(t => t.name === hName);
        const aTeam = leagueData.find(t => t.name === aName);

        const hXG = hTeam.hAtt * aTeam.aDef * 1.35;
        const aXG = aTeam.aAtt * hTeam.hDef * 1.35;

        let pH = 0, pA = 0, pD = 0, maxP = 0, score = "";

        for (let h = 0; h <= 10; h++) {
            for (let a = 0; a <= 10; a++) {
                const p = poisson(h, hXG) * poisson(a, aXG);
                if (h > a) pH += p; else if (a > h) pA += p; else pD += p;
                if (p > maxP) { maxP = p; score = `${h} - ${a}`; }
            }
        }

        document.getElementById('probStats').innerHTML = `
            <p>Victoria Local: ${(pH*100).toFixed(1)}% | Empate: ${(pD*100).toFixed(1)}% | Visitante: ${(pA*100).toFixed(1)}%</p>
        `;
        document.getElementById('resScore').innerText = `Marcador Probable: ${score}`;
        document.getElementById('results').style.display = 'block';
    }

    window.onload = init;
</script>
</body>
</html>
