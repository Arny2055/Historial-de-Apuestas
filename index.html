<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BETAGS - Global Deep Analytics</title>
    <style>
        :root {
            --bg-dark: #0b0e14;
            --bg-card: #151921;
            --primary: #4dabf7;
            --accent-green: #51cf66;
            --accent-red: #ff6b6b;
            --accent-yellow: #fcc419;
            --text-white: #e9ecef;
            --text-muted: #adb5bd;
            --border: #2c3440;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-white);
            margin: 0;
            padding: 0;
            display: flex; 
            justify-content: center;
            min-height: 100vh;
            text-align: center;
        }

        .container { 
            width: 100%; 
            max-width: 1200px; 
            padding: 15px; 
            box-sizing: border-box;
            padding-bottom: 40px;
        }

        h1 { font-size: 1.4rem; color: var(--primary); text-align: center; margin: 20px 0; letter-spacing: 3px; font-weight: 900; }
        h1 span { color: var(--text-white); }

        .nav-header {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn-nav-roi, .btn-nav-xg {
            background: rgba(77, 171, 247, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 8px 15px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-nav-xg { border-color: var(--accent-green); color: var(--accent-green); background: rgba(81, 207, 102, 0.1); }
        .btn-nav-roi:hover { background: var(--primary); color: var(--bg-dark); }
        .btn-nav-xg:hover { background: var(--accent-green); color: var(--bg-dark); }

        .section-title { 
            font-size: 0.7rem; 
            color: var(--primary); 
            text-transform: uppercase; 
            margin: 20px 0 12px 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 8px; 
            font-weight: bold; 
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-grid { width: 100%; display: grid; grid-template-columns: 1fr; gap: 12px; }
        
        select, input { 
            width: 100%; 
            padding: 14px; 
            border-radius: 10px; 
            border: 1px solid var(--border); 
            background: #0b0e14;
            color: white;
            font-size: 1rem;
            outline: none;
            text-align: center;
            box-sizing: border-box;
        }

        .add-league-box { display: flex; gap: 8px; width: 100%; }
        .input-new-sheet { flex: 1; border: 1px dashed var(--primary); font-size: 0.8rem; }
        .btn-add-sheet { background: var(--primary); color: var(--bg-dark); border: none; padding: 0 15px; border-radius: 8px; font-weight: 900; font-size: 0.7rem; cursor: pointer; }
        .btn-delete-sheet { background: rgba(255, 107, 107, 0.2); color: var(--accent-red); border: 1px solid var(--accent-red); padding: 0 12px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; }

        .btn-analyze-day {
            width: 100%;
            background: linear-gradient(90deg, #fcc419, #ff922b);
            color: #000;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-weight: 900;
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(252, 196, 25, 0.3);
            transition: transform 0.2s;
        }
        .btn-analyze-day:active { transform: scale(0.98); }

        /* Estilos de Tabla de Resultados Globales */
        .table-wrapper { width: 100%; overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; min-width: 600px; }
        th { background: rgba(255,255,255,0.03); color: var(--text-muted); padding: 12px 8px; font-weight: bold; border-bottom: 2px solid var(--border); text-transform: uppercase; font-size: 0.6rem; }
        td { padding: 12px 8px; border-bottom: 1px solid var(--border); vertical-align: middle; text-align: center; }
        
        .league-tag { font-size: 0.6rem; background: var(--primary); color: #000; padding: 2px 4px; border-radius: 4px; font-weight: 900; }
        .team-cell { text-align: left; font-weight: bold; color: var(--text-white); }
        .xg-cell { font-family: monospace; color: var(--accent-yellow); font-weight: bold; }
        
        .input-odds-small {
            width: 50px;
            padding: 5px;
            font-size: 0.75rem;
            border-radius: 4px;
            background: #000;
            border: 1px solid var(--border);
            color: var(--accent-yellow);
            text-align: center;
        }

        .btn-send-bet {
            background: var(--accent-green);
            color: #000;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            font-weight: 900;
            font-size: 0.65rem;
            cursor: pointer;
            opacity: 0.5;
            pointer-events: none;
        }
        .btn-send-bet.active { opacity: 1; pointer-events: auto; }

        .value-badge {
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: 900;
            font-size: 0.65rem;
        }
        .positive { background: rgba(81, 207, 102, 0.2); color: var(--accent-green); }
        .negative { background: rgba(255, 107, 107, 0.2); color: var(--accent-red); }

        /* Chart & Single View */
        .chart-container { width: 100%; height: 160px; display: flex; align-items: flex-end; justify-content: space-around; margin: 10px 0; padding-bottom: 25px; }
        .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end; }
        .bar { width: 80%; background: var(--primary); border-radius: 3px 3px 0 0; min-height: 2px; }
        .bar.away { background: var(--accent-green); }
        .bar-label { font-size: 0.7rem; color: var(--text-muted); margin-top: 8px; }

        .loading-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #globalResultsPanel { display: none; width: 100%; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p id="loadingText" style="margin-top: 15px; font-weight: bold; color: var(--primary);">PROCESANDO TODAS LAS LIGAS...</p>
</div>

<div class="container">
    <h1>BETA<span>GS</span> GLOBAL ANALYTICS</h1>
    
    <div class="nav-header">
        <a href="roi2.html" class="btn-nav-roi"><span>üßÆ</span> ROI CALC</a>
        <a href="xg.html" class="btn-nav-xg"><span>‚öΩ</span> XG ANALYTICS</a>
    </div>

    <div class="section-title"><span>‚öôÔ∏è</span> PANEL DE CONTROL</div>
    <div class="card">
        <div class="input-grid">
            <button class="btn-analyze-day" onclick="analizarTodasLasLigas()">
                üöÄ ANALIZAR TODAS LAS LIGAS (FULL SCAN)
            </button>
            
            <div style="width: 100%; height: 1px; background: var(--border); margin: 10px 0;"></div>
            
            <select id="leagueSelect" onchange="cargarDatosLigaIndividual()"></select>
            <div class="add-league-box">
                <input type="text" id="newSheetName" class="input-new-sheet" placeholder="NOMBRE DE NUEVA HOJA...">
                <button class="btn-add-sheet" onclick="agregarNuevaLiga()">A√ëADIR</button>
                <button class="btn-delete-sheet" onclick="borrarLigaSeleccionada()">üóëÔ∏è</button>
            </div>

            <div style="display: flex; gap: 10px; width: 100%;">
                <select id="homeTeamSelect" onchange="calcularXGIndividual()"><option value="">LOCAL...</option></select>
                <select id="awayTeamSelect" onchange="calcularXGIndividual()"><option value="">VISITA...</option></select>
            </div>
        </div>
    </div>

    <div id="globalResultsPanel">
        <div class="section-title"><span>üèÜ</span> VALOR ENCONTRADO (TODAS LAS LIGAS)</div>
        <div class="card" style="padding: 10px 5px;">
            <div class="table-wrapper">
                <table id="globalTable">
                    <thead>
                        <tr>
                            <th>LIGA</th>
                            <th>PARTIDO</th>
                            <th>xG L/V</th>
                            <th>MERCADO</th>
                            <th>PROB</th>
                            <th>JUSTA</th>
                            <th>CUOTA</th>
                            <th>VALUE</th>
                            <th>ACCION</th>
                        </tr>
                    </thead>
                    <tbody id="globalTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="xgPanel" style="display: none;">
        <div class="section-title"><span>üìà</span> DISTRIBUCI√ìN POISSON</div>
        <div class="card">
            <div class="chart-container" id="golesChart"></div>
            <div style="display: flex; gap: 30px;">
                <div><small>xG L</small><div id="ind_xg_l" style="font-size: 1.2rem; font-weight: 900; color: var(--primary);">0.00</div></div>
                <div><small>xG V</small><div id="ind_xg_v" style="font-size: 1.2rem; font-weight: 900; color: var(--accent-green);">0.00</div></div>
            </div>
        </div>
    </div>
</div>

<script>
    const DEFAULT_ID = '1lmUPv7SP0XYi9ns4jkj3RTCScxIN2pCfBJyMUp_kNRI';
    let ligasCache = {}; // Guardar√° los datos de cada liga cargada

    // --- UTILIDADES ---
    function factorial(n) { if (n === 0) return 1; let res = 1; for (let i = 1; i <= n; i++) res *= i; return res; }
    function poisson(k, lambda) { return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k); }

    function getSavedLeagues() {
        const saved = localStorage.getItem('betags_custom_leagues');
        return saved ? JSON.parse(saved) : [];
    }

    function renderLeagueSelect() {
        const select = document.getElementById('leagueSelect');
        const leagues = getSavedLeagues();
        if (leagues.length === 0) {
            select.innerHTML = '<option value="">SIN LIGAS</option>';
            return;
        }
        leagues.sort((a, b) => a.name.localeCompare(b.name));
        select.innerHTML = leagues.map(l => `<option value="${l.sheet}">${l.name}</option>`).join('');
    }

    // --- L√ìGICA DE CARGA ---

    async function fetchHoja(sheetName) {
        const url = `https://docs.google.com/spreadsheets/d/${DEFAULT_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}&range=A1:W50`;
        const response = await fetch(url);
        const csvText = await response.text();
        const filas = csvText.split('\n').map(linea => 
            linea.split(',').map(celda => celda.replace(/^"(.*)"$/, '$1').trim())
        );

        let data = { locales: [], visitantes: [], ligaPromedio: {} };
        filas.forEach((cols, index) => {
            if (index > 0 && cols[1] && !isNaN(parseFloat(cols[2]))) {
                data.locales.push({ nombre: cols[1], gp: parseFloat(cols[2]), gf: parseFloat(cols[6]), ga: parseFloat(cols[7]) });
                if (cols[13] && !isNaN(parseFloat(cols[14]))) {
                    data.visitantes.push({ nombre: cols[13], gp: parseFloat(cols[14]), gf: parseFloat(cols[18]), ga: parseFloat(cols[19]) });
                }
            }
        });

        if(data.locales.length > 0) {
            let sGFL = 0, sGAL = 0, sPJL = 0, sGFV = 0, sGAV = 0, sPJV = 0;
            data.locales.forEach(e => { sGFL += e.gf; sGAL += e.ga; sPJL += e.gp; });
            data.visitantes.forEach(e => { sGFV += e.gf; sGAV += e.ga; sPJV += e.gp; });
            data.ligaPromedio = { 
                gfl: sGFL / sPJL, gal: sGAL / sPJL, 
                gfv: sGFV / sPJV, gav: sGAV / sPJV 
            };
            return data;
        }
        return null;
    }

    // --- PROCESAMIENTO GLOBAL (LA MEJORA SOLICITADA) ---

    async function analizarTodasLasLigas() {
        const overlay = document.getElementById('loadingOverlay');
        const statusText = document.getElementById('loadingText');
        const tableBody = document.getElementById('globalTableBody');
        const leagues = getSavedLeagues();

        if (leagues.length === 0) return alert("A√±ade ligas primero.");

        overlay.style.display = 'flex';
        tableBody.innerHTML = '';
        
        try {
            // 1. Obtener partidos del d√≠a
            statusText.innerText = "DESCARGANDO PARTIDOS DEL D√çA...";
            const dailyUrl = `https://docs.google.com/spreadsheets/d/${DEFAULT_ID}/gviz/tq?tqx=out:csv&sheet=PARTIDOS+DEL+DIA&range=D1:F100`;
            const dailyResponse = await fetch(dailyUrl);
            const dailyCsv = await dailyResponse.text();
            const dailyMatches = dailyCsv.split('\n').map(line => line.split(',').map(c => c.replace(/"/g, '').trim()));

            // 2. Procesar cada liga
            for (let league of leagues) {
                statusText.innerText = `ANALIZANDO: ${league.name}...`;
                const data = await fetchHoja(league.sheet);
                if (!data) continue;

                dailyMatches.forEach(match => {
                    const homeName = match[0];
                    const awayName = match[2];
                    if (!homeName || homeName === "LOCAL") return;

                    const lData = data.locales.find(e => e.nombre.toUpperCase() === homeName.toUpperCase());
                    const vData = data.visitantes.find(e => e.nombre.toUpperCase() === awayName.toUpperCase());

                    if (lData && vData) {
                        const xGL = ((lData.gf/lData.gp)/data.ligaPromedio.gfl) * ((vData.ga/vData.gp)/data.ligaPromedio.gav) * data.ligaPromedio.gfl;
                        const xGV = ((vData.gf/vData.gp)/data.ligaPromedio.gfv) * ((lData.ga/lData.gp)/data.ligaPromedio.gal) * data.ligaPromedio.gfv;

                        // Poisson para mercados
                        let pL = [], pV = [];
                        for(let i=0; i<=6; i++) { pL[i] = poisson(i, xGL); pV[i] = poisson(i, xGV); }
                        
                        let u25 = 0;
                        for(let i=0; i<=2; i++) for(let j=0; j<=2; j++) if(i+j <= 2) u25 += pL[i]*pV[j];
                        
                        const bttsY = 1 - (pL[0] + pV[0] - (pL[0]*pV[0]));
                        const markets = [
                            { n: 'OVER 2.5', p: 1 - u25 },
                            { n: 'UNDER 2.5', p: u25 },
                            { n: 'BTTS YES', p: bttsY },
                            { n: 'BTTS NO', p: 1 - bttsY }
                        ];

                        markets.forEach(m => {
                            insertarFilaGlobal(league.name, homeName, awayName, xGL, xGV, m);
                        });
                    }
                });
            }

            document.getElementById('globalResultsPanel').style.display = 'block';
            window.scrollTo({ top: document.getElementById('globalResultsPanel').offsetTop, behavior: 'smooth' });

        } catch (e) {
            console.error(e);
            alert("Error en el escaneo global.");
        } finally {
            overlay.style.display = 'none';
        }
    }

    function insertarFilaGlobal(liga, local, visita, xgl, xgv, market) {
        const tbody = document.getElementById('globalTableBody');
        const rowId = 'row_' + Math.random().toString(36).substr(2, 9);
        const fairOdd = (1 / market.p).toFixed(2);
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><span class="league-tag">${liga}</span></td>
            <td class="team-cell">${local} vs ${visita}</td>
            <td class="xg-cell">${xgl.toFixed(1)} / ${xgv.toFixed(1)}</td>
            <td style="font-weight:bold">${market.n}</td>
            <td style="color:var(--primary)">${(market.p*100).toFixed(0)}%</td>
            <td style="font-family:monospace">${fairOdd}</td>
            <td><input type="number" step="0.01" class="input-odds-small" placeholder="Cuota" oninput="validarValorGlobal('${rowId}', ${market.p})"></td>
            <td id="val_${rowId}">--</td>
            <td><button class="btn-send-bet" id="btn_${rowId}" onclick="enviarApuestaGlobal('${liga}', '${local}', '${visita}', '${market.n}', ${market.p}, ${fairOdd}, '${rowId}')">SEND</button></td>
        `;
        tbody.appendChild(tr);
    }

    function validarValorGlobal(rowId, prob) {
        const row = document.getElementById('val_' + rowId).parentElement;
        const input = row.querySelector('input');
        const valCell = document.getElementById('val_' + rowId);
        const btn = document.getElementById('btn_' + rowId);
        const cuota = parseFloat(input.value);

        if (cuota > 1) {
            const edge = (prob * cuota) - 1;
            const edgePct = (edge * 100).toFixed(1);
            valCell.innerHTML = `<span class="value-badge ${edge > 0 ? 'positive' : 'negative'}">${edgePct}%</span>`;
            if (edge > 0) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        } else {
            valCell.innerHTML = '--';
            btn.classList.remove('active');
        }
    }

    function enviarApuestaGlobal(liga, local, visita, mercado, prob, justa, rowId) {
        const row = document.getElementById('val_' + rowId).parentElement;
        const cuota = parseFloat(row.querySelector('input').value);
        
        const STORAGE_KEY = 'betags_pre_match';
        let currentBets = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

        const newPick = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            teams: `${liga}: ${local} vs ${visita}`,
            market: mercado,
            prob: prob,
            fair_odd: justa,
            odd: cuota,
            edge: ((prob * cuota - 1) * 100).toFixed(1) + '%',
            stake: 1, // Stake obligatorio 1
            status: 'pending',
            profit: 0
        };

        currentBets.push(newPick);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(currentBets));
        
        alert("¬°APUESTA ENVIADA! Stake: 1");
        window.location.href = 'roi2.html';
    }

    // --- FUNCIONES ORIGINALES (SIN ELIMINAR NADA) ---

    async function cargarDatosLigaIndividual() {
        const sheet = document.getElementById('leagueSelect').value;
        if (!sheet) return;
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        const data = await fetchHoja(sheet);
        if (data) {
            ligasCache[sheet] = data;
            const hS = document.getElementById('homeTeamSelect');
            const aS = document.getElementById('awayTeamSelect');
            hS.innerHTML = '<option value="">LOCAL...</option>';
            aS.innerHTML = '<option value="">VISITA...</option>';
            data.locales.map(e => e.nombre).sort().forEach(n => {
                hS.options.add(new Option(n, n));
                aS.options.add(new Option(n, n));
            });
        }
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function calcularXGIndividual() {
        const sheet = document.getElementById('leagueSelect').value;
        const home = document.getElementById('homeTeamSelect').value;
        const away = document.getElementById('awayTeamSelect').value;
        const data = ligasCache[sheet];

        if (home && away && data) {
            const lD = data.locales.find(e => e.nombre === home);
            const vD = data.visitantes.find(e => e.nombre === away);
            
            const xGL = ((lD.gf/lD.gp)/data.ligaPromedio.gfl) * ((vD.ga/vD.gp)/data.ligaPromedio.gav) * data.ligaPromedio.gfl;
            const xGV = ((vD.gf/vD.gp)/data.ligaPromedio.gfv) * ((lD.ga/lD.gp)/data.ligaPromedio.gal) * data.ligaPromedio.gfv;

            document.getElementById('ind_xg_l').innerText = xGL.toFixed(2);
            document.getElementById('ind_xg_v').innerText = xGV.toFixed(2);
            
            let pL = [], pV = [];
            for(let i=0; i<=6; i++) { pL[i] = poisson(i, xGL); pV[i] = poisson(i, xGV); }
            
            // Render Chart
            const chart = document.getElementById('golesChart');
            chart.innerHTML = '';
            for(let i=0; i<=6; i++){
                const g = document.createElement('div');
                g.className = 'bar-group';
                g.innerHTML = `<div style="display:flex;gap:3px;height:100%;align-items:flex-end;"><div class="bar" style="height:${pL[i]*150}%"></div><div class="bar away" style="height:${pV[i]*150}%"></div></div><div class="bar-label">${i}</div>`;
                chart.appendChild(g);
            }
            document.getElementById('xgPanel').style.display = 'block';
        }
    }

    function agregarNuevaLiga() {
        const input = document.getElementById('newSheetName');
        let name = input.value.trim().toUpperCase();
        if (!name) return;
        let leagues = getSavedLeagues();
        if (leagues.some(l => l.sheet === name)) return alert("Ya existe.");
        leagues.push({ name, sheet: name });
        localStorage.setItem('betags_custom_leagues', JSON.stringify(leagues));
        renderLeagueSelect();
        input.value = "";
    }

    function borrarLigaSeleccionada() {
        const sheet = document.getElementById('leagueSelect').value;
        if (!sheet) return;
        if (confirm("¬øBorrar liga?")) {
            let leagues = getSavedLeagues().filter(l => l.sheet !== sheet);
            localStorage.setItem('betags_custom_leagues', JSON.stringify(leagues));
            renderLeagueSelect();
        }
    }

    window.onload = () => {
        renderLeagueSelect();
        if (getSavedLeagues().length > 0) cargarDatosLigaIndividual();
    };
</script>
</body>
</html>
