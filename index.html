<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Liga MX â€“ Descubrimiento de Patrones & Recomendaciones</title>
<style>
  :root{
    --bg:#0e1020; --panel:#161a2e; --panel2:#1d2240; --muted:#a7acc8; --text:#e8eaf2;
    --border:#2a2e4a; --accent:#5dd4a4; --accent2:#7aa2ff; --warn:#ffb84d; --danger:#ff6b6b;
    --chip:#2a2f55; --table:#13172b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  header{position:sticky;top:0;z-index:5;padding:16px;border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(14,16,32,.98), rgba(14,16,32,.92))}
  header h1{margin:0 0 6px;font-size:20px}
  header .sub{color:var(--muted);font-size:12px}
  .wrap{max-width:1300px;margin:0 auto;padding:18px 16px 40px}
  .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .btn{background:var(--accent2);color:#0c1122;border:0;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn.alt{background:var(--chip);color:var(--text);border:1px solid var(--border)}
  input[type=file]{display:none}
  .file-label{background:var(--accent2);color:#0c1122;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer}
  .grid{display:grid;gap:12px;grid-template-columns: repeat(12,1fr)}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
  .card h3{margin:0 0 10px;font-size:14px;color:var(--muted);letter-spacing:.02em;text-transform:uppercase}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:12px;color:var(--muted)}
  .field input,.field select{background:var(--panel2);color:var(--text);border:1px solid var(--border);
    border-radius:8px;padding:8px 9px}
  .pill{font-weight:700;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:var(--muted);font-size:12px}
  .muted{color:var(--muted)} .small{font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0;background:var(--table);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  thead th{position:sticky;top:128px;background:linear-gradient(180deg,#1a1f3a,#161b33);
    color:var(--muted);font-size:12px;text-align:left;padding:10px 8px;border-bottom:1px solid var(--border);cursor:pointer;white-space:nowrap}
  tbody td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:top}
  tbody tr:hover{background:#1a1f3a}
  .right{text-align:right}.center{text-align:center}
  .good{color:var(--accent)} .bad{color:var(--danger)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:var(--chip);border:1px solid var(--border);padding:6px 8px;border-radius:999px;font-size:12px}
  .scroll-x{overflow:auto}
  .tag{display:inline-block;padding:2px 6px;border-radius:6px;border:1px solid var(--border);background:var(--panel2);font-size:11px;color:var(--muted)}
  .rec-row strong{font-weight:800}
  @media (max-width:980px){ thead th{top:168px} .grid{grid-template-columns: repeat(6,1fr)} }
  @media (max-width:620px){ thead th{top:208px} .grid{grid-template-columns: repeat(2,1fr)} }
</style>
</head>
<body>
  <header>
    <h1>Patrones & Recomendaciones â€“ Liga MX</h1>
    <div class="sub">Carga tu JSON, detecta patrones por equipo y genera entradas sugeridas con EV.</div>
    <div class="bar" style="margin-top:10px">
      <label class="file-label" for="fileInput">ðŸ“‚ Cargar JSON</label>
      <input type="file" id="fileInput" accept=".json,application/json">
      <button class="btn alt" id="btnPaste">Pegar JSON</button>
      <button class="btn ghost" id="btnReset">Limpiar</button>
      <span class="pill" id="pillCount">0 filas</span>
      <span class="pill" id="pillNext">PrÃ³ximos: 0</span>
      <span class="pill" id="pillRecs">Recs: 0</span>
    </div>
  </header>

  <div class="wrap">
    <!-- ParÃ¡metros de modelado -->
    <div class="grid">
      <div class="card" style="grid-column: span 8;">
        <h3>ParÃ¡metros del modelo</h3>
        <div class="grid" style="gap:10px">
          <div class="field" style="grid-column: span 3;">
            <label>Partidos recientes (N)</label>
            <input id="paramN" type="number" min="3" max="30" step="1" value="10">
          </div>
          <div class="field" style="grid-column: span 3;">
            <label>Peso recency (0â€“1) â€” exponencial</label>
            <input id="paramAlpha" type="number" min="0" max="1" step="0.05" value="0.30">
          </div>
          <div class="field" style="grid-column: span 3;">
            <label>MÃ¡x. goles en matriz Poisson</label>
            <input id="paramGMax" type="number" min="4" max="12" step="1" value="8">
          </div>
          <div class="field" style="grid-column: span 3;">
            <label>Ventana rachas (Ãºltimos M)</label>
            <input id="paramStreak" type="number" min="3" max="15" step="1" value="5">
          </div>

          <div class="field" style="grid-column: span 3;">
            <label>Prob. mÃ­nima de mercado</label>
            <input id="paramPMin" type="number" step="0.01" value="0.45">
          </div>
          <div class="field" style="grid-column: span 3;">
            <label>EV mÃ­nimo</label>
            <input id="paramEVMin" type="number" step="0.01" value="0.02">
          </div>
          <div class="field" style="grid-column: span 3;">
            <label>Mercados a considerar</label>
            <select id="paramMarkets" multiple size="4">
              <option selected value="1X2">1X2</option>
              <option selected value="O2.5">Over 2.5</option>
              <option selected value="U2.5">Under 2.5</option>
              <option selected value="BTTS">BTTS (GG)</option>
            </select>
          </div>
          <div class="field" style="grid-column: span 3;">
            <label>Usar medias H/A (mÃ¡s realista)</label>
            <select id="paramHomeAway">
              <option value="1" selected>SÃ­</option>
              <option value="0">No (global)</option>
            </select>
          </div>
        </div>
        <div class="bar" style="margin-top:10px">
          <button class="btn" id="btnRun">Analizar & Sugerir</button>
          <button class="btn ghost" id="btnExportRecs">Exportar recomendaciones CSV</button>
          <span class="muted small">Tip: ajusta N y Î± para datasets pequeÃ±os o desactualizados.</span>
        </div>
      </div>

      <div class="card" style="grid-column: span 4;">
        <h3>Estado del dataset</h3>
        <div class="field">
          <div class="chips" id="chipsMeta"></div>
        </div>
        <div class="field">
          <label class="small">Filtrar Liga</label>
          <select id="league" multiple size="6"></select>
        </div>
        <div class="field">
          <label class="small">Buscar global</label>
          <input id="q" type="search" placeholder="Equipo, marcador, etiquetaâ€¦">
        </div>
      </div>
    </div>

    <!-- Recomendaciones -->
    <div class="card" style="margin-top:12px">
      <h3>Recomendaciones (valor esperado positivo)</h3>
      <div class="scroll-x">
        <table id="tblRecs">
          <thead><tr>
            <th>Fecha</th><th>Partido</th><th>Mercado</th><th>Cuota</th>
            <th>Prob.</th><th>EV</th><th>Modelo</th><th>Razonamiento</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Tabla base -->
    <div class="card" style="margin-top:12px">
      <h3>Partidos del JSON</h3>
      <div class="scroll-x">
        <table id="tblBase">
          <thead id="theadBase"></thead>
          <tbody id="tbodyBase"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(()=>{

// ===== Utilidades generales =====
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const MONTH_MAP = {"ene.":0,"feb.":1,"mar.":2,"abr.":3,"may.":4,"jun.":5,"jul.":6,"ago.":7,"sept.":8,"sep.":8,"oct.":9,"nov.":10,"dic.":11};
const WDAYS = ["lun.","mar.","miÃ©.","mie.","jue.","vie.","sÃ¡b.","sab.","dom."];

function parseSpanishDate(s){
  if(!s) return null;
  try{
    let str = String(s).trim().toLowerCase();
    for(const w of WDAYS){ if(str.startsWith(w)){ str = str.replace(w,"").replace(",","").trim(); break; } }
    const parts = str.split(/\s+/);
    // admite "25 jul. 2025 19:00" o "2025-07-25 19:00"
    if(parts.length>=3 && MONTH_MAP[parts[1]]!==undefined){
      const d = Number(parts[0]); const m = MONTH_MAP[parts[1]]; const y = Number(parts[2]);
      let hh=0, mm=0; if(parts[3]){ [hh,mm] = parts[3].split(":").map(Number); }
      return new Date(y,m,d,hh||0,mm||0);
    }
    const dt = new Date(s);
    return isNaN(dt)? null: dt;
  }catch(e){ return null; }
}
const toNum = v => {
  if(v==null) return null;
  const s = String(v).replace("%","").replace(",",".").trim();
  if(s==="") return null;
  const n = Number(s);
  return Number.isFinite(n)? n : null;
}
const fmtPct = p=> (p==null? "â€”" : (p*100).toFixed(1)+"%");
const fmtProb = p=> (p==null? "â€”" : (p*100).toFixed(1)+"%");
const fmt2 = n=> n==null? "â€”" : Number(n).toFixed(2);
const csvEscape = s=>{
  if(s==null) return "";
  s = String(s);
  return (s.includes('"')||s.includes(",")||s.includes("\n"))? `"${s.replace(/"/g,'""')}"` : s;
}
function download(name, content, mime="text/csv;charset=utf-8"){
  const blob = new Blob([content],{type:mime});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
}

// ===== Carga =====
let RAW=[], DATA=[];
let FUTURE=[], PAST=[];
let sortBase = {key:"Date",dir:1};

$("#fileInput").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const txt = await f.text(); loadFromText(txt);
});
$("#btnPaste").addEventListener("click", ()=>{
  const txt = prompt("Pega aquÃ­ el JSON (array de objetos):");
  if(!txt) return;
  loadFromText(txt);
});
$("#btnReset").addEventListener("click", ()=>{
  RAW=[]; DATA=[]; FUTURE=[]; PAST=[];
  $("#tbodyBase").innerHTML=""; $("#tblRecs tbody").innerHTML="";
  $("#chipsMeta").innerHTML=""; $("#league").innerHTML="";
  $("#pillCount").textContent="0 filas"; $("#pillNext").textContent="PrÃ³ximos: 0"; $("#pillRecs").textContent="Recs: 0";
});

function loadFromText(txt){
  try{
    RAW = JSON.parse(txt);
    DATA = RAW.map(augmentRow).filter(r => r);
    splitFuturePast();
    populateLeagueFilter();
    buildBaseTable();
    renderBase();
    renderMeta();
  }catch(err){
    alert("No se pudo parsear el JSON: "+err.message);
  }
}

function augmentRow(r){
  const row = {...r};
  // Match â†’ Home/Away
  if(row.Match && typeof row.Match==="string" && row.Match.includes(" - ")){
    const [h,a] = row.Match.split(" - ").map(s=>s.trim());
    row.Home = row.Home||h; row.Away = row.Away||a;
  }
  row._dt = parseSpanishDate(row.Date);
  // Goles FT/HT
  const [hht,aht] = parseScore(row["Result HT"]);
  const [hft,aft] = parseScore(row["Result FT"]);
  row._HT_H=hht; row._HT_A=aht; row._FT_H=hft; row._FT_A=aft;
  if(hft!=null && aft!=null){ row._TotalGoals = hft+aft; row._GG = (hft>0 && aft>0); }
  // NumÃ©ricos:
  ["Home Position","Away Position","Odd","Odd 1 PreMatch","Odd X PreMatch","Odd 2 PreMatch",
   "Home Total Shots at FT","Away Total Shots at FT",
   "Home Ball Possession at FT","Away Ball Possession at FT",
   "Home Corners at FT","Away Corners at FT"].forEach(k=> row[k]=toNum(row[k]));
  row["Success Rate"] = row["Success Rate"]??""; // % string
  row["Overall ROI"]  = row["Overall ROI"]??"";
  return row;
}
function parseScore(s){
  if(!s) return [null,null];
  const m = String(s).trim().match(/^(\d+)\s*-\s*(\d+)$/);
  return m? [Number(m[1]),Number(m[2])] : [null,null];
}
function splitFuturePast(){
  const now = new Date();
  FUTURE = DATA.filter(r => (!r._FT_H && !r._FT_A) || (r._dt && r._dt>now));
  PAST   = DATA.filter(r => (r._FT_H!=null && r._FT_A!=null) && r._dt && r._dt<=now);
  $("#pillCount").textContent = DATA.length+" filas";
  $("#pillNext").textContent  = "PrÃ³ximos: "+FUTURE.length;
}
function populateLeagueFilter(){
  const leagues = Array.from(new Set(DATA.map(x=>x.League).filter(Boolean))).sort((a,b)=> String(a).localeCompare(String(b),'es'));
  const sel = $("#league"); sel.innerHTML="";
  for(const l of leagues){ const opt=document.createElement("option"); opt.value=l; opt.textContent=l; sel.appendChild(opt); }
}

// ===== Tabla base =====
const BASE_COLS = [
  {key:"Date",label:"Fecha"},
  {key:"League",label:"Liga"},
  {key:"Home",label:"Local"},
  {key:"Away",label:"Visitante"},
  {key:"Result HT",label:"HT"},
  {key:"Result FT",label:"FT"},
  {key:"Odd 1 PreMatch",label:"Odd 1",align:"right"},
  {key:"Odd X PreMatch",label:"Odd X",align:"right"},
  {key:"Odd 2 PreMatch",label:"Odd 2",align:"right"},
  {key:"Overall ROI",label:"ROI",align:"right"},
  {key:"Success Rate",label:"Ã‰xito",align:"right"},
  {key:"Result",label:"Etiqueta"}
];
function buildBaseTable(){
  const thead=$("#theadBase"); thead.innerHTML="";
  const tr=document.createElement("tr");
  BASE_COLS.forEach(c=>{
    const th=document.createElement("th");
    th.textContent=c.label; if(c.align) th.classList.add(c.align);
    th.onclick=()=>{ sortBase.key=c.key; sortBase.dir*=-1; renderBase(); };
    tr.appendChild(th);
  });
  thead.appendChild(tr);
}
function renderBase(){
  // filtros simples: liga + query
  const sel = $("#league");
  const leagues = Array.from(sel.selectedOptions).map(o=>o.value);
  const q = $("#q").value.trim().toLowerCase();
  let arr = DATA.filter(r=>{
    if(leagues.length && !leagues.includes(r.League)) return false;
    if(q){
      const blob = JSON.stringify(r).toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  });
  if(sortBase.key){
    const k=sortBase.key, dir=sortBase.dir;
    arr.sort((a,b)=>{
      const va = norm(a[k]); const vb = norm(b[k]);
      if(va<vb) return -1*dir; if(va>vb) return 1*dir; return 0;
    });
  }
  const tbody=$("#tbodyBase"); tbody.innerHTML="";
  for(const r of arr){
    const tr=document.createElement("tr");
    for(const c of BASE_COLS){
      const td=document.createElement("td");
      let v = r[c.key]; if(c.key==="Date" && r._dt) v = r._dt.toLocaleString();
      td.textContent = v==null? "" : v;
      if(c.align) td.classList.add(c.align);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}
function norm(v){
  if(v==null) return -Infinity;
  if(v instanceof Date) return v.getTime();
  const n = toNum(v); return n!=null? n : String(v).toLowerCase();
}
$("#league").addEventListener("change", renderBase);
$("#q").addEventListener("input", renderBase);

// ===== Meta =====
function renderMeta(){
  const chips=$("#chipsMeta"); chips.innerHTML="";
  const leagues = new Set(DATA.map(x=>x.League).filter(Boolean));
  const teams = new Set(DATA.flatMap(x=>[x.Home,x.Away]).filter(Boolean));
  addChip(`${leagues.size} ligas`, chips);
  addChip(`${teams.size} equipos`, chips);
  const years = new Set(DATA.map(r=> r._dt? r._dt.getFullYear(): null).filter(Boolean));
  addChip(`AÃ±os: ${Array.from(years).sort().join(", ")}`, chips);
}
function addChip(text, container){
  const s=document.createElement("span"); s.className="chip"; s.textContent=text; container.appendChild(s);
}

// ===== Motor de patrones =====

// 1) Construir Ã­ndices por equipo
function buildTeamIndex(pastRows){
  const idx = {};
  for(const r of pastRows){
    if(!r.Home || !r.Away) continue;
    if(!idx[r.Home]) idx[r.Home] = {home:[],away:[],all:[]};
    if(!idx[r.Away]) idx[r.Away] = {home:[],away:[],all:[]};
    idx[r.Home].home.push(r); idx[r.Home].all.push({...r,_side:"H"});
    idx[r.Away].away.push(r); idx[r.Away].all.push({...r,_side:"A"});
  }
  // ordenar por fecha
  for(const t of Object.keys(idx)){
    ["home","away","all"].forEach(k=> idx[t][k].sort((a,b)=> a._dt-b._dt));
  }
  return idx;
}

// 2) Medias ponderadas (recency Î±) para goles a favor/en contra
function weightedGoalRates(rows, side, N, alpha){ // side "H" o "A" o "ALL"
  // tomamos Ãºltimos N partidos (segÃºn side)
  let arr = side==="H"? rows.home : side==="A"? rows.away : rows.all;
  if(!arr || !arr.length) return {gf:0.9, ga:0.9, n:0};
  arr = arr.slice(-N);
  // pesos exponenciales (mÃ¡s recientes pesan mÃ¡s)
  const m = arr.length;
  let wsum=0, gf=0, ga=0;
  for(let i=0;i<m;i++){
    const r = arr[m-1-i]; // i=0 mÃ¡s reciente
    const w = Math.pow(1-alpha, i);
    const gfor  = r._FT_H!=null && r._FT_A!=null ? (r._side==="A"? r._FT_A : r._FT_H) : 0;
    const gagen = r._FT_H!=null && r._FT_A!=null ? (r._side==="A"? r._FT_H : r._FT_A) : 0;
    gf += w*gfor; ga += w*gagen; wsum += w;
  }
  if(wsum===0) return {gf:0.9,ga:0.9,n:arr.length};
  return {gf:gf/wsum, ga:ga/wsum, n:arr.length};
}

// 3) Fuerzas ofensiva/defensiva simples (tipo Dixon-Coles lite)
function leagueAverages(pastRows){
  let hGoals=0,aGoals=0,c=0;
  for(const r of pastRows){
    if(r._FT_H==null || r._FT_A==null) continue;
    hGoals+=r._FT_H; aGoals+=r._FT_A; c++;
  }
  const muH = c? hGoals/c : 1.2;
  const muA = c? aGoals/c : 1.0;
  return {muH, muA};
}

// 4) Matriz Poisson y mercados
function poissonPmf(k, lambda){ return Math.exp(-lambda) * Math.pow(lambda, k) / factorial(k); }
const FACTS = [1];
function factorial(n){
  for(let i=FACTS.length;i<=n;i++) FACTS[i]=FACTS[i-1]*i;
  return FACTS[n];
}
function matchDistribution(lh, la, gmax){
  // devuelve matriz P(X=h, Y=a) hasta gmax
  const PX = Array.from({length:gmax+1},(_,x)=>poissonPmf(x,lh));
  const PY = Array.from({length:gmax+1},(_,y)=>poissonPmf(y,la));
  const M = Array.from({length:gmax+1},()=>Array(gmax+1).fill(0));
  for(let x=0;x<=gmax;x++) for(let y=0;y<=gmax;y++) M[x][y]=PX[x]*PY[y];
  // masa fuera de rango
  const tailH = 1-PX.reduce((a,b)=>a+b,0);
  const tailA = 1-PY.reduce((a,b)=>a+b,0);
  // aproximaciÃ³n: aÃ±adir cola a Ãºltima fila/col
  for(let x=0;x<=gmax;x++) M[x][gmax]+=PX[x]*tailA;
  for(let y=0;y<=gmax;y++) M[gmax][y]+=PY[y]*tailH;
  M[gmax][gmax]+=tailH*tailA;
  return M;
}
function probFromMatrix(M, fn){
  let p=0;
  for(let x=0;x<M.length;x++)
    for(let y=0;y<M[x].length;y++)
      if(fn(x,y)) p+=M[x][y];
  return Math.min(Math.max(p,0),1);
}
function probsFromLambdas(lh, la, gmax){
  const M = matchDistribution(lh,la,gmax);
  const pH = probFromMatrix(M,(x,y)=>x>y);
  const pD = probFromMatrix(M,(x,y)=>x===y);
  const pA = probFromMatrix(M,(x,y)=>x<y);
  const pO25 = probFromMatrix(M,(x,y)=>x+y>=3);
  const pU25 = 1-pO25;
  const pBTTS = probFromMatrix(M,(x,y)=>x>0 && y>0);
  return {pH,pD,pA,pO25,pU25,pBTTS};
}

// 5) Rachas y patrones simples
function streakStats(rows, team, M){
  // rows: idx[team].all (ordenado por fecha)
  const arr = rows.slice(-M);
  let over = 0, btts=0, win=0, draw=0, lose=0;
  for(const r of arr){
    if(r._FT_H==null||r._FT_A==null) continue;
    const tg = r._FT_H + r._FT_A;
    if(tg>=3) over++;
    if(r._FT_H>0 && r._FT_A>0) btts++;
    const isH = r._side==="H";
    if((isH && r._FT_H>r._FT_A) || (!isH && r._FT_A>r._FT_H)) win++;
    else if(r._FT_H===r._FT_A) draw++;
    else lose++;
  }
  return {overRate: over/arr.length || 0, bttsRate:btts/arr.length || 0, winRate:win/arr.length||0, sample:arr.length};
}

// 6) Generar recomendaciones
$("#btnRun").addEventListener("click", generateRecommendations);

function generateRecommendations(){
  const N = Number($("#paramN").value)||10;
  const alpha = Number($("#paramAlpha").value)||0.3;
  const gmax = Math.max(5, Math.min(12, Number($("#paramGMax").value)||8));
  const Mstreak = Number($("#paramStreak").value)||5;
  const pMin = Number($("#paramPMin").value)||0.45;
  const evMin = Number($("#paramEVMin").value)||0.02;
  const useHA = $("#paramHomeAway").value==="1";
  const wantedMkts = Array.from($("#paramMarkets").selectedOptions).map(o=>o.value);

  // filtrar por liga seleccionada para modelar, si aplica
  const leaguesSel = Array.from($("#league").selectedOptions).map(o=>o.value);
  const past = leaguesSel.length? PAST.filter(r=>leaguesSel.includes(r.League)) : PAST;
  const fut  = leaguesSel.length? FUTURE.filter(r=>leaguesSel.includes(r.League)) : FUTURE;

  if(!past.length){ alert("No hay historial (pasado) suficiente para modelar."); return; }

  const lg = leagueAverages(past);
  const idx = buildTeamIndex(past);

  const recs = [];
  for(const f of fut){
    const home = f.Home, away = f.Away;
    if(!home || !away) continue;
    const H = idx[home], A = idx[away];
    if(!H || !A) continue;

    // rates H/A o global
    const sideH = useHA?"H":"ALL", sideA = useHA?"A":"ALL";
    const hFor = weightedGoalRates(H, sideH, N, alpha); // gf, ga
    const aFor = weightedGoalRates(A, sideA, N, alpha);

    // fuerza-ofensiva/defensiva vs promedio liga
    // lambda local â‰ˆ (promedio local de H) * (promedio concedido visitante de A) / liga referencia
    // AÃ±adimos un suavizado mÃ­nimo para evitar ceros
    const eps = 0.05;
    const offH = Math.max(hFor.gf, eps);
    const defA = Math.max(aFor.ga, eps);
    const offA = Math.max(aFor.gf, eps);
    const defH = Math.max(hFor.ga, eps);
    const lambdaH = offH * (defA) / (lg.muA || 1.0);
    const lambdaA = offA * (defH) / (lg.muH || 1.0);

    const probs = probsFromLambdas(lambdaH, lambdaA, gmax);

    // Rachas para contexto
    const stH = streakStats(H.all, home, Mstreak);
    const stA = streakStats(A.all, away, Mstreak);

    // Cuotas (si existen). Si no, seguir proponiendo con cuota estimada "â€”"
    const o1 = toNum(f["Odd 1 PreMatch"]);
    const ox = toNum(f["Odd X PreMatch"]);
    const o2 = toNum(f["Odd 2 PreMatch"]);
    const oO25 = toNum(f["Odd Over 2.5"]) ?? toNum(f["Odd Over2.5"]) ?? null;
    const oU25 = toNum(f["Odd Under 2.5"]) ?? toNum(f["Odd Under2.5"]) ?? null;
    const oBTTS = toNum(f["Odd BTTS"]) ?? toNum(f["Odd GG"]) ?? null;

    // Probar mercados solicitados
    const cand = [];
    if(wantedMkts.includes("1X2")){
      pushEV(cand, "1", o1, probs.pH, pMin, evMin, `Î»H=${lambdaH.toFixed(2)}, Î»A=${lambdaA.toFixed(2)}`);
      pushEV(cand, "X", ox, probs.pD, pMin, evMin, `Î»H=${lambdaH.toFixed(2)}, Î»A=${lambdaA.toFixed(2)}`);
      pushEV(cand, "2", o2, probs.pA, pMin, evMin, `Î»H=${lambdaH.toFixed(2)}, Î»A=${lambdaA.toFixed(2)}`);
    }
    if(wantedMkts.includes("O2.5")){
      pushEV(cand, "Over 2.5", oO25, probs.pO25, pMin, evMin, `TGâ‰ˆ${(lambdaH+lambdaA).toFixed(2)}`);
    }
    if(wantedMkts.includes("U2.5")){
      pushEV(cand, "Under 2.5", oU25, probs.pU25, pMin, evMin, `TGâ‰ˆ${(lambdaH+lambdaA).toFixed(2)}`);
    }
    if(wantedMkts.includes("BTTS")){
      pushEV(cand, "BTTS SÃ­", oBTTS, probs.pBTTS, pMin, evMin, `Î»H=${lambdaH.toFixed(2)}, Î»A=${lambdaA.toFixed(2)}`);
    }

    // Enriquecer con razones (patrones)
    for(const c of cand){
      const reasons = [];
      reasons.push(`Ãšltimos ${Math.min(N, (idx[home]?.all?.length||0))} ${home}: Overâ‰¥3 en ${(stH.overRate*100).toFixed(0)}% Â· BTTS ${(stH.bttsRate*100).toFixed(0)}%`);
      reasons.push(`Ãšltimos ${Math.min(N, (idx[away]?.all?.length||0))} ${away}: Overâ‰¥3 en ${(stA.overRate*100).toFixed(0)}% Â· BTTS ${(stA.bttsRate*100).toFixed(0)}%`);
      // Sesgo de localÃ­a implÃ­cito si Î»H>Î»A
      if(lambdaH>lambdaA+0.2) reasons.push("Modelo favorece al local (Î»H>Î»A)");
      if(lambdaA>lambdaH+0.2) reasons.push("Modelo favorece al visitante (Î»A>Î»H)");
      if((stH.overRate+stA.overRate)/2>0.6) reasons.push("Tendencia Over en ambos");
      if((stH.bttsRate+stA.bttsRate)/2>0.6) reasons.push("Tendencia BTTS en ambos");
      c.reasons = reasons;
      c.date = f._dt ? f._dt.toLocaleString() : (f.Date||"â€”");
      c.match = `${home} vs ${away}`;
      c.model = `Poisson gmax=${gmax}, N=${N}, Î±=${alpha}`;
      c.league = f.League || "";
    }
    recs.push(...cand);
  }

  // Ordenar por EV desc
  recs.sort((a,b)=> (b.EV??-1) - (a.EV??-1));
  renderRecs(recs);
}

function pushEV(list, market, odd, p, pMin, evMin, note){
  if(p==null || isNaN(p)) return;
  if(pMin!=null && p<pMin) return; // prob. mÃ­nima
  let EV=null;
  if(odd && odd>1) EV = p*odd - 1;
  // Si no hay cuota, proponemos igual pero marcamos EV como "â€”" y priorizamos por p
  if(odd==null){
    if(p>=Math.max(pMin,0.55)) list.push({Market:market, Odd:"â€”", P:p, EV:null, Note:note});
    return;
  }
  if(EV>=evMin) list.push({Market:market, Odd:odd, P:p, EV:EV, Note:note});
}

function renderRecs(recs){
  const tbody = $("#tblRecs tbody"); tbody.innerHTML="";
  let count=0;
  for(const r of recs){
    const tr = document.createElement("tr"); tr.className="rec-row";
    tr.innerHTML = `
      <td>${r.date||"â€”"}</td>
      <td><strong>${r.match||"â€”"}</strong><div class="small muted">${r.league||""}</div></td>
      <td><span class="tag">${r.Market}</span></td>
      <td class="right">${r.Odd=="â€”"?"â€”":fmt2(r.Odd)}</td>
      <td class="right">${fmtProb(r.P)}</td>
      <td class="right ${r.EV!=null && r.EV>=0? "good":"bad"}">${r.EV==null?"â€”":fmt2(r.EV)}</td>
      <td class="small muted">${r.model||""}</td>
      <td class="small">${(r.reasons||[]).map(x=>`â€¢ ${x}`).join("<br>")}${r.Note? `<br><span class="muted">(${r.Note})</span>`:""}</td>
    `;
    tbody.appendChild(tr); count++;
  }
  $("#pillRecs").textContent = "Recs: "+count;
}

// ===== Exportar recomendaciones =====
$("#btnExportRecs").addEventListener("click", ()=>{
  const rows = Array.from($("#tblRecs tbody").children).map(tr=>{
    const tds = Array.from(tr.children).map(td=>td.innerText);
    return tds;
  });
  if(!rows.length){ alert("No hay recomendaciones para exportar."); return; }
  const headers = ["Fecha","Partido","Mercado","Cuota","Prob.","EV","Modelo","Razonamiento"];
  const lines = [headers.map(csvEscape).join(",")];
  for(const r of rows) lines.push(r.map(csvEscape).join(","));
  download("recomendaciones.csv", lines.join("\n"));
});

// ===== Listeners extra =====
$("#q").addEventListener("input", ()=>{}); // ya usado en renderBase()

// ===== Inicio: cabeceras vacÃ­as para estructura =====
buildBaseTable();

})();</script>
</body>
</html>