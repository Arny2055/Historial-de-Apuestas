<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BETAGS - Deep Analytics</title>
    <style>
        :root {
            --bg-dark: #0b0e14;
            --bg-card: #151921;
            --primary: #4dabf7;
            --accent-green: #51cf66;
            --accent-yellow: #fcc419;
            --text-white: #e9ecef;
            --text-muted: #adb5bd;
            --border: #2c3440;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-white);
            margin: 0;
            padding: 10px;
            display: flex; 
            justify-content: center;
        }

        .container { 
            width: 100%; 
            max-width: 430px; 
            padding-bottom: 40px;
        }

        h1 { font-size: 1.2rem; color: var(--primary); text-align: center; margin: 15px 0; letter-spacing: 2px; }

        /* Estilo Data Entry similar a la imagen */
        .section-title { font-size: 0.65rem; color: var(--primary); text-transform: uppercase; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; font-weight: bold; }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }

        .input-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        
        select { 
            width: 100%; 
            padding: 12px; 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            background: #0b0e14;
            color: white;
            font-size: 0.9rem;
            outline: none;
        }

        /* GrÃ¡fica de Probabilidades */
        .chart-container {
            height: 150px;
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 4px;
            margin: 20px 0;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end; }
        .bar { width: 100%; background: var(--primary); border-radius: 2px 2px 0 0; transition: height 0.5s ease; min-height: 2px; }
        .bar.away { background: var(--accent-green); }
        .bar-label { font-size: 0.6rem; color: var(--text-muted); margin-top: 5px; }

        /* Resumen de probabilidad superior */
        .probs-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .summary-box { 
            border: 1px solid var(--border); 
            border-radius: 10px; 
            padding: 10px; 
            text-align: left;
        }
        .summary-box.blue { border-left: 3px solid var(--primary); }
        .summary-box.green { border-left: 3px solid var(--accent-green); }
        .summary-box.yellow { border-left: 3px solid var(--accent-yellow); }

        .summary-title { font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; font-weight: bold; }
        .summary-val { font-size: 1.1rem; font-weight: 800; margin: 4px 0; }
        .summary-odds { font-size: 0.6rem; color: var(--accent-green); background: rgba(81, 207, 102, 0.1); padding: 2px 4px; border-radius: 4px; display: inline-block; }

        /* Tabla de mercados */
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 10px; }
        th { text-align: left; color: var(--text-muted); padding: 8px; font-weight: normal; border-bottom: 1px solid var(--border); }
        td { padding: 12px 8px; border-bottom: 1px solid var(--border); }
        .prob-cell { color: var(--primary); font-weight: bold; }
        .odds-cell { color: var(--text-white); }
        
        .action-btn { 
            background: #1e293b; 
            color: var(--primary); 
            border: none; 
            padding: 5px 8px; 
            border-radius: 4px; 
            font-size: 0.65rem; 
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .loading-text { color: var(--primary); text-align: center; font-size: 0.8rem; display: none; }
        #xgPanel { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>BETA<span>GS</span> ANALYTICS</h1>
    
    <div class="section-title"><span>ðŸ“Š</span> DATA ENTRY</div>
    <div class="card">
        <div class="input-grid">
            <select id="leagueSelect" onchange="cargarDatosLiga()">
                <option value="SPA">ESPAÃ‘A - LA LIGA</option>
                <option value="ENG">INGLATERRA - PREMIER</option>
                <option value="ITA">ITALIA - SERIE A</option>
                <option value="GER">ALEMANIA - BUNDESLIGA</option>
                <option value="FRA">FRANCIA - LIGUE 1</option>
            </select>
            <select id="homeTeamSelect" onchange="calcularXG()">
                <option value="">EQUIPO LOCAL...</option>
            </select>
            <select id="awayTeamSelect" onchange="calcularXG()">
                <option value="">EQUIPO VISITANTE...</option>
            </select>
        </div>
    </div>

    <div id="loading" class="loading-text">Sincronizando con base de datos...</div>

    <div id="xgPanel">
        <div class="section-title"><span>ðŸ“ˆ</span> DISTRIBUCIÃ“N DE PROBABILIDAD</div>
        <div class="card">
            <div class="chart-container" id="golesChart">
                </div>
        </div>

        <div class="probs-summary">
            <div class="summary-box blue">
                <div class="summary-title">OVER 0.5 HT</div>
                <div class="summary-val" id="ov05ht_val">0.0%</div>
                <div class="summary-odds" id="ov05ht_odds">C. Justa: 0.00</div>
            </div>
            <div class="summary-box green">
                <div class="summary-title">OVER 2.5 FT</div>
                <div class="summary-val" id="ov25ft_val">0.0%</div>
                <div class="summary-odds" id="ov25ft_odds">C. Justa: 0.00</div>
            </div>
            <div class="summary-box yellow">
                <div class="summary-title">BTTS (AMBOS)</div>
                <div class="summary-val" id="btts_val">0.0%</div>
                <div class="summary-odds" id="btts_odds">C. Justa: 0.00</div>
            </div>
        </div>

        <div class="card" style="padding: 5px;">
            <table>
                <thead>
                    <tr>
                        <th>MERCADO</th>
                        <th>PROB (%)</th>
                        <th>C. JUSTA</th>
                        <th>ACCIÃ“N</th>
                    </tr>
                </thead>
                <tbody id="marketsTable">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const SHEET_ID = '1lmUPv7SP0XYi9ns4jkj3RTCScxIN2pCfBJyMUp_kNRI';
    let dataGlobal = { locales: [], visitantes: [], liga: {} };

    function poisson(k, lambda) {
        return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k);
    }

    function factorial(n) {
        if (n === 0) return 1;
        let res = 1;
        for (let i = 1; i <= n; i++) res *= i;
        return res;
    }

    async function cargarDatosLiga() {
        const league = document.getElementById('leagueSelect').value;
        const loading = document.getElementById('loading');
        loading.style.display = 'block';
        document.getElementById('xgPanel').style.display = 'none';

        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${league}&range=A1:W50`;

        try {
            const response = await fetch(url);
            const csvText = await response.text();
            const filas = csvText.split('\n').map(linea => 
                linea.split(',').map(celda => celda.replace(/^"(.*)"$/, '$1').trim())
            );

            dataGlobal.locales = [];
            dataGlobal.visitantes = [];

            filas.forEach((cols, index) => {
                if (index > 0 && cols[1] && !isNaN(parseFloat(cols[2]))) {
                    dataGlobal.locales.push({ nombre: cols[1], gp: parseFloat(cols[2]), gf: parseFloat(cols[6]), ga: parseFloat(cols[7]) });
                    if (cols[13] && !isNaN(parseFloat(cols[14]))) {
                        dataGlobal.visitantes.push({ nombre: cols[13], gp: parseFloat(cols[14]), gf: parseFloat(cols[18]), ga: parseFloat(cols[19]) });
                    }
                }
            });

            let sumaGFL = 0, sumaGAL = 0, sumaPJL = 0, sumaGFV = 0, sumaGAV = 0, sumaPJV = 0;
            dataGlobal.locales.forEach(e => { sumaGFL += e.gf; sumaGAL += e.ga; sumaPJL += e.gp; });
            dataGlobal.visitantes.forEach(e => { sumaGFV += e.gf; sumaGAV += e.ga; sumaPJV += e.gp; });
            dataGlobal.liga = { gfl: sumaGFL / sumaPJL, gal: sumaGAL / sumaPJL, gfv: sumaGFV / sumaPJV, gav: sumaGAV / sumaPJV };

            actualizarSelectoresEquipos();
        } catch (error) {
            console.error("Error:", error);
        } finally {
            loading.style.display = 'none';
        }
    }

    function actualizarSelectoresEquipos() {
        const hS = document.getElementById('homeTeamSelect');
        const aS = document.getElementById('awayTeamSelect');
        hS.innerHTML = '<option value="">EQUIPO LOCAL...</option>';
        aS.innerHTML = '<option value="">EQUIPO VISITANTE...</option>';
        const nombres = dataGlobal.locales.map(e => e.nombre).sort();
        nombres.forEach(n => {
            hS.options.add(new Option(n, n));
            aS.options.add(new Option(n, n));
        });
    }

    function calcularXG() {
        const homeName = document.getElementById('homeTeamSelect').value;
        const awayName = document.getElementById('awayTeamSelect').value;
        if (!homeName || !awayName) return;

        const localData = dataGlobal.locales.find(e => e.nombre === homeName);
        const visitData = dataGlobal.visitantes.find(e => e.nombre === awayName);

        if (localData && visitData) {
            const xGL = ((localData.gf/localData.gp)/dataGlobal.liga.gfl) * ((visitData.ga/visitData.gp)/dataGlobal.liga.gav) * dataGlobal.liga.gfl;
            const xGV = ((visitData.gf/visitData.gp)/dataGlobal.liga.gfv) * ((localData.ga/localData.gp)/dataGlobal.liga.gal) * dataGlobal.liga.gfv;

            // Probabilidades
            let pL = [], pV = [];
            for(let i=0; i<=6; i++) { pL[i] = poisson(i, xGL); pV[i] = poisson(i, xGV); }

            renderChart(pL, pV);

            // CÃ¡lculos Mercados
            let u25 = 0, bttsNo = pL[0] + pV[0] - (pL[0]*pV[0]);
            for(let i=0; i<=2; i++) for(let j=0; j<=2; j++) if(i+j <= 2) u25 += pL[i]*pV[j];
            
            // EstimaciÃ³n simple Over 0.5 HT (aprox 33% del xG total)
            let probHT = 1 - Math.exp(-(xGL + xGV) * 0.45);

            // Actualizar UI
            updateUI(probHT, 1-u25, 1-bttsNo, u25, bttsNo);
            document.getElementById('xgPanel').style.display = 'block';
        }
    }

    function renderChart(pL, pV) {
        const container = document.getElementById('golesChart');
        container.innerHTML = '';
        for(let i=0; i<=6; i++) {
            const group = document.createElement('div');
            group.className = 'bar-group';
            group.innerHTML = `
                <div style="display:flex; gap:2px; height:100%; align-items:flex-end; width:100%;">
                    <div class="bar" style="height: ${pL[i]*150}%"></div>
                    <div class="bar away" style="height: ${pV[i]*150}%"></div>
                </div>
                <div class="bar-label">${i}</div>
            `;
            container.appendChild(group);
        }
    }

    function updateUI(ov05ht, ov25, bttsY, u25, bttsN) {
        document.getElementById('ov05ht_val').innerText = (ov05ht*100).toFixed(1) + '%';
        document.getElementById('ov05ht_odds').innerText = 'C. Justa: ' + (1/ov05ht).toFixed(2);
        document.getElementById('ov25ft_val').innerText = (ov25*100).toFixed(1) + '%';
        document.getElementById('ov25ft_odds').innerText = 'C. Justa: ' + (1/ov25).toFixed(2);
        document.getElementById('btts_val').innerText = (bttsY*100).toFixed(1) + '%';
        document.getElementById('btts_odds').innerText = 'C. Justa: ' + (1/bttsY).toFixed(2);

        const markets = [
            {n: 'OVER 0.5 HT', p: ov05ht},
            {n: 'OVER 2.5 FT', p: ov25},
            {n: 'UNDER 2.5 FT', p: u25},
            {n: 'BTTS YES', p: bttsY},
            {n: 'BTTS NO', p: bttsN}
        ];

        document.getElementById('marketsTable').innerHTML = markets.map(m => `
            <tr>
                <td>${m.n}</td>
                <td class="prob-cell">${(m.p*100).toFixed(1)}%</td>
                <td class="odds-cell">${(1/m.p).toFixed(2)}</td>
                <td><button class="action-btn">âžœ ROI</button></td>
            </tr>
        `).join('');
    }

    window.onload = cargarDatosLiga;
</script>
</body>
</html>