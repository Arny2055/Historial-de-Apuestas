<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poisson Pro - Database Edition</title>
    <style>
        :root { --primary: #00ff85; --secondary: #3d195a; --bg: #f2f2f7; --accent: #007aff; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 500px; margin: auto; background: white; padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        /* Sistema de Pesta√±as */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #e5e5ea; padding: 4px; border-radius: 12px; }
        .tab-btn { flex: 1; padding: 10px; border: none; border-radius: 10px; font-weight: bold; font-size: 13px; cursor: pointer; }
        .active-tab { background: white; color: var(--secondary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .view { display: none; }
        .view.active { display: block; }

        /* Tabla de Configuraci√≥n de Ligas */
        .config-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
        .config-table th { background: #f2f2f7; padding: 10px; text-align: left; color: #666; }
        .config-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .url-input { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 10px; }
        
        .btn-add { background: var(--primary); color: var(--secondary); border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; margin-top: 10px; width: 100%; }
        .btn-scrape { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 15px; }

        /* Resultados y Filtros */
        .filter-box { background: #fff3cd; padding: 12px; border-radius: 12px; margin-bottom: 15px; }
        .match-card { background: white; border: 1px solid #eee; border-radius: 15px; margin-top: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .match-header { background: var(--secondary); color: white; padding: 12px; font-size: 13px; font-weight: bold; display: flex; justify-content: space-between; }
        .prob-table { width: 100%; border-collapse: collapse; }
        .prob-table td { padding: 12px; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
        .highlight { background: #e8fff3; font-weight: 800; color: #008a4e; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active-tab" onclick="switchTab('analisis')">üìä An√°lisis</button>
        <button class="tab-btn" onclick="switchTab('config')">‚öôÔ∏è Config. Ligas</button>
    </div>

    <div id="analisis" class="view active">
        <div class="filter-box">
            <label style="font-size: 11px; font-weight: bold;">UMBRAL OVER 2.5: <span id="val">60</span>%</label>
            <input type="range" id="threshold" min="50" max="90" value="60" style="width:100%" oninput="document.getElementById('val').innerText=this.value">
        </div>
        
        <select id="activeLeague" style="width:100%; padding:12px; border-radius:10px; margin-bottom:10px;"></select>
        <button class="btn-scrape" onclick="runAutoScraper()">AUTO-SCRAPING & CALCULAR</button>
        
        <div id="results"></div>
    </div>

    <div id="config" class="view">
        <h3>Gesti√≥n de Fuentes (Soccerstats)</h3>
        <table class="config-table" id="leagueTable">
            <thead>
                <tr>
                    <th>Liga</th>
                    <th>URL Calendario</th>
                    <th>URL Home/Away</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="leagueBody">
                </tbody>
        </table>
        <button class="btn-add" onclick="addNewLeague()">+ A√±adir Nueva Liga</button>
        <p style="font-size: 10px; color: #999; margin-top: 15px;">* Los datos se guardan localmente en tu iPhone.</p>
    </div>
</div>

<script>
    // 1. GESTI√ìN DE BASE DE DATOS LOCAL
    let leagues = JSON.parse(localStorage.getItem('poisson_leagues')) || [
        { name: 'Premier League', cal: 'https://www.soccerstats.com/results.asp?league=england', stats: 'https://www.soccerstats.com/homeaway.asp?league=england' }
    ];

    function saveLeagues() {
        localStorage.setItem('poisson_leagues', JSON.stringify(leagues));
        renderLeagues();
    }

    function renderLeagues() {
        const body = document.getElementById('leagueBody');
        const selector = document.getElementById('activeLeague');
        body.innerHTML = '';
        selector.innerHTML = '';

        leagues.forEach((l, idx) => {
            body.innerHTML += `
                <tr>
                    <td><input class="url-input" value="${l.name}" onchange="updateLeague(${idx}, 'name', this.value)"></td>
                    <td><input class="url-input" value="${l.cal}" onchange="updateLeague(${idx}, 'cal', this.value)"></td>
                    <td><input class="url-input" value="${l.stats}" onchange="updateLeague(${idx}, 'stats', this.value)"></td>
                    <td><button onclick="deleteLeague(${idx})">üóëÔ∏è</button></td>
                </tr>`;
            selector.innerHTML += `<option value="${idx}">${l.name}</option>`;
        });
    }

    function updateLeague(idx, key, val) { leagues[idx][key] = val; saveLeagues(); }
    function addNewLeague() { leagues.push({name:'Nueva', cal:'', stats:''}); renderLeagues(); }
    function deleteLeague(idx) { leagues.splice(idx,1); saveLeagues(); }

    // 2. SISTEMA DE NAVEGACI√ìN
    function switchTab(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active-tab');
    }

    // 3. SCRAPER Y C√ÅLCULO
    async function runAutoScraper() {
        const idx = document.getElementById('activeLeague').value;
        const league = leagues[idx];
        const resDiv = document.getElementById('results');
        resDiv.innerHTML = `<p style="text-align:center">Conectando a Soccerstats...<br><small>${league.name}</small></p>`;

        // Aqu√≠ se usa el proxy para leer Soccerstats
        const proxy = "https://api.allorigins.win/get?url=";
        
        try {
            // En una implementaci√≥n real de scraping, aqu√≠ har√≠amos fetch(proxy + encodeURIComponent(league.stats))
            // Por ahora, simulamos el proceso de an√°lisis para mostrar el flujo de trabajo:
            setTimeout(() => {
                resDiv.innerHTML = `<p style="text-align:center; color:orange;">An√°lisis completado. Filtrando partidos ‚â• ${document.getElementById('threshold').value}%</p>`;
                // Aqu√≠ ir√≠a el motor de c√°lculo que ya tenemos perfeccionado.
            }, 1500);
        } catch(e) {
            resDiv.innerHTML = "Error al obtener datos.";
        }
    }

    // Inicializar
    renderLeagues();
</script>
</body>
</html>
