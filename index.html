<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtester Semanal Completo: BTTS & Over 2.5 + Patrones</title>
    <style>
        body { font-family: 'Roboto', sans-serif; margin: 20px; background: #f9f9f9; color: #333; line-height: 1.6; }
        #container { max-width: 1200px; margin: auto; padding: 20px; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; }
        h1, h2 { color: #123456; }
        button { padding: 10px 20px; background: #3d8bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #2a6bcc; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.pattern { background: #ff9800; }
        button.pattern:hover { background: #e68900; }
        input[type="checkbox"] { margin-right: 10px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
        th { background: #123456; color: white; }
        tr:nth-child(even) { background: #f5f5f5; }
        .positive { color: #2a9d8f; font-weight: bold; }
        .negative { color: #e63946; font-weight: bold; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .stat-box { padding: 15px; background: #f0f8ff; border-radius: 6px; text-align: center; }
        .stat-box p { font-size: 1.4em; font-weight: bold; margin: 5px 0 0; }
        .stat-box span { font-size: 0.9em; color: #56789a; }
        #status { margin: 10px 0; padding: 10px; border-radius: 4px; background: #e8f5e8; color: #2a9d8f; }
        #error { background: #ffebee; color: #c62828; }
        .details, #patterns-section { display: none; margin-top: 10px; }
        .details.show, #patterns-section.show { display: block; }
        .market-btts { background: #e3f2fd; }
        .market-over { background: #f3e5f5; }
        #patterns-table tr.highlight { background: #fff3e0; font-weight: bold; }
    </style>
</head>
<body>
<div id="container">
    <h1>Backtester Semanal Completo: BTTS & Over 2.5 + Patrones</h1>
    <p>Carga JSON. Simula backtests, luego busca patrones. Logs en Console (F12).</p>
    
    <input type="file" id="json-input" accept=".json" onchange="loadJSON()">
    <label><input type="checkbox" id="include-over" checked> Incluir Over 2.5 (simulado)</label>
    <button id="run-btn" onclick="runSimulation()" disabled>üî¨ Simular Backtests</button>
    <button id="patterns-btn" onclick="analyzePatterns()" disabled class="pattern">üîç Buscar Patrones</button>
    <div id="status">Estatus: Esperando JSON...</div>
    
    <section id="results-section" style="display: none;">
        <h2>üìä Resultados Backtest</h2>
        <div class="stats-grid">
            <div class="stat-box"><span>Semanas</span><p id="total-weeks">0</p></div>
            <div class="stat-box"><span>Unidades Netas</span><p id="net-units" class="positive">0.00</p></div>
            <div class="stat-box"><span>Yield (%)</span><p id="avg-yield" class="positive">0.00%</p></div>
            <div class="stat-box"><span>Acierto (%)</span><p id="win-rate">0.00%</p></div>
        </div>
        
        <h2>Detalles por Semana</h2>
        <table id="weekly-table">
            <thead><tr><th>Semana</th><th>Mercados</th><th>Unidades</th><th>Yield (%)</th><th>EV (%)</th><th>Acciones</th></tr></thead>
            <tbody></tbody>
        </table>
        <div id="details-section" class="details"></div>
    </section>
    
    <section id="patterns-section">
        <h2>üîç Patrones Encontrados</h2>
        <p>An√°lisis basado en datos cargados. Highlights en naranja.</p>
        <table id="patterns-table">
            <thead><tr><th>Categor√≠a</th><th>Patr√≥n</th><th>Estad√≠stica</th><th>Insight</th></tr></thead>
            <tbody></tbody>
        </table>
    </section>
</div>

<script>
    let allData = [];
    const SIX_MONTHS_MS = 6 * 30 * 24 * 60 * 60 * 1000;
    const ONE_WEEK_MS = 7 * 24 * 60 * 60 * 1000;
    const MIN_MATCHES = 5;
    const EDGE_MARGIN = 0.05;
    const PROB_MIN = 0.50;
    const PROB_MAX = 0.85;
    const CORRELATION_FACTOR = 0.04;
    const DECAY_FACTOR = 0.95;
    const MATCHES_LIMIT = 3;

    // Poisson functions
    const factorialCache = { 0: 1, 1: 1 };
    function factorial(n) {
        if (n in factorialCache) return factorialCache[n];
        let result = 1;
        for (let i = 2; i <= n; i++) result *= i;
        return factorialCache[n] = result;
    }

    function poisson(k, lambda) {
        if (k < 0) return 0;
        if (lambda <= 0) return k === 0 ? 1 : 0;
        return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k);
    }

    function runPoissonSimulation(lambdaL, lambdaV, correlationFactor) {
        const maxGoals = 4;
        let probMatrix = [];
        let totalProb = 0;
        const P_plus = (lambda) => 1 - Array.from({ length: maxGoals }, (_, k) => poisson(k, lambda)).reduce((a, b) => a + b, 0);

        for (let i = 0; i <= maxGoals; i++) {
            probMatrix[i] = [];
            for (let j = 0; j <= maxGoals; j++) {
                const probL = (i < maxGoals) ? poisson(i, lambdaL) : P_plus(lambdaL);
                const probV = (j < maxGoals) ? poisson(j, lambdaV) : P_plus(lambdaV);
                probMatrix[i][j] = probL * probV;
                totalProb += probMatrix[i][j];
            }
        }

        const normFactor = 1.0 / totalProb;
        let normalizedProbMatrix = probMatrix.map(row => row.map(p => p * normFactor));
        let finalProbMatrix = JSON.parse(JSON.stringify(normalizedProbMatrix));

        if (correlationFactor > 0) {
            const prob00 = normalizedProbMatrix[0][0];
            const prob11 = normalizedProbMatrix[1][1];
            const sumDraws = prob00 + prob11;
            if (sumDraws > 0) {
                finalProbMatrix[0][0] += correlationFactor * (prob00 / sumDraws);
                finalProbMatrix[1][1] += correlationFactor * (prob11 / sumDraws);
                const sumDrawsNew = finalProbMatrix[0][0] + finalProbMatrix[1][1];
                const sumNonDrawsOrig = 1.0 - sumDraws;
                const sumNonDrawsReq = 1.0 - sumDrawsNew;
                const reduction = sumNonDrawsOrig > 0 ? sumNonDrawsReq / sumNonDrawsOrig : 1.0;
                for (let i = 0; i <= maxGoals; i++) {
                    for (let j = 0; j <= maxGoals; j++) {
                        if (!((i === 0 && j === 0) || (i === 1 && j === 1))) {
                            finalProbMatrix[i][j] = normalizedProbMatrix[i][j] * reduction;
                        }
                    }
                }
            }
        }

        let probBTTS = 0, probOU25 = 0;
        for (let i = 0; i <= maxGoals