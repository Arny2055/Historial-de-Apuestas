<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador BTTS por Varianza (M√≥vil)</title>
    <style>
        /* --- ESTILOS GENERALES Y RESET M√ìVIL --- */
        body { 
            font-family: sans-serif; 
            margin: 0; /* Elimina m√°rgenes exteriores */
            padding: 10px; /* Padding interno para que no toque los bordes */
            background-color: #f4f7f6; 
            font-size: 16px; /* Tama√±o de fuente base legible */
        }
        .container { 
            width: 100%; /* Ocupa el 100% del ancho */
            max-width: none; /* Ignora el max-width para m√≥vil */
            margin: 0 auto; 
            background: white; 
            padding: 15px; /* Padding interno adecuado */
            border-radius: 0; /* Bordes menos pronunciados o eliminados */
            box-shadow: none; /* Elimina sombras para rendimiento */
        }
        h2 { 
            color: #2c3e50; 
            border-bottom: 2px solid #3498db; 
            padding-bottom: 8px; 
            font-size: 1.5em; /* Tama√±o de t√≠tulo claro */
        }
        
        /* --- ESTILOS DE ENTRADA Y SELECCI√ìN --- */
        .data-input { 
            padding: 10px; 
            border: 1px solid #ccc; 
        }
        .match-setup { 
            flex-direction: column; /* Apila los selectores verticalmente */
            align-items: stretch;
        }
        .match-setup select { 
            width: 100%; /* Ocupa todo el ancho */
            margin-bottom: 10px; /* Espacio entre selectores */
        }
        input[type="file"], select { 
            padding: 12px 10px; 
            font-size: 1em; 
        }
        
        /* --- COMPARACI√ìN DE EQUIPOS (Ajuste para Dos Columnas) --- */
        .team-comparison { 
            flex-direction: column; /* Apila las cajas de los equipos */
            gap: 15px; /* Espacio entre las cajas apiladas */
        }
        .team-box { 
            width: 100%; /* Ocupa todo el ancho al estar apilado */
            padding: 10px; 
            font-size: 0.95em;
        }

        /* --- TABLA DE RECOMENDACI√ìN (Ajuste para evitar Scroll Horizontal) --- */
        .range-table { 
            width: 100%; 
            font-size: 0.9em; /* Fuente ligeramente m√°s peque√±a para que quepa */
            display: block; /* Permite flexibilidad si es necesario */
            overflow-x: auto; /* Fallback para tablas muy anchas */
        }
        .range-table th, .range-table td { 
            padding: 6px; /* Reduce padding */
            word-break: break-word; /* Permite que el texto se rompa */
        }

        /* Estilos de Color y √ânfasis */
        .recommendation { 
            padding: 12px; 
        }
        .error { 
            font-size: 1em; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>‚öîÔ∏è Comparador de Varianza de Equipos (BTTS)</h2>
        <p>Analiza un enfrentamiento espec√≠fico (Local vs Visitante) y calcula la probabilidad de Ambos Anotan (BTTS) bas√°ndose en la varianza de cada equipo.</p>

        <div class="data-input">
            <h4>Paso 1: Carga el Archivo JSON</h4>
            <input type="file" id="jsonFile" accept=".json" onchange="extractTeams()">
            
            <div id="teamSelectionArea" style="margin-top: 15px; display: none;">
                <h4>Paso 2: Selecciona el Enfrentamiento</h4>
                <div class="match-setup">
                    <select id="localTeamSelect" onchange="executeComparison()">
                        <option value="">-- Selecciona Local --</option>
                    </select>
                    <span>**VS**</span>
                    <select id="awayTeamSelect" onchange="executeComparison()">
                        <option value="">-- Selecciona Visitante --</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div id="analysisOutput" class="analysis-output">
            <h4>Resultados de la Comparaci√≥n</h4>
            <p>Por favor, carga un archivo y selecciona los dos equipos.</p>
        </div>
    </div>

    <script>
        let globalMatchData = [];

        // --- FUNCIONES DE C√ÅLCULO ESTAD√çSTICO ---
        function calcularMedia(datos) {
            if (datos.length === 0) return 0;
            const suma = datos.reduce((acc, val) => acc + val, 0);
            return suma / datos.length;
        }

        function calcularVarianza(datos) {
            const n = datos.length;
            if (n < 2) return 0;
            const media = calcularMedia(datos);
            const sumatoria = datos.reduce((acc, val) => acc + Math.pow(val - media, 2), 0);
            return sumatoria / (n - 1);
        }

        // --- L√ìGICA DE CARGA Y EXTRACCI√ìN DE EQUIPOS ---

        function extractTeams() {
            const fileInput = document.getElementById('jsonFile');
            const outputDiv = document.getElementById('analysisOutput');
            outputDiv.innerHTML = '<h4>Analizando Archivo...</h4>';
            document.getElementById('teamSelectionArea').style.display = 'none';

            if (fileInput.files.length === 0) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    globalMatchData = data;
                    populateTeamSelect(data, outputDiv);
                } catch (error) {
                    outputDiv.innerHTML = `<p class="error">‚ùå Error al cargar/parsear JSON: ${error.message}</p>`;
                }
            };
            reader.onerror = function() {
                outputDiv.innerHTML = '<p class="error">‚ùå Error al leer el archivo.</p>';
            };
            reader.readAsText(fileInput.files[0]);
        }

        function populateTeamSelect(data, outputDiv) {
            const teams = new Set();
            data.forEach(item => {
                const match = item['Match'];
                if (match) {
                    const parts = match.split('-');
                    if (parts.length >= 2) {
                        teams.add(parts[0].trim());
                        teams.add(parts[1].trim());
                    }
                }
            });

            const localSelect = document.getElementById('localTeamSelect');
            const awaySelect = document.getElementById('awayTeamSelect');
            localSelect.innerHTML = '<option value="">-- Selecciona Local --</option>';
            awaySelect.innerHTML = '<option value="">-- Selecciona Visitante --</option>';

            if (teams.size === 0) {
                outputDiv.innerHTML = '<p class="error">‚ùå No se encontraron equipos. Verifica el formato "Local - Visitante".</p>';
                return;
            }
            
            Array.from(teams).sort().forEach(teamName => {
                localSelect.appendChild(new Option(teamName, teamName));
                awaySelect.appendChild(new Option(teamName, teamName));
            });

            document.getElementById('teamSelectionArea').style.display = 'flex';
            outputDiv.innerHTML = '<p>‚úÖ Archivo cargado. Selecciona los equipos para comparar.</p>';
        }

        // --- FUNCI√ìN DE AN√ÅLISIS POR EQUIPO (Datos extra√≠dos del JSON) ---

        function getTeamStats(teamName, data) {
            const gaArray = []; 
            const grArray = []; 
            const bttsOdds = []; 

            data.forEach(item => {
                const match = item['Match'];
                const resultFT = item['Result FT'];
                const result = item['Result']; 

                if (!match || !resultFT) return;
                
                const [scoreLocalStr, scoreAwayStr] = resultFT.split('-').map(s => s.trim());
                const scoreLocal = parseInt(scoreLocalStr);
                const scoreAway = parseInt(scoreAwayStr);

                if (isNaN(scoreLocal) || isNaN(scoreAway)) return;
                
                // Recopilar Goles
                if (match.startsWith(teamName + ' -')) { 
                    gaArray.push(scoreLocal);
                    grArray.push(scoreAway);
                } else if (match.endsWith('- ' + teamName)) {
                    gaArray.push(scoreAway);
                    grArray.push(scoreLocal);
                }

                // Recopilar Cuotas BTTS ganadoras
                if (result === 'Winning') {
                    const odd = parseFloat(item['Odd']);
                    if (!isNaN(odd)) {
                        bttsOdds.push(odd);
                    }
                }
            });

            if (gaArray.length < 2) {
                return null;
            }

            const varGA = calcularVarianza(gaArray);
            const varGR = calcularVarianza(grArray);
            const mediaOdd = calcularMedia(bttsOdds);
            const desvEstOdd = calcularVarianza(bttsOdds) > 0 ? Math.sqrt(calcularVarianza(bttsOdds)) : 0;

            return {
                name: teamName,
                N: gaArray.length,
                mediaGA: calcularMedia(gaArray),
                mediaGR: calcularMedia(grArray),
                varGA: varGA,
                varGR: varGR,
                mediaOdd: mediaOdd,
                desvEstOdd: desvEstOdd
            };
        }

        // --- L√ìGICA PRINCIPAL DE COMPARACI√ìN ---

        function executeComparison() {
            const localName = document.getElementById('localTeamSelect').value;
            const awayName = document.getElementById('awayTeamSelect').value;
            const outputDiv = document.getElementById('analysisOutput');

            if (!localName || !awayName) return;
            if (localName === awayName) {
                outputDiv.innerHTML = '<p class="error">‚ùå No puedes comparar el mismo equipo.</p>';
                return;
            }

            const localStats = getTeamStats(localName, globalMatchData);
            const awayStats = getTeamStats(awayName, globalMatchData);

            if (!localStats || !awayStats) {
                outputDiv.innerHTML = '<p class="error">‚ùå No hay suficientes datos (m√≠nimo 2 partidos) para uno o ambos equipos seleccionados.</p>';
                return;
            }

            // 1. Calcular la Probabilidad BTTS (S√ç) para el enfrentamiento
            
            // Probabilidad de que el Local Anote (Factor Local GA / Factor Visitante GR)
            const probLocalScores = (localStats.mediaGA * awayStats.mediaGR) / (localStats.mediaGA + awayStats.mediaGR); 

            // Probabilidad de que el Visitante Anote (Factor Visitante GA / Factor Local GR)
            const probAwayScores = (awayStats.mediaGA * localStats.mediaGR) / (awayStats.mediaGA + localStats.mediaGR);

            // Ajuste por Varianza (Si ambos equipos son vol√°tiles, aumenta la probabilidad de goles at√≠picos)
            const varFactor = ((localStats.varGA + awayStats.varGR) / 2 + (awayStats.varGA + localStats.varGR) / 2) / 4;
            const varianzaAdjustment = (varFactor > 1.0) ? 0.05 * varFactor : 0; 

            // Simulaci√≥n de Probabilidad BTTS
            let probBTTS = (probLocalScores / (probLocalScores + probAwayScores)) * 0.75 + (probAwayScores / (probLocalScores + probAwayScores)) * 0.75;
            
            probBTTS = Math.min(0.85, Math.max(0.40, probBTTS));
            probBTTS += varianzaAdjustment;
            probBTTS = Math.min(0.95, probBTTS);

            const cuotaJustaBTTS = 1 / probBTTS;

            // 2. Mostrar Resultados
            mostrarComparacion(localStats, awayStats, probBTTS, cuotaJustaBTTS, outputDiv);
        }

        // --- FUNCI√ìN DE VISUALIZACI√ìN Y RECOMENDACI√ìN ---

        function mostrarComparacion(local, away, probBTTS, cuotaJustaBTTS, outputDiv) {
            
            const localVolatil = local.varGA > 1.0 || local.varGR > 1.0;
            const awayVolatil = away.varGA > 1.0 || away.varGR > 1.0;

            const rangoMin = cuotaJustaBTTS * 1.05; // 5% Edge
            const rangoMax = cuotaJustaBTTS * 1.15; // 15% Edge
            
            let comentarioVarianza = 'An√°lisis de Varianza: ';
            if (localVolatil && awayVolatil) {
                comentarioVarianza += 'Ambos son **Vol√°tiles**. El BTTS S√ç es una apuesta de alta probabilidad y volatilidad.';
            } else if (localVolatil) {
                comentarioVarianza += `${local.name} es **Vol√°til**. Su ataque/defensa inconsistente puede generar goles inesperados en ambos lados.`;
            } else if (awayVolatil) {
                comentarioVarianza += `${away.name} es **Vol√°til**. Esto aumenta la posibilidad de que el Visitante anote y sorprenda.`;
            } else {
                comentarioVarianza += 'Ambos son **Consistentes**. La probabilidad BTTS S√ç es m√°s fiable, el valor reside en la precisi√≥n del Edge.';
            }

            outputDiv.innerHTML = `
                <h4>An√°lisis del Enfrentamiento: ${local.name} vs ${away.name}</h4>
                <div class="team-comparison">
                    <div class="team-box">
                        <h5>Equipo Local: ${local.name}</h5>
                        <p>GA Media: ${local.mediaGA.toFixed(2)} | Varianza GA: **${local.varGA.toFixed(3)}**</p>
                        <p>GR Media: ${local.mediaGR.toFixed(2)} | Varianza GR: **${local.varGR.toFixed(3)}**</p>
                        <p style="color: ${local.varGA > 1.0 || local.varGR > 1.0 ? '#c0392b' : '#27ae60'}">${localVolatil ? 'üî¥ Equipo Vol√°til' : 'üü¢ Equipo Consistente'}</p>
                    </div>
                    <div class="team-box">
                        <h5>Equipo Visitante: ${away.name}</h5>
                        <p>GA Media: ${away.mediaGA.toFixed(2)} | Varianza GA: **${away.varGA.toFixed(3)}**</p>
                        <p>GR Media: ${away.mediaGR.toFixed(2)} | Varianza GR: **${away.varGR.toFixed(3)}**</p>
                        <p style="color: ${away.varGA > 1.0 || away.varGR > 1.0 ? '#c0392b' : '#27ae60'}">${awayVolatil ? 'üî¥ Equipo Vol√°til' : 'üü¢ Equipo Consistente'}</p>
                    </div>
                </div>
                <hr>

                <div class="recommendation">
                    <h4>üìä Previsi√≥n de BTTS S√ç y Estrategia</h4>
                    <p>Probabilidad de Ambos Anoten (BTTS S√ç) seg√∫n tu modelo: **${(probBTTS * 100).toFixed(2)}%**</p>
                    <p>Cuota Justa Impl√≠cita (Valor Real): **${cuotaJustaBTTS.toFixed(2)}**</p>
                    <p>${comentarioVarianza}</p>
                    
                    <table class="range-table">
                        <thead>
                            <tr>
                                <th>Estrategia de Apuesta</th>
                                <th>Rango de Cuotas BTTS S√ç</th>
                                <th>Edge Requerido</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>**ENTRADA CON EDGE M√çNIMO**</td>
                                <td>Cuotas **superiores a ${rangoMin.toFixed(2)}**</td>
                                <td>**BUSCAR ESTA CUOTA.** Aqu√≠ obtienes un *Edge* (Ventaja) del 5% o m√°s.</td>
                            </tr>
                            <tr>
                                <td>**ENTRADA CON EDGE ALTO**</td>
                                <td>Cuotas **superiores a ${rangoMax.toFixed(2)}**</td>
                                <td>**VALOR EXCEPCIONAL.** Si la casa la ofrece, el retorno potencial es muy alto.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
        }
    </script>
</body>
</html>