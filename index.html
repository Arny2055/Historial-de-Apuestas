<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poisson Auto-Scraper Pro</title>
    <style>
        :root { --primary: #00ff85; --secondary: #3d195a; --bg: #f2f2f7; --accent: #007aff; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 500px; margin: auto; background: white; padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        /* Pesta√±as */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #e5e5ea; padding: 4px; border-radius: 12px; }
        .tab-btn { flex: 1; padding: 10px; border: none; border-radius: 10px; font-weight: bold; font-size: 13px; cursor: pointer; }
        .active-tab { background: white; color: var(--secondary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .view { display: none; }
        .view.active { display: block; }

        /* Configuraci√≥n */
        .config-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 10px; }
        .config-table input { width: 100%; border: 1px solid #ddd; padding: 4px; border-radius: 4px; }
        
        /* Resultados */
        .filter-box { background: #fff3cd; padding: 12px; border-radius: 12px; margin-bottom: 15px; font-size: 12px; }
        .match-card { background: white; border: 1px solid #eee; border-radius: 15px; margin-top: 15px; overflow: hidden; border-left: 5px solid var(--primary); }
        .match-header { background: var(--secondary); color: white; padding: 10px; font-size: 12px; font-weight: bold; }
        .btts-row { display: flex; justify-content: space-between; padding: 10px; background: #f0f7ff; font-weight: bold; border-bottom: 1px solid #e1e8f0; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        td { padding: 10px; border-bottom: 1px solid #f9f9f9; }
        .mkt-prob { text-align: right; font-weight: 800; }
        
        .btn-action { width: 100%; padding: 16px; background: var(--secondary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .status-msg { font-size: 12px; text-align: center; margin: 10px 0; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active-tab" onclick="switchTab('analisis')">üìä An√°lisis</button>
        <button class="tab-btn" onclick="switchTab('config')">‚öôÔ∏è Ligas</button>
    </div>

    <div id="analisis" class="view active">
        <div class="filter-box">
            <b>FILTRAR OVER 2.5 ‚â• <span id="val">60</span>%</b>
            <input type="range" id="threshold" min="50" max="90" value="60" style="width:100%" oninput="document.getElementById('val').innerText=this.value">
        </div>
        
        <label style="font-size: 11px; font-weight: bold; color: #666;">SELECCIONAR LIGA:</label>
        <select id="activeLeague" style="width:100%; padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid #ddd;"></select>
        
        <button class="btn-action" onclick="runAutoAnalysis()">EJECUTAR SCRAPER Y ANALIZAR</button>
        <div id="status" class="status-msg"></div>
        <div id="results"></div>
    </div>

    <div id="config" class="view">
        <table class="config-table">
            <thead><tr><th>Liga</th><th>URL Cal.</th><th>URL Stats</th></tr></thead>
            <tbody id="leagueBody"></tbody>
        </table>
        <button onclick="addNewLeague()" style="width:100%; margin-top:10px; padding:8px; border-radius:8px; border:1px dashed #666; background:none;">+ A√±adir Liga</button>
    </div>
</div>

<script>
    // Configuraci√≥n Inicial
    let leagues = JSON.parse(localStorage.getItem('poisson_leagues')) || [
        { name: 'Premier League', cal: 'https://www.soccerstats.com/results.asp?league=england', stats: 'https://www.soccerstats.com/homeaway.asp?league=england' }
    ];

    function switchTab(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active-tab');
    }

    function renderSettings() {
        const body = document.getElementById('leagueBody');
        const select = document.getElementById('activeLeague');
        body.innerHTML = ''; select.innerHTML = '';
        leagues.forEach((l, i) => {
            body.innerHTML += `<tr>
                <td><input value="${l.name}" onchange="updateL(${i},'name',this.value)"></td>
                <td><input value="${l.cal}" onchange="updateL(${i},'cal',this.value)"></td>
                <td><input value="${l.stats}" onchange="updateL(${i},'stats',this.value)"></td>
            </tr>`;
            select.innerHTML += `<option value="${i}">${l.name}</option>`;
        });
    }
    function updateL(i, k, v) { leagues[i][k] = v; localStorage.setItem('poisson_leagues', JSON.stringify(leagues)); renderSettings(); }
    function addNewLeague() { leagues.push({name:'Nueva', cal:'', stats:''}); renderSettings(); }

    // MATEM√ÅTICAS POISSON
    const fact = n => n <= 1 ? 1 : n * fact(n - 1);
    const poi = (l, x) => (Math.exp(-l) * Math.pow(l, x)) / fact(x);

    async function runAutoAnalysis() {
        const idx = document.getElementById('activeLeague').value;
        const league = leagues[idx];
        const status = document.getElementById('status');
        const resDiv = document.getElementById('results');
        const thr = document.getElementById('threshold').value;

        resDiv.innerHTML = '';
        status.innerHTML = "‚è≥ Extrayendo datos de Soccerstats...";

        try {
            // USANDO PROXY PARA LEER SOCCERSTATS
            const proxy = "https://api.allorigins.win/get?url=";
            
            // 1. EXTRAER ESTAD√çSTICAS (HOME/AWAY)
            const statsResp = await fetch(proxy + encodeURIComponent(league.stats));
            const statsData = await statsResp.json();
            const parser = new DOMParser();
            const docStats = parser.parseFromString(statsData.contents, 'text/html');

            // Buscamos la tabla de Soccerstats (usualmente es la que tiene clase 'sortable' o ID 'h2h-table')
            const teamRows = docStats.querySelectorAll('tr.odd, tr.even');
            let statsMap = {};
            
            teamRows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if(cols.length >= 8) {
                    const name = cols[1].innerText.trim();
                    statsMap[name] = {
                        pj: parseFloat(cols[2].innerText),
                        gf: parseFloat(cols[6].innerText),
                        gc: parseFloat(cols[7].innerText)
                    };
                }
            });

            // 2. EXTRAER CALENDARIO
            const calResp = await fetch(proxy + encodeURIComponent(league.cal));
            const calData = await calResp.json();
            const docCal = parser.parseFromString(calData.contents, 'text/html');
            const matchRows = docCal.querySelectorAll('tr[height="34"]'); // Formato t√≠pico de Soccerstats para partidos

            status.innerHTML = "‚úÖ Datos obtenidos. Calculando Poisson...";

            matchRows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if(cols.length >= 4) {
                    const hName = cols[1].innerText.trim();
                    const aName = cols[3].innerText.trim();
                    const time = cols[2].innerText.trim();

                    if(statsMap[hName] && statsMap[aName]) {
                        calculateMatch(hName, aName, time, statsMap, thr, resDiv);
                    }
                }
            });

            if(resDiv.innerHTML === "") {
                status.innerHTML = "‚ùå No hay partidos que cumplan el " + thr + "% hoy.";
            } else {
                status.innerHTML = "üéØ Partidos encontrados:";
            }

        } catch (e) {
            status.innerHTML = "‚ùå Error: Verifica los URLs en configuraci√≥n.";
            console.error(e);
        }
    }

    function calculateMatch(hName, aName, time, stats, thr, container) {
        // Promedios Liga (Puedes automatizarlos tambi√©n, aqu√≠ usamos los est√°ndar)
        const avH = 1.61, avA = 1.22;
        const h = stats[hName], a = stats[aName];

        const lamH = (h.gf/h.pj/avH) * (a.gc/a.pj/avH) * avH;
        const lamA = (a.gf/a.pj/avA) * (h.gc/h.pj/avA) * avA;

        let over25 = 0;
        for(let i=0; i<=8; i++) {
            for(let j=0; j<=8; j++) {
                if(i+j > 2.5) over25 += poi(lamH, i) * poi(lamA, j);
            }
        }

        const prob = (over25 * 100).toFixed(1);
        if(prob >= thr) {
            const btts = ((1-poi(lamH,0))*(1-poi(lamA,0))*100).toFixed(1);
            container.innerHTML += `
                <div class="match-card">
                    <div class="match-header">${hName} vs ${aName} | ${time}</div>
                    <div class="btts-row"><span>Ambos Anotan</span><span style="color:var(--accent)">${btts}%</span></div>
                    <table>
                        <tr style="background:#e8fff3">
                            <td><b>Over 2.5 Goles üéØ</b></td>
                            <td class="mkt-prob" style="color:#008a4e">${prob}%</td>
                        </tr>
                    </table>
                    <button onclick="share('${hName} vs ${aName}','${prob}')" style="width:100%; border:none; padding:10px; background:#f2f2f7; font-size:12px;">üì≤ Compartir Pick</button>
                </div>`;
        }
    }

    function share(m, p) {
        const t = `‚öΩ *PICK FILTRADO*\nüèüÔ∏è ${m}\nüéØ Over 2.5 Goles\nüìà Probabilidad: ${p}%`;
        navigator.share({text: t});
    }

    renderSettings();
</script>
</body>
</html>
