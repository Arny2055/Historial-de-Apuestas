<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Historial de Apuestas Profesional v2.0</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<style>
  :root {
    --color-primary: #8257e6;
    --color-primary-dark: #6a40d6;
    --color-background: #121214;
    --color-surface-1: #202024;
    --color-surface-2: #29292e;
    --color-surface-3: #333339;
    --color-text-primary: #e1e1e6;
    --color-text-secondary: #c4c4cc;
    --color-text-muted: #bbb;
    --color-success: #4caf50;
    --color-danger: #ef4444;
    --color-warning: #fbbf24;
    --border-radius: 10px;
  }

  /* --- Reset y base --- */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: 'Inter', sans-serif;
    background-color: var(--color-background);
    color: var(--color-text-primary);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  main {
    max-width: 1200px;
    width: 95%;
    margin: 20px auto 40px auto;
    flex-grow: 1;
  }
  h1, h2 {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--color-primary);
    text-align: center;
  }

  /* --- Notificaciones Toast --- */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: var(--color-surface-1);
    color: var(--color-text-primary);
    padding: 15px 25px;
    border-radius: var(--border-radius);
    border-left: 5px solid var(--color-primary);
    box-shadow: 0 6px 20px rgba(0,0,0,0.5);
    opacity: 0;
    transform: translateX(100%);
    transition: opacity 0.5s, transform 0.5s;
    z-index: 1000;
  }
  .toast.show {
    opacity: 1;
    transform: translateX(0);
  }
  .toast.success { border-left-color: var(--color-success); }
  .toast.error { border-left-color: var(--color-danger); }


  /* --- Formulario de apuesta --- */
  form#formApuesta {
    background-color: var(--color-surface-1);
    padding: 25px 30px;
    border-radius: var(--border-radius);
    box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px 24px;
    margin-bottom: 40px;
  }
  form#formApuesta label {
    display: block;
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 6px;
    color: var(--color-text-secondary);
  }
  form#formApuesta input[type="text"],
  form#formApuesta input[type="number"],
  form#formApuesta select {
    width: 100%;
    padding: 10px 14px;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid transparent;
    background-color: var(--color-background);
    color: var(--color-text-primary);
    box-shadow: inset 0 0 5px rgb(255 255 255 / 0.1);
    transition: box-shadow 0.25s ease, border-color 0.25s ease;
  }
  form#formApuesta input[type="text"]:focus,
  form#formApuesta input[type="number"]:focus,
  form#formApuesta select:focus {
    outline: none;
    box-shadow: inset 0 0 8px var(--color-primary);
    border-color: var(--color-primary);
  }
  form#formApuesta input.invalid {
    border-color: var(--color-danger);
    box-shadow: inset 0 0 8px var(--color-danger);
  }
  form#formApuesta input[readonly] {
    background-color: #2a2a30;
    cursor: not-allowed;
  }
  #submitButton {
    grid-column: 1 / -1;
    background-color: var(--color-primary);
    color: white;
    font-weight: 700;
    font-size: 1.2rem;
    padding: 14px 20px;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.1s ease;
    box-shadow: 0 6px 10px var(--color-primary-dark);
  }
  #submitButton:hover:not(:disabled) {
    background-color: var(--color-primary-dark);
  }
  #submitButton:disabled {
    background-color: #555;
    cursor: not-allowed;
  }
  #submitButton:active:not(:disabled) {
    transform: translateY(2px);
  }

  /* --- Sección filtros --- */
  section.filtros {
    margin-bottom: 30px;
    display: flex;
    flex-wrap: wrap;
    gap: 15px 18px;
    align-items: center;
  }
  section.filtros input[type="text"],
  section.filtros select {
    min-width: 160px;
    padding: 9px 14px;
    border-radius: 8px;
    border: none;
    background-color: var(--color-background);
    color: var(--color-text-primary);
    box-shadow: inset 0 0 5px rgb(255 255 255 / 0.1);
    transition: box-shadow 0.25s ease;
  }
  section.filtros input[type="text"]:focus,
  section.filtros select:focus {
    outline: none;
    box-shadow: inset 0 0 8px var(--color-primary);
  }
  #btnLimpiarFiltros {
    background-color: var(--color-danger);
    color: white;
    font-weight: 700;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    padding: 8px 14px;
    transition: background-color 0.3s ease;
  }
  #btnLimpiarFiltros:hover {
    background-color: #dc2626;
  }

  /* --- Botones export/import --- */
  .botones-utiles {
    margin-bottom: 35px;
    display: flex;
    gap: 18px;
  }
  .botones-utiles button {
    background-color: var(--color-primary);
    color: white;
    font-weight: 600;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    padding: 12px 20px;
    box-shadow: 0 4px 8px var(--color-primary-dark);
    transition: background-color 0.3s ease;
  }
  .botones-utiles button:hover {
    background-color: var(--color-primary-dark);
  }
  input[type="file"] {
    display: none;
  }

  /* --- Tabla --- */
  #tablaWrapper {
    overflow-x: auto;
    box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    border-radius: 12px;
  }
  table#tablaHistorial {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
    min-width: 900px;
    font-size: 0.9rem;
  }
  thead th {
    position: sticky;
    top: 0;
    background-color: var(--color-surface-2);
    color: var(--color-text-muted);
    font-weight: 700;
    text-align: left;
    padding: 14px 18px;
    user-select: none;
    white-space: nowrap;
    z-index: 10;
  }
  tbody tr {
    background-color: var(--color-surface-1);
    transition: background-color 0.3s ease;
  }
  tbody tr:hover {
    background-color: var(--color-surface-3);
  }
  tbody td {
    padding: 14px 18px;
    color: #ddd;
    vertical-align: middle;
    white-space: nowrap;
  }
  .acciones button {
    background: none;
    border: none;
    font-size: 1.2rem;
    margin: 0 4px;
    cursor: pointer;
    color: #aaa;
    transition: color 0.2s ease, transform 0.1s ease;
  }
  .acciones button:hover {
    color: var(--color-primary);
    transform: scale(1.1);
  }
  .status-pendiente { color: var(--color-warning); font-weight: 600; }
  .status-ganada { color: var(--color-success); font-weight: 600; }
  .status-perdida { color: var(--color-danger); font-weight: 600; }
  .no-results-row td {
    text-align: center;
    padding: 40px;
    font-size: 1.1rem;
    color: var(--color-text-muted);
  }

  /* --- Resumen estadísticas --- */
  #resumen {
    margin-top: 40px;
    background-color: var(--color-surface-2);
    border-radius: var(--border-radius);
    padding: 22px 26px;
    color: #d4d4d8;
    font-size: 1.05rem;
    font-weight: 600;
    display: flex;
    flex-wrap: wrap;
    gap: 28px;
    justify-content: space-around;
  }
  #resumen > div { min-width: 140px; }
  #resumen > div strong {
    display: block;
    font-size: 1.15rem;
    color: var(--color-primary);
    margin-bottom: 6px;
  }

  /* --- Gráficas --- */
  #graficas {
    margin-top: 45px;
    display: flex;
    flex-direction: column;
    gap: 40px;
  }
  canvas {
    background-color: var(--color-surface-1);
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.5);
    max-width: 100%;
    height: 320px !important;
  }

  /* --- Responsive --- */
  @media (max-width: 900px) {
    form#formApuesta {
      grid-template-columns: 1fr;
    }
    section.filtros {
      flex-direction: column;
      gap: 15px;
    }
    .botones-utiles {
      flex-direction: column;
      gap: 15px;
    }
    #resumen {
      flex-direction: column;
      gap: 20px;
      text-align: center;
    }
    tbody td, thead th {
      font-size: 0.8rem;
      padding: 10px 12px;
    }
  }
</style>
</head>
<body>
<main>
 <h1>Historial Profesional de Apuestas</h1>

  <form id="formApuesta" autocomplete="off" novalidate aria-label="Formulario para agregar apuesta">
    <div>
      <label for="liga">Liga *</label>
      <input type="text" id="liga" name="liga" placeholder="Ej: LaLiga" required aria-required="true" />
    </div>
    <div>
      <label for="local">Equipo Local *</label>
      <input type="text" id="local" name="local" placeholder="Ej: Real Madrid" required aria-required="true" />
    </div>
    <div>
      <label for="visita">Equipo Visitante *</label>
      <input type="text" id="visita" name="visita" placeholder="Ej: Barcelona" required aria-required="true" />
    </div>
    <div>
      <label for="mercado">Mercado *</label>
      <select id="mercado" name="mercado" required aria-required="true">
        <option value="" disabled selected>Selecciona mercado</option>
      </select>
    </div>
    <div>
      <label for="probabilidad">Probabilidad (%) *</label>
      <input type="number" id="probabilidad" name="probabilidad" min="0.01" max="100" step="0.01" placeholder="Ej: 60" required aria-required="true" aria-describedby="descProbabilidad" />
      <small id="descProbabilidad" style="color:#c4c4cc; font-size:0.8rem;">Ingresa probabilidad estimada entre 0 y 100</small>
    </div>
    <div>
      <label for="cuotaImplicita">Cuota Implícita</label>
      <input type="number" id="cuotaImplicita" name="cuotaImplicita" step="0.01" readonly aria-readonly="true" placeholder="Ej: 1.66" />
    </div>
    <div>
      <label for="cuotaBookie">Cuota Bookie (decimal) *</label>
      <input type="number" id="cuotaBookie" name="cuotaBookie" min="1.01" step="0.01" placeholder="Ej: 1.80" required aria-required="true" />
    </div>
    <div>
      <label for="bankroll">Bankroll *</label>
      <input type="number" id="bankroll" name="bankroll" min="0.01" step="0.01" placeholder="Ej: 100" value="100" required aria-required="true" />
    </div>
    <div>
      <label for="kellyFrac">Fracción Kelly *</label>
      <select id="kellyFrac" name="kellyFrac" required aria-required="true">
        <option value="0.10">10%</option>
        <option value="0.25" selected>25%</option>
        <option value="0.33">33%</option>
        <option value="0.50">50%</option>
        <option value="1.00">100%</option>
      </select>
    </div>
    <div style="align-self: end;">
      <button type="submit" id="submitButton" aria-label="Agregar apuesta">Agregar apuesta</button>
    </div>
  </form>

  <section class="filtros" aria-label="Filtros para el historial de apuestas">
    <input type="text" id="filtroLiga" placeholder="Filtrar por liga..." aria-label="Filtro por liga" />
    <input type="text" id="filtroLocal" placeholder="Filtrar por local..." aria-label="Filtro por equipo local" />
    <input type="text" id="filtroVisita" placeholder="Filtrar por visita..." aria-label="Filtro por equipo visitante" />
    <select id="filtroMercado" aria-label="Filtro por mercado">
      <option value="">Todos los mercados</option>
    </select>
    <select id="filtroEstado" aria-label="Filtro por estado de apuesta">
      <option value="">Todos los estados</option>
      <option value="pendiente">Pendiente</option>
      <option value="ganada">Ganada</option>
      <option value="perdida">Perdida</option>
    </select>
    <button id="btnLimpiarFiltros" title="Limpiar filtros" aria-label="Limpiar filtros">✖</button>
  </section>

  <section class="botones-utiles" aria-label="Exportar o importar historial de apuestas">
    <button id="btnExportarCSV" title="Exportar historial a CSV">Exportar CSV</button>
    <button id="btnImportarJSON" title="Importar historial desde archivo JSON">Importar JSON</button>
    <input type="file" id="inputImportJSON" accept=".json" aria-label="Seleccionar archivo JSON para importar" />
  </section>

  <section aria-label="Historial de apuestas registradas">
    <div id="tablaWrapper">
      <table role="grid" aria-describedby="tableDescription" id="tablaHistorial" tabindex="0">
        <caption id="tableDescription" style="text-align:left; margin-bottom:12px; font-weight:700; font-size:1.2rem;">
          Historial de apuestas agregadas
        </caption>
        <thead>
          <tr>
            <th scope="col">#</th><th scope="col">Fecha</th><th scope="col">Liga</th>
            <th scope="col">Local</th><th scope="col">Visita</th><th scope="col">Mercado</th>
            <th scope="col">Prob (%)</th><th scope="col">Cuota Implícita</th><th scope="col">Cuota Bookie</th>
            <th scope="col">EV (%)</th><th scope="col">Kelly FULL (%)</th><th scope="col">Stake sugerido</th>
            <th scope="col">Estado</th><th scope="col" aria-label="Acciones">⚙</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="resumen" aria-label="Resumen estadístico de apuestas">
    <div><strong>Bankroll inicial:</strong> <span id="resumenBankroll">-</span></div>
    <div><strong>Número apuestas:</strong> <span id="resumenNumApuestas">0</span></div>
    <div><strong>Apuestas ganadas:</strong> <span id="resumenGanadas">0</span></div>
    <div><strong>Apuestas perdidas:</strong> <span id="resumenPerdidas">0</span></div>
    <div><strong>Yield (%):</strong> <span id="resumenYield">0.00%</span></div>
    <div><strong>ROI (%):</strong> <span id="resumenROI">0.00%</span></div>
  </section>

  <section id="graficas" aria-label="Gráficas de evolución del bankroll y Kelly">
    <canvas id="graficaBankroll" aria-label="Gráfica de evolución de bankroll"></canvas>
    <canvas id="graficaKelly" aria-label="Gráfica de Kelly Full"></canvas>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  'use strict';

  // --- MÓDULO DE CONSTANTES Y ESTADO ---
  const CONSTANTS = {
    STORAGE_KEY: 'historialApuestasProfesionalCompleto',
    MERCADOS: [
      "Over 2.5 FT", "Under 2.5 FT", "Ambos Anotan", "BTTS NO",
      "Hándicap", "Local", "Visitante", "Empate"
    ],
  };

  const state = {
    historial: [],
    graficaBankroll: null,
    graficaKelly: null,
  };

  // --- MÓDULO DE ELEMENTOS DEL DOM ---
  const DOMElements = {
    form: document.getElementById('formApuesta'),
    submitButton: document.getElementById('submitButton'),
    cuotaImplicitaInput: document.getElementById('cuotaImplicita'),
    probabilidadInput: document.getElementById('probabilidad'),
    mercadoSelect: document.getElementById('mercado'),
    filtros: {
      liga: document.getElementById('filtroLiga'),
      local: document.getElementById('filtroLocal'),
      visita: document.getElementById('filtroVisita'),
      mercado: document.getElementById('filtroMercado'),
      estado: document.getElementById('filtroEstado'),
      btnLimpiar: document.getElementById('btnLimpiarFiltros'),
    },
    tablaBody: document.querySelector('#tablaHistorial tbody'),
    resumen: {
      bankroll: document.getElementById('resumenBankroll'),
      numApuestas: document.getElementById('resumenNumApuestas'),
      ganadas: document.getElementById('resumenGanadas'),
      perdidas: document.getElementById('resumenPerdidas'),
      yield: document.getElementById('resumenYield'),
      roi: document.getElementById('resumenROI'),
    },
    botones: {
      exportarCSV: document.getElementById('btnExportarCSV'),
      importarJSON: document.getElementById('btnImportarJSON'),
      inputImportJSON: document.getElementById('inputImportJSON'),
    },
    graficas: {
      ctxBankroll: document.getElementById('graficaBankroll').getContext('2d'),
      ctxKelly: document.getElementById('graficaKelly').getContext('2d'),
    },
  };

  // --- MÓDULO DE UTILIDADES ---
  const utils = {
    generateUUID: () => ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)),
    calcularCuotaImplicita: prob => (!prob || prob <= 0) ? '' : (100 / prob).toFixed(2),
    calcularEV: (prob, cuota) => (!(prob > 0 && cuota > 1)) ? 0 : (prob / 100) * cuota - 1,
    calcularKelly: (prob, cuota) => (!(prob > 0 && cuota > 1)) ? 0 : ((prob / 100) * (cuota - 1) - (1 - (prob / 100))) / (cuota - 1),
    stakeSugerido: (bank, kelly, frac) => {
      if (!(bank > 0 && kelly > 0 && frac > 0)) return 0;
      const stake = bank * kelly * frac;
      return stake > bank ? bank : stake;
    },
    showToast: (message, type = 'success') => {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    },
    formatearFecha: (fechaISO) => new Intl.DateTimeFormat('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }).format(new Date(fechaISO)),
  };

  // --- MÓDULO DE MANEJO DE DATOS (LOCALSTORAGE) ---
  const dataHandler = {
    guardar: () => localStorage.setItem(CONSTANTS.STORAGE_KEY, JSON.stringify(state.historial)),
    cargar: () => {
      const data = localStorage.getItem(CONSTANTS.STORAGE_KEY);
      state.historial = data ? JSON.parse(data) : [];
    },
  };

  // --- MÓDULO DE INTERFAZ DE USUARIO (UI) ---
  const ui = {
    renderizarTabla: () => {
      const apuestas = actions.filtrarHistorial();
      if (apuestas.length === 0) {
        DOMElements.tablaBody.innerHTML = `<tr class="no-results-row"><td colspan="14">No hay apuestas que mostrar.</td></tr>`;
        return;
      }
      DOMElements.tablaBody.innerHTML = apuestas.map((a, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${utils.formatearFecha(a.fecha)}</td>
          <td>${a.liga}</td>
          <td>${a.local}</td>
          <td>${a.visita}</td>
          <td>${a.mercado}</td>
          <td>${a.probabilidad.toFixed(2)}</td>
          <td>${a.cuotaImplicita.toFixed(2)}</td>
          <td>${a.cuotaBookie.toFixed(2)}</td>
          <td style="color: ${a.ev >= 0 ? 'var(--color-success)' : 'var(--color-danger)'}">${(a.ev * 100).toFixed(2)}</td>
          <td style="color: ${a.kellyFull > 0 ? 'var(--color-success)' : 'var(--color-text-secondary)'}">${(a.kellyFull * 100).toFixed(2)}</td>
          <td>${utils.stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac).toFixed(2)}</td>
          <td><span class="status-${a.estado}">${a.estado}</span></td>
          <td class="acciones">
            <button title="Marcar como ganada" aria-label="Marcar apuesta ${i + 1} como ganada" data-id="${a.id}" data-action="ganada">✅</button>
            <button title="Marcar como perdida" aria-label="Marcar apuesta ${i + 1} como perdida" data-id="${a.id}" data-action="perdida">❌</button>
            <button title="Marcar como pendiente" aria-label="Marcar apuesta ${i + 1} como pendiente" data-id="${a.id}" data-action="pendiente">⏳</button>
            <button title="Eliminar apuesta" aria-label="Eliminar apuesta ${i + 1}" data-id="${a.id}" data-action="eliminar">🗑️</button>
          </td>
        </tr>
      `).join('');
    },

    actualizarResumen: () => {
      const apuestas = actions.filtrarHistorial();
      const resumen = DOMElements.resumen;

      if (apuestas.length === 0) {
        Object.values(resumen).forEach(el => el.textContent = el.id.includes('Yield') || el.id.includes('ROI') ? '0.00%' : '0');
        resumen.bankroll.textContent = '-';
        return;
      }

      const bankrollInicial = apuestas[0].bankroll || 0;
      const ganadas = apuestas.filter(a => a.estado === 'ganada').length;
      const perdidas = apuestas.filter(a => a.estado === 'perdida').length;

      let totalGanado = 0;
      let totalApostado = 0;
      apuestas.forEach(a => {
        if(a.estado === 'ganada' || a.estado === 'perdida') {
            const stake = utils.stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac);
            totalApostado += stake;
            if (a.estado === 'ganada') totalGanado += stake * a.cuotaBookie;
        }
      });
      const neto = totalGanado - totalApostado;
      
      resumen.bankroll.textContent = bankrollInicial.toFixed(2);
      resumen.numApuestas.textContent = apuestas.length;
      resumen.ganadas.textContent = ganadas;
      resumen.perdidas.textContent = perdidas;
      resumen.yield.textContent = `${(totalApostado > 0 ? (neto / totalApostado) * 100 : 0).toFixed(2)}%`;
      resumen.roi.textContent = `${(bankrollInicial > 0 ? (neto / bankrollInicial) * 100 : 0).toFixed(2)}%`;
    },

    actualizarGraficas: () => {
      const apuestas = actions.filtrarHistorial();
      if (state.graficaBankroll) state.graficaBankroll.destroy();
      if (state.graficaKelly) state.graficaKelly.destroy();
      if (apuestas.length === 0) return;

      let bankInicial = apuestas[0].bankroll || 100;
      let bankData = [bankInicial];
      let labels = ['Inicio'];

      apuestas.forEach((a, i) => {
        const stake = utils.stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac);
        let ultimoBank = bankData[bankData.length - 1];
        if (a.estado === 'ganada') ultimoBank += stake * (a.cuotaBookie - 1);
        else if (a.estado === 'perdida') ultimoBank -= stake;
        bankData.push(ultimoBank);
        labels.push(`Apuesta ${i + 1}`);
      });
      
      const chartOptions = {
        responsive: true,
        plugins: { legend: { labels: { color: '#ddd', font: { size: 14, weight: '600' } } } },
        scales: {
          y: { beginAtZero: false, ticks: { color: '#ddd' }, grid: { color: '#444' } },
          x: { ticks: { color: '#ddd' }, grid: { color: '#444' } }
        }
      };

      state.graficaBankroll = new Chart(DOMElements.graficas.ctxBankroll, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Bankroll', data: bankData, borderColor: '#8257e6', backgroundColor: 'rgba(130, 87, 230, 0.3)', fill: true, tension: 0.3 }] },
        options: chartOptions
      });

      state.graficaKelly = new Chart(DOMElements.graficas.ctxKelly, {
        type: 'bar',
        data: { labels: labels.slice(1), datasets: [{ label: 'Kelly FULL (%)', data: apuestas.map(a => a.kellyFull * 100), backgroundColor: '#ffba08', borderRadius: 4 }] },
        options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, max: 100, beginAtZero: true } } }
      });
    },

    poblarSelectsMercado: () => {
        const optionsHTML = CONSTANTS.MERCADOS.map(m => `<option value="${m}">${m}</option>`).join('');
        DOMElements.mercadoSelect.insertAdjacentHTML('beforeend', optionsHTML);
        DOMElements.filtros.mercado.insertAdjacentHTML('beforeend', optionsHTML);
    },

    actualizarVistaCompleta: () => {
      ui.renderizarTabla();
      ui.actualizarResumen();
      ui.actualizarGraficas();
    },
  };

  // --- MÓDULO DE ACCIONES Y LÓGICA ---
  const actions = {
    filtrarHistorial: () => {
      const { liga, local, visita, mercado, estado } = DOMElements.filtros;
      const filtroLiga = liga.value.toLowerCase();
      const filtroLocal = local.value.toLowerCase();
      const filtroVisita = visita.value.toLowerCase();
      
      return state.historial.filter(a => 
        (!filtroLiga || a.liga.toLowerCase().includes(filtroLiga)) &&
        (!filtroLocal || a.local.toLowerCase().includes(filtroLocal)) &&
        (!filtroVisita || a.visita.toLowerCase().includes(filtroVisita)) &&
        (!mercado.value || a.mercado === mercado.value) &&
        (!estado.value || a.estado === estado.value)
      );
    },

    cambiarEstado: (id, nuevoEstado) => {
      const index = state.historial.findIndex(a => a.id === id);
      if (index !== -1) {
        state.historial[index].estado = nuevoEstado;
        dataHandler.guardar();
        ui.actualizarVistaCompleta();
      }
    },

    eliminarApuesta: id => {
      if (confirm('¿Estás seguro de eliminar esta apuesta?')) {
        state.historial = state.historial.filter(a => a.id !== id);
        dataHandler.guardar();
        ui.actualizarVistaCompleta();
        utils.showToast('Apuesta eliminada', 'success');
      }
    },

    validarFormulario: () => {
        let esValido = true;
        DOMElements.form.querySelectorAll('[required]').forEach(input => {
            if (!input.value.trim()) {
                input.classList.add('invalid');
                esValido = false;
            } else {
                input.classList.remove('invalid');
            }
        });
        return esValido;
    },

    agregarApuesta: () => {
        if (!actions.validarFormulario()) {
            utils.showToast('Por favor, completa todos los campos requeridos.', 'error');
            return;
        }

        const formData = new FormData(DOMElements.form);
        const prob = parseFloat(formData.get('probabilidad'));
        const cuotaBookie = parseFloat(formData.get('cuotaBookie'));

        const apuesta = {
            id: utils.generateUUID(),
            fecha: new Date().toISOString(),
            liga: formData.get('liga').trim(),
            local: formData.get('local').trim(),
            visita: formData.get('visita').trim(),
            mercado: formData.get('mercado'),
            probabilidad: prob,
            cuotaImplicita: parseFloat(utils.calcularCuotaImplicita(prob)),
            cuotaBookie: cuotaBookie,
            ev: utils.calcularEV(prob, cuotaBookie),
            kellyFull: utils.calcularKelly(prob, cuotaBookie),
            bankroll: parseFloat(formData.get('bankroll')),
            kellyFrac: parseFloat(formData.get('kellyFrac')),
            estado: 'pendiente'
        };

        state.historial.push(apuesta);
        dataHandler.guardar();
        
        DOMElements.form.reset();
        DOMElements.cuotaImplicitaInput.value = '';
        ui.actualizarVistaCompleta();
        utils.showToast('Apuesta agregada correctamente', 'success');
    },
  };
  
  // --- MÓDULO DE MANEJADORES DE EVENTOS ---
  const events = {
    init: () => {
      document.addEventListener('DOMContentLoaded', () => {
        ui.poblarSelectsMercado();
        dataHandler.cargar();
        ui.actualizarVistaCompleta();
        events.attachAll();
      });
    },

    attachAll: () => {
      DOMElements.form.addEventListener('submit', events.handleFormSubmit);
      DOMElements.probabilidadInput.addEventListener('input', events.handleProbabilidadInput);
      DOMElements.tablaBody.addEventListener('click', events.handleTablaClick);

      Object.values(DOMElements.filtros).forEach(el => 
        el.addEventListener(el.tagName === 'SELECT' ? 'change' : 'input', ui.actualizarVistaCompleta)
      );
      DOMElements.filtros.btnLimpiar.addEventListener('click', events.handleLimpiarFiltros);

      DOMElements.botones.exportarCSV.addEventListener('click', events.handleExportarCSV);
      DOMElements.botones.importarJSON.addEventListener('click', () => DOMElements.botones.inputImportJSON.click());
      DOMElements.botones.inputImportJSON.addEventListener('change', events.handleImportarJSON);

      DOMElements.form.querySelectorAll('[required]').forEach(input => {
        input.addEventListener('input', () => input.classList.remove('invalid'));
      });
    },

    handleFormSubmit: e => {
        e.preventDefault();
        DOMElements.submitButton.disabled = true;
        DOMElements.submitButton.textContent = 'Agregando...';
        setTimeout(() => {
            actions.agregarApuesta();
            DOMElements.submitButton.disabled = false;
            DOMElements.submitButton.textContent = 'Agregar apuesta';
        }, 200);
    },

    handleProbabilidadInput: e => {
      DOMElements.cuotaImplicitaInput.value = utils.calcularCuotaImplicita(parseFloat(e.target.value));
    },

    handleTablaClick: e => {
      const button = e.target.closest('button[data-action]');
      if (!button) return;
      
      const { id, action } = button.dataset;
      if (action === 'eliminar') actions.eliminarApuesta(id);
      else actions.cambiarEstado(id, action);
    },

    handleLimpiarFiltros: () => {
      ['liga', 'local', 'visita', 'mercado', 'estado'].forEach(key => DOMElements.filtros[key].value = '');
      ui.actualizarVistaCompleta();
    },

    handleExportarCSV: () => {
      if (state.historial.length === 0) return utils.showToast('No hay datos para exportar', 'error');
      const headers = Object.keys(state.historial[0]).join(',');
      const rows = state.historial.map(row => Object.values(row).map(val => `"${String(val).replace(/"/g, '""')}"`).join(','));
      const csv = [headers, ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `historial_apuestas_${new Date().toISOString().slice(0, 10)}.csv`;
      link.click();
      URL.revokeObjectURL(link.href);
    },

    handleImportarJSON: e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const data = JSON.parse(evt.target.result);
          if (!Array.isArray(data)) throw new Error('El archivo JSON debe contener un array.');
          state.historial = data;
          dataHandler.guardar();
          ui.actualizarVistaCompleta();
          utils.showToast('Historial importado correctamente', 'success');
        } catch (error) {
          utils.showToast(`Error al importar: ${error.message}`, 'error');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    },
  };

  // --- INICIALIZACIÓN DE LA APLICACIÓN ---
  events.init();

})();
</script>
</body>
</html>