<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Analizador Profesional de Rentabilidad por Equipo</title>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; background: #f4f4f9; padding: 20px; }
.container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
h1 { text-align: center; color: #4caf50; border-bottom: 2px solid #4caf50; padding-bottom: 10px; }
.controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
select, input, button { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { border: 1px solid #ddd; padding: 10px; }
th { background: #4caf50; color: white; }
.rentable { color: #2e7d32; font-weight: bold; }
.no-rentable { color: #d32f2f; font-weight: bold; }
.neutral { color: #555; font-weight: bold; }
button { cursor: pointer; background: #4caf50; color: white; border: none; }
</style>
</head>

<body>
<div class="container">
<h1>âš½ Analizador Profesional de Equipos</h1>

<div class="controls">
<input type="file" id="fileInput" accept=".xlsx">
<select id="filtroPosicion">
    <option value="all">Local + Visitante</option>
    <option value="home">Solo Local</option>
    <option value="away">Solo Visitante</option>
</select>

<select id="filtroLiga">
    <option value="all">Todas las Ligas</option>
</select>

<select id="filtroLimite">
    <option value="0">Todos los partidos</option>
    <option value="15">Ãšltimos 15 registros</option>
</select>

<button onclick="exportarExcel()">Exportar a Excel</button>
</div>

<div id="resultados"></div>
</div>

<script>
let datosGlobales = [];
let rankingFinal = [];

document.getElementById('fileInput').addEventListener('change', cargarArchivo);
document.querySelectorAll('select').forEach(e => e.addEventListener('change', recalcular));

function cargarArchivo(e) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        // Aseguramos que los encabezados coincidan o se manejen correctamente (aunque 'Match', 'Odd', 'Result', 'League' parecen ser correctos)
        datosGlobales = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        cargarLigas();
        recalcular();
    };
    reader.readAsArrayBuffer(e.target.files[0]);
}

function cargarLigas() {
    const ligas = [...new Set(datosGlobales.map(r => r.League).filter(l => l && l.trim() !== ''))];
    const select = document.getElementById("filtroLiga");
    
    // ðŸ’¡ CORRECCIÃ“N: Limpiar opciones viejas antes de agregar las nuevas
    select.innerHTML = '<option value="all">Todas las Ligas</option>'; 
    
    ligas.forEach(l => {
        const opt = document.createElement("option");
        opt.value = l;
        opt.textContent = l;
        select.appendChild(opt);
    });
}

function recalcular() {
    const posicion = document.getElementById("filtroPosicion").value;
    const liga = document.getElementById("filtroLiga").value;
    const limite = parseInt(document.getElementById("filtroLimite").value);

    let datosFiltrados = [...datosGlobales];

    // Aplicar filtro por Liga
    if (liga !== "all") {
        datosFiltrados = datosFiltrados.filter(d => String(d.League) === liga);
    }
    
    // Aplicar filtro de LÃ­mite (sobre los registros ya filtrados por liga)
    if (limite > 0) {
        // slice(-limite) toma los Ãºltimos 'limite' elementos
        datosFiltrados = datosFiltrados.slice(-limite);
    }

    procesarDatos(datosFiltrados, posicion);
}

function procesarDatos(data, posicion) {
    const resultados = {};

    data.forEach(row => {
        // Aseguramos que la columna Match exista y tenga el formato correcto
        if (!row.Match || !String(row.Match).includes("-")) return; 

        // ExtracciÃ³n robusta de equipos (usando el formato que funciona)
        const [home, away] = String(row.Match).split("-").map(t => t.trim());
        
        // Convertir y validar Odd
        const odd = parseFloat(row.Odd) || 1;
        
        // ðŸ’¡ CORRECCIÃ“N CRÃTICA: Asegurar que se detecten todas las palabras de Ã©xito ('WINNING', '1', etc.)
        const resultUpper = String(row.Result).toUpperCase().trim();
        const isWin = resultUpper === "WIN" || resultUpper === "WINNING" || resultUpper === "1";

        const aplicar = (team, tipo) => {
            // Aplicar el filtro de PosiciÃ³n (Home, Away, All)
            if (posicion !== "all" && posicion !== tipo) return;

            // Inicializar y agregar estadÃ­sticas
            if (!resultados[team]) resultados[team] = { partidos: 0, aciertos: 0, profit: 0 };
            resultados[team].partidos++;
            if (isWin) resultados[team].aciertos++;
            
            // CÃ¡lculo de Profit
            resultados[team].profit += isWin ? (odd - 1) : -1;
        };

        aplicar(home, "home");
        aplicar(away, "away");
    });
    
    // GeneraciÃ³n del ranking final para la tabla y exportaciÃ³n
    rankingFinal = Object.entries(resultados).map(([name, d]) => ({
        Equipo: name,
        Partidos: d.partidos,
        Aciertos: d.aciertos,
        WinRate: ((d.aciertos / d.partidos) * 100).toFixed(1),
        Profit: d.profit.toFixed(2),
        // CÃ¡lculo del Retorno de InversiÃ³n (ROI): (Profit / Unidades Apostadas) * 100
        ROI: ((d.profit / d.partidos) * 100).toFixed(2) 
    })).sort((a, b) => parseFloat(b.Profit) - parseFloat(a.Profit)); // Ordenar por Profit (como nÃºmero)

    mostrarTabla();
}

function mostrarTabla() {
    let html = `<table>
    <tr>
        <th>Equipo</th><th>Partidos</th><th>Aciertos</th><th>Win%</th>
        <th>Profit</th><th>ROI%</th><th>Estado</th>
    </tr>`;

    rankingFinal.forEach(e => {
        const profitValue = parseFloat(e.Profit);
        
        const estado = profitValue > 0 ? "Rentable" : profitValue < 0 ? "PÃ©rdida" : "Neutro";
        const clase = profitValue > 0 ? "rentable" : profitValue < 0 ? "no-rentable" : "neutral";

        html += `
        <tr>
            <td>${e.Equipo}</td>
            <td>${e.Partidos}</td>
            <td>${e.Aciertos}</td>
            <td>${e.WinRate}%</td>
            <td class="${clase}">${e.Profit} u</td>
            <td class="${clase}">${e.ROI}%</td>
            <td class="${clase}">${estado}</td>
        </tr>`;
    });

    html += "</table>";
    document.getElementById("resultados").innerHTML = html;
}

function exportarExcel() {
    if (rankingFinal.length === 0) {
        alert("No hay datos para exportar. Por favor, carga un archivo y recalcula.");
        return;
    }
    const ws = XLSX.utils.json_to_sheet(rankingFinal);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ranking Equipos");
    XLSX.writeFile(wb, "ranking_rentabilidad_equipos.xlsx");
}
</script>
</body>
</html>
