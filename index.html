<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Poisson Premier League</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: 1 / span 2; }
        label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
        textarea { width: 100%; height: 120px; border: 1px solid #ccc; border-radius: 5px; padding: 10px; box-sizing: border-box; resize: vertical; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; transition: 0.3s; }
        button:hover { background-color: #218838; }
        #results { margin-top: 30px; }
        .match-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; background: #fff; }
        .match-header { font-weight: bold; font-size: 1.1em; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .prob-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .prob-table td, .prob-table th { border: 1px solid #eee; padding: 8px; text-align: center; }
        .best-bet { color: #d9534f; font-weight: bold; }
        .stats-summary { font-size: 0.9em; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Predicciones de Poisson</h1>
    
    <div class="grid">
        <div class="full-width">
            <label>1. Próximos Partidos (Copia la lista):</label>
            <textarea id="matchesInput" placeholder="Fri 26 Dec Manchester Utd 14:00 Newcastle Utd..."></textarea>
        </div>
        
        <div>
            <label>2. Estadística de Local:</label>
            <textarea id="homeStatsInput" placeholder="1 Manchester City 9 8 0 1 25 6..."></textarea>
        </div>
        
        <div>
            <label>3. Estadística de Visitante:</label>
            <textarea id="awayStatsInput" placeholder="1 Arsenal 9 5 2 2 11 7..."></textarea>
        </div>

        <div>
            <label>4. Promedio Goles Local (Ej: 1.61):</label>
            <input type="number" id="avgHomeGoals" step="0.01" value="1.61">
        </div>

        <div>
            <label>5. Promedio Goles Visita (Ej: 1.22):</label>
            <input type="number" id="avgAwayGoals" step="0.01" value="1.22">
        </div>
    </div>

    <button onclick="calculatePoisson()">Calcular Probabilidades</button>

    <div id="results"></div>
</div>

<script>
    function factorial(n) {
        if (n === 0 || n === 1) return 1;
        let res = 1;
        for (let i = 2; i <= n; i++) res *= i;
        return res;
    }

    function poissonProb(lambda, x) {
        return (Math.exp(-lambda) * Math.pow(lambda, x)) / factorial(x);
    }

    function parseStats(text) {
        const stats = {};
        const lines = text.split('\n');
        lines.forEach(line => {
            const parts = line.trim().split(/\t|\s{2,}/);
            if (parts.length >= 7) {
                // Nombre del equipo suele ser el segundo elemento
                // Ajuste para nombres compuestos (ej: Manchester Utd)
                const teamName = parts[1].trim();
                stats[teamName] = {
                    pj: parseFloat(parts[2]),
                    gf: parseFloat(parts[6]),
                    gc: parseFloat(parts[7])
                };
            }
        });
        return stats;
    }

    function calculatePoisson() {
        const matchesText = document.getElementById('matchesInput').value.trim();
        const homeStats = parseStats(document.getElementById('homeStatsInput').value);
        const awayStats = parseStats(document.getElementById('awayStatsInput').value);
        const leagueAvgHome = parseFloat(document.getElementById('avgHomeGoals').value);
        const leagueAvgAway = parseFloat(document.getElementById('avgAwayGoals').value);

        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';

        const lines = matchesText.split('\n');
        
        lines.forEach(line => {
            // Regex simple para detectar equipos: busca patrones de nombres entre fechas y horas
            // Formato esperado: Day Date Team1 Time Team2
            const parts = line.split(/\t|\s{2,}/);
            if (parts.length < 4) return;

            const homeTeam = parts[1].trim();
            const awayTeam = parts[3].trim();

            if (homeStats[homeTeam] && awayStats[awayTeam]) {
                const h = homeStats[homeTeam];
                const a = awayStats[awayTeam];

                // Cálculo de Expectativa de Goles (xG)
                const attackStrengthH = (h.gf / h.pj) / leagueAvgHome;
                const defenseStrengthA = (a.gc / a.pj) / leagueAvgAway;
                const lambdaH = attackStrengthH * defenseStrengthA * leagueAvgHome;

                const attackStrengthA = (a.gf / a.pj) / leagueAvgAway;
                const defenseStrengthH = (h.gc / h.pj) / leagueAvgHome;
                const lambdaA = attackStrengthA * defenseStrengthH * leagueAvgAway;

                displayMatch(homeTeam, awayTeam, lambdaH, lambdaA, resultsDiv);
            }
        });
    }

    function displayMatch(home, away, lH, lA, container) {
        let probH = 0, probD = 0, probA = 0;
        let matrix = [];

        for (let i = 0; i <= 5; i++) {
            matrix[i] = [];
            for (let j = 0; j <= 5; j++) {
                const p = poissonProb(lH, i) * poissonProb(lA, j);
                matrix[i][j] = p;
                if (i > j) probH += p;
                else if (i === j) probD += p;
                else probA += p;
            }
        }

        const card = document.createElement('div');
        card.className = 'match-card';
        card.innerHTML = `
            <div class="match-header">
                <span>${home} vs ${away}</span>
                <span>xG: ${lH.toFixed(2)} - ${lA.toFixed(2)}</span>
            </div>
            <div class="stats-summary">
                Probabilidades: <b>L: ${(probH * 100).toFixed(1)}%</b> | 
                <b>E: ${(probD * 100).toFixed(1)}%</b> | 
                <b>V: ${(probA * 100).toFixed(1)}%</b>
            </div>
            <table class="prob-table">
                <tr><th>Goles</th><th>0</th><th>1</th><th>2</th><th>3</th></tr>
                <tr><th>${home}</th>
                    <td>${(poissonProb(lH, 0)*100).toFixed(1)}%</td>
                    <td>${(poissonProb(lH, 1)*100).toFixed(1)}%</td>
                    <td>${(poissonProb(lH, 2)*100).toFixed(1)}%</td>
                    <td>${(poissonProb(lH, 3)*100).toFixed(1)}%</td>
                </tr>
                <tr><th>${away}</th>
                    <td>${(poissonProb(lA, 0)*100).toFixed(1)}%</td>
                    <td>${(poissonProb(lA, 1)*100).toFixed(1)}%</td>
                    <td>${(poissonProb(lA, 2)*100).toFixed(1)}%</td>
                    <td>${(poissonProb(lA, 3)*100).toFixed(1)}%</td>
                </tr>
            </table>
        `;
        container.appendChild(card);
    }
</script>

</body>
</html>
