<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Calculadora Poisson - Cálculo Manual de Fuerzas</title>
    <style>
        /* Estilos Base */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0;
            background-color: #1a1a2e;
            color: #e0e0e0; 
            min-height: 100vh; 
            width: 100vw;
            display: flex;
            flex-direction: column; 
            justify-content: flex-start; 
            align-items: center;
        }
        .container { 
            width: 98vw; 
            max-width: 950px; 
            padding: 40px 30px; 
            margin-top: 15px; 
            margin-bottom: 15px; 
            background-color: #2c2c54; 
            border-radius: 20px; 
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.7); 
        }
        h2 { 
            text-align: center; 
            color: #79d70f; 
            margin-bottom: 5px; 
            font-size: 2.2em; 
        }
        small {
            display: block;
            text-align: center;
            margin-bottom: 20px;
            color: #ccc;
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600; 
            color: #f0f0f0;
            font-size: 1.1em; 
        }
        input[type="number"] { 
            padding: 12px;
            margin-bottom: 15px; 
            width: 100%; 
            box-sizing: border-box; 
            border: 3px solid #4a4e69; 
            border-radius: 10px; 
            background-color: #3e3e6b; 
            color: #ffffff; 
            font-size: 1.1em;
        }
        button { 
            padding: 15px; 
            background-color: #79d70f; 
            color: #1a1a2e; 
            border: none; 
            border-radius: 10px; 
            width: 100%; 
            cursor: pointer; 
            font-size: 1.2em; 
            font-weight: bold;
            transition: background-color 0.3s; 
            margin-top: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            opacity: 0.9;
        }
        .section-title {
            color: #79d70f; 
            margin-top: 25px;
            margin-bottom: 10px;
            font-size: 1.4em;
            text-align: center;
            border-bottom: 2px solid #3a3a5e;
            padding-bottom: 8px;
        }
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .input-manual-data {
            padding: 15px;
            border: 1px solid #79d70f; 
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .manual-data-title {
            color: #79d70f;
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .resultado { 
            margin-top: 30px; 
            padding: 25px; 
            border: 4px dashed #79d70f; 
            border-radius: 15px; 
            background-color: #3a3a5e;
        }
        .resultado p { 
            margin: 8px 0; 
            font-size: 1.3em; 
            display: flex;
            justify-content: space-between;
        }
        .resultado strong { 
            color: #92e62c; 
            font-weight: bold;
        }
        .calculation-summary {
            margin-top: 15px;
            padding: 15px;
            background-color: #1a1a2e;
            border-radius: 10px;
            font-size: 0.95em;
        }
        .calculation-summary h4 {
            color: #79d70f;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px dashed #4a4e69;
            padding-bottom: 5px;
        }
        .calculation-summary p {
            margin: 5px 0;
            color: #ccc;
        }

    </style>
</head>
<body>
    <div class="container">
        <h2>⚽ Calculadora Poisson - Cálculo Manual</h2>
        <small>Introduzca las medias de goles de la Liga y los Equipos para calcular los $\lambda$ de Poisson.</small>
        
        <div class="section-title">1. Medias Promedio de la Liga</div>
        <div class="input-group">
            <div class="input-manual-data">
                <div class="manual-data-title">Promedio Goles Liga (Local)</div>
                <label for="avg_league_home">Goles marcados por locales en la liga:</label>
                <input type="number" id="avg_league_home" placeholder="Ej: 1.55" step="0.01" value="1.55">
            </div>
            <div class="input-manual-data">
                <div class="manual-data-title">Promedio Goles Liga (Visitante)</div>
                <label for="avg_league_away">Goles marcados por visitantes en la liga:</label>
                <input type="number" id="avg_league_away" placeholder="Ej: 1.15" step="0.01" value="1.15">
            </div>
        </div>

        <div class="section-title">2. Medias Promedio de los Equipos</div>
        <div class="input-group">
            <div class="input-manual-data" style="border-color: #00bcd4;">
                <div class="manual-data-title" style="color: #00bcd4;">Equipo Local (L)</div>
                <label for="avg_home_scored">Promedio Goles **A Favor** (Local):</label>
                <input type="number" id="avg_home_scored" placeholder="Ej: 1.90" step="0.01" value="1.90">
                <label for="avg_home_conceded">Promedio Goles **En Contra** (Local):</label>
                <input type="number" id="avg_home_conceded" placeholder="Ej: 0.80" step="0.01" value="0.80">
            </div>
            <div class="input-manual-data" style="border-color: #ff9800;">
                <div class="manual-data-title" style="color: #ff9800;">Equipo Visitante (V)</div>
                <label for="avg_away_scored">Promedio Goles **A Favor** (Visitante):</label>
                <input type="number" id="avg_away_scored" placeholder="Ej: 1.20" step="0.01" value="1.20">
                <label for="avg_away_conceded">Promedio Goles **En Contra** (Visitante):</label>
                <input type="number" id="avg_away_conceded" placeholder="Ej: 1.30" step="0.01" value="1.30">
            </div>
        </div>

        <button onclick="calculateManualPoisson()">3. Calcular Goles Esperados y Pronóstico Poisson</button>

        <div class="resultado" id="resultados_poisson" style="display:none;">
            <div class="section-title" style="color:#79d70f; border-color:#79d70f;">📊 Resultados del Modelo Poisson Estándar</div>

            <div class="calculation-summary">
                <h4>Detalle de Parámetros de la Fórmula</h4>
                <p>Media Goles Liga (Local): <strong id="avg_league_L_res">...</strong> | Media Goles Liga (Visitante): <strong id="avg_league_V_res">...</strong></p>
                <hr style="border-top: 1px dashed #4a4e69; margin: 10px 0;">
                
                <p>Fuerza de Ataque Local ($\text{Att}_L$): <strong id="att_L">...</strong></p>
                <p>Fuerza de Defensa Visitante ($\text{Def}_V$): <strong id="def_V">...</strong></p>
                <p>Fuerza de Ataque Visitante ($\text{Att}_V$): <strong id="att_V">...</strong></p>
                <p>Fuerza de Defensa Local ($\text{Def}_L$): <strong id="def_L">...</strong></p>
                
                <hr style="border-top: 1px solid #555; margin: 10px 0;">
                <p style="font-size:1.4em;">**Goles Esperados Local ($\lambda_L$):** <strong id="lambda_L_res">...</strong></p>
                <p style="font-size:1.4em;">**Goles Esperados Visitante ($\lambda_V$):** <strong id="lambda_V_res">...</strong></p>
            </div>
            
            <div class="section-title" style="color:#79d70f; border-color:#79d70f; margin-top:20px;">Mercados de Goles</div>
            
            <p>Over 2.5 Goles: <strong id="over25Prob">...</strong></p>
            <p>Under 2.5 Goles: <strong id="under25Prob">...</strong></p>
            
            <div class="section-title" style="color:#79d70f; border-color:#79d70f; margin-top:20px;">Ambos Anotan (BTTS)</div>
            <p>BTTS Yes (Sí): <strong id="bttsYesProb">...</strong></p>
            <p>BTTS No (No): <strong id="bttsNoProb">...</strong></p>
            
        </div>

    </div>

    <script>
        const MAX_GOALS = 6; 
        
        // =======================================================
        // 1. LÓGICA DE CÁLCULO DE FUERZAS Y LAMBDA
        // =======================================================

        function calculateManualPoisson() {
            const resultsDiv = document.getElementById('resultados_poisson');

            // 1. Obtener Entradas
            const avgLeagueL = parseFloat(document.getElementById('avg_league_home').value);
            const avgLeagueV = parseFloat(document.getElementById('avg_league_away').value);
            
            const avgHomeScored = parseFloat(document.getElementById('avg_home_scored').value);
            const avgHomeConceded = parseFloat(document.getElementById('avg_home_conceded').value);
            
            const avgAwayScored = parseFloat(document.getElementById('avg_away_scored').value);
            const avgAwayConceded = parseFloat(document.getElementById('avg_away_conceded').value);

            // Validar entradas
            if ([avgLeagueL, avgLeagueV, avgHomeScored, avgHomeConceded, avgAwayScored, avgAwayConceded].some(isNaN) ||
                [avgLeagueL, avgLeagueV].some(val => val <= 0)) {
                alert("Por favor, introduce todos los valores numéricos válidos. Las medias de liga deben ser mayores a 0.");
                resultsDiv.style.display = 'none';
                return;
            }

            try {
                // 2. Calcular Fuerzas
                // Fórmula: Fuerza Ataque = Media Goles Favor Equipo / Media Goles Liga (Local si es Local, Visitante si es Visitante)
                // Fórmula: Fuerza Defensa = Media Goles Contra Equipo / Media Goles Liga (Contraria)

                // 2.1. Fuerzas de Ataque
                const attackL = avgHomeScored / avgLeagueL;
                const attackV = avgAwayScored / avgLeagueV;
                
                // 2.2. Fuerzas de Defensa
                // La defensa del local (Home) se compara con los goles que reciben los visitantes de la liga (AvgLeagueV)
                const defenseL = avgHomeConceded / avgLeagueV; 
                // La defensa del visitante (Away) se compara con los goles que reciben los locales de la liga (AvgLeagueL)
                const defenseV = avgAwayConceded / avgLeagueL; 

                // 3. Calcular Goles Esperados (Lambda)
                // lambda_L = AttL * DefV * AvgL
                const lambdaL = attackL * defenseV * avgLeagueL;
                // lambda_V = AttV * DefL * AvgV
                const lambdaV = attackV * defenseL * avgLeagueV;

                const params = {
                    lambdaL, lambdaV, 
                    attackL, defenseV, 
                    attackV, defenseL,
                    avgLeagueL, avgLeagueV,
                };

                // 4. Calcular Probabilidades Poisson
                const probabilities = calculateStandardPoissonProbabilities(lambdaL, lambdaV);
                
                // 5. Mostrar Resultados
                displayResults(probabilities, params);
                resultsDiv.style.display = 'block';

            } catch (error) {
                alert("Error durante el cálculo: " + error.message);
                resultsDiv.style.display = 'none';
            }
        }
        
        // =======================================================
        // 4. FUNCIONES AUXILIARES (Poisson y Display)
        // =======================================================

        function factorial(n) {
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }

        function poisson_prob(k, lambda) {
            if (k < 0 || lambda < 0) return 0;
            return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
        }
        
        function calculateStandardPoissonProbabilities(L_FT, V_FT) {
            let p_total_0 = 0;
            let p_total_1 = 0;
            let p_total_2 = 0;
            let p_btts_ft = 0;
            let p_suma_total_ft = 0;

            for (let L = 0; L <= MAX_GOALS; L++) {
                for (let V = 0; V <= MAX_GOALS; V++) {
                    const P_LV = poisson_prob(L, L_FT) * poisson_prob(V, V_FT);
                    p_suma_total_ft += P_LV; 
                    
                    const total = L + V;
                    if (total === 0) p_total_0 += P_LV;
                    if (total === 1) p_total_1 += P_LV;
                    if (total === 2) p_total_2 += P_LV;
                    
                    if (L > 0 && V > 0) p_btts_ft += P_LV; 
                }
            }
            
            if (p_suma_total_ft === 0) return { p_under_2_5: 0, p_over_2_5: 0, p_btts_yes: 0, p_btts_no: 0 };
            
            // Normalización
            const factor = 1.0 / p_suma_total_ft;
            p_btts_ft *= factor;
            const p_under_2_5_ft = (p_total_0 + p_total_1 + p_total_2) * factor;
            
            return {
                p_under_2_5: p_under_2_5_ft, 
                p_over_2_5: 1 - p_under_2_5_ft,
                p_btts_yes: p_btts_ft, 
                p_btts_no: 1 - p_btts_ft,
            };
        }

        const calculateOdds = (probability) => (probability > 0 ? (1 / probability).toFixed(2) : '∞');
        
        const formatOutput = (prob) => {
            const percentage = (prob * 100).toFixed(2);
            const odds = calculateOdds(prob);
            return `${percentage}% (Cuota: ${odds})`; 
        };

        function displayResults(probabilities, params) {
            // Mostrar Detalle de Cálculos
            document.getElementById('avg_league_L_res').textContent = params.avgLeagueL.toFixed(3);
            document.getElementById('avg_league_V_res').textContent = params.avgLeagueV.toFixed(3);
            
            document.getElementById('att_L').textContent = params.attackL.toFixed(3);
            document.getElementById('def_V').textContent = params.defenseV.toFixed(3);
            document.getElementById('att_V').textContent = params.attackV.toFixed(3);
            document.getElementById('def_L').textContent = params.defenseL.toFixed(3);
            
            document.getElementById('lambda_L_res').textContent = params.lambdaL.toFixed(3);
            document.getElementById('lambda_V_res').textContent = params.lambdaV.toFixed(3);

            // Mostrar Resultados de Mercados
            document.getElementById('over25Prob').textContent = formatOutput(probabilities.p_over_2_5);
            document.getElementById('under25Prob').textContent = formatOutput(probabilities.p_under_2_5);
            document.getElementById('bttsYesProb').textContent = formatOutput(probabilities.p_btts_yes);
            document.getElementById('bttsNoProb').textContent = formatOutput(probabilities.p_btts_no);
        }
    </script>
</body>
</html>
