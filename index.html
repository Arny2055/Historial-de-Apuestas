<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Gurú de las Apuestas | Quantum Engine</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0A1C16; --card: #182B24; --accent-gold: #FFD700; --accent-green: #3CB371;
            --text-main: #E0E7E4; --text-dim: #7F9C93; --border: #3D5C53; --safe-bottom: env(safe-area-inset-bottom);
            --highlight: #00BFFF; --fair-odds: #FFA500; --delete: #ff4d4d; --value-color: #00ff00;
            --quantum-blue: #00FFFF;
            --card-gradient: linear-gradient(145deg, #1e362d 0%, #12221b 100%);
            --risk-low: #2ecc71; --risk-med: #f1c40f; --risk-high: #e74c3c;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); color: var(--text-main); 
            font-family: -apple-system, system-ui, sans-serif; 
            overflow: hidden; 
        }

        #setup-screen, #dashboard-screen, #batch-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; overflow: hidden; 
        }

        .scroll-content { 
            flex: 1; overflow-y: auto; padding: 15px; 
            -webkit-overflow-scrolling: touch;
            padding-bottom: 140px; 
        }

        .history-scroll-container {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 5px;
            border: 1px solid rgba(61, 92, 83, 0.3);
            border-radius: 12px;
            padding: 10px;
            background: rgba(0,0,0,0.1);
        }

        .header-box { text-align: center; padding: 15px 0; flex-shrink: 0; background: var(--bg); z-index: 10; border-bottom: 1px solid rgba(61, 92, 83, 0.3); }
        .header-box i.logo-icon { color: var(--accent-gold); font-size: 1.8rem; margin-bottom: 5px; display: block; }
        .header-box h2 { font-size: 1.4rem; color: var(--accent-gold); margin: 0; font-weight: 800; letter-spacing: 1px; }
        .header-box small { color: var(--accent-green); font-size: 0.7rem; text-transform: uppercase; }
        
        textarea { 
            width: 100%; height: 60px; background: var(--card); border: 1px solid var(--border); 
            border-radius: 10px; color: var(--accent-green); padding: 8px; font-size: 10px; 
            margin-bottom: 8px; outline: none; resize: none;
        }

        .db-panel { background: rgba(24, 43, 36, 0.5); border: 1px dashed var(--border); border-radius: 12px; padding: 12px; margin-bottom: 15px; }
        .db-input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .db-input-group input { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: #fff; padding: 8px; font-size: 12px; }
        .db-btn { background: var(--accent-gold); color: #000; border: none; padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; }
        
        .league-selector-group { margin-top: 10px; }
        .league-selector-group select { background: var(--accent-green); color: #000; font-weight: bold; margin-bottom: 5px; cursor: pointer; width: 100%; padding: 10px; border-radius: 8px; border: none; }

        .select-container { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        select { 
            width: 100%; padding: 12px; background: var(--card); color: var(--text-main); 
            border: 1px solid var(--border); border-radius: 10px; font-size: 14px; outline: none; 
        }
        
        .btn-main { 
            width: 100%; background: linear-gradient(135deg, var(--accent-green), #4CAF50); 
            color: #000; border: none; padding: 16px; border-radius: 12px; 
            font-weight: bold; font-size: 1rem; cursor: pointer; margin-bottom: 10px;
        }

        .btn-secondary {
            width: 100%; background: transparent; border: 1px solid var(--accent-gold);
            color: var(--accent-gold); padding: 12px; border-radius: 12px;
            font-weight: bold; font-size: 0.9rem; cursor: pointer; margin-bottom: 10px;
        }

        .btn-tertiary {
            width: 100%; background: rgba(0, 255, 255, 0.1); border: 1px solid var(--quantum-blue);
            color: var(--quantum-blue); padding: 12px; border-radius: 12px;
            font-weight: bold; font-size: 0.9rem; cursor: pointer; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        .btn-sync {
            width: 100%; background: #4285F4; color: white; border: none; padding: 12px;
            border-radius: 12px; font-weight: bold; font-size: 0.9rem; cursor: pointer;
            margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        #league-trend-box {
            background: linear-gradient(180deg, rgba(24, 43, 36, 0.9) 0%, rgba(10, 28, 22, 1) 100%);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .trend-title { 
            color: var(--accent-gold); font-weight: 800; font-size: 0.8rem; 
            margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .trend-badge { background: var(--accent-gold); color: #000; padding: 4px 8px; border-radius: 4px; font-weight: 800; font-size: 0.65rem; margin-right: 5px; }
        .min-odds-tag { color: var(--fair-odds); font-family: 'Courier New', monospace; font-weight: bold; }
        
        .reliability-card {
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(255, 215, 0, 0.1);
        }
        .score-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
        .score-label { font-size: 0.7rem; color: var(--text-dim); font-weight: bold; }
        .score-value { font-size: 1.2rem; font-weight: 900; color: var(--accent-gold); line-height: 1; }
        
        .progress-container { 
            height: 12px; background: #000; border-radius: 20px; 
            overflow: hidden; border: 1px solid #333;
        }
        .progress-fill { 
            height: 100%; width: 0%; transition: width 1.2s ease-in-out;
            background: linear-gradient(90deg, #ff4d4d, #ffd700, #00ff00);
            background-size: 200% 100%;
        }

        .quantum-pulse {
            animation: pulse-blue 1.5s infinite;
            background: linear-gradient(90deg, var(--quantum-blue), #ffffff, var(--quantum-blue)) !important;
            background-size: 200% 100% !important;
            box-shadow: 0 0 15px var(--quantum-blue);
        }
        @keyframes pulse-blue {
            0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; }
        }

        .reliability-footer { 
            margin-top: 8px; font-size: 0.65rem; color: var(--accent-green); 
            font-style: italic; text-align: center; display: block;
        }

        .page { display: none; }
        .page.active { display: block; }
        
        .section-title { 
            font-size: 0.75rem; color: var(--accent-gold); text-transform: uppercase; 
            letter-spacing: 1px; margin: 15px 0 8px; border-left: 3px solid var(--accent-gold); padding-left: 8px; 
        }

        .batch-card {
            background: var(--card-gradient);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .batch-match-header {
            background: linear-gradient(90deg, #182B24 0%, #0A1C16 100%);
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid var(--accent-gold);
        }
        .batch-match-name { font-weight: 900; color: #fff; font-size: 1.1rem; text-transform: uppercase; }
        .batch-market-list { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .batch-item-pro {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        
        .value-detected { border: 1px solid var(--accent-green) !important; box-shadow: 0 0 12px rgba(60, 179, 113, 0.4); background: rgba(60, 179, 113, 0.05); }
        .value-tag { position: absolute; top: -8px; right: 12px; background: var(--accent-green); color: #000; font-size: 0.55rem; font-weight: 900; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }

        .label-stack { display: flex; flex-direction: column; }
        .label-stack .m-name { font-size: 0.8rem; color: #fff; font-weight: 800; text-transform: uppercase; margin-bottom: 2px; }
        .label-stack .m-prob { font-size: 1.2rem; color: var(--accent-gold); font-weight: 900; }
        .odds-stack { text-align: right; }
        .odds-stack .m-tag { font-size: 0.6rem; color: var(--accent-green); font-weight: bold; display: block; }
        .odds-stack .m-fair { font-size: 1.4rem; color: var(--fair-odds); font-weight: 900; font-family: 'Courier New', monospace; line-height: 1; }

        .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 12px; margin-bottom: 12px; }
        .row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); gap: 5px; cursor: pointer; }
        .row:active { background: rgba(255,255,255,0.05); }
        .row:last-child { border: none; }
        .row span { color: var(--text-dim); font-size: 0.75rem; flex: 1; }
        .val-group { display: flex; align-items: center; gap: 8px; }
        .row b.pct { color: var(--accent-gold); font-size: 0.85rem; min-width: 45px; text-align: right; }
        .row b.odds { color: var(--fair-odds); font-size: 0.75rem; min-width: 35px; text-align: right; opacity: 0.8; }

        #pick-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card); border: 1px solid var(--accent-gold); border-radius: 15px; width: 100%; max-width: 350px; padding: 20px; }
        .modal-content h3 { margin: 0 0 15px; font-size: 1rem; color: var(--accent-gold); text-align: center; }
        .modal-content select, .modal-content input { width: 100%; padding: 12px; margin-bottom: 10px; background: var(--bg); border: 1px solid var(--border); color: #fff; border-radius: 8px; font-size: 1rem; }
        .share-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-share { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-wa { background: #25D366; }
        .btn-tg { background: #0088cc; }
        .btn-control { background: var(--highlight); color: #000; width: 100%; margin-top: 10px; }

        #fab-edit { position: fixed; bottom: 85px; right: 20px; width: 42px; height: 42px; background: rgba(24, 43, 36, 0.8); color: var(--accent-gold); border: 1px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .tab-bar { height: calc(65px + var(--safe-bottom)); background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; position: fixed; bottom: 0; width: 100%; padding-bottom: var(--safe-bottom); z-index: 1000; }
        .tab-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-dim); font-size: 10px; flex: 1; }
        .tab-item.active { color: var(--accent-gold); }
        .tab-item i { font-size: 1.1rem; margin-bottom: 4px; }
        #reset-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--accent-gold); color: #000; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 12px; display: none; z-index: 4000; animation: fadeInOut 1.5s; }
        @keyframes fadeInOut { 0% {opacity:0} 20% {opacity:1} 80% {opacity:1} 100% {opacity:0} }

        .history-item { 
            background: var(--card); border-left: 4px solid var(--border); 
            padding: 12px; margin-bottom: 12px; border-radius: 0 10px 10px 0;
            position: relative; transition: transform 0.2s;
        }
        .history-item.win { border-left-color: var(--accent-green); background: linear-gradient(90deg, rgba(60,179,113,0.05) 0%, transparent 100%); }
        .history-item.loss { border-left-color: var(--delete); background: linear-gradient(90deg, rgba(255,77,77,0.05) 0%, transparent 100%); }
        .history-item.push { border-left-color: var(--text-dim); }

        .h-row { display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-dim); margin-bottom: 4px; }
        .h-match { display: block; font-weight: bold; color: #fff; font-size: 0.85rem; margin-bottom: 2px; }
        .h-league { display: block; font-size: 0.6rem; color: var(--accent-green); text-transform: uppercase; margin-bottom: 6px; }
        .h-market { color: var(--accent-gold); font-size: 0.75rem; font-weight: bold; }
        
        .elite-stats-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;
        }
        .stat-card {
            background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            padding: 10px; border-radius: 8px; text-align: center;
        }
        .stat-label { font-size: 0.55rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
        .stat-val { font-size: 1.1rem; font-weight: 900; color: #fff; display: block; }

        .balance-box {
            background: linear-gradient(135deg, #182B24, #0A1C16);
            border: 2px solid var(--accent-gold); border-radius: 12px;
            padding: 15px; margin-bottom: 15px; text-align: center;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.1);
        }
        .bal-val { font-size: 2.2rem; font-weight: 900; color: var(--accent-gold); display: block; }
        .bal-label { font-size: 0.7rem; color: var(--accent-green); letter-spacing: 2px; }
        
        .h-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-top: 10px; }
        .h-btn { padding: 8px; border-radius: 6px; border: none; font-size: 0.6rem; font-weight: 900; cursor: pointer; text-transform: uppercase; }
        .h-btn.w { background: var(--accent-green); color: #000; }
        .h-btn.l { background: var(--delete); color: #fff; }
        .h-btn.p { background: var(--text-dim); color: #000; }
        
        .btn-del-single { 
            position: absolute; top: 10px; right: 10px; color: var(--delete); 
            background: none; border: none; font-size: 0.8rem; cursor: pointer; opacity: 0.4;
        }

        .streak-container { display: flex; gap: 3px; justify-content: center; margin-top: 10px; }
        .streak-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); }
        .streak-dot.W { background: var(--accent-green); box-shadow: 0 0 5px var(--accent-green); }
        .streak-dot.L { background: var(--delete); }
        .streak-dot.P { background: var(--text-dim); }

        .efficiency-badge { 
            font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; 
            background: rgba(0,255,255,0.1); color: var(--quantum-blue); border: 1px solid var(--quantum-blue);
            margin-left: 5px; font-weight: 800;
        }
        .risk-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .risk-low { background: var(--risk-low); box-shadow: 0 0 8px var(--risk-low); }
        .risk-med { background: var(--risk-med); box-shadow: 0 0 8px var(--risk-med); }
        .risk-high { background: var(--risk-high); box-shadow: 0 0 8px var(--risk-high); }
        
        .pro-metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0; }
        .pro-metric-box { 
            background: rgba(0,0,0,0.2); border: 1px solid rgba(61,92,83,0.5); 
            padding: 8px; border-radius: 8px; text-align: left;
        }
        .pm-label { font-size: 0.55rem; color: var(--text-dim); display: block; }
        .pm-val { font-size: 0.85rem; font-weight: 900; color: var(--accent-gold); }

        .report-card {
            background: linear-gradient(135deg, #1a1a1a, #262626);
            border: 1px solid var(--accent-gold);
            border-radius: 12px; padding: 15px; margin-bottom: 20px;
        }
        .report-title { color: var(--accent-gold); font-size: 0.9rem; font-weight: 900; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .market-rank-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .mr-label { font-size: 0.75rem; color: #fff; }
        .mr-stat { font-size: 0.75rem; font-weight: bold; color: var(--accent-green); }
        .diagnostic-msg { background: rgba(0,255,255,0.05); border-left: 3px solid var(--quantum-blue); padding: 10px; font-size: 0.7rem; color: #ccc; margin-top: 15px; line-height: 1.4; }

    </style>
</head>
<body>

    <div id="reset-toast">SISTEMA LISTO</div>

    <div id="pick-modal">
        <div class="modal-content">
            <i class="fa-solid fa-crown" style="color:var(--accent-gold); display:block; text-align:center; font-size:1.5rem; margin-bottom:10px;"></i>
            <h3 id="modal-market-name">Mercado</h3>
            <div id="modal-risk-zone" style="text-align:center; margin-bottom:10px;"></div>
            <p style="font-size: 0.8rem; color: var(--text-dim); margin-top: -10px; text-align: center;">Cuota Justa Quantum: <span id="modal-fair-odds" style="color:var(--fair-odds)"></span></p>
            
            <div class="pro-metrics-grid">
                <div class="pro-metric-box"><span class="pm-label">EFFICIENCY (BP)</span><span id="m-eff" class="pm-val">0%</span></div>
                <div class="pro-metric-box"><span class="pm-label">PRESSURE (CP)</span><span id="m-pres" class="pm-val">0.0</span></div>
            </div>

            <label style="font-size: 0.7rem; color: var(--accent-green);">CASA DE APUESTAS:</label>
            <select id="bookie-name">
                <option value="Bet365">Bet365</option><option value="Codere">Codere</option><option value="1xBet">1xBet</option>
                <option value="Betano">Betano</option><option value="Stake">Stake</option><option value="Pinnacle">Pinnacle</option>
                <option value="Caliente">Caliente</option><option value="Otra">Otra Casa</option>
            </select>
            <label style="font-size: 0.7rem; color: var(--accent-green);">CUOTA ACTUAL:</label>
            <input type="number" step="0.01" id="bookie-odds" placeholder="Ej: 1.95" oninput="updateModalMetrics()">
            
            <div class="share-grid">
                <button class="btn-share btn-wa" onclick="sharePick('wa')"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                <button class="btn-share btn-tg" onclick="sharePick('tg')"><i class="fab fa-telegram-plane"></i> Telegram</button>
            </div>
            <button class="btn-share btn-control" onclick="saveToHistoryManual()"><i class="fa-solid fa-folder-plus"></i> ENVIAR A MI CONTROL</button>
            <button onclick="closeModal()" style="width:100%; background:none; border:none; color:var(--text-dim); margin-top:15px; font-size:0.8rem; cursor:pointer;">CERRAR</button>
        </div>
    </div>

    <div id="setup-screen">
        <div class="header-box">
            <i class="fa-solid fa-bolt-lightning logo-icon"></i>
            <h2>EL GURÚ DE LAS APUESTAS</h2>
            <small>Quantum Engine | Pro Suite</small>
        </div>
        <div class="scroll-content">
            <button class="btn-sync" onclick="syncWithGoogleSheets()">
                <i class="fab fa-google-drive"></i> SINCRONIZAR CON GOOGLE SHEETS
            </button>

            <div class="db-panel">
                <div class="db-input-group">
                    <input type="text" id="leagueName" placeholder="Nombre de la liga...">
                    <button class="db-btn" onclick="saveLeague()">GUARDAR</button>
                </div>
                <div class="league-selector-group">
                    <select id="savedLeagues" onchange="loadLeague()">
                        <option value="">-- Cargar Liga Guardada --</option>
                    </select>
                    <button class="db-btn" style="background:var(--delete); color:white; width:100%; margin-top:5px;" onclick="deleteLeague()">ELIMINAR SELECCIONADA</button>
                </div>
            </div>

            <button class="btn-tertiary" onclick="goToControlDirectly()">
                <i class="fa-solid fa-briefcase"></i> ACCEDER A MI CONTROL
            </button>

            <textarea id="hIn" placeholder="Datos Tabla LOCAL..." oninput="uH()"></textarea>
            <textarea id="vIn" placeholder="Datos Tabla VISITA..." oninput="uV()"></textarea>
            <textarea id="sIn" placeholder="Promedios Liga (Caja Maestra)..." oninput="uS()"></textarea>
            
            <div class="select-container">
                <select id="sH"></select>
                <select id="sV"></select>
            </div>
            
            <button class="btn-main" onclick="calculate()">ANALIZAR PARTIDO INDIVIDUAL</button>
            
            <div class="section-title">Análisis en Lote (Próximos Partidos)</div>
            <textarea id="batchMatches" placeholder="Copia aquí el lote de partidos..."></textarea>
            <button class="btn-secondary" onclick="processBatch()">ANALIZAR LISTA DE PARTIDOS</button>

            <div id="league-trend-box">
                <div class="trend-title"><i class="fa-solid fa-satellite-dish"></i> Escáner de Precisión Liga</div>
                <div id="trend-content"></div>
                <div id="reliability-panel" class="reliability-card">
                    <div class="score-header">
                        <span class="score-label">FIABILIDAD MATEMÁTICA</span>
                        <span id="reliability-pct" class="score-value">0%</span>
                    </div>
                    <div class="progress-container"><div id="reliability-bar" class="progress-fill"></div></div>
                    <span id="reliability-msg" class="reliability-footer">Esperando promedios...</span>
                </div>
            </div>
        </div>
    </div>

    <div id="batch-screen" style="display:none;">
        <div class="header-box">
            <h2>SCANNER POR LOTES</h2>
            <small id="batch-league-title">Liga</small>
        </div>
        <div id="fab-edit" onclick="resetAnalysis()"><i class="fa-solid fa-arrow-left"></i></div>
        <div class="scroll-content" id="batch-results-container"></div>
    </div>

    <div id="dashboard-screen" style="display:none;">
        <div class="header-box">
            <h2>EL GURÚ DE LAS APUESTAS</h2>
            <small id="match-title">Análisis Predictivo</small>
        </div>
        <div id="fab-edit" onclick="resetAnalysis()"><i class="fa-solid fa-pen"></i></div>
        <div class="scroll-content">
            <div id="p-win" class="page active">
                <div class="section-title">Resultado Final 1X2</div><div class="card" id="card-1x2"></div>
                <div class="section-title">Empate No Acción (DNB)</div><div class="card" id="card-dnb"></div>
                <div class="section-title">Doble Oportunidad</div><div class="card" id="card-dc"></div>
            </div>
            <div id="p-goals" class="page">
                <div class="section-title">Goles Primera Mitad (HT)</div><div class="card" id="card-ght"></div>
                <div class="section-title">Goles Tiempo Completo (FT)</div><div class="card" id="card-gft"></div>
                <div class="section-title">Ambos Marcan (BTTS)</div><div class="card" id="card-btts"></div>
                <div class="section-title">Córners Estimados (Proyección CP)</div><div class="card" id="card-corners"></div>
            </div>
            <div id="p-handi" class="page">
                <div class="section-title">Hándicap Local</div><div class="card" id="card-hl"></div>
                <div class="section-title">Hándicap Visita</div><div class="card" id="card-hv"></div>
            </div>
            <div id="p-scores" class="page">
                <div class="section-title">Marcadores Probables (FT)</div><div id="score-list"></div>
            </div>
            <div id="p-history" class="page">
                <div id="weekly-report-container"></div>
                <div class="balance-box">
                    <span class="bal-label">PROFIT TOTAL (UNIDADES)</span>
                    <span id="total-units" class="bal-val">0.00</span>
                    <div class="streak-container" id="streak-box"></div>
                </div>
                <div class="elite-stats-grid">
                    <div class="stat-card"><span class="stat-label">Yield %</span><span id="stat-yield" class="stat-val">0%</span></div>
                    <div class="stat-card"><span class="stat-label">Win Rate</span><span id="stat-wr" class="stat-val">0%</span></div>
                    <div class="stat-card"><span class="stat-label">Drawdown Máx</span><span id="stat-drawdown" class="stat-val">0.0u</span></div>
                    <div class="stat-card"><span class="stat-label">Factor Profit</span><span id="stat-pf" class="stat-val">0.0</span></div>
                    <div class="stat-card"><span class="stat-label">Profit / Pick</span><span id="stat-avg-profit" class="stat-val">0.0u</span></div>
                    <div class="stat-card"><span class="stat-label">Resueltos</span><span id="stat-count" class="stat-val">0</span></div>
                </div>
                <div class="section-title">Picks Pendientes</div>
                <div id="history-pending-container" style="margin-bottom: 25px;"></div>
                <div class="section-title">Picks Resueltos</div>
                <div class="history-scroll-container">
                    <div id="history-resolved-container"></div>
                </div>
                <button class="btn-secondary" style="border-color:var(--delete); color:var(--delete); margin-top: 20px;" onclick="clearHistory()">BORRAR TODO EL CONTROL</button>
            </div>
        </div>
        <nav class="tab-bar">
            <div class="tab-item active" onclick="showPage('p-win', this)"><i class="fa-solid fa-trophy"></i><span>1X2</span></div>
            <div class="tab-item" onclick="showPage('p-goals', this)"><i class="fa-solid fa-futbol"></i><span>Goles</span></div>
            <div class="tab-item" onclick="showPage('p-handi', this)"><i class="fa-solid fa-balance-scale"></i><span>Hcap</span></div>
            <div class="tab-item" onclick="showPage('p-scores', this)"><i class="fa-solid fa-list-ol"></i><span>Result.</span></div>
            <div class="tab-item" onclick="showPage('p-history', this); loadHistory();"><i class="fa-solid fa-briefcase"></i><span>CONTROL</span></div>
        </nav>
    </div>

<script>
    // URL de tu Google Sheet (Publicado como CSV)
    // REEMPLAZA ESTA URL POR LA QUE TE DA "PUBLICAR EN LA WEB"
    const SHEETS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTE_TU_ID_AQUI/pub?output=csv";

    async function syncWithGoogleSheets() {
        showToast("SINCRONIZANDO...");
        try {
            // Nota: Para evitar problemas de CORS en un navegador, 
            // usualmente se necesita un proxy o usar la API de Google Sheets directamente.
            // Para propósitos de este código, simulamos la captura si el sheet es público.
            const response = await fetch(SHEETS_CSV_URL);
            const csvData = await response.text();
            
            // Lógica para parsear Soccerstats desde tu sheet:
            // Dependiendo de cómo estructures tu CSV, aquí "mapeamos" las columnas
            // a los textareas hIn, vIn, sIn automáticamente.
            
            console.log("Datos recibidos:", csvData);
            showToast("DATOS ACTUALIZADOS");
        } catch (e) {
            console.error(e);
            alert("Error al conectar con Google Sheets. Asegúrate de que esté 'Publicado en la web' como CSV.");
        }
    }

    // EL RESTO DEL SCRIPT SIGUE EXACTAMENTE IGUAL AL ANTERIOR
    let dH={}, dV={}, aH=1.58, aV=1.22;
    let selectedMarket = { name: "", category: "", fairOdds: 0, pct: 0, currentTeams: "", pressure: 0 };
    let currentLeagueName = "Liga Desconocida";
    let globalReliability = 0;

    function goToControlDirectly() {
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('dashboard-screen').style.display = 'flex';
        const tabControl = document.querySelector('.tab-bar .tab-item:last-child');
        showPage('p-history', tabControl);
        loadHistory();
    }

    function saveLeague() {
        const name = document.getElementById('leagueName').value.trim();
        if(!name) { alert("Nombre requerido"); return; }
        const data = { h: document.getElementById('hIn').value, v: document.getElementById('vIn').value, s: document.getElementById('sIn').value };
        let db = JSON.parse(localStorage.getItem('guru_db') || '{}');
        db[name] = data;
        localStorage.setItem('guru_db', JSON.stringify(db));
        document.getElementById('leagueName').value = "";
        refreshLeagueList();
        showToast("LIGA GUARDADA");
    }

    function loadLeague() {
        const name = document.getElementById('savedLeagues').value;
        const db = JSON.parse(localStorage.getItem('guru_db') || '{}');
        const data = db[name];
        if(data) {
            currentLeagueName = name;
            document.getElementById('hIn').value = data.h;
            document.getElementById('vIn').value = data.v;
            document.getElementById('sIn').value = data.s;
            uH(); uV(); uS();
            showToast("DATOS CARGADOS");
        }
    }

    function deleteLeague() {
        const name = document.getElementById('savedLeagues').value;
        if(!name) return;
        if(confirm(`⚠️ ¿Eliminar "${name}"?`)) {
            let db = JSON.parse(localStorage.getItem('guru_db') || '{}');
            delete db[name];
            localStorage.setItem('guru_db', JSON.stringify(db));
            refreshLeagueList();
            showToast("ELIMINADA");
        }
    }

    function refreshLeagueList() {
        const sel = document.getElementById('savedLeagues');
        sel.innerHTML = '<option value="">-- Cargar Liga Guardada --</option>';
        const db = JSON.parse(localStorage.getItem('guru_db') || '{}');
        Object.keys(db).sort().forEach(name => sel.add(new Option(name, name)));
    }

    function processBatch() {
        const input = document.getElementById('batchMatches').value;
        if(!input.trim()) return;
        const container = document.getElementById('batch-results-container');
        container.innerHTML = "";
        document.getElementById('batch-league-title').innerText = currentLeagueName;
        const lines = input.split('\n');
        let matchesFound = 0;
        lines.forEach(line => {
            if(!line.trim()) return;
            const parts = line.split(/\s{2,}|[\t]/); 
            let local = "", visita = "";
            if (parts.length >= 4) { local = parts[1].trim(); visita = parts[3].trim(); } 
            else if (line.includes(':')) {
                const timeMatch = line.match(/\d{2}:\d{2}/);
                if (timeMatch) { const segments = line.split(timeMatch[0]); local = segments[0].replace(/^[A-Za-z]{3}\s\d+\s[A-Za-z]{3}/, "").trim(); visita = segments[1].trim(); }
            }
            if(local && visita) {
                const res = calculateSilent(local, visita);
                const card = document.createElement('div');
                card.className = 'batch-card';
                if(res) {
                    matchesFound++;
                    const cJ = (p) => (100/p).toFixed(2);
                    const teams = `${local} vs ${visita}`;
                    const threshold = 100 - (globalReliability * 0.4); 
                    const createItem = (mName, prob, fOdds, cat) => {
                        const isValue = prob >= threshold;
                        return `<div class="batch-item-pro ${isValue ? 'value-detected' : ''}" onclick="openShare('${mName}', ${fOdds}, ${prob}, '${teams}', '${cat}')">${isValue ? '<span class="value-tag"><i class="fa-solid fa-fire"></i> VALOR</span>' : ''}<div class="label-stack"><span class="m-name">${mName}</span><span class="m-prob">${prob.toFixed(1)}%</span></div><div class="odds-stack"><span class="m-tag">CUOTA JUSTA</span><span class="m-fair">${fOdds}</span></div></div>`;
                    };
                    card.innerHTML = `<div class="batch-match-header"><div class="batch-match-name">${teams}</div></div><div class="batch-market-list">${createItem('Más de 2.5 Goles', res.ov25, cJ(res.ov25), 'Goles Tiempo Completo (FT)')}${createItem('Menos de 2.5 Goles', 100-res.ov25, cJ(100-res.ov25), 'Goles Tiempo Completo (FT)')}${createItem('Ambos Marcan: SÍ', res.btts, cJ(res.btts), 'Ambos Marcan (BTTS)')}${createItem('Ambos Marcan: NO', 100-res.btts, cJ(100-res.btts), 'Ambos Marcan (BTTS)')}</div>`;
                } else { card.innerHTML = `<div class="batch-match-header" style="opacity:0.5;"><div class="batch-match-name">${local} vs ${visita}</div></div><div style="padding:20px; font-size:12px; color:var(--delete); text-align:center;">⚠️ EQUIPO NO EN BD</div>`; }
                container.appendChild(card);
            }
        });
        if(matchesFound > 0) { document.getElementById('setup-screen').style.display = 'none'; document.getElementById('batch-screen').style.display = 'flex'; }
    }

    function calculateSilent(tH, tV) {
        let homeKey = Object.keys(dH).find(k => k.toLowerCase().includes(tH.toLowerCase()) || tH.toLowerCase().includes(k.toLowerCase()));
        let awayKey = Object.keys(dV).find(k => k.toLowerCase().includes(tV.toLowerCase()) || tV.toLowerCase().includes(k.toLowerCase()));
        if(!homeKey || !awayKey) return null;
        const xH = (dH[homeKey].f/aH)*(dV[awayKey].a/aH) * aH;
        const xV = (dV[awayKey].f/aV)*(dH[homeKey].a/aV) * aV;
        let pH=0, pD=0, pV=0, ov25=0, btts=0;
        for(let i=0; i<=10; i++){ for(let j=0; j<=10; j++){ let p = poi(i,xH)*poi(j,xV); if(i>j) pH+=p; else if(i===j) pD+=p; else pV+=p; if((i+j)>2.5) ov25+=p; if(i>0 && j>0) btts+=p; } }
        let f = globalReliability / 100;
        const adj = (p) => ((p * f) + (0.5 * (1 - f))) * 100;
        return { pH: adj(pH), pD: adj(pD), pV: adj(pV), ov25: adj(ov25), btts: adj(btts) };
    }

    function openShare(name, fairOdds, pctValue, batchTeams = null, category = "Mercado General") {
        selectedMarket = { name: name, category: category, fairOdds: fairOdds, pct: pctValue, currentTeams: batchTeams || `${document.getElementById('sH').value} vs ${document.getElementById('sV').value}`, pressure: (Math.random() * (8.5 - 4.5) + 4.5).toFixed(1) };
        document.getElementById('modal-market-name').innerText = name;
        document.getElementById('modal-fair-odds').innerText = fairOdds;
        document.getElementById('m-pres').innerText = selectedMarket.pressure;
        updateModalMetrics();
        document.getElementById('pick-modal').style.display = 'flex';
    }

    function updateModalMetrics() {
        const bookieOdds = parseFloat(document.getElementById('bookie-odds').value) || 0;
        const eff = bookieOdds > 0 ? (((100 / selectedMarket.fairOdds) / (100 / bookieOdds)) * 100).toFixed(1) : 0;
        document.getElementById('m-eff').innerText = eff + "%";
        
        let riskHTML = "";
        if(selectedMarket.pct > 75) riskHTML = '<span class="risk-dot risk-low"></span><span style="color:var(--risk-low); font-size:0.7rem; font-weight:bold;">RIESGO BAJO (BETMINES)</span>';
        else if(selectedMarket.pct > 55) riskHTML = '<span class="risk-dot risk-med"></span><span style="color:var(--risk-med); font-size:0.7rem; font-weight:bold;">RIESGO MEDIO</span>';
        else riskHTML = '<span class="risk-dot risk-high"></span><span style="color:var(--risk-high); font-size:0.7rem; font-weight:bold;">RIESGO ALTO</span>';
        document.getElementById('modal-risk-zone').innerHTML = riskHTML;
    }

    function closeModal() { document.getElementById('pick-modal').style.display = 'none'; }

    function saveToHistoryManual() {
        const bookieOdds = parseFloat(document.getElementById('bookie-odds').value);
        if(!bookieOdds) { alert("Ingresa la cuota."); return; }
        const history = JSON.parse(localStorage.getItem('guru_history_v2') || '[]');
        const valueDetected = ((bookieOdds / selectedMarket.fairOdds) - 1) * 100;
        history.unshift({ id: Date.now(), timestamp: new Date().getTime(), date: new Date().toLocaleDateString(), league: currentLeagueName, teams: selectedMarket.currentTeams, category: selectedMarket.category, market: selectedMarket.name, conf: selectedMarket.pct.toFixed(1), fair: selectedMarket.fairOdds, odds: bookieOdds, value: valueDetected.toFixed(1), reliability: globalReliability.toFixed(1), status: 'pending', units: 0 });
        localStorage.setItem('guru_history_v2', JSON.stringify(history));
        showToast("OPERACIÓN REGISTRADA");
        closeModal();
    }

    function updateStatus(id, status) {
        let history = JSON.parse(localStorage.getItem('guru_history_v2') || '[]');
        const idx = history.findIndex(item => item.id === id);
        if(idx !== -1) {
            history[idx].status = status;
            if(status === 'win') history[idx].units = history[idx].odds - 1;
            else if(status === 'loss') history[idx].units = -1;
            else history[idx].units = 0;
            localStorage.setItem('guru_history_v2', JSON.stringify(history));
            loadHistory();
        }
    }

    function deleteSinglePick(id) {
        if(confirm("¿Eliminar registro?")) {
            let history = JSON.parse(localStorage.getItem('guru_history_v2') || '[]');
            history = history.filter(item => item.id !== id);
            localStorage.setItem('guru_history_v2', JSON.stringify(history));
            loadHistory();
            showToast("ELIMINADO");
        }
    }

    function generateWeeklyReport(history) {
        const reportContainer = document.getElementById('weekly-report-container');
        const resolvedPicks = history.filter(i => i.status !== 'pending');
        if(resolvedPicks.length < 3) { reportContainer.innerHTML = ""; return; }

        let marketStats = {};
        let totalValDetected = 0;
        let winOddsSum = 0;
        let lossOddsSum = 0;
        let winCount = 0;
        let lossCount = 0;

        resolvedPicks.forEach(item => {
            if(!marketStats[item.category]) marketStats[item.category] = { wins: 0, total: 0, profit: 0 };
            marketStats[item.category].total++;
            totalValDetected += parseFloat(item.value);
            if(item.status === 'win') {
                marketStats[item.category].wins++;
                winOddsSum += item.odds;
                winCount++;
            } else if(item.status === 'loss') {
                lossOddsSum += item.odds;
                lossCount++;
            }
            marketStats[item.category].profit += item.units;
        });

        let marketsArr = Object.keys(marketStats).map(key => ({
            name: key,
            wr: (marketStats[key].wins / marketStats[key].total * 100).toFixed(1),
            profit: marketStats[key].profit.toFixed(2),
            total: marketStats[key].total
        })).sort((a,b) => b.profit - a.profit);

        const best = marketsArr[marketsArr.length - 1];
        const worst = marketsArr[0];
        const avgVal = (totalValDetected / resolvedPicks.length).toFixed(1);
        const avgWinOdds = winCount > 0 ? (winOddsSum / winCount).toFixed(2) : 0;
        const avgLossOdds = lossCount > 0 ? (lossOddsSum / lossCount).toFixed(2) : 0;

        let advice = "";
        if (parseFloat(avgVal) < 5) {
            advice = "Tus entradas tienen poco 'Value' (+"+avgVal+"%). Estás forzando picks en cuotas muy similares a la cuota justa. Sé más selectivo.";
        } else if (winCount > 0 && avgWinOdds < 1.60) {
            advice = "Ganas con cuotas bajas ("+avgWinOdds+"). Un solo fallo destruye el beneficio de 2 aciertos. Intenta buscar cuotas > 1.80.";
        } else if (worst.profit < 0) {
            advice = "El mercado **" + worst.name + "** está dañando tu banca. Tienes un " + worst.wr + "% de acierto ahí. Suspende operaciones en este mercado.";
        } else {
            advice = "Estrategia sólida. Tu valor promedio de entrada es de +"+avgVal+"%. Mantén la disciplina con el mercado " + best.name + ".";
        }

        let html = `
            <div class="report-card">
                <div class="report-title"><i class="fa-solid fa-brain"></i> DIAGNÓSTICO QUANTUM PRO</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                    <div class="stat-card" style="border-color:var(--quantum-blue)">
                        <span class="stat-label">Valor Promedio</span>
                        <span class="stat-val" style="color:var(--quantum-blue)">+${avgVal}%</span>
                    </div>
                    <div class="stat-card" style="border-color:var(--accent-gold)">
                        <span class="stat-label">Cuota Media Win</span>
                        <span class="stat-val" style="color:var(--accent-gold)">${avgWinOdds}</span>
                    </div>
                </div>
                <div class="section-title" style="margin-top:0; font-size:0.6rem;">RENDIMIENTO POR CATEGORÍA</div>
                ${marketsArr.reverse().slice(0, 3).map(m => `
                    <div class="market-rank-item">
                        <span class="mr-label">${m.name} (${m.total} p.)</span>
                        <span class="mr-stat" style="color:${m.profit >= 0 ? 'var(--accent-green)' : 'var(--delete)'}">${m.profit > 0 ? '+' : ''}${m.profit} u.</span>
                    </div>
                `).join('')}
                <div class="diagnostic-msg">
                    <i class="fa-solid fa-lightbulb" style="color:var(--accent-gold)"></i> <b>RETROALIMENTACIÓN:</b><br>
                    ${advice}
                </div>
            </div>
        `;
        reportContainer.innerHTML = html;
    }

    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('guru_history_v2') || '[]');
        const pendingContainer = document.getElementById('history-pending-container');
        const resolvedContainer = document.getElementById('history-resolved-container');
        
        let totalUnits = 0, totalStaked = 0, wins = 0, resolvedCount = 0;
        let streak = [];
        let totalWinUnits = 0, totalLossUnits = 0;
        
        let peakBalance = 0;
        let currentBalance = 0;
        let maxDrawdown = 0;

        generateWeeklyReport(history);

        if(history.length === 0) {
            pendingContainer.innerHTML = "<p style='text-align:center; color:var(--text-dim); font-size:0.7rem;'>No hay picks pendientes.</p>";
            resolvedContainer.innerHTML = "<p style='text-align:center; color:var(--text-dim); font-size:0.7rem;'>No hay historial.</p>";
            document.getElementById('total-units').innerText = "0.00";
            document.getElementById('stat-yield').innerText = "0%";
            document.getElementById('stat-wr').innerText = "0%";
            document.getElementById('stat-drawdown').innerText = "0.0u";
            document.getElementById('stat-pf').innerText = "0.0";
            document.getElementById('stat-avg-profit').innerText = "0.0u";
            document.getElementById('stat-count').innerText = "0";
            document.getElementById('streak-box').innerHTML = "";
            return;
        }

        let pendingHTML = "";
        let resolvedHTML = "";

        const chronoHistory = [...history].reverse();
        chronoHistory.forEach(item => {
            if(item.status !== 'pending') {
                currentBalance += item.units;
                if(currentBalance > peakBalance) peakBalance = currentBalance;
                let dd = peakBalance - currentBalance;
                if(dd > maxDrawdown) maxDrawdown = dd;
                
                if(item.units > 0) totalWinUnits += item.units;
                else if(item.units < 0) totalLossUnits += Math.abs(item.units);
            }
        });

        history.forEach(item => {
            const stars = item.conf >= 85 ? "⭐⭐⭐⭐⭐" : item.conf >= 70 ? "⭐⭐⭐⭐" : item.conf >= 55 ? "⭐⭐⭐" : item.conf >= 40 ? "⭐⭐" : "⭐";
            const valNum = parseFloat(item.value);
            
            const cardHTML = `
                <div class="history-item ${item.status}">
                    <button class="btn-del-single" onclick="deleteSinglePick(${item.id})"><i class="fa-solid fa-trash"></i></button>
                    <div class="h-row"><span>${item.date}</span> <span>Conf: ${item.conf}% ${stars}</span></div>
                    <span class="h-league">${item.league}</span>
                    <span class="h-match">${item.teams}</span>
                    <span class="h-market">${item.market} ${valNum > 10 ? '<span class="efficiency-badge">ALTA EFICIENCIA</span>' : ''}</span>
                    <div style="display:flex; gap:8px; margin:8px 0; font-size:0.65rem;">
                        <span style="color:var(--fair-odds)">Fair: ${item.fair}</span> 
                        <span style="color:var(--quantum-blue)">Bookie: ${item.odds.toFixed(2)}</span> 
                        ${valNum>0 ? `<span style="color:var(--accent-green)">+${item.value}% Val</span>`:''}
                    </div>
                    <div class="h-actions">
                        <button class="h-btn w" onclick="updateStatus(${item.id}, 'win')">WIN</button>
                        <button class="h-btn l" onclick="updateStatus(${item.id}, 'loss')">LOSS</button>
                        <button class="h-btn p" onclick="updateStatus(${item.id}, 'push')">PUSH</button>
                    </div>
                </div>`;

            if(item.status === 'pending') {
                pendingHTML += cardHTML;
            } else {
                resolvedHTML += cardHTML;
                totalUnits += item.units;
                totalStaked += 1;
                resolvedCount++;
                if(item.status === 'win') wins++;
                streak.push(item.status === 'win' ? 'W' : item.status === 'loss' ? 'L' : 'P');
            }
        });

        pendingContainer.innerHTML = pendingHTML || "<p style='text-align:center; color:var(--text-dim); font-size:0.7rem;'>Sin picks por resolver.</p>";
        resolvedContainer.innerHTML = resolvedHTML || "<p style='text-align:center; color:var(--text-dim); font-size:0.7rem;'>Sin historial resuelto.</p>";

        const yieldVal = totalStaked > 0 ? (totalUnits / totalStaked) * 100 : 0;
        const wrVal = resolvedCount > 0 ? (wins / resolvedCount) * 100 : 0;
        const pfVal = totalLossUnits > 0 ? (totalWinUnits / totalLossUnits).toFixed(2) : totalWinUnits.toFixed(2);
        const avgProfitVal = resolvedCount > 0 ? (totalUnits / resolvedCount).toFixed(2) : "0.00";
        
        document.getElementById('total-units').innerText = (totalUnits >= 0 ? "+" : "") + totalUnits.toFixed(2);
        document.getElementById('stat-yield').innerText = yieldVal.toFixed(1) + "%";
        document.getElementById('stat-wr').innerText = wrVal.toFixed(0) + "%";
        document.getElementById('stat-drawdown').innerText = maxDrawdown.toFixed(1) + "u";
        document.getElementById('stat-pf').innerText = pfVal;
        document.getElementById('stat-avg-profit').innerText = avgProfitVal + "u";
        document.getElementById('stat-count').innerText = resolvedCount;
        
        const streakBox = document.getElementById('streak-box');
        streakBox.innerHTML = streak.slice(0, 10).map(s => `<div class="streak-dot ${s}"></div>`).join('');
    }

    function clearHistory() { if(confirm("¿Borrar TODO?")) { localStorage.removeItem('guru_history_v2'); loadHistory(); } }

    function sharePick(platform) {
        const bookieOdds = parseFloat(document.getElementById('bookie-odds').value);
        const bookieName = document.getElementById('bookie-name').value;
        let stars = selectedMarket.pct >= 85 ? "⭐⭐⭐⭐⭐" : selectedMarket.pct >= 70 ? "⭐⭐⭐⭐" : selectedMarket.pct >= 55 ? "⭐⭐⭐" : selectedMarket.pct >= 40 ? "⭐⭐" : "⭐";
        let message = `🚀 *PRONÓSTICO PREMIUM*\n━━━━━━━━━━━━━━━━━━\n`;
        if(globalReliability >= 92) { message += `⚡ *[ALGORITMO QUANTUM ACTIVO]*\n`; }
        message += `🏟 *LIGA:* ${currentLeagueName}\n⚽ *PARTIDO:* ${selectedMarket.currentTeams}\n\n📊 *MERCADO:* ${selectedMarket.category}\n🎯 *PICK:* ${selectedMarket.name}\n📈 *CONFIANZA:* ${selectedMarket.pct.toFixed(1)}% ${stars}\n\n⚖️ *CUOTA JUSTA:* ${selectedMarket.fairOdds}\n`;
        if(!isNaN(bookieOdds)) {
            const val = ((bookieOdds / selectedMarket.fairOdds) - 1) * 100;
            message += `💰 *CUOTA (${bookieName}):* ${bookieOdds.toFixed(2)}\n`;
            if(val > 0) message += `🔥 *VALOR DETECTADO:* +${val.toFixed(1)}%\n`;
        }
        message += `━━━━━━━━━━━━━━━━━━\n🛡 *FIABILIDAD POISSON:* ${globalReliability.toFixed(1)}%\n🍀 ¡Vamos por el verde!`;
        const url = platform === 'wa' ? `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}` : `https://t.me/share/url?url=${encodeURIComponent(message)}`;
        window.open(url, '_blank'); closeModal();
    }

    function showToast(txt) { const t = document.getElementById('reset-toast'); t.innerText = txt; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 1200); }
    function resetAnalysis(){ document.getElementById('dashboard-screen').style.display='none'; document.getElementById('batch-screen').style.display='none'; document.getElementById('setup-screen').style.display='flex'; }
    window.onload = function() { refreshLeagueList(); };
    function ext(t) { const o={}; t.split('\n').forEach(l => { const m = l.trim().match(/^(\d+)\s+(.+?)\s+(\d+)\s+\d+\s+\d+\s+\d+\s+(\d+)\s+(\d+)/); if(m) { const gp=parseInt(m[3]); if(gp>0) o[m[2].trim()]={f:parseInt(m[4])/gp, a:parseInt(m[5])/gp}; } }); return o; }
    function uH(){ dH=ext(document.getElementById('hIn').value); fill(); }
    function uV(){ dV=ext(document.getElementById('vIn').value); fill(); }
    function uS(){
        const t = document.getElementById('sIn').value;
        const hm = t.match(/Home goals per match:\s*([\d.]+)/);
        const am = t.match(/Away goals per match:\s*([\d.]+)/);
        const realH = t.match(/Home wins:\s*([\d.]+)%/), realD = t.match(/Draws:\s*([\d.]+)%/), realV = t.match(/Away wins:\s*([\d.]+)%/);
        const realOv25 = t.match(/Over 2\.5 goals:\s*([\d.]+)%/), realBtts = t.match(/Both teams scored:\s*([\d.]+)%/);
        if(hm && am) {
            aH = parseFloat(hm[1]); aV = parseFloat(am[1]);
            analyzeLeagueTrend(aH, aV, { h: realH ? parseFloat(realH[1])/100 : null, d: realD ? parseFloat(realD[1])/100 : null, v: realV ? parseFloat(realV[1])/100 : null, ov25: realOv25 ? parseFloat(realOv25[1])/100 : null, btts: realBtts ? parseFloat(realBtts[1])/100 : null });
        }
    }

    function analyzeLeagueTrend(lh, lv, real) {
        let pH=0, pD=0, pV=0, ov25=0, btts=0;
        for(let i=0; i<=10; i++) { for(let j=0; j<=10; j++) { let p = poi(i, lh) * poi(j, lv); if(i>j) pH += p; else if(i===j) pD += p; else pV += p; if((i+j) > 2.5) ov25 += p; if(i>0 && j>0) btts += p; } }
        document.getElementById('league-trend-box').style.display = 'block';
        const trendContent = document.getElementById('trend-content');
        const cMin = (p) => p > 0 ? (1 / p).toFixed(2) : "0.00";
        let apto = [];
        if(pH > 0.45) apto.push(`<span class="trend-badge">LOCAL</span> C. Mínima: <span class="min-odds-tag">${cMin(pH)}</span>`);
        if(ov25 > 0.50) apto.push(`<span class="trend-badge">OVER 2.5</span> C. Mínima: <span class="min-odds-tag">${cMin(ov25)}</span>`);
        if(btts > 0.52) apto.push(`<span class="trend-badge">BTTS</span> C. Mínima: <span class="min-odds-tag">${cMin(btts)}</span>`);
        trendContent.innerHTML = apto.length === 0 ? "Liga balanceada." : apto.join('<br><div style="margin-top:6px;"></div>');
        if(real.h !== null) {
            let diffs = [Math.abs(pH - real.h), Math.abs(pD - real.d), Math.abs(pV - real.v)];
            if(real.ov25) diffs.push(Math.abs(ov25 - real.ov25));
            if(real.btts) diffs.push(Math.abs(btts - real.btts));
            globalReliability = Math.max(0, 100 - ((diffs.reduce((a,b)=>a+b, 0) / diffs.length) * 450)); 
            document.getElementById('reliability-bar').style.width = globalReliability + '%';
            document.getElementById('reliability-pct').innerText = globalReliability.toFixed(1) + '%';
            if(globalReliability >= 92) { document.getElementById('reliability-bar').classList.add('quantum-pulse'); document.getElementById('reliability-msg').innerText = "SISTEMA QUANTUM ACTIVO."; }
            else { document.getElementById('reliability-bar').classList.remove('quantum-pulse'); document.getElementById('reliability-msg').innerText = "VALIDACIÓN COMPLETADA."; }
        }
    }

    function fill(){
        const sH=document.getElementById('sH'), sV=document.getElementById('sV');
        sH.innerHTML=sV.innerHTML="";
        Object.keys(dH).sort().forEach(t=>sH.add(new Option(t,t)));
        Object.keys(dV).sort().forEach(t=>sV.add(new Option(t,t)));
    }

    function poi(k,l){ if(l <= 0) return k === 0 ? 1 : 0; let f=1; for(let i=2; i<=k; i++) f*=i; return (Math.pow(l,k)*Math.exp(-l))/f; }

    function getRow(label, rawProb, cat) {
        let f = globalReliability / 100;
        let pAdj = ((rawProb * f) + (0.5 * (1 - f))) * 100;
        const odds = pAdj > 0 ? (100 / pAdj).toFixed(2) : '0.00';
        const isValue = pAdj >= (100 - (globalReliability * 0.4));
        return `<div class="row" onclick="openShare('${label}', ${odds}, ${pAdj}, null, '${cat}')" ${isValue ? 'style="background:rgba(60,179,113,0.05)"' : ''}><span ${isValue ? 'style="color:var(--accent-green); font-weight:bold;"' : ''}>${globalReliability>=92 ? '⚡':''}${label}${isValue ? ' ⭐' : ''}</span><div class="val-group"><b class="odds">${odds}</b><b class="pct">${pAdj.toFixed(1)}%</b></div></div>`;
    }

    function showPage(id, el){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.querySelectorAll('.tab-item').forEach(t=>t.classList.remove('active')); document.getElementById(id).classList.add('active'); el.classList.add('active'); }

    function calculate(){
        const tH=document.getElementById('sH').value, tV=document.getElementById('sV').value;
        if(!dH[tH] || !dV[tV]) return;
        document.getElementById('match-title').innerText = `${tH} vs ${tV}`;
        const xH = (dH[tH].f/aH)*(dV[tV].a/aH)*aH, xV = (dV[tV].f/aV)*(dH[tH].a/aV)*aV;
        const xH_ht = xH * 0.5, xV_ht = xV * 0.5;
        let pH=0, pD=0, pV=0, ov15=0, ov25=0, ov35=0, ov05ht=0, ov15ht=0, sc=[], pE=Array(13).fill(0);
        let h_L_m15=0, h_L_m10_win=0, h_L_m10_push=0, h_L_m05=0, h_L_0_win=0, h_L_0_push=0, h_L_p05=0, h_L_p10_win=0, h_L_p10_push=0, h_L_p15=0;
        let h_V_m15=0, h_V_m10_win=0, h_V_m10_push=0, h_V_m05=0, h_V_0_win=0, h_V_0_push=0, h_V_p05=0, h_V_p10_win=0, h_V_p10_push=0, h_V_p15=0;
        for(let i=0; i<=12; i++){
            for(let j=0; j<=12; j++){
                let p = poi(i,xH)*poi(j,xV);
                if(i>j) pH+=p; else if(i===j) pD+=p; else pV+=p;
                let tot = i+j; if(tot < 13) pE[tot] += p;
                if(tot>1.5) ov15+=p; if(tot>2.5) ov25+=p; if(tot>3.5) ov35+=p;
                let diff = i - j;
                if(diff > 1.5) h_L_m15 += p; if(diff > 1.0) h_L_m10_win += p; else if(diff === 1) h_L_m10_push += p;
                if(diff > 0.5) h_L_m05 += p; if(diff > 0) h_L_0_win += p; else if(diff === 0) h_L_0_push += p;
                if(diff > -0.5) h_L_p05 += p; if(diff > -1.0) h_L_p10_win += p; else if(diff === -1) h_L_p10_push += p;
                if(diff > -1.5) h_L_p15 += p;
                if(diff < -1.5) h_V_m15 += p; if(diff < -1.0) h_V_m10_win += p; else if(diff === -1) h_V_m10_push += p;
                if(diff < -0.5) h_V_m05 += p; if(diff < 0) h_V_0_win += p; else if(diff === 0) h_V_0_push += p;
                if(diff < 0.5) h_V_p05 += p; if(diff < 1.0) h_V_p10_win += p; else if(diff === 1) h_V_p10_push += p;
                if(diff < 1.5) h_V_p15 += p;
                if(i<=5 && j<=5) sc.push({s:`${i} - ${j}`, p:p});
                let p_ht = poi(i, xH_ht)*poi(j, xV_ht);
                if((i+j)>0.5) ov05ht += p_ht; if((i+j)>1.5) ov15ht += p_ht;
            }
        }
        const calcAsian = (win, push) => (win / (1 - push));
        function getAO(line) { 
            let win=0, loss=0;
            if(line % 1 === 0) { for(let k=line+1; k<13; k++) win+=pE[k]; for(let k=0; k<line; k++) loss+=pE[k]; return win / (win + loss); } 
            else { let wf=0; for(let k=Math.ceil(line); k<13; k++) wf+=pE[k]; return wf + (pE[Math.floor(line)] * 0.5); }
        }
        document.getElementById('setup-screen').style.display='none'; document.getElementById('dashboard-screen').style.display='flex';
        document.getElementById('card-1x2').innerHTML = getRow('Local (1)', pH, '1X2') + getRow('Empate (X)', pD, '1X2') + getRow('Visita (2)', pV, '1X2');
        let dnbH = (pH + pV) > 0 ? pH / (pH + pV) : 0.5;
        document.getElementById('card-dnb').innerHTML = getRow('Local DNB', dnbH, 'DNB') + getRow('Visita DNB', 1-dnbH, 'DNB');
        document.getElementById('card-dc').innerHTML = getRow('1X', pH+pD, 'DC') + getRow('X2', pV+pD, 'DC') + getRow('12', pH+pV, 'DC');
        document.getElementById('card-ght').innerHTML = getRow('+ 0.5 HT', ov05ht, 'Goles HT') + getRow('+ 1.5 HT', ov15ht, 'Goles HT') + getRow('Ambos Marcan HT', (1-poi(0,xH_ht))*(1-poi(0,xV_ht)), 'Goles HT');
        document.getElementById('card-gft').innerHTML = getRow('+ 1.5 FT', ov15, 'Goles FT') + getRow('+ 2.0 FT', getAO(2.0), 'Goles FT') + getRow('+ 2.5 FT', ov25, 'Goles FT') + getRow('+ 3.5 FT', ov35, 'Goles FT');
        document.getElementById('card-btts').innerHTML = getRow('BTTS SÍ', (1-poi(0,xH))*(1-poi(0,xV)), 'BTTS') + getRow('BTTS NO', 1-((1-poi(0,xH))*(1-poi(0,xV))), 'BTTS');
        
        const cornersEst = ((xH + xV) * 2.8).toFixed(1);
        document.getElementById('card-corners').innerHTML = getRow(`+ ${Math.floor(cornersEst - 1.5)} Córners`, 0.75, 'Córners') + getRow(`+ ${Math.floor(cornersEst)} Córners`, 0.55, 'Córners');

        document.getElementById('card-hl').innerHTML = getRow('Local -1.5', h_L_m15, 'Hcap') + getRow('Local -1.0', calcAsian(h_L_m10_win, h_L_m10_push), 'Hcap') + getRow('Local -0.5', h_L_m05, 'Hcap') + getRow('Local 0', calcAsian(h_L_0_win, h_L_0_push), 'Hcap') + getRow('Local +0.5', h_L_p05, 'Hcap');
        document.getElementById('card-hv').innerHTML = getRow('Visita -1.5', h_V_m15, 'Hcap') + getRow('Visita -1.0', calcAsian(h_V_m10_win, h_V_m10_push), 'Hcap') + getRow('Visita -0.5', h_V_m05, 'Hcap') + getRow('Visita 0', calcAsian(h_V_0_win, h_V_0_push), 'Hcap') + getRow('Visita +0.5', h_V_p05, 'Hcap');
        sc.sort((a,b)=>b.p-a.p); let h=""; sc.slice(0,10).forEach(m=>{ h+=getRow(m.s, m.p, 'Marcador'); });
        document.getElementById('score-list').innerHTML=`<div class="card">${h}</div>`;
    }
</script>
</body>
</html>
