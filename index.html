<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poisson Pro - Analizador de Discrepancia</title>
    <style>
        :root { --bg: #0e1621; --card: #17212b; --accent: #52a8ff; --success: #27ae60; --warning: #f1c40f; --danger: #e74c3c; --text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; }
        .container { max-width: 900px; margin: auto; background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #2b3948; box-sizing: border-box; }
        textarea { width: 100%; height: 100px; background: #000; color: #00ff00; border: 1px solid #3d4b59; border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: #242f3d; padding: 15px; border-radius: 10px; }
        select, input { width: 100%; padding: 10px; margin-top: 5px; background: var(--bg); color: white; border: 1px solid #3d4b59; border-radius: 5px; }
        button { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .semaforo { padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center; font-weight: bold; display: none; }
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #2b3948; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h1>Calculador de Discrepancia Poisson</h1>
    
    <label>Pegue los datos para extraer equipos:</label>
    <textarea id="raw_data" oninput="extraerEquipos()"></textarea>

    <div class="grid">
        <div class="card">
            <label>üè† Local:</label>
            <select id="sel_local"></select>
            <label>Cuota Casa:</label>
            <input type="number" id="c_local" value="2.10" step="0.01">
        </div>
        <div class="card">
            <label>üöÄ Visitante:</label>
            <select id="sel_visita"></select>
            <label>Cuota Over 2.5 Casa:</label>
            <input type="number" id="c_over" value="2.22" step="0.01">
        </div>
    </div>

    <button onclick="analizarDiscrepancia()">Calcular Ventaja Real</button>

    <div id="semaforo_v" class="semaforo"></div>

    <div id="res_area" style="display:none;">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Mercado</th>
                        <th>Tu Prob.</th>
                        <th>Casa Prob.</th>
                        <th>Discrepancia</th>
                        <th>EV (%)</th>
                    </tr>
                </thead>
                <tbody id="tabla-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function factorial(n) { return (n <= 1) ? 1 : n * factorial(n - 1); }
    function poisson(k, lambda) { return (Math.pow(Math.E, -lambda) * Math.pow(lambda, k)) / factorial(k); }

    function extraerEquipos() {
        const rawText = document.getElementById('raw_data').value;
        const lineas = rawText.split('\n');
        let equipos = new Set();
        lineas.forEach(l => {
            const match = l.match(/([A-Z][a-z√±√°√©√≠√≥√∫]+\s?[A-Z]?[a-z√±√°√©√≠√≥√∫]*)\s-\s([A-Z][a-z√±√°√©√≠√≥√∫]+\s?[A-Z]?[a-z√±√°√©√≠√≥√∫]*)/);
            if (match) { equipos.add(match[1].trim()); equipos.add(match[2].trim()); }
        });
        const sorted = Array.from(equipos).sort();
        const fill = (id) => document.getElementById(id).innerHTML = sorted.map(e => `<option value="${e}">${e}</option>`).join('');
        fill('sel_local'); fill('sel_visita');
    }

    function analizarDiscrepancia() {
        const rawText = document.getElementById('raw_data').value;
        const localNom = document.getElementById('sel_local').value;
        const visitaNom = document.getElementById('sel_visita').value;
        const cOverCasa = parseFloat(document.getElementById('c_over').value);
        
        const lineas = rawText.split('\n');
        const partidosL = lineas.filter(l => l.includes(localNom)).slice(-10);
        const partidosV = lineas.filter(l => l.includes(visitaNom)).slice(-10);

        const getStats = (partidos, nombre) => {
            let m = 0, r = 0;
            partidos.forEach(l => {
                const res = l.match(/(\d+)-(\d+)/);
                if (res) {
                    const isHome = l.indexOf(nombre) < l.indexOf('-');
                    m += isHome ? parseInt(res[1]) : parseInt(res[2]);
                    r += isHome ? parseInt(res[2]) : parseInt(res[1]);
                }
            });
            return { f: m / partidos.length || 0, c: r / partidos.length || 0 };
        };

        const sL = getStats(partidosL, localNom);
        const sV = getStats(partidosV, visitaNom);
        const lambda = ((sL.f + sV.c) / 2) + ((sV.f + sL.c) / 2);

        let pOver25 = 0;
        for (let i = 0; i <= 8; i++) {
            for (let j = 0; j <= 8; j++) {
                if ((i + j) > 2.5) pOver25 += poisson(i, (sL.f + sV.c)/2) * poisson(j, (sV.f + sL.c)/2);
            }
        }

        const probCasa = (1 / cOverCasa);
        const discrepancia = (pOver25 - probCasa) * 100;
        const ev = ((cOverCasa / (1/pOver25)) - 1) * 100;

        const sem = document.getElementById('semaforo_v');
        sem.style.display = "block";
        if (discrepancia > 12) {
            sem.style.background = "var(--danger)";
            sem.innerHTML = "‚ö†Ô∏è DISCREPANCIA SOSPECHOSA (" + discrepancia.toFixed(1) + "%). Revisa bajas y noticias.";
        } else if (discrepancia >= 5) {
            sem.style.background = "var(--success)";
            sem.innerHTML = "‚úÖ VALOR DETECTADO (" + discrepancia.toFixed(1) + "%). Buena oportunidad.";
        } else {
            sem.style.background = "var(--warning)";
            sem.innerHTML = "‚ÑπÔ∏è POCA VENTAJA (" + discrepancia.toFixed(1) + "%). No vale el riesgo.";
        }

        document.getElementById('tabla-body').innerHTML = `
            <tr>
                <td>Over 2.5 Goles</td>
                <td>${(pOver25 * 100).toFixed(1)}%</td>
                <td>${(probCasa * 100).toFixed(1)}%</td>
                <td>${discrepancia.toFixed(1)}%</td>
                <td class="${ev > 0 ? 'val-win' : ''}">${ev.toFixed(2)}%</td>
            </tr>
        `;
        document.getElementById('res_area').style.display = "block";
    }
</script>
</body>
</html>
