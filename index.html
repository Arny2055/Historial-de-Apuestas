<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Historial de Apuestas Profesional v4.0 (Estable y con Scroll)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<style>
  :root {
    --color-primary: #8257e6;
    --color-primary-dark: #6a40d6;
    --color-background: #121214;
    --color-surface-1: #202024;
    --color-surface-2: #29292e;
    --color-surface-3: #333339;
    --color-text-primary: #e1e1e6;
    --color-text-secondary: #c4c4cc;
    --color-text-muted: #bbb;
    --color-success: #4caf50;
    --color-danger: #ef4444;
    --color-warning: #fbbf24;
    --border-radius: 10px;
  }
  *, *::before, *::after { box-sizing: border-box; }
  body {
    margin: 0; padding: 0;
    font-family: 'Inter', sans-serif;
    background-color: var(--color-background);
    color: var(--color-text-primary);
  }
  main { max-width: 1200px; width: 95%; margin: 20px auto 40px auto; }
  h1 { font-weight: 700; text-align: center; color: var(--color-primary); }
  button { cursor: pointer; }

  /* --- Componentes Reutilizables (Botones, etc.) --- */
  .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; }
  .btn-primary { background-color: var(--color-primary); color: #fff; }
  .btn-primary:hover { background-color: var(--color-primary-dark); }
  .btn-secondary { background-color: var(--color-surface-3); color: #fff; }
  .btn-secondary:hover { background-color: #444; }
  .btn-danger { background-color: var(--color-danger); color: #fff; }

  /* --- Notificaciones Toast y Modal --- */
  .toast { position: fixed; top: 20px; right: 20px; z-index: 1001; background-color: var(--color-surface-1); color: var(--color-text-primary); padding: 15px 25px; border-radius: var(--border-radius); border-left: 5px solid var(--color-primary); box-shadow: 0 6px 20px rgba(0,0,0,0.5); opacity: 0; transform: translateX(100%); transition: opacity 0.5s, transform 0.5s; }
  .toast.show { opacity: 1; transform: translateX(0); }
  .toast.success { border-left-color: var(--color-success); }
  .toast.error { border-left-color: var(--color-danger); }
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
  .modal-overlay.visible { opacity: 1; visibility: visible; }
  .modal-content { background: var(--color-surface-2); padding: 30px; border-radius: var(--border-radius); width: 90%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: scale(0.9); transition: transform 0.3s; }
  .modal-overlay.visible .modal-content { transform: scale(1); }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .modal-header h2 { margin: 0; color: var(--color-primary); }
  .modal-close { background: none; border: none; font-size: 1.8rem; color: #fff; cursor: pointer; }
  .modal-body p { margin: 0 0 20px; }
  .modal-footer { display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px;}

  /* --- Formulario y Filtros --- */
  form { background-color: var(--color-surface-1); padding: 25px 30px; border-radius: var(--border-radius); box-shadow: 0 6px 12px rgba(0,0,0,0.4); display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px 24px; margin-bottom: 40px; }
  form label { display: block; font-weight: 600; font-size: 0.95rem; margin-bottom: 6px; color: var(--color-text-secondary); }
  form input[type="text"], form input[type="number"], form input[type="date"], form select { width: 100%; padding: 10px 14px; font-size: 1rem; border-radius: 8px; border: 1px solid transparent; background-color: var(--color-background); color: var(--color-text-primary); box-shadow: inset 0 0 5px rgb(255 255 255 / 0.1); transition: box-shadow 0.25s ease, border-color 0.25s ease; }
  form input:focus, form select:focus { outline: none; box-shadow: inset 0 0 8px var(--color-primary); border-color: var(--color-primary); }
  form input[readonly] { background-color: #333; cursor: not-allowed; }
  #submitButton { grid-column: 1 / -1; font-size: 1.2rem; }
  .filtros { margin-bottom: 30px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }

  /* --- Tabla (Enfoque Robusto con Scroll) --- */
  #tablaContenedorConScroll {
    max-height: 600px; /* ALTURA MÁXIMA PARA ~10 FILAS. AJÚSTALA A TU GUSTO */
    overflow-y: auto;
    overflow-x: hidden;
    border-radius: 12px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.4);
  }
  
  #tablaWrapper {
    overflow-x: auto; /* Solo para scroll horizontal en pantallas pequeñas */
  }

  /* Estilos para la barra de scroll */
  #tablaContenedorConScroll::-webkit-scrollbar { width: 8px; }
  #tablaContenedorConScroll::-webkit-scrollbar-track { background: var(--color-surface-2); }
  #tablaContenedorConScroll::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
  #tablaContenedorConScroll::-webkit-scrollbar-thumb:hover { background: var(--color-primary); }

  table#tablaHistorial {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
    min-width: 950px;
    font-size: 0.9rem;
  }
  thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: var(--color-surface-2);
    color: var(--color-text-muted);
    font-weight: 700;
    text-align: left;
    padding: 14px 18px;
    white-space: nowrap;
  }
  th[data-sort] { cursor: pointer; user-select: none; }
  th[data-sort]:hover { color: var(--color-text-primary); }
  th .sort-indicator { margin-left: 8px; color: var(--color-primary); display: inline-block; width: 1em; }
  tbody tr {
    background-color: var(--color-surface-1);
    transition: background-color 0.3s ease;
  }
  tbody tr:hover {
    background-color: var(--color-surface-3);
  }
  tbody td {
    padding: 14px 18px;
    vertical-align: middle;
  }
  .acciones button { background: none; border: none; font-size: 1.2rem; margin: 0 4px; color: #aaa; transition: color 0.2s ease, transform 0.1s ease; }
  .acciones button:hover { color: var(--color-primary); transform: scale(1.1); }
  .no-results-row td { text-align: center; padding: 40px; font-size: 1.1rem; color: var(--color-text-muted); }
  .status-pendiente { color: var(--color-warning); } .status-ganada { color: var(--color-success); } .status-perdida { color: var(--color-danger); }

  /* --- Resumen y Gráficas --- */
  #resumen { margin-top: 40px; background-color: var(--color-surface-2); border-radius: var(--border-radius); padding: 22px 26px; font-weight: 600; display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-around; }
  #resumen > div { min-width: 140px; text-align: center; }
  #resumen > div strong { display: block; font-size: 1.1rem; color: var(--color-primary); margin-bottom: 6px; }
  #graficas { margin-top: 45px; display: flex; flex-direction: column; gap: 40px; }
  canvas { background-color: var(--color-surface-1); border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.5); }
</style>
</head>
<body>
<main>
 <h1>Historial Profesional de Apuestas</h1>

  <form id="formApuesta" autocomplete="off" novalidate>
    <div><label for="liga">Liga *</label><input type="text" id="liga" name="liga" required /></div>
    <div><label for="local">Equipo Local *</label><input type="text" id="local" name="local" required /></div>
    <div><label for="visita">Equipo Visitante *</label><input type="text" id="visita" name="visita" required /></div>
    <div><label for="mercado">Mercado *</label><select id="mercado" name="mercado" required><option value="" disabled selected>Selecciona</option></select></div>
    <div><label for="probabilidad">Probabilidad (%) *</label><input type="number" id="probabilidad" name="probabilidad" min="0.01" max="100" step="0.01" required /></div>
    <div><label for="cuotaImplicita">Cuota Implícita</label><input type="number" id="cuotaImplicita" readonly /></div>
    <div><label for="cuotaBookie">Cuota Bookie *</label><input type="number" id="cuotaBookie" name="cuotaBookie" min="1.01" step="0.01" required /></div>
    <div><label for="bankroll">Bankroll *</label><input type="number" id="bankroll" name="bankroll" min="0.01" step="0.01" value="100" required /></div>
    <div><label for="kellyFrac">Fracción Kelly *</label><select id="kellyFrac" name="kellyFrac" required>
        <option value="0.10">10%</option><option value="0.25" selected>25%</option><option value="0.33">33%</option><option value="0.50">50%</option><option value="1.00">100%</option>
    </select></div>
    <button type="submit" id="submitButton" class="btn btn-primary">Agregar apuesta</button>
  </form>

  <section class="filtros" aria-label="Filtros">
    <input type="text" id="filtroLiga" placeholder="Filtrar por liga..." />
    <input type="date" id="filtroFechaDesde" title="Fecha desde" />
    <input type="date" id="filtroFechaHasta" title="Fecha hasta" />
    <select id="filtroMercado"><option value="">Todos los mercados</option></select>
    <select id="filtroEstado"><option value="">Todos los estados</option><option value="pendiente">Pendiente</option><option value="ganada">Ganada</option><option value="perdida">Perdida</option></select>
    <button id="btnLimpiarFiltros" title="Limpiar filtros" class="btn btn-danger" style="padding: 8px 14px;">✖</button>
  </section>
  
  <div id="tablaContenedorConScroll">
    <div id="tablaWrapper">
      <table id="tablaHistorial">
        <thead>
          <tr>
            <th data-sort="index">#<span class="sort-indicator"></span></th>
            <th data-sort="fecha">Fecha<span class="sort-indicator"></span></th>
            <th data-sort="liga">Liga<span class="sort-indicator"></span></th>
            <th>Local</th>
            <th>Visita</th>
            <th>Mercado</th>
            <th data-sort="probabilidad">Prob (%)<span class="sort-indicator"></span></th>
            <th>Cuota Impl.</th>
            <th data-sort="cuotaBookie">Cuota<span class="sort-indicator"></span></th>
            <th data-sort="ev">EV (%)<span class="sort-indicator"></span></th>
            <th data-sort="kellyFull">Kelly (%)<span class="sort-indicator"></span></th>
            <th>Stake</th>
            <th>Estado</th>
            <th>⚙</th>
          </tr>
        </thead>
        <tbody><!-- Las filas se generan aquí --></tbody>
      </table>
    </div>
  </div>

  <section id="resumen">
    <div><strong>Apuestas</strong><span id="resumenNumApuestas">0</span></div>
    <div><strong>Tasa de Acierto</strong><span id="resumenWinRate">0.00%</span></div>
    <div><strong>Cuota Media</strong><span id="resumenAvgOdds">0.00</span></div>
    <div><strong>Yield</strong><span id="resumenYield">0.00%</span></div>
    <div><strong>ROI</strong><span id="resumenROI">0.00%</span></div>
  </section>

  <section id="graficas">
    <canvas id="graficaBankroll"></canvas>
    <canvas id="graficaKelly"></canvas>
  </section>
</main>

<div class="modal-overlay" id="editModal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <div class="modal-header">
      <h2>Editar Apuesta</h2>
      <button class="modal-close" data-dismiss="modal" aria-label="Cerrar">×</button>
    </div>
    <form id="formEditApuesta" autocomplete="off" novalidate style="box-shadow: none; padding: 0; margin: 0; display: contents;">
        <div class="modal-body" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
    </form>
  </div>
</div>

<div class="modal-overlay" id="confirmModal" aria-hidden="true">
  <div class="modal-content" role="alertdialog">
    <div class="modal-header"><h2 id="confirmModalTitle">Confirmar Acción</h2><button class="modal-close" data-dismiss="modal" aria-label="Cerrar">×</button></div>
    <div class="modal-body"><p id="confirmModalBody">¿Estás seguro?</p></div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
      <button type="button" id="confirmModalButton" class="btn btn-danger">Confirmar</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  'use strict';
  
  const CONSTANTS = {
    STORAGE_KEY: 'historialApuestasProfesionalCompleto',
    MERCADOS: ["Over 2.5 FT", "Under 2.5 FT", "Ambos Anotan", "BTTS NO", "Hándicap", "Local", "Visitante", "Empate"],
  };
  const state = {
    historial: [],
    graficaBankroll: null,
    graficaKelly: null,
    sortColumn: 'fecha',
    sortDirection: 'desc',
    resolveConfirm: null,
  };
  
  const DOMElements = {
      form: document.getElementById('formApuesta'),
      probabilidadInput: document.getElementById('probabilidad'),
      cuotaImplicitaInput: document.getElementById('cuotaImplicita'),
      tablaBody: document.querySelector('#tablaHistorial tbody'),
      thead: document.querySelector('#tablaHistorial thead'),
      editModal: document.getElementById('editModal'),
      editModalBody: document.querySelector('#editModal .modal-body'),
      formEditApuesta: document.getElementById('formEditApuesta'),
      confirmModal: document.getElementById('confirmModal'),
      graficas: {
        ctxBankroll: document.getElementById('graficaBankroll').getContext('2d'),
        ctxKelly: document.getElementById('graficaKelly').getContext('2d'),
      },
      filtros: {
          liga: document.getElementById('filtroLiga'),
          fechaDesde: document.getElementById('filtroFechaDesde'),
          fechaHasta: document.getElementById('filtroFechaHasta'),
          mercado: document.getElementById('filtroMercado'),
          estado: document.getElementById('filtroEstado'),
          btnLimpiar: document.getElementById('btnLimpiarFiltros'),
      }
  };

  const utils = {
    generateUUID: () => ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)),
    calcularCuotaImplicita: prob => (!prob||prob<=0)?'':(100/prob).toFixed(2),
    calcularEV: (prob, cuota) => (!(prob>0&&cuota>1))?0:(prob/100)*cuota-1,
    calcularKelly: (prob, cuota) => (!(prob>0&&cuota>1))?0:((prob/100)*(cuota-1)-(1-(prob/100)))/(cuota-1),
    stakeSugerido: (bank, kelly, frac) => {
        if(!(bank>0&&kelly>0&&frac>0)) return 0;
        const stake=bank*kelly*frac;
        return stake>bank?bank:stake;
    },
    showToast: (message, type='success') => {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    },
    confirmAction: (title, body) => {
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalBody').textContent = body;
        DOMElements.confirmModal.classList.add('visible');
        return new Promise(resolve => { state.resolveConfirm = resolve; });
    }
  };

  const dataHandler = {
    guardar: () => localStorage.setItem(CONSTANTS.STORAGE_KEY, JSON.stringify(state.historial)),
    cargar: () => state.historial = JSON.parse(localStorage.getItem(CONSTANTS.STORAGE_KEY) || '[]'),
  };

  const ui = {
    renderizarTabla: () => {
      const apuestas = actions.getVisibleApuestas();
      if(apuestas.length === 0){
          DOMElements.tablaBody.innerHTML = `<tr><td colspan="14" class="no-results-row">No hay apuestas que mostrar.</td></tr>`;
          return;
      }
      DOMElements.tablaBody.innerHTML = apuestas.map((a, i) => `
        <tr>
          <td>${i+1}</td>
          <td>${new Date(a.fecha).toLocaleDateString('es-ES')}</td>
          <td>${a.liga}</td>
          <td>${a.local}</td>
          <td>${a.visita}</td>
          <td>${a.mercado}</td>
          <td>${a.probabilidad.toFixed(2)}</td>
          <td>${a.cuotaImplicita.toFixed(2)}</td>
          <td>${a.cuotaBookie.toFixed(2)}</td>
          <td style="color:${a.ev>=0?'var(--color-success)':'var(--color-danger)'}">${(a.ev*100).toFixed(2)}</td>
          <td style="color:${a.kellyFull>0?'var(--color-success)':'var(--color-text-secondary)'}">${(a.kellyFull*100).toFixed(2)}</td>
          <td>${utils.stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac).toFixed(2)}</td>
          <td><span class="status-${a.estado}">${a.estado}</span></td>
          <td class="acciones">
            <button title="Editar" data-id="${a.id}" data-action="edit">✏️</button>
            <button title="Ganada" data-id="${a.id}" data-action="ganada">✅</button>
            <button title="Perdida" data-id="${a.id}" data-action="perdida">❌</button>
            <button title="Eliminar" data-id="${a.id}" data-action="delete">🗑️</button>
          </td>
        </tr>`).join('');
      ui.updateSortIndicators();
    },
    actualizarResumen: () => {
        const apuestas = actions.getVisibleApuestas();
        const totalApuestas = apuestas.length;
        const bankrollInicial = totalApuestas > 0 ? apuestas[0].bankroll : 0;
        const finalizadas = apuestas.filter(a => a.estado === 'ganada' || a.estado === 'perdida');
        const ganadas = finalizadas.filter(a => a.estado === 'ganada');
        const winRate = finalizadas.length > 0 ? (ganadas.length / finalizadas.length) * 100 : 0;
        const avgOdds = finalizadas.length > 0 ? finalizadas.reduce((acc, a) => acc + a.cuotaBookie, 0) / finalizadas.length : 0;
        let totalGanado = 0, totalApostado = 0;
        finalizadas.forEach(a => {
            const stake = utils.stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac);
            totalApostado += stake;
            if (a.estado === 'ganada') totalGanado += stake * a.cuotaBookie;
        });
        const neto = totalGanado - totalApostado;
        const yieldPct = totalApostado > 0 ? (neto / totalApostado) * 100 : 0;
        const roiPct = bankrollInicial > 0 ? (neto / bankrollInicial) * 100 : 0;
        document.getElementById('resumenNumApuestas').textContent = totalApuestas;
        document.getElementById('resumenWinRate').textContent = `${winRate.toFixed(2)}%`;
        document.getElementById('resumenAvgOdds').textContent = avgOdds.toFixed(2);
        document.getElementById('resumenYield').textContent = `${yieldPct.toFixed(2)}%`;
        document.getElementById('resumenROI').textContent = `${roiPct.toFixed(2)}%`;
    },
    actualizarGraficas: () => {
      if (state.graficaBankroll) state.graficaBankroll.destroy();
      if (state.graficaKelly) state.graficaKelly.destroy();

      let apuestasParaGrafica = actions.getVisibleApuestas();
      apuestasParaGrafica.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

      if (apuestasParaGrafica.length === 0) return;

      let bankInicial = apuestasParaGrafica[0].bankroll || 100;
      let bankData = [bankInicial];
      let labels = ['Inicio'];

      apuestasParaGrafica.forEach((a, i) => {
        const stake = utils.stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac);
        let ultimoBank = bankData[bankData.length - 1];
        if (a.estado === 'ganada') ultimoBank += stake * (a.cuotaBookie - 1);
        else if (a.estado === 'perdida') ultimoBank -= stake;
        bankData.push(ultimoBank);
        labels.push(`Ap. ${i + 1}`);
      });
      
      const chartOptions = {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#ddd' } } },
        scales: {
          y: { beginAtZero: false, ticks: { color: '#ddd' }, grid: { color: '#444' } },
          x: { ticks: { color: '#ddd' }, grid: { color: '#444' } }
        }
      };

      state.graficaBankroll = new Chart(DOMElements.graficas.ctxBankroll, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Bankroll', data: bankData, borderColor: '#8257e6', backgroundColor: 'rgba(130, 87, 230, 0.3)', fill: true, tension: 0.3 }] },
        options: chartOptions
      });

      state.graficaKelly = new Chart(DOMElements.graficas.ctxKelly, {
        type: 'bar',
        data: { labels: labels.slice(1), datasets: [{ label: 'Kelly FULL (%)', data: apuestasParaGrafica.map(a => a.kellyFull * 100), backgroundColor: '#ffba08', borderRadius: 4 }] },
        options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, max: 100, beginAtZero: true } } }
      });
    },
    poblarSelects: () => {
        const optionsHTML = CONSTANTS.MERCADOS.map(m => `<option value="${m}">${m}</option>`).join('');
        document.getElementById('mercado').insertAdjacentHTML('beforeend', optionsHTML);
        document.getElementById('filtroMercado').insertAdjacentHTML('beforeend', optionsHTML);
    },
    updateSortIndicators: () => {
        DOMElements.thead.querySelectorAll('th[data-sort]').forEach(th => {
            const indicator = th.querySelector('.sort-indicator');
            indicator.textContent = (th.dataset.sort === state.sortColumn) ? (state.sortDirection === 'asc' ? '▲' : '▼') : '';
        });
    },
    openEditModal: (apuesta) => {
        DOMElements.formEditApuesta.dataset.editingId = apuesta.id;
        DOMElements.editModalBody.innerHTML = `
            <div><label>Liga</label><input type="text" name="liga" value="${apuesta.liga}"></div>
            <div><label>Local</label><input type="text" name="local" value="${apuesta.local}"></div>
            <div><label>Visita</label><input type="text" name="visita" value="${apuesta.visita}"></div>
            <div><label>Mercado</label><select name="mercado">${CONSTANTS.MERCADOS.map(m => `<option value="${m}" ${m === apuesta.mercado ? 'selected' : ''}>${m}</option>`).join('')}</select></div>
            <div><label>Probabilidad (%)</label><input type="number" name="probabilidad" value="${apuesta.probabilidad}" step="0.01"></div>
            <div><label>Cuota Bookie</label><input type="number" name="cuotaBookie" value="${apuesta.cuotaBookie}" step="0.01"></div>
            <div><label>Bankroll</label><input type="number" name="bankroll" value="${apuesta.bankroll}" step="0.01"></div>
            <div><label>Fecha</label><input type="date" name="fecha" value="${apuesta.fecha.slice(0,10)}"></div>
        `;
        DOMElements.editModal.classList.add('visible');
    },
    closeAllModals: () => document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('visible')),
    actualizarVistaCompleta: () => {
      ui.renderizarTabla();
      ui.actualizarResumen();
      ui.actualizarGraficas();
    },
  };

  const actions = {
    getVisibleApuestas: () => {
        const { liga, fechaDesde, fechaHasta, mercado, estado } = DOMElements.filtros;
        const filtered = state.historial.filter(a => {
            const fechaApuesta = a.fecha.slice(0, 10);
            return (!liga.value || a.liga.toLowerCase().includes(liga.value.toLowerCase())) &&
                   (!fechaDesde.value || fechaApuesta >= fechaDesde.value) &&
                   (!fechaHasta.value || fechaApuesta <= fechaHasta.value) &&
                   (!mercado.value || a.mercado === mercado.value) &&
                   (!estado.value || a.estado === estado.value);
        });
        return filtered.sort((a, b) => {
            let valA = a[state.sortColumn], valB = b[state.sortColumn];
            if (state.sortColumn === 'fecha') { valA = new Date(valA); valB = new Date(valB); }
            if (valA < valB) return state.sortDirection === 'asc' ? -1 : 1;
            if (valA > valB) return state.sortDirection === 'asc' ? 1 : -1;
            return 0;
        });
    },
    agregarApuesta: (formData) => {
        const prob = parseFloat(formData.get('probabilidad'));
        const cuotaBookie = parseFloat(formData.get('cuotaBookie'));
        const apuesta = {
            id: utils.generateUUID(),
            fecha: new Date().toISOString(),
            liga: formData.get('liga'), local: formData.get('local'), visita: formData.get('visita'),
            mercado: formData.get('mercado'), probabilidad: prob, cuotaBookie: cuotaBookie,
            bankroll: parseFloat(formData.get('bankroll')), kellyFrac: parseFloat(formData.get('kellyFrac')),
            cuotaImplicita: parseFloat(utils.calcularCuotaImplicita(prob)),
            ev: utils.calcularEV(prob, cuotaBookie), kellyFull: utils.calcularKelly(prob, cuotaBookie),
            estado: 'pendiente'
        };
        state.historial.push(apuesta);
        dataHandler.guardar();
        utils.showToast('Apuesta agregada');
    },
    updateApuesta: (id, formData) => {
        const index = state.historial.findIndex(a => a.id === id);
        if (index === -1) return;
        const prob = parseFloat(formData.get('probabilidad'));
        const cuota = parseFloat(formData.get('cuotaBookie'));
        const fecha = new Date(formData.get('fecha')).toISOString();
        Object.assign(state.historial[index], {
            liga: formData.get('liga'), local: formData.get('local'), visita: formData.get('visita'),
            mercado: formData.get('mercado'), probabilidad: prob, cuotaBookie: cuota,
            bankroll: parseFloat(formData.get('bankroll')), fecha: fecha,
            cuotaImplicita: parseFloat(utils.calcularCuotaImplicita(prob)),
            ev: utils.calcularEV(prob, cuota), kellyFull: utils.calcularKelly(prob, cuota),
        });
        dataHandler.guardar();
        utils.showToast('Apuesta actualizada');
        ui.actualizarVistaCompleta();
        ui.closeAllModals();
    }
  };
  
  const events = {
    init: () => {
      document.addEventListener('DOMContentLoaded', () => {
        ui.poblarSelects();
        dataHandler.cargar();
        ui.actualizarVistaCompleta();
        events.attachAll();
      });
    },
    attachAll: () => {
      DOMElements.form.addEventListener('submit', events.handleFormSubmit);
      DOMElements.probabilidadInput.addEventListener('input', events.handleProbabilidadInput);
      DOMElements.tablaBody.addEventListener('click', events.handleTablaClick);
      DOMElements.thead.addEventListener('click', events.handleSortClick);
      DOMElements.formEditApuesta.addEventListener('submit', events.handleEditFormSubmit);
      
      document.querySelectorAll('[data-dismiss="modal"]').forEach(el => el.addEventListener('click', ui.closeAllModals));
      document.getElementById('confirmModalButton').addEventListener('click', () => {
          if (state.resolveConfirm) state.resolveConfirm(true);
          ui.closeAllModals();
      });
      DOMElements.filtros.btnLimpiar.addEventListener('click', events.handleLimpiarFiltros);
      Object.values(DOMElements.filtros).forEach(el => el.addEventListener('input', ui.actualizarVistaCompleta));
    },
    handleFormSubmit: e => {
        e.preventDefault();
        const formData = new FormData(DOMElements.form);
        const lastBankroll = formData.get('bankroll');
        actions.agregarApuesta(formData);
        DOMElements.form.reset();
        DOMElements.form.bankroll.value = lastBankroll;
        DOMElements.cuotaImplicitaInput.value = '';
        ui.actualizarVistaCompleta();
    },
    handleProbabilidadInput: e => {
      DOMElements.cuotaImplicitaInput.value = utils.calcularCuotaImplicita(parseFloat(e.target.value));
    },
    handleTablaClick: async e => {
      const button = e.target.closest('button[data-action]');
      if (!button) return;
      const { id, action } = button.dataset;
      const apuesta = state.historial.find(a => a.id === id);
      if (action === 'edit') ui.openEditModal(apuesta);
      if (action === 'ganada' || action === 'perdida') {
        apuesta.estado = action;
        dataHandler.guardar();
        ui.actualizarVistaCompleta();
      }
      if (action === 'delete') {
        const confirmed = await utils.confirmAction('Eliminar Apuesta', 'Esta acción es irreversible. ¿Estás seguro?');
        if (confirmed) {
            state.historial = state.historial.filter(a => a.id !== id);
            dataHandler.guardar();
            ui.actualizarVistaCompleta();
            utils.showToast('Apuesta eliminada');
        }
      }
    },
    handleSortClick: e => {
        const header = e.target.closest('th[data-sort]');
        if (!header) return;
        const column = header.dataset.sort;
        if (state.sortColumn === column) {
            state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            state.sortColumn = column;
            state.sortDirection = column === 'fecha' ? 'desc' : 'asc';
        }
        ui.actualizarVistaCompleta();
    },
    handleEditFormSubmit: e => {
        e.preventDefault();
        const id = e.target.dataset.editingId;
        const formData = new FormData(e.target);
        actions.updateApuesta(id, formData);
    },
    handleLimpiarFiltros: () => {
        Object.values(DOMElements.filtros).forEach(el => { if(el.tagName !== 'BUTTON') el.value = ''; });
        ui.actualizarVistaCompleta();
    }
  };
  events.init();
})();
</script>
</body>
</html>