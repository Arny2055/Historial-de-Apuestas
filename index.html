<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Calculadora Poisson Bivariante - C√°lculo Manual de Fuerzas</title>
    <style>
        /* Estilos Base */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0;
            background-color: #1a1a2e;
            color: #e0e0e0; 
            min-height: 100vh; 
            width: 100vw;
            display: flex;
            flex-direction: column; 
            justify-content: flex-start; 
            align-items: center;
        }
        .container { 
            width: 98vw; 
            max-width: 950px; 
            padding: 40px 30px; 
            margin-top: 15px; 
            margin-bottom: 15px; 
            background-color: #2c2c54; 
            border-radius: 20px; 
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.7); 
        }
        h2 { 
            text-align: center; 
            color: #ff9800; /* Color principal Bivariante */
            margin-bottom: 5px; 
            font-size: 2.2em; 
        }
        small {
            display: block;
            text-align: center;
            margin-bottom: 20px;
            color: #ccc;
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600; 
            color: #f0f0f0;
            font-size: 1.1em; 
        }
        input[type="number"] { 
            padding: 12px;
            margin-bottom: 15px; 
            width: 100%; 
            box-sizing: border-box; 
            border: 3px solid #4a4e69; 
            border-radius: 10px; 
            background-color: #3e3e6b; 
            color: #ffffff; 
            font-size: 1.1em;
        }
        button { 
            padding: 15px; 
            background-color: #ff9800; /* Color principal Bivariante */
            color: #1a1a2e; 
            border: none; 
            border-radius: 10px; 
            width: 100%; 
            cursor: pointer; 
            font-size: 1.2em; 
            font-weight: bold;
            transition: background-color 0.3s; 
            margin-top: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            opacity: 0.9;
        }
        .section-title {
            color: #ff9800; 
            margin-top: 25px;
            margin-bottom: 10px;
            font-size: 1.4em;
            text-align: center;
            border-bottom: 2px solid #3a3a5e;
            padding-bottom: 8px;
        }
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .input-manual-data {
            padding: 15px;
            border: 1px solid #ff9800; /* Color principal Bivariante */
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .manual-data-title {
            color: #ff9800;
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .resultado { 
            margin-top: 30px; 
            padding: 25px; 
            border: 4px dashed #ff9800; /* Color principal Bivariante */
            border-radius: 15px; 
            background-color: #3a3a5e;
        }
        .resultado p { 
            margin: 8px 0; 
            font-size: 1.3em; 
            display: flex;
            justify-content: space-between;
        }
        .resultado strong { 
            color: #fff; 
            font-weight: bold;
        }
        .calculation-summary {
            margin-top: 15px;
            padding: 15px;
            background-color: #1a1a2e;
            border-radius: 10px;
            font-size: 0.95em;
        }
        .calculation-summary h4 {
            color: #ff9800;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px dashed #4a4e69;
            padding-bottom: 5px;
        }
        .calculation-summary p {
            margin: 5px 0;
            color: #ccc;
        }
        .correlation-input {
            grid-column: 1 / -1; /* Ocupa ambas columnas */
            margin-top: 10px;
            background-color: #4a4e69;
            padding: 15px;
            border-radius: 10px;
        }
        .correlation-input input {
            border-color: #f7a400;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>‚öΩ Calculadora Poisson Bivariante (BP)</h2>
        <small>Modelo avanzado con par√°metro de Correlaci√≥n ($\lambda_3$).</small>
        
        <div class="section-title">1. Medias Promedio de la Liga y Equipos</div>
        <div class="input-group">
            <div class="input-manual-data">
                <div class="manual-data-title">Promedio Goles Liga (Local)</div>
                <label for="avg_league_home">Goles marcados por locales en la liga:</label>
                <input type="number" id="avg_league_home" placeholder="Ej: 1.55" step="0.01" value="1.55">
            </div>
            <div class="input-manual-data">
                <div class="manual-data-title">Promedio Goles Liga (Visitante)</div>
                <label for="avg_league_away">Goles marcados por visitantes en la liga:</label>
                <input type="number" id="avg_league_away" placeholder="Ej: 1.15" step="0.01" value="1.15">
            </div>
        </div>

        <div class="input-group">
            <div class="input-manual-data" style="border-color: #00bcd4;">
                <div class="manual-data-title" style="color: #00bcd4;">Equipo Local (L)</div>
                <label for="avg_home_scored">Promedio Goles **A Favor** (Local):</label>
                <input type="number" id="avg_home_scored" placeholder="Ej: 1.90" step="0.01" value="1.90">
                <label for="avg_home_conceded">Promedio Goles **En Contra** (Local):</label>
                <input type="number" id="avg_home_conceded" placeholder="Ej: 0.80" step="0.01" value="0.80">
            </div>
            <div class="input-manual-data" style="border-color: #ff9800;">
                <div class="manual-data-title" style="color: #ff9800;">Equipo Visitante (V)</div>
                <label for="avg_away_scored">Promedio Goles **A Favor** (Visitante):</label>
                <input type="number" id="avg_away_scored" placeholder="Ej: 1.20" step="0.01" value="1.20">
                <label for="avg_away_conceded">Promedio Goles **En Contra** (Visitante):</label>
                <input type="number" id="avg_away_conceded" placeholder="Ej: 1.30" step="0.01" value="1.30">
            </div>
        </div>
        
        <div class="section-title">2. Par√°metro de Correlaci√≥n ($\lambda_3$)</div>
        <div class="correlation-input">
            <label for="lambda_3">Correlaci√≥n ($\lambda_3$):</label>
            <input type="number" id="lambda_3" placeholder="Ej: 0.15" step="0.01" min="0" value="0.15">
            <small style="color:#f7a400;">Un valor $\lambda_3 > 0$ corrige la subestimaci√≥n de empates (ej. 1-1, 2-2).</small>
        </div>


        <button onclick="calculateManualBivariatePoisson()">3. Calcular Pron√≥stico Poisson Bivariante</button>

        <div class="resultado" id="resultados_poisson" style="display:none;">
            <div class="section-title" style="color:#ff9800; border-color:#ff9800;">üìä Resultados del Modelo Poisson Bivariante</div>

            <div class="calculation-summary">
                <h4>Detalle de Par√°metros Clave</h4>
                <p>Goles Esperados "Netos" Local ($\lambda_1$): <strong id="lambda_1_res">...</strong></p>
                <p>Goles Esperados "Netos" Visitante ($\lambda_2$): <strong id="lambda_2_res">...</strong></p>
                <p>Correlaci√≥n ($\lambda_3$): <strong id="lambda_3_res_summary">...</strong></p>
                <hr style="border-top: 1px dashed #4a4e69; margin: 10px 0;">
                <p>Fuerza Ataque Local: <strong id="att_L">...</strong> | Fuerza Defensa Visitante: <strong id="def_V">...</strong></p>
                <p>Fuerza Ataque Visitante: <strong id="att_V">...</strong> | Fuerza Defensa Local: <strong id="def_L">...</strong></p>
            </div>
            
            <div class="section-title" style="color:#ff9800; border-color:#ff9800; margin-top:20px;">Mercados de Goles</div>
            
            <p>Over 2.5 Goles: <strong id="over25Prob">...</strong></p>
            <p>Under 2.5 Goles: <strong id="under25Prob">...</strong></p>
            
            <div class="section-title" style="color:#ff9800; border-color:#ff9800; margin-top:20px;">Ambos Anotan (BTTS)</div>
            <p>BTTS Yes (S√≠): <strong id="bttsYesProb">...</strong></p>
            <p>BTTS No (No): <strong id="bttsNoProb">...</strong></p>

            <div class="section-title" style="color:#ff9800; border-color:#ff9800; margin-top:20px;">Resultado Final (1X2)</div>
            <p>Local (1): <strong id="prob_1">...</strong></p>
            <p>Empate (X): <strong id="prob_X">...</strong></p>
            <p>Visitante (2): <strong id="prob_2">...</strong></p>
            
        </div>

    </div>

    <script>
        const MAX_GOALS = 6; 
        
        // =======================================================
        // 1. L√ìGICA DE C√ÅLCULO DE FUERZAS Y LAMBDA
        // =======================================================

        function calculateManualBivariatePoisson() {
            const resultsDiv = document.getElementById('resultados_poisson');

            // 1. Obtener Entradas
            const avgLeagueL = parseFloat(document.getElementById('avg_league_home').value);
            const avgLeagueV = parseFloat(document.getElementById('avg_league_away').value);
            const lambda3 = parseFloat(document.getElementById('lambda_3').value);
            
            const avgHomeScored = parseFloat(document.getElementById('avg_home_scored').value);
            const avgHomeConceded = parseFloat(document.getElementById('avg_home_conceded').value);
            
            const avgAwayScored = parseFloat(document.getElementById('avg_away_scored').value);
            const avgAwayConceded = parseFloat(document.getElementById('avg_away_conceded').value);

            // Validar entradas
            if ([avgLeagueL, avgLeagueV, avgHomeScored, avgHomeConceded, avgAwayScored, avgAwayConceded, lambda3].some(isNaN) ||
                [avgLeagueL, avgLeagueV].some(val => val <= 0) || lambda3 < 0) {
                alert("Por favor, introduce todos los valores num√©ricos v√°lidos. Las medias de liga y Œª3 deben ser ‚â• 0.");
                resultsDiv.style.display = 'none';
                return;
            }

            try {
                // 2. Calcular Fuerzas (Mismo m√©todo que SP)
                const attackL = avgHomeScored / avgLeagueL;
                const attackV = avgAwayScored / avgLeagueV;
                const defenseL = avgHomeConceded / avgLeagueV; 
                const defenseV = avgAwayConceded / avgLeagueL; 

                // 3. Calcular Goles Esperados del Poisson EST√ÅNDAR (lambda_L_SP, lambda_V_SP)
                // Usamos estos como la media total antes de la correlaci√≥n (Œª_SP = Œª_1 + Œª_3)
                const lambdaL_SP = attackL * defenseV * avgLeagueL;
                const lambdaV_SP = attackV * defenseL * avgLeagueV;
                
                // 4. Calcular los par√°metros NETOS del Bivariante (Œª1, Œª2)
                const lambda1 = lambdaL_SP - lambda3;
                const lambda2 = lambdaV_SP - lambda3;
                
                if (lambda1 < 0 || lambda2 < 0) {
                     throw new Error(`Error Bivariante: La correlaci√≥n ($\lambda_3$: ${lambda3.toFixed(3)}) es demasiado alta. Debe ser menor o igual a ambos Goles Esperados ($\lambda_L$ y $\lambda_V$).`);
                }

                const params = {
                    lambda1, lambda2, lambda3, 
                    attackL, defenseV, 
                    attackV, defenseL,
                    avgLeagueL, avgLeagueV,
                };

                // 5. Calcular Probabilidades Poisson Bivariante
                const probabilities = calculateBivariatePoissonProbabilities(lambda1, lambda2, lambda3);
                
                // 6. Mostrar Resultados
                displayResults(probabilities, params);
                resultsDiv.style.display = 'block';

            } catch (error) {
                alert("Error durante el c√°lculo: " + error.message);
                resultsDiv.style.display = 'none';
            }
        }
        
        // =======================================================
        // 4. FUNCIONES AUXILIARES (Poisson Bivariante y Display)
        // =======================================================

        function factorial(n) {
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }
        
        // --- POISSON BIVARIANTE (BP) (Funci√≥n principal de un marcador) ---
        function bivariate_poisson_prob(x, y, lambda1, lambda2, lambda3) {
            x = Math.round(x);
            y = Math.round(y);
            
            // Constante de normalizaci√≥n (Exponencial del negativo de la suma de lambdas)
            const c = Math.exp(-(lambda1 + lambda2 + lambda3));
            const min_xy = Math.min(x, y);
            
            let sumatoria = 0;
            for (let i = 0; i <= min_xy; i++) {
                const term1 = Math.pow(lambda1, x - i) / factorial(x - i);
                const term2 = Math.pow(lambda2, y - i) / factorial(y - i);
                const term3 = Math.pow(lambda3, i) / factorial(i);
                sumatoria += term1 * term2 * term3;
            }
            
            return c * sumatoria;
        }

        // Funci√≥n principal de c√°lculo de probabilidades de Poisson Bivariante
        function calculateBivariatePoissonProbabilities(lambda1, lambda2, lambda3) {
            let p_win_L = 0;
            let p_draw = 0;
            let p_win_V = 0;
            let p_total_0 = 0;
            let p_total_1 = 0;
            let p_total_2 = 0;
            let p_btts_ft = 0;
            let p_suma_total_ft = 0;
            let P_LV_Function = (L, V) => bivariate_poisson_prob(L, V, lambda1, lambda2, lambda3);

            for (let L = 0; L <= MAX_GOALS; L++) {
                for (let V = 0; V <= MAX_GOALS; V++) {
                    const P_LV = P_LV_Function(L, V);
                    p_suma_total_ft += P_LV; 
                    
                    // 1X2
                    if (L > V) p_win_L += P_LV;
                    else if (L === V) p_draw += P_LV;
                    else p_win_V += P_LV;
                    
                    // O/U 2.5
                    const total = L + V;
                    if (total === 0) p_total_0 += P_LV;
                    if (total === 1) p_total_1 += P_LV;
                    if (total === 2) p_total_2 += P_LV;
                    
                    // BTTS
                    if (L > 0 && V > 0) p_btts_ft += P_LV; 
                }
            }
            
            if (p_suma_total_ft === 0) throw new Error("La suma total de probabilidades es cero.");

            // Normalizaci√≥n
            const factor = 1.0 / p_suma_total_ft;

            p_win_L *= factor;
            p_draw *= factor;
            p_win_V *= factor;
            p_btts_ft *= factor;
            const p_under_2_5_ft = (p_total_0 + p_total_1 + p_total_2) * factor;
            
            return {
                p_win_L: p_win_L, p_draw: p_draw, p_win_V: p_win_V,
                p_under_2_5: p_under_2_5_ft, 
                p_over_2_5: 1 - p_under_2_5_ft,
                p_btts_yes: p_btts_ft, 
                p_btts_no: 1 - p_btts_ft,
            };
        }

        const calculateOdds = (probability) => (probability > 0 ? (1 / probability).toFixed(2) : '‚àû');
        
        const formatOutput = (prob) => {
            const percentage = (prob * 100).toFixed(2);
            const odds = calculateOdds(prob);
            return `${percentage}% (Cuota: ${odds})`; 
        };

        function displayResults(probabilities, params) {
            // Mostrar Detalle de C√°lculos (Fuerzas y Lambdas Netos)
            document.getElementById('lambda_1_res').textContent = params.lambda1.toFixed(3);
            document.getElementById('lambda_2_res').textContent = params.lambda2.toFixed(3);
            document.getElementById('lambda_3_res_summary').textContent = params.lambda3.toFixed(3);
            
            document.getElementById('att_L').textContent = params.attackL.toFixed(3);
            document.getElementById('def_V').textContent = params.defenseV.toFixed(3);
            document.getElementById('att_V').textContent = params.attackV.toFixed(3);
            document.getElementById('def_L').textContent = params.defenseL.toFixed(3);
            
            // Mostrar Resultados de Mercados
            document.getElementById('over25Prob').textContent = formatOutput(probabilities.p_over_2_5);
            document.getElementById('under25Prob').textContent = formatOutput(probabilities.p_under_2_5);
            document.getElementById('bttsYesProb').textContent = formatOutput(probabilities.p_btts_yes);
            document.getElementById('bttsNoProb').textContent = formatOutput(probabilities.p_btts_no);

            // Mostrar 1X2
            document.getElementById('prob_1').textContent = formatOutput(probabilities.p_win_L);
            document.getElementById('prob_X').textContent = formatOutput(probabilities.p_draw);
            document.getElementById('prob_2').textContent = formatOutput(probabilities.p_win_V);
        }
    </script>
</body>
</html>
