<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Historial de Apuestas Profesional — Perfiles</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  /* --- Reset y base --- */
  *, *::before, *::after { box-sizing: border-box; }
  body {
    margin: 0; padding: 0;
    font-family: 'Inter', sans-serif;
    background-color: #121214; color: #e1e1e6;
    min-height: 100vh; display: flex; flex-direction: column; align-items: center;
  }
  main { max-width: 1200px; width: 95%; margin: 20px auto 40px auto; flex-grow: 1; }
  h1, h2 { font-weight: 600; margin-bottom: 0.5rem; color: #8257e6; }

  /* --- Barra de perfiles --- */
  .perfil-bar{
    background:#202024; padding:12px 16px; border-radius:10px; margin-bottom:18px;
    display:flex; flex-wrap:wrap; gap:10px 12px; align-items:center;
    box-shadow:0 6px 12px rgba(0,0,0,.35);
  }
  .perfil-bar label{color:#c4c4cc; font-weight:600}
  .perfil-bar select,.perfil-bar input{
    min-width:160px; padding:9px 14px; border-radius:8px; border:none;
    background:#121214; color:#e1e1e6; box-shadow:inset 0 0 5px rgb(255 255 255 / .1);
  }
  .perfil-bar button{
    background:#8257e6; color:#fff; font-weight:600; border:none; border-radius:10px;
    cursor:pointer; padding:10px 14px; box-shadow:0 4px 8px #6b45d9;
  }
  .perfil-bar button:hover{filter:brightness(.95)}
  .perfil-bar .btn-danger{background:#ef4444; box-shadow:0 4px 8px rgba(239,68,68,.4);}
  .perfil-bar small{opacity:.8}

  /* --- Formulario de apuesta --- */
  form#formApuesta{
    background-color:#202024; padding:25px 30px; border-radius:10px;
    box-shadow:0 6px 12px rgba(0,0,0,0.4);
    display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:20px 24px; margin-bottom:40px;
  }
  form#formApuesta label{display:block;font-weight:600;font-size:0.95rem;margin-bottom:6px;color:#c4c4cc;}
  form#formApuesta input[type="text"],
  form#formApuesta input[type="number"],
  form#formApuesta select{
    width:100%; padding:10px 14px; font-size:1rem; border-radius:8px; border:none;
    background-color:#121214; color:#e1e1e6; box-shadow:inset 0 0 5px rgb(255 255 255 / 0.1);
    transition: box-shadow 0.25s ease;
  }
  form#formApuesta input[type="text"]:focus,
  form#formApuesta input[type="number"]:focus,
  form#formApuesta select:focus{outline:none; box-shadow:inset 0 0 8px #8257e6;}
  form#formApuesta input[readonly]{background-color:#2a2a30; cursor:not-allowed;}
  form#formApuesta button[type="submit"]{
    grid-column:1 / -1; background-color:#8257e6; color:#fff; font-weight:700; font-size:1.2rem;
    padding:14px 20px; border:none; border-radius:10px; cursor:pointer; transition:background-color 0.3s ease;
    box-shadow:0 6px 10px #6a40d6;
  }
  form#formApuesta button[type="submit"]:hover{background-color:#6a40d6;}

  /* --- Sección filtros --- */
  section.filtros{
    margin-bottom:30px; display:flex; flex-wrap:wrap; gap:15px 18px;
    align-items: center;
  }
  section.filtros input[type="text"],
  section.filtros input[type="number"],
  section.filtros input[type="date"],
  section.filtros select{
    min-width:160px; padding:9px 14px; border-radius:8px; border:none;
    background-color:#121214; color:#e1e1e6; box-shadow:inset 0 0 5px rgb(255 255 255 / 0.1);
    transition: box-shadow 0.25s ease;
  }
  section.filtros input:focus,
  section.filtros select:focus{outline:none; box-shadow:inset 0 0 8px #8257e6;}
  #btnLimpiarFiltros{
    background-color:#ef4444; color:#fff; font-weight:700; border:none; border-radius:10px;
    cursor:pointer; padding:8px 14px; transition:background-color 0.3s ease;
  }
  #btnLimpiarFiltros:hover{background-color:#dc2626;}

  /* --- Botones export/import --- */
  .botones-utiles{margin-bottom:35px; display:flex; gap:18px; flex-wrap:wrap;}
  .botones-utiles button{
    background-color:#8257e6; color:#fff; font-weight:600; border:none; border-radius:10px;
    cursor:pointer; padding:12px 20px; box-shadow:0 4px 8px #6b45d9; transition:background-color 0.3s ease;
  }
  .botones-utiles button:hover{background-color:#6b45d9;}
  .botones-utiles .btn-danger{background-color:#ef4444; box-shadow:0 4px 8px rgba(239,68,68,.4);}
  .botones-utiles .btn-danger:hover{background-color:#dc2626;}
  input[type="file"]{display:none;}

  /* --- Tabla --- */
  #tablaWrapper{
    overflow-x:auto; overflow-y:auto; max-height:580px;
    box-shadow:0 6px 12px rgba(0,0,0,0.4); border-radius:12px;
  }
  table#tablaHistorial{width:100%; border-collapse:separate; border-spacing:0 5px; min-width:900px; font-size:0.9rem;}
  thead th{
    position:sticky; top:0; background-color:#29292e; color:#bbb; font-weight:700; text-align:left;
    padding:14px 18px; user-select:none; white-space:nowrap;
  }
  tbody tr{background-color:#202024; transition:background-color 0.3s ease;}
  tbody tr:hover{background-color:#333339;}
  tbody td{padding:14px 18px; color:#ddd; vertical-align:middle; white-space:nowrap;}
  .acciones button{background:none; border:none; font-size:1.2rem; margin:0 4px; cursor:pointer; color:#aaa; transition:color 0.2s ease;}
  .acciones button:hover{color:#8257e6;}
  .status-pendiente{color:#fbbf24; font-weight:600;}
  .status-ganada{color:#4caf50; font-weight:600;}
  .status-perdida{color:#ef4444; font-weight:600;}

  /* --- Resumen estadísticas --- */
  #resumen{
    margin-top:40px; background-color:#29292e; border-radius:10px; padding:22px 26px; color:#d4d4d8;
    font-size:1.05rem; font-weight:600; display:flex; flex-wrap:wrap; gap:28px; justify-content:space-around;
  }
  #resumen > div{min-width:140px;}
  #resumen > div strong{display:block; font-size:1.15rem; color:#8257e6; margin-bottom:6px;}

  /* --- Gráficas --- */
  #graficas{margin-top:45px; display:flex; flex-direction:column; gap:40px;}
  canvas{background-color:#202024; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,0.5); max-width:100%; height:320px !important;}

  /* --- Análisis por días de la semana (nuevo) --- */
  #analisisSemana{
    margin-top:40px; background:#29292e; border-radius:12px; padding:18px;
    box-shadow:0 6px 18px rgba(0,0,0,.45); display:none;
  }
  #analisisSemana .hdr{
    display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;
  }
  #analisisSemana .hdr h2{margin:0; color:#e1e1e6; font-size:1.25rem}
  #analisisSemana .hdr .actions{display:flex; gap:8px}
  #analisisSemana .hdr .actions button{
    background:#202024; color:#e1e1e6; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,.3);
  }
  #tablaSemana{
    width:100%; border-collapse:separate; border-spacing:0 6px; margin-top:8px; min-width:700px;
  }
  #tablaSemana thead th{
    position:sticky; top:0; background:#202024; color:#c4c4cc; padding:10px 12px; text-align:left;
  }
  #tablaSemana tbody tr{background:#202024;}
  #tablaSemana td{padding:10px 12px; white-space:nowrap;}
  #tablaSemana tfoot td{padding:10px 12px; font-weight:700; background:#202024; color:#e1e1e6;}
</style>
</head>
<body>
<main>
  <h1 style="text-align:center;">Historial Profesional de Apuestas</h1>

  <!-- BARRA DE PERFILES -->
  <section class="perfil-bar" aria-label="Gestión de perfiles">
    <label for="selectPerfil">Perfil:</label>
    <select id="selectPerfil" title="Selecciona el perfil"></select>
    <input id="inputNuevoPerfil" placeholder="Nuevo perfil (ej. NBA_2025)" />
    <button id="btnCrearPerfil" title="Crear nuevo perfil">Crear perfil</button>
    <button id="btnRenombrarPerfil" title="Renombrar perfil">Renombrar</button>
    <button id="btnBorrarPerfil" class="btn-danger" title="Eliminar perfil">Eliminar perfil</button>
    <small id="hintPerfil">Tus datos anteriores se migrarán automáticamente al perfil actual la primera vez.</small>
  </section>

  <!-- FORMULARIO -->
  <form id="formApuesta" autocomplete="off" novalidate aria-label="Formulario para agregar apuesta">
    <div>
      <label for="liga">Liga *</label>
      <input type="text" id="liga" name="liga" placeholder="Ej: LaLiga" required aria-required="true" />
    </div>
    <div>
      <label for="local">Equipo Local *</label>
      <input type="text" id="local" name="local" placeholder="Ej: Real Madrid" required aria-required="true" />
    </div>
    <div>
      <label for="visita">Equipo Visitante *</label>
      <input type="text" id="visita" name="visita" placeholder="Ej: Barcelona" required aria-required="true" />
    </div>
    <div>
      <label for="mercado">Mercado *</label>
      <select id="mercado" name="mercado" required aria-required="true">
        <option value="" disabled selected>Selecciona mercado</option>
        <option value="Over 2.5 FT">Over 2.5 FT</option>
        <option value="Under 2.5 FT">Under 2.5 FT</option>
        <option value="Ambos Anotan">Ambos Anotan</option>
        <option value="BTTS NO">BTTS NO</option>
        <option value="Hándicap">Hándicap</option>
      </select>
    </div>
    <div>
      <label for="probabilidad">Probabilidad (%) *</label>
      <input type="number" id="probabilidad" name="probabilidad" min="0.01" max="100" step="0.01" placeholder="Ej: 60" required aria-required="true" aria-describedby="descProbabilidad" />
      <small id="descProbabilidad" style="color:#c4c4cc; font-size:0.8rem;">Ingresa probabilidad estimada entre 0 y 100</small>
    </div>
    <div>
      <label for="cuotaImplicita">Cuota Implícita (calculada automáticamente)</label>
      <input type="number" id="cuotaImplicita" name="cuotaImplicita" step="0.01" readonly aria-readonly="true" placeholder="Ej: 1.66" />
    </div>
    <div>
      <label for="cuotaBookie">Cuota Bookie (decimal) *</label>
      <input type="number" id="cuotaBookie" name="cuotaBookie" min="1.01" step="0.01" placeholder="Ej: 1.80" required aria-required="true" />
    </div>
    <div>
      <label for="bankroll">Bankroll *</label>
      <input type="number" id="bankroll" name="bankroll" min="0.01" step="0.01" placeholder="Ej: 100" value="100" required aria-required="true" />
    </div>
    <div>
      <label for="kellyFrac">Fracción Kelly *</label>
      <select id="kellyFrac" name="kellyFrac" required aria-required="true">
        <option value="0.10">10%</option>
        <option value="0.25" selected>25%</option>
        <option value="0.33">33%</option>
        <option value="0.50">50%</option>
        <option value="1.00">100%</option>
      </select>
    </div>
    <div>
      <label for="stakePreview">Stake sugerido (preview)</label>
      <input type="number" id="stakePreview" readonly placeholder="0.00" />
    </div>
    <div style="align-self:end;">
      <button type="submit" aria-label="Agregar apuesta">Agregar apuesta</button>
    </div>
  </form>

  <!-- FILTROS -->
  <section class="filtros" aria-label="Filtros para el historial de apuestas">
    <input type="text" id="filtroLiga" placeholder="Filtrar por liga..." aria-label="Filtro por liga" />
    <input type="text" id="filtroLocal" placeholder="Filtrar por local..." aria-label="Filtro por equipo local" />
    <input type="text" id="filtroVisita" placeholder="Filtrar por visita..." aria-label="Filtro por equipo visitante" />

    <select id="filtroMercado" aria-label="Filtro por mercado">
      <option value="">Todos los mercados</option>
      <option value="Over 2.5 FT">Over 2.5 FT</option>
      <option value="Under 2.5 FT">Under 2.5 FT</option>
      <option value="Ambos Anotan">Ambos Anotan</option>
      <option value="BTTS NO">BTTS NO</option>
      <option value="Hándicap">Hándicap</option>
    </select>

    <select id="filtroEstado" aria-label="Filtro por estado de apuesta">
      <option value="">Todos los estados</option>
      <option value="pendiente">Pendiente</option>
      <option value="ganada">Ganada</option>
      <option value="perdida">Perdida</option>
    </select>

    <!-- NUEVOS: filtros por probabilidad -->
    <input type="number" id="filtroProbMin" placeholder="Prob. mín (%)" min="0" max="100" step="0.01" aria-label="Filtro por probabilidad mínima" />
    <input type="number" id="filtroProbMax" placeholder="Prob. máx (%)" min="0" max="100" step="0.01" aria-label="Filtro por probabilidad máxima" />

    <!-- Filtros por fecha -->
    <input type="date" id="filtroFechaInicio" aria-label="Filtro por fecha inicio" />
    <input type="date" id="filtroFechaFin" aria-label="Filtro por fecha fin" />

    <button id="btnLimpiarFiltros" title="Limpiar filtros" aria-label="Limpiar filtros">✖</button>
  </section>

  <!-- BOTONES UTILES -->
  <section class="botones-utiles" aria-label="Exportar o importar historial de apuestas">
    <button id="btnExportarCSV" title="Exportar historial a CSV">Exportar CSV</button>
    <button id="btnImportarJSON" title="Importar historial desde archivo JSON">Importar JSON</button>
    <input type="file" id="inputImportJSON" accept=".json" aria-label="Seleccionar archivo JSON para importar" />
    <button id="btnIrLigas" title="Ver historial por ligas">Historial por Ligas</button>
    <button id="btnIrEquiposRol" title="Ver historial por equipo (rol)">Historial por Equipos (Rol)</button>
    <button id="btnIrProbabilidades" title="Ver estadísticas por probabilidad">Probabilidades</button>
    <!-- NUEVO BOTÓN -->
    <button id="btnAnalizarSemana" title="Ver análisis por días de la semana">Días de la Semana</button>
    <!-- NUEVO: borrar todo -->
    <button id="btnEliminarTodo" class="btn-danger" title="Eliminar todo el historial">Eliminar todo</button>
  </section>

  <!-- TABLA -->
  <section aria-label="Historial de apuestas registradas">
    <div id="tablaWrapper">
      <table role="grid" aria-describedby="tableDescription" id="tablaHistorial" tabindex="0">
        <caption id="tableDescription" style="text-align:left; margin-bottom:12px; font-weight:700; font-size:1.2rem;">
          Historial de apuestas agregadas
        </caption>
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Fecha</th>
            <th scope="col">Liga</th>
            <th scope="col">Local</th>
            <th scope="col">Visita</th>
            <th scope="col">Mercado</th>
            <th scope="col">Prob (%)</th>
            <th scope="col">Cuota Implícita</th>
            <th scope="col">Cuota Bookie</th>
            <th scope="col">EV (%)</th>
            <th scope="col">Kelly FULL (%)</th>
            <th scope="col">Stake sugerido</th>
            <th scope="col">Estado</th>
            <th scope="col" aria-label="Acciones">⚙</th>
          </tr>
        </thead>
        <tbody><!-- Contenido generado por JS --></tbody>
      </table>
    </div>
  </section>

  <!-- RESUMEN -->
  <section id="resumen" aria-label="Resumen estadístico de apuestas">
    <div><strong>Bankroll inicial:</strong> <span id="resumenBankroll">-</span></div>
    <div><strong>Número apuestas:</strong> <span id="resumenNumApuestas">0</span></div>
    <div><strong>Apuestas ganadas:</strong> <span id="resumenGanadas">0</span></div>
    <div><strong>Apuestas perdidas:</strong> <span id="resumenPerdidas">0</span></div>
    <div><strong>Yield (%):</strong> <span id="resumenYield">0.00%</span></div>
    <div><strong>ROI (%):</strong> <span id="resumenROI">0.00%</span></div>
    <div><strong>Tasa de éxito (%):</strong> <span id="resumenTasaExito">0.00%</span></div>
    <div><strong>Unidades ganadas:</strong> <span id="resumenUnidades">0.00</span></div>
  </section>

  <!-- GRAFICAS -->
  <section id="graficas" aria-label="Gráficas de evolución del bankroll y Kelly">
    <canvas id="graficaBankroll" aria-label="Gráfica de evolución de bankroll"></canvas>
    <canvas id="graficaKelly" aria-label="Gráfica de Kelly Full"></canvas>
  </section>

  <!-- NUEVO: ANÁLISIS POR DÍAS DE LA SEMANA -->
  <section id="analisisSemana" aria-label="Análisis por días de la semana">
    <div class="hdr">
      <h2>Análisis por días de la semana</h2>
      <div class="actions">
        <button id="btnRefrescarSemana" title="Refrescar con filtros actuales">Refrescar</button>
        <button id="btnCerrarAnalisis" title="Ocultar panel">Cerrar</button>
      </div>
    </div>

    <div style="overflow:auto; border-radius:10px; box-shadow:0 6px 12px rgba(0,0,0,.35);">
      <table id="tablaSemana">
        <thead>
          <tr>
            <th>Día</th>
            <th>Apuestas</th>
            <th>Ganadas</th>
            <th>Perdidas</th>
            <th>Pendientes</th>
            <th>Winrate %</th>
            <th>Yield %</th>
            <th>Unidades</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td>TOTAL</td>
            <td id="dwTotApu">0</td>
            <td id="dwTotGan">0</td>
            <td id="dwTotPer">0</td>
            <td id="dwTotPen">0</td>
            <td id="dwTotWr">0.00</td>
            <td id="dwTotYield">0.00</td>
            <td id="dwTotUnid">0.00</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <canvas id="graficaDiasSemana" aria-label="Unidades por día de la semana" style="margin-top:16px;"></canvas>
    <small style="color:#c4c4cc; display:block; margin-top:8px;">
      Nota: usa los filtros de arriba para recalcular este análisis y pulsa “Refrescar”.
    </small>
  </section>

</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  'use strict';

  /* ==========================
     SISTEMA DE PERFILES + MIGRACIÓN
     ========================== */
  const STORAGE_ROOT = 'HAPC';
  const PROFILE_LIST_KEY = STORAGE_ROOT + '_profiles';
  const CURRENT_PROFILE_KEY = STORAGE_ROOT + '_currentProfile';
  const dataKeyFor = (perfil) => `${STORAGE_ROOT}_data_${perfil}`;
  const OLD_STORAGE_KEY = 'historialApuestasProfesionalCompleto';

  function getProfiles(){
    try { const v = JSON.parse(localStorage.getItem(PROFILE_LIST_KEY) || '[]'); return Array.isArray(v) ? v : []; }
    catch { return []; }
  }
  function setProfiles(list){ localStorage.setItem(PROFILE_LIST_KEY, JSON.stringify(list)); }
  function getCurrentProfile(){
    const urlP = new URLSearchParams(location.search).get('perfil');
    if (urlP && urlP.trim()) return urlP.trim();
    return localStorage.getItem(CURRENT_PROFILE_KEY) || 'default';
  }
  function setCurrentProfile(p){ localStorage.setItem(CURRENT_PROFILE_KEY, p); }
  function ensureInitialProfiles(){
    let list = getProfiles();
    if (list.length === 0){
      list = ['default']; setProfiles(list);
      if (!localStorage.getItem(dataKeyFor('default'))) localStorage.setItem(dataKeyFor('default'), '[]');
    }
    return list;
  }
  function migrateIfNeeded(perfil){
    const old = localStorage.getItem(OLD_STORAGE_KEY);
    const destKey = dataKeyFor(perfil);
    if (old && !localStorage.getItem(destKey)){
      localStorage.setItem(destKey, old);
    }
  }

  let perfil = 'default';
  let historial = [];

  /* ==========================
     ELEMENTOS DOM
     ========================== */
  const form = document.getElementById('formApuesta');
  const cuotaImplicitaInput = document.getElementById('cuotaImplicita');

  const selectPerfil = document.getElementById('selectPerfil');
  const inputNuevoPerfil = document.getElementById('inputNuevoPerfil');
  const btnCrearPerfil = document.getElementById('btnCrearPerfil');
  const btnRenombrarPerfil = document.getElementById('btnRenombrarPerfil');
  const btnBorrarPerfil = document.getElementById('btnBorrarPerfil');

  const filtroLiga = document.getElementById('filtroLiga');
  const filtroLocal = document.getElementById('filtroLocal');
  const filtroVisita = document.getElementById('filtroVisita');
  const filtroMercado = document.getElementById('filtroMercado');
  const filtroEstado = document.getElementById('filtroEstado');
  const filtroProbMin = document.getElementById('filtroProbMin');
  const filtroProbMax = document.getElementById('filtroProbMax');
  const filtroFechaInicio = document.getElementById('filtroFechaInicio');
  const filtroFechaFin = document.getElementById('filtroFechaFin');
  const btnLimpiarFiltros = document.getElementById('btnLimpiarFiltros');

  const tablaBody = document.querySelector('#tablaHistorial tbody');

  const resumenBankroll = document.getElementById('resumenBankroll');
  const resumenNumApuestas = document.getElementById('resumenNumApuestas');
  const resumenGanadas = document.getElementById('resumenGanadas');
  const resumenPerdidas = document.getElementById('resumenPerdidas');
  const resumenYield = document.getElementById('resumenYield');
  const resumenROI = document.getElementById('resumenROI');
  const resumenTasaExito = document.getElementById('resumenTasaExito');
  const resumenUnidades = document.getElementById('resumenUnidades');

  const btnExportarCSV = document.getElementById('btnExportarCSV');
  const btnImportarJSON = document.getElementById('btnImportarJSON');
  const inputImportJSON = document.getElementById('inputImportJSON');
  const btnEliminarTodo = document.getElementById('btnEliminarTodo');

  const btnIrLigas = document.getElementById('btnIrLigas');
  const btnIrEquiposRol = document.getElementById('btnIrEquiposRol');
  const btnIrProbabilidades = document.getElementById('btnIrProbabilidades');

  const ctxBankroll = document.getElementById('graficaBankroll').getContext('2d');
  const ctxKelly = document.getElementById('graficaKelly').getContext('2d');

  let graficaBankroll = null;
  let graficaKelly = null;

  /* NUEVO: elementos del análisis por días */
  const btnAnalizarSemana = document.getElementById('btnAnalizarSemana');
  const panelSemana = document.getElementById('analisisSemana');
  const btnCerrarAnalisis = document.getElementById('btnCerrarAnalisis');
  const btnRefrescarSemana = document.getElementById('btnRefrescarSemana');
  const tbodySemana = panelSemana.querySelector('tbody');
  const dwTotApu = document.getElementById('dwTotApu');
  const dwTotGan = document.getElementById('dwTotGan');
  const dwTotPer = document.getElementById('dwTotPer');
  const dwTotPen = document.getElementById('dwTotPen');
  const dwTotWr = document.getElementById('dwTotWr');
  const dwTotYield = document.getElementById('dwTotYield');
  const dwTotUnid = document.getElementById('dwTotUnid');
  const ctxDias = document.getElementById('graficaDiasSemana').getContext('2d');
  let graficaDias = null;

  /* ==========================
     FUNCIONES AUXILIARES BASE
     ========================== */
  function calcularCuotaImplicita(prob) { if (!(prob > 0)) return ''; return (100 / prob).toFixed(2); }
  function calcularEV(prob, cuotaBookie) { if (!(prob > 0 && cuotaBookie > 1)) return 0; const p = prob / 100; return p * cuotaBookie - 1; }
  function calcularKelly(prob, cuotaBookie) {
    if (!(prob > 0 && cuotaBookie > 1)) return 0;
    const p = prob / 100, b = cuotaBookie - 1;
    return (p * b - (1 - p)) / b;
  }
  function stakeSugerido(bankroll, kellyFull, kellyFrac) {
    if (!(bankroll > 0 && kellyFull > 0 && kellyFrac > 0)) return 0;
    const stake = bankroll * kellyFull * kellyFrac;
    return stake > bankroll ? bankroll : stake;
  }

  /* ==========================
     CARGA/GUARDADO
     ========================== */
  function guardarHistorial() { localStorage.setItem(dataKeyFor(perfil), JSON.stringify(historial)); }
  function cargarHistorial() {
    const raw = localStorage.getItem(dataKeyFor(perfil));
    if (raw) { try { historial = JSON.parse(raw); } catch { historial = []; } }
    else { historial = []; localStorage.setItem(dataKeyFor(perfil), '[]'); }
  }

  /* ==========================
     FILTROS + RENDER TABLA/RESUMEN/GRAFICAS
     ========================== */
  function limpiarFiltros() {
    filtroLiga.value = ''; filtroLocal.value = ''; filtroVisita.value = '';
    filtroMercado.value = ''; filtroEstado.value = '';
    filtroProbMin.value = ''; filtroProbMax.value = '';
    filtroFechaInicio.value = ''; filtroFechaFin.value = '';
  }

  function filtrarHistorial() {
    return historial.filter(a => {
      if (filtroLiga.value && !a.liga.toLowerCase().includes(filtroLiga.value.toLowerCase())) return false;
      if (filtroLocal.value && !a.local.toLowerCase().includes(filtroLocal.value.toLowerCase())) return false;
      if (filtroVisita.value && !a.visita.toLowerCase().includes(filtroVisita.value.toLowerCase())) return false;
      if (filtroMercado.value && a.mercado !== filtroMercado.value) return false;
      if (filtroEstado.value && a.estado !== filtroEstado.value) return false;

      const p = Number(a.probabilidad) || 0;
      const min = filtroProbMin.value !== '' ? parseFloat(filtroProbMin.value) : null;
      const max = filtroProbMax.value !== '' ? parseFloat(filtroProbMax.value) : null;
      if (min !== null && p < min) return false;
      if (max !== null && p > max) return false;

      if (filtroFechaInicio.value) {
        const fechaIni = new Date(filtroFechaInicio.value);
        if (new Date(a.fecha) < fechaIni) return false;
      }
      if (filtroFechaFin.value) {
        const fechaFin = new Date(filtroFechaFin.value);
        fechaFin.setHours(23, 59, 59, 999);
        if (new Date(a.fecha) > fechaFin) return false;
      }
      return true;
    });
  }

  function renderizarTabla() {
    const apuestas = filtrarHistorial().slice().reverse();
    tablaBody.innerHTML = '';
    apuestas.forEach((a, i) => {
      const tr = document.createElement('tr');
      const tdIndex = document.createElement('td'); tdIndex.textContent = i + 1; tr.appendChild(tdIndex);

      const tdFecha = document.createElement('td'); tdFecha.textContent = new Date(a.fecha).toLocaleDateString(); tr.appendChild(tdFecha);

      const tdLiga = document.createElement('td'); tdLiga.textContent = a.liga;
      tdLiga.addEventListener('dblclick', () => {
        const input = document.createElement('input'); input.type = 'text'; input.value = a.liga; input.style.width = "100%";
        tdLiga.textContent = ''; tdLiga.appendChild(input); input.focus();
        input.addEventListener('blur', () => { a.liga = input.value.trim() || a.liga; guardarHistorial(); actualizarVista(); });
        input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); });
      });
      tr.appendChild(tdLiga);

      const tdLocal = document.createElement('td'); tdLocal.textContent = a.local; tr.appendChild(tdLocal);
      const tdVisita = document.createElement('td'); tdVisita.textContent = a.visita; tr.appendChild(tdVisita);
      const tdMercado = document.createElement('td'); tdMercado.textContent = a.mercado; tr.appendChild(tdMercado);

      const tdProb = document.createElement('td'); tdProb.textContent = (Number(a.probabilidad) || 0).toFixed(2); tr.appendChild(tdProb);

      const tdCuotaImpl = document.createElement('td');
      const impl = a.cuotaImplicita !== '' && a.cuotaImplicita !== null ? a.cuotaImplicita : calcularCuotaImplicita(a.probabilidad);
      tdCuotaImpl.textContent = impl !== '' ? Number(impl).toFixed(2) : '-'; tr.appendChild(tdCuotaImpl);

      const tdCuotaBookie = document.createElement('td'); tdCuotaBookie.textContent = (Number(a.cuotaBookie) || 0).toFixed(2); tr.appendChild(tdCuotaBookie);

      const tdEV = document.createElement('td'); tdEV.textContent = ((a.ev || 0) * 100).toFixed(2);
      tdEV.style.color = (a.ev || 0) >= 0 ? '#4caf50' : '#ef4444'; tr.appendChild(tdEV);

      const tdKelly = document.createElement('td');
      tdKelly.textContent = a.kellyFull ? (a.kellyFull * 100).toFixed(2) : '-';
      tdKelly.style.color = a.kellyFull && a.kellyFull > 0 ? '#4caf50' : '#c4c4cc'; tr.appendChild(tdKelly);

      const stake = stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac);
      const tdStake = document.createElement('td'); tdStake.textContent = stake.toFixed(2); tr.appendChild(tdStake);

      const tdEstado = document.createElement('td'); tdEstado.textContent = a.estado; tdEstado.className = `status-${a.estado}`; tr.appendChild(tdEstado);

      const tdAcciones = document.createElement('td'); tdAcciones.className = 'acciones';
      const btnGanada = document.createElement('button'); btnGanada.title='Marcar como ganada'; btnGanada.innerHTML='✅';
      btnGanada.addEventListener('click', () => cambiarEstado(a.id, 'ganada'));
      const btnPerdida = document.createElement('button'); btnPerdida.title='Marcar como perdida'; btnPerdida.innerHTML='❌';
      btnPerdida.addEventListener('click', () => cambiarEstado(a.id, 'perdida'));
      const btnPendiente = document.createElement('button'); btnPendiente.title='Marcar como pendiente'; btnPendiente.innerHTML='⏳';
      btnPendiente.addEventListener('click', () => cambiarEstado(a.id, 'pendiente'));
      const btnBorrar = document.createElement('button'); btnBorrar.title='Eliminar apuesta'; btnBorrar.innerHTML='🗑️';
      btnBorrar.addEventListener('click', () => eliminarApuesta(a.id));
      tdAcciones.append(btnGanada, btnPerdida, btnPendiente, btnBorrar);
      tr.appendChild(tdAcciones);

      tablaBody.appendChild(tr);
    });
  }

  function cambiarEstado(id, nuevoEstado) {
    const index = historial.findIndex(a => a.id === id);
    if (index !== -1) {
      historial[index].estado = nuevoEstado;
      guardarHistorial();
      actualizarVista();
    }
  }

  function eliminarApuesta(id) {
    if (!confirm('¿Estás seguro de eliminar esta apuesta?')) return;
    historial = historial.filter(a => a.id !== id);
    guardarHistorial();
    actualizarVista();
  }

  btnEliminarTodo.addEventListener('click', () => {
    if (!confirm(`⚠️ ¿Seguro que quieres eliminar TODO el historial del perfil "${perfil}"? Esta acción no se puede deshacer.`)) return;
    historial = []; localStorage.setItem(dataKeyFor(perfil), '[]');
    actualizarVista(); inputImportJSON.value = '';
    alert('Historial eliminado ✅');
  });

  function actualizarResumen() {
    const apuestasFiltradas = filtrarHistorial();
    if (apuestasFiltradas.length === 0) {
      resumenBankroll.textContent = '-';
      resumenNumApuestas.textContent = '0';
      resumenGanadas.textContent = '0';
      resumenPerdidas.textContent = '0';
      resumenYield.textContent = '0.00%';
      resumenROI.textContent = '0.00%';
      resumenTasaExito.textContent = '0.00%';
      resumenUnidades.textContent = '0.00';
      return;
    }

    const bankrollInicial = apuestasFiltradas[0].bankroll || 0;
    resumenBankroll.textContent = bankrollInicial.toFixed(2);

    const numApuestas = apuestasFiltradas.length;
    resumenNumApuestas.textContent = numApuestas;

    const ganadas = apuestasFiltradas.filter(a => a.estado === 'ganada').length;
    const perdidas = apuestasFiltradas.filter(a => a.estado === 'perdida').length;
    resumenGanadas.textContent = ganadas;
    resumenPerdidas.textContent = perdidas;

    const tasaExito = numApuestas > 0 ? (ganadas / numApuestas) * 100 : 0;
    resumenTasaExito.textContent = tasaExito.toFixed(2) + '%';

    let totalGanado = 0, totalApostado = 0;
    apuestasFiltradas.forEach(a => {
      const stake = stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac);
      totalApostado += stake;
      if (a.estado === 'ganada') totalGanado += stake * a.cuotaBookie;
      if (a.estado === 'perdida') totalGanado += 0;
    });
    const neto = totalGanado - totalApostado;
    const yieldPct = totalApostado > 0 ? (neto / totalApostado) * 100 : 0;
    resumenYield.textContent = yieldPct.toFixed(2) + '%';
    const roiPct = bankrollInicial > 0 ? (neto / bankrollInicial) * 100 : 0;
    resumenROI.textContent = roiPct.toFixed(2) + '%';
    resumenUnidades.textContent = neto.toFixed(2);
  }

  function actualizarGraficas() {
    const apuestasFiltradas = filtrarHistorial();
    if (graficaBankroll) graficaBankroll.destroy();
    if (graficaKelly) graficaKelly.destroy();
    if (apuestasFiltradas.length === 0) return;

    let bankInicial = apuestasFiltradas[0].bankroll || 100;
    let bankData = [bankInicial];
    let labels = ['Inicio'];

    apuestasFiltradas.forEach((a, i) => {
      const stake = stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac);
      let lastBank = bankData[bankData.length - 1];
      let nuevoBank = lastBank;
      if (a.estado === 'ganada') nuevoBank += stake * (a.cuotaBookie - 1);
      else if (a.estado === 'perdida') nuevoBank -= stake;
      bankData.push(nuevoBank);
      labels.push(`Apuesta ${i + 1}`);
    });

    graficaBankroll = new Chart(ctxBankroll, {
      type: 'line',
      data: { labels, datasets: [{ label: 'Bankroll', data: bankData, borderColor: '#8257e6', backgroundColor: 'rgba(130,87,230,.3)', fill: true, tension: .3, pointRadius:3, pointHoverRadius:6, borderWidth:3 }]},
      options: {
        responsive:true, interaction:{mode:'nearest', intersect:false},
        plugins:{ legend:{labels:{color:'#ddd', font:{size:14, weight:'600'}}}, tooltip:{callbacks:{label: ctx => `Bankroll: ${ctx.parsed.y.toFixed(2)}`}}},
        scales:{ y:{beginAtZero:false, ticks:{color:'#ddd'}, grid:{color:'#444'}}, x:{ticks:{color:'#ddd'}, grid:{color:'#444'}} }
      }
    });

    const kellyData = apuestasFiltradas.map(a => a.kellyFull ? a.kellyFull * 100 : 0);
    graficaKelly = new Chart(ctxKelly, {
      type:'bar',
      data:{ labels: labels.slice(1), datasets:[{ label:'Kelly FULL (%)', data: kellyData, backgroundColor:'#ffba08', borderRadius:4 }]},
      options:{
        responsive:true,
        scales:{ y:{beginAtZero:true, max:100, ticks:{color:'#ddd'}, grid:{color:'#444'}}, x:{ticks:{color:'#ddd'}, grid:{color:'#444'}} },
        plugins:{ legend:{labels:{color:'#ddd', font:{size:14, weight:'600'}}}}
      }
    });
  }

  /* ==========================
     NUEVO: ANÁLISIS POR DÍAS
     ========================== */
  const DOW_LABELS = ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'];
  function mondayIndex(date){ return (date.getDay() + 6) % 7; } // 0=Lun ... 6=Dom

  function statsPorDia(apuestas){
    const base = Array.from({length:7}, ()=>({count:0, wins:0, losses:0, pending:0, apostado:0, net:0}));
    apuestas.forEach(a=>{
      const d = new Date(a.fecha);
      const idx = mondayIndex(d);
      const s = base[idx];
      const stake = stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac);
      s.count++; s.apostado += stake;
      if (a.estado === 'ganada'){ s.wins++; s.net += stake * (a.cuotaBookie - 1); }
      else if (a.estado === 'perdida'){ s.losses++; s.net -= stake; }
      else { s.pending++; }
    });
    return base.map(s=>({
      ...s,
      wr: s.count ? (s.wins / s.count * 100) : 0,
      yld: s.apostado ? (s.net / s.apostado * 100) : 0
    }));
  }

  function renderAnalisisSemana(){
    const apuestas = filtrarHistorial();
    const st = statsPorDia(apuestas);

    // Tabla
    tbodySemana.innerHTML = '';
    let tCount=0, tWins=0, tLoss=0, tPend=0, tApost=0, tNet=0;
    st.forEach((s, i)=>{
      tCount += s.count; tWins += s.wins; tLoss += s.losses; tPend += s.pending; tApost += s.apostado; tNet += s.net;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${DOW_LABELS[i]}</td>
        <td>${s.count}</td>
        <td>${s.wins}</td>
        <td>${s.losses}</td>
        <td>${s.pending}</td>
        <td>${s.wr.toFixed(2)}</td>
        <td>${s.yld.toFixed(2)}</td>
        <td style="font-weight:700; color:${s.net>=0?'#4caf50':'#ef4444'}">${s.net.toFixed(2)}</td>`;
      tbodySemana.appendChild(tr);
    });

    const tWr = tCount ? (tWins / tCount * 100) : 0;
    const tYield = tApost ? (tNet / tApost * 100) : 0;
    dwTotApu.textContent = tCount;
    dwTotGan.textContent = tWins;
    dwTotPer.textContent = tLoss;
    dwTotPen.textContent = tPend;
    dwTotWr.textContent = tWr.toFixed(2);
    dwTotYield.textContent = tYield.toFixed(2);
    dwTotUnid.textContent = tNet.toFixed(2);

    // Gráfica
    if (graficaDias) graficaDias.destroy();
    graficaDias = new Chart(ctxDias, {
      type:'bar',
      data:{
        labels:DOW_LABELS,
        datasets:[
          { label:'Unidades netas', data: st.map(s=>s.net), backgroundColor:'#36a2eb', borderRadius:6 },
          { label:'Winrate (%)', data: st.map(s=>s.wr), type:'line', yAxisID:'y1', tension:.3, borderColor:'#ff6384', fill:false, pointRadius:4 }
        ]
      },
      options:{
        responsive:true,
        scales:{
          y:{ beginAtZero:true, ticks:{color:'#ddd'}, grid:{color:'#444'}, title:{display:true, text:'Unidades', color:'#ddd'} },
          y1:{ position:'right', beginAtZero:true, ticks:{color:'#ddd'}, grid:{display:false}, title:{display:true, text:'%', color:'#ddd'} },
          x:{ ticks:{color:'#ddd'}, grid:{color:'#444'} }
        },
        plugins:{ legend:{labels:{color:'#ddd'}} }
      }
    });
  }

  btnAnalizarSemana.addEventListener('click', ()=>{
    panelSemana.style.display = 'block';
    renderAnalisisSemana();
    panelSemana.scrollIntoView({behavior:'smooth', block:'start'});
  });
  btnCerrarAnalisis.addEventListener('click', ()=>{ panelSemana.style.display = 'none'; });
  btnRefrescarSemana.addEventListener('click', renderAnalisisSemana);

  /* ==========================
     EXPORT / IMPORT
     ========================== */
  btnExportarCSV.addEventListener('click', () => {
    if (historial.length === 0) { alert('No hay datos para exportar'); return; }
    const csvRows = [];
    const headers = ['id','fecha','liga','local','visita','mercado','probabilidad','cuotaImplicita','cuotaBookie','ev','kellyFull','bankroll','kellyFrac','estado'];
    csvRows.push(headers.join(','));
    historial.forEach(a => {
      csvRows.push([ a.id, a.fecha, `"${a.liga}"`, `"${a.local}"`, `"${a.visita}"`, `"${a.mercado}"`, a.probabilidad, a.cuotaImplicita, a.cuotaBookie, a.ev, a.kellyFull, a.bankroll, a.kellyFrac, a.estado ].join(','));
    });
    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a'); link.href = url; link.download = `historial_apuestas_${perfil}.csv`;
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
  });

  btnImportarJSON.addEventListener('click', () => inputImportJSON.click());

  // -------- utilidades de import (sin cambios de fondo) --------
  const removeDiacritics = (s) => s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  const normalizeKey = (k) => removeDiacritics(String(k)).toLowerCase().replace(/[^a-z0-9]+/g,'');
  function getVal(obj, candidates) {
    const map = new Map(Object.keys(obj).map(k => [normalizeKey(k), k]));
    for (const c of candidates) { const nk = normalizeKey(c); if (map.has(nk)) return obj[map.get(nk)]; }
    return undefined;
  }
  function toNumber(val) {
    if (typeof val === 'number') return val;
    if (val === null || val === undefined) return NaN;
    let s = String(val).trim().replace(/%/g,'').replace(/\s+/g,'').replace(/,/g,'.');
    if (s === '') return NaN; const n = parseFloat(s); return isNaN(n) ? NaN : n;
  }
  const monthMap = {ene:0, enero:0, feb:1, febrero:1, mar:2, marzo:2, abr:3, abril:3, may:4, mayo:4, jun:5, junio:5, jul:6, julio:6, ago:7, agosto:7, sep:8, set:8, sept:8, septiembre:8, setiembre:8, oct:9, octubre:9, nov:10, noviembre:10, dic:11, diciembre:11};
  function parseSpanishDate(str) {
    if (!str) return new Date();
    const raw = removeDiacritics(String(str)).toLowerCase().replace(/\./g,' ').replace(/,/g,' ').replace(/\s+/g,' ').trim();
    const m = raw.match(/(\d{1,2})\s+([a-z]+)\s+(\d{4})(?:\s+(\d{1,2}):(\d{2}))?/);
    if (m) {
      const day = parseInt(m[1],10);
      const monToken = m[2];
      const monKey = (monthMap[monToken] !== undefined) ? monToken
                    : monthMap[monToken.slice(0,4)] !== undefined ? monToken.slice(0,4)
                    : monthMap[monToken.slice(0,3)] !== undefined ? monToken.slice(0,3)
                    : null;
      const month = monKey !== null ? monthMap[monKey] : undefined;
      if (month !== undefined) {
        const year = parseInt(m[3],10);
        const hh = m[4] ? parseInt(m[4],10) : 12;
        const mm = m[5] ? parseInt(m[5],10) : 0;
        return new Date(year, month, day, hh, mm, 0);
      }
    }
    const d2 = new Date(str);
    return isNaN(d2) ? new Date() : d2;
  }
  function splitMatch(what) {
    if (!what) return ['', ''];
    const s = String(what).replace(/vs\.?|v\.s\.?/gi, '-');
    const parts = s.split('-');
    if (parts.length >= 2) return [parts[0].trim(), parts.slice(1).join('-').trim()];
    return [String(what).trim(), ''];
  }
  function mapOutcome(x) {
    const s = String(x || '').toLowerCase();
    if (/gg\b|btts\s*si|btts\s*s[ií]|ambos/.test(s)) return 'Ambos Anotan';
    if (/ng\b|btts\s*no/.test(s)) return 'BTTS NO';
    if ((/over/.test(s) || /\bo\d+(\.\d+)?\b/.test(s)) && /2(\.|,)?5/.test(s)) return 'Over 2.5 FT';
    if ((/under/.test(s) || /\bu\d+(\.\d+)?\b/.test(s)) && /2(\.|,)?5/.test(s)) return 'Under 2.5 FT';
    if (/handicap|h.ndicap/i.test(s)) return 'Hándicap';
    return x || '';
  }
  function mapEstado(x) {
    const s = String(x || '').trim().toLowerCase();
    if (/\bwin(n?ing)?\b/.test(s) || /\bwon\b/.test(s) || /ganad[ao]s?/.test(s) || /\bgreen\b/.test(s)) return 'ganada';
    if (/\blos(e|ing|t)\b/.test(s) || /\bloss\b/.test(s) || /perdid[ao]s?/.test(s) || /\bred\b/.test(s)) return 'perdida';
    if (/\bvoid(ed)?\b/.test(s) || /cancel(l?ed|ar|ada)/.test(s) || /\bpush\b/.test(s) || /\brefund(ed)?\b/.test(s) || /nula|anulada/.test(s)) return 'pendiente';
    return 'pendiente';
  }

  btnImportarJSON.addEventListener('click', () => inputImportJSON.click());
  inputImportJSON.addEventListener('change', (e) => {
    const file = e.target.files && e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        let data = JSON.parse(event.target.result); if (!Array.isArray(data)) data = [data];
        let importados = 0;
        data.forEach(item => {
          let apuesta;
          const isInternal = ('liga' in item) && ('cuotaBookie' in item) && ('probabilidad' in item);
          if (isInternal) {
            apuesta = {
              id: item.id || Date.now() + Math.random(),
              fecha: item.fecha || new Date().toISOString(),
              liga: item.liga || 'Sin liga',
              local: item.local || '',
              visita: item.visita || '',
              mercado: item.mercado || '',
              probabilidad: Number(item.probabilidad) || 0,
              cuotaImplicita: item.cuotaImplicita !== undefined ? item.cuotaImplicita : (Number(item.probabilidad) ? Number((100/Number(item.probabilidad)).toFixed(2)) : ''),
              cuotaBookie: Number(item.cuotaBookie) || 0,
              ev: (typeof item.ev === 'number') ? item.ev : calcularEV(Number(item.probabilidad)||0, Number(item.cuotaBookie)||0),
              kellyFull: (typeof item.kellyFull === 'number') ? item.kellyFull : calcularKelly(Number(item.probabilidad)||0, Number(item.cuotaBookie)||0),
              bankroll: Number(item.bankroll) || (parseFloat(document.getElementById('bankroll').value)||100),
              kellyFrac: Number(item.kellyFrac) || (parseFloat(document.getElementById('kellyFrac').value)||0.25),
              estado: item.estado || 'pendiente'
            };
          } else {
            const rawDate = getVal(item, ['Date','Fecha']);
            const rawLeague = getVal(item, ['League','Liga']);
            const rawMatch  = getVal(item, ['Match','Partido']);
            const rawOutcome = getVal(item, ['Desired Outcome','Outcome','Mercado']);
            let prob = toNumber(getVal(item, ['Prob(%)','Prob','Probability','Probabilidad']));
            const implied = toNumber(getVal(item, ['Cuota Implícita','Cuota Implicita','Cuota Implcita','Implied Odds']));
            const odd = toNumber(getVal(item, ['Odd','Cuota','Cuota Bookie','Precio','Decimal Odds']));
            const result = getVal(item, ['Result','Estado','Resultado']);
            if (!(prob > 0) && implied > 0) prob = 100 / implied;
            const fechaISO = parseSpanishDate(rawDate).toISOString();
            const liga = (rawLeague ? String(rawLeague) : 'Sin liga').trim();
            const [local, visita] = splitMatch(rawMatch);
            const mercado = mapOutcome(rawOutcome);
            const bankrollActual = parseFloat(document.getElementById('bankroll').value) || 100;
            const kellyFracActual = parseFloat(document.getElementById('kellyFrac').value) || 0.25;
            const ev = calcularEV(prob, odd);
            const kellyFull = calcularKelly(prob, odd);
            apuesta = {
              id: Date.now() + Math.random(), fecha: fechaISO,
              liga, local, visita, mercado, probabilidad: prob > 0 ? prob : 0,
              cuotaImplicita: prob > 0 ? parseFloat((100/prob).toFixed(2)) : '',
              cuotaBookie: odd > 0 ? odd : 0, ev, kellyFull,
              bankroll: bankrollActual, kellyFrac: kellyFracActual,
              estado: mapEstado(result)
            };
          }
          historial.push(apuesta); importados++;
        });
        guardarHistorial(); actualizarVista();
        alert(`Importación exitosa ✅  Registros añadidos: ${importados}`);
        inputImportJSON.value = '';
      } catch (err) { console.error(err); alert('Error al importar el archivo JSON. Verifica el formato.'); }
    };
    reader.readAsText(file);
  });

  /* ==========================
     PERFILES: UI Y NAVEGACIÓN
     ========================== */
  function refreshPerfilSelect(){
    const list = ensureInitialProfiles();
    let p = getCurrentProfile();
    if (!list.includes(p)) { p = list[0]; setCurrentProfile(p); }
    perfil = p; migrateIfNeeded(perfil);
    selectPerfil.innerHTML = '';
    list.forEach(name=>{
      const opt = document.createElement('option');
      opt.value = name; opt.textContent = name; if (name === perfil) opt.selected = true;
      selectPerfil.appendChild(opt);
    });
    cargarHistorial();
    btnIrLigas.onclick = () => location.href = `historial_ligas.html?perfil=${encodeURIComponent(perfil)}`;
    btnIrEquiposRol.onclick = () => location.href = `historial_equipos_rol.html?perfil=${encodeURIComponent(perfil)}`;
    btnIrProbabilidades.onclick = () => location.href = `probabilidades.html?perfil=${encodeURIComponent(perfil)}`;
  }

  selectPerfil.addEventListener('change', ()=>{
    perfil = selectPerfil.value; setCurrentProfile(perfil); cargarHistorial(); actualizarVista();
    btnIrLigas.onclick = () => location.href = `historial_ligas.html?perfil=${encodeURIComponent(perfil)}`;
    btnIrEquiposRol.onclick = () => location.href = `historial_equipos_rol.html?perfil=${encodeURIComponent(perfil)}`;
    btnIrProbabilidades.onclick = () => location.href = `probabilidades.html?perfil=${encodeURIComponent(perfil)}`;
  });

  btnCrearPerfil.addEventListener('click', ()=>{
    const name = (inputNuevoPerfil.value || '').trim(); if (!name) { alert('Escribe un nombre para el nuevo perfil.'); return; }
    const list = getProfiles(); if (list.includes(name)) { alert('Ese perfil ya existe.'); return; }
    list.push(name); setProfiles(list); localStorage.setItem(dataKeyFor(name), '[]');
    selectPerfil.insertAdjacentHTML('beforeend', `<option value="${name}">${name}</option>`);
    selectPerfil.value = name; selectPerfil.dispatchEvent(new Event('change')); inputNuevoPerfil.value = '';
  });

  btnRenombrarPerfil.addEventListener('click', ()=>{
    const nuevo = prompt('Nuevo nombre para el perfil:', perfil); if (!nuevo) return;
    const list = getProfiles(); if (list.includes(nuevo) && nuevo !== perfil) { alert('Ya existe un perfil con ese nombre.'); return; }
    const oldKey = dataKeyFor(perfil), newKey = dataKeyFor(nuevo);
    const data = localStorage.getItem(oldKey) || '[]'; localStorage.setItem(newKey, data);
    if (nuevo !== perfil) localStorage.removeItem(oldKey);
    const idx = list.indexOf(perfil); if (idx >= 0) list[idx] = nuevo; else list.push(nuevo);
    setProfiles(list); perfil = nuevo; setCurrentProfile(perfil);
    refreshPerfilSelect(); actualizarVista();
  });

  btnBorrarPerfil.addEventListener('click', ()=>{
    const list = getProfiles(); if (list.length <= 1) { alert('Debe existir al menos un perfil.'); return; }
    if (!confirm(`¿Eliminar el perfil "${perfil}" y todos sus datos?`)) return;
    localStorage.removeItem(dataKeyFor(perfil));
    const nuevaLista = list.filter(x=>x!==perfil); setProfiles(nuevaLista);
    perfil = nuevaLista[0]; setCurrentProfile(perfil); refreshPerfilSelect(); actualizarVista();
  });

  /* ==========================
     INICIALIZACIÓN
     ========================== */
  function actualizarVista() {
    renderizarTabla();
    actualizarResumen();
    actualizarGraficas();
    if (panelSemana.style.display !== 'none') { renderAnalisisSemana(); } // si está abierto, refresca
  }

  function init() { refreshPerfilSelect(); actualizarVista(); }
  init();

  /* Stake preview */
  const cuotaBookieInput = document.getElementById('cuotaBookie');
  const bankrollInput = document.getElementById('bankroll');
  const kellyFracInput = document.getElementById('kellyFrac');
  const stakePreviewInput = document.getElementById('stakePreview');

  function actualizarStakePreview() {
    const prob = parseFloat(document.getElementById('probabilidad').value);
    const cuotaBookie = parseFloat(cuotaBookieInput.value);
    const bankroll = parseFloat(bankrollInput.value);
    const kellyFrac = parseFloat(kellyFracInput.value);
    if (!(prob > 0 && cuotaBookie > 1 && bankroll > 0 && kellyFrac > 0)) { stakePreviewInput.value = ""; return; }
    const kellyFull = calcularKelly(prob, cuotaBookie);
    const stake = stakeSugerido(bankroll, kellyFull, kellyFrac);
    stakePreviewInput.value = stake.toFixed(2);
  }
  document.getElementById('probabilidad').addEventListener('input', e => { cuotaImplicitaInput.value = calcularCuotaImplicita(parseFloat(e.target.value)); actualizarStakePreview(); });
  ['input','change'].forEach(evt => {
    cuotaBookieInput.addEventListener(evt, actualizarStakePreview);
    bankrollInput.addEventListener(evt, actualizarStakePreview);
    kellyFracInput.addEventListener(evt, actualizarStakePreview);
  });

  // Filtros listeners
  [filtroLiga, filtroLocal, filtroVisita, filtroMercado, filtroEstado,
   filtroProbMin, filtroProbMax, filtroFechaInicio, filtroFechaFin].forEach(el => {
    el.addEventListener('input', actualizarVista);
    el.addEventListener('change', actualizarVista);
  });
  btnLimpiarFiltros.addEventListener('click', e => { e.preventDefault(); limpiarFiltros(); actualizarVista(); });

})();
</script>
</body>
</html>
