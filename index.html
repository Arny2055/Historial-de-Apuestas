<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Poisson de Fútbol</title>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        select, button { padding: 10px; margin: 10px 0; width: 100%; border-radius: 5px; border: 1px solid #ccc; }
        button { background-color: #28a745; color: white; cursor: pointer; font-weight: bold; }
        .result { margin-top: 20px; padding: 15px; border-left: 5px solid #28a745; background: #e9f7ef; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Herramienta Poisson - Pronósticos</h2>
    
    <label>Selecciona la Liga:</label>
    <select id="liga" onchange="cargarEquipos()">
        <option value="ENG">Inglaterra - Premier League</option>
        <option value="ITA">Italia - Serie A</option>
        <option value="SPA">España - La Liga</option>
        <option value="FRA">Francia - Ligue 1</option>
        <option value="GER">Alemania - Bundesliga</option>
    </select>

    <div class="grid">
        <div>
            <label>Equipo Local:</label>
            <select id="local"></select>
        </div>
        <div>
            <label>Equipo Visitante:</label>
            <select id="visitante"></select>
        </div>
    </div>

    <button onclick="calcularPoisson()">Calcular xG y Probabilidades</button>

    <div id="resultado" class="result" style="display:none;"></div>
</div>

<script>
    google.charts.load('current', {'packages':['corechart']});

    const spreadsheetId = '1lmUPv7SP0XYi9ns4jkj3RTCScxIN2pCfBJyMUp_kNRI';
    let datosActuales = [];

    async function cargarEquipos() {
        const liga = document.getElementById('liga').value;
        const query = encodeURIComponent('SELECT A, E, F, J, N, O'); // Columnas: Equipo, GF_L, GC_L, Equipo_V, GF_V, GC_V
        const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?sheet=${liga}&tq=${query}`;

        fetch(url)
            .then(res => res.text())
            .then(text => {
                const data = JSON.parse(text.substr(47).slice(0, -2));
                datosActuales = data.table.rows;
                
                const localSelect = document.getElementById('local');
                const visitaSelect = document.getElementById('visitante');
                localSelect.innerHTML = "";
                visitaSelect.innerHTML = "";

                datosActuales.forEach((row, index) => {
                    if (row.c[1]) { // Si hay datos de goles
                        let nombre = row.c[1].v; // Ajustar según índice real del nombre en tu sheet
                        let option = `<option value="${index}">${row.c[1].v}</option>`;
                        localSelect.innerHTML += option;
                        visitaSelect.innerHTML += option;
                    }
                });
            });
    }

    function calcularPoisson() {
        const idxL = document.getElementById('local').value;
        const idxV = document.getElementById('visitante').value;
        
        // --- Lógica solicitada ---
        // 1. Promedios de la Liga (Simulados basados en tus tablas)
        // Nota: En una versión pro, sumarías toda la columna. Aquí usamos promedios estándar.
        const avgGfLiga = 1.5; 
        const avgGcLiga = 1.5;

        [span_1](start_span)// 2. Datos de los equipos seleccionados[span_1](end_span)
        const dataL = datosActuales[idxL].c;
        const dataV = datosActuales[idxV].c;

        const gfLocal = dataL[4].v / dataL[2].v; // GF / GP Local
        const gcLocal = dataL[5].v / dataL[2].v; // GC / GP Local
        const gfVisita = dataV[13].v / dataV[11].v; // GF / GP Visita (Ajustar índices según tu sheet)
        const gcVisita = dataV[14].v / dataV[11].v; // GC / GP Visita

        // 3. Cálculo de Fuerzas
        const fuerzaAtaqueLocal = gfLocal / avgGfLiga;
        const fuerzaDefensaLocal = gcLocal / avgGcLiga;
        const fuerzaAtaqueVisita = gfVisita / avgGfLiga;
        const fuerzaDefensaVisita = gcVisita / avgGcLiga;

        // 4. Cálculo de xG (Expectativa de Goles)
        // Local xG = Ataque Local * Defensa Visita * Promedio Liga
        const xGLocal = fuerzaAtaqueLocal * fuerzaDefensaVisita * avgGfLiga;
        // Visita xG = Ataque Visita * Defensa Local * Promedio Liga
        const xGVisita = fuerzaAtaqueVisita * fuerzaDefensaLocal * avgGfLiga;

        mostrarResultados(xGLocal, xGVisita);
    }

    function mostrarResultados(lg, vg) {
        const div = document.getElementById('resultado');
        div.style.display = "block";
        div.innerHTML = `
            <strong>Resultados Estimados:</strong><br>
            xG Local: ${lg.toFixed(2)} goles<br>
            xG Visitante: ${vg.toFixed(2)} goles<br><br>
            [span_2](start_span)<em>Cálculo basado en promedios de ataque y defensa por liga[span_2](end_span).</em>
        `;
    }

    // Carga inicial
    google.charts.setOnLoadCallback(cargarEquipos);
</script>

</body>
</html>