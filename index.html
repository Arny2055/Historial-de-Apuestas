<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poisson Pro - Matriz de Over/Under</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 20px; color: #333; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: #1a73e8; border-bottom: 2px solid #e8f0fe; padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .full-width { grid-column: 1 / span 2; }
        label { font-weight: 600; margin-bottom: 8px; display: block; }
        textarea { width: 100%; height: 100px; border: 1px solid #ddd; border-radius: 6px; padding: 10px; font-size: 13px; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        button { width: 100%; padding: 15px; background-color: #1a73e8; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; }
        button:hover { background-color: #1557b0; }
        
        .match-card { border: 1px solid #e0e0e0; padding: 20px; margin-top: 20px; border-radius: 10px; background: #fff; }
        .match-header { font-size: 1.2em; font-weight: bold; color: #1a73e8; margin-bottom: 15px; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .tables-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
        th { background: #f8f9fa; color: #555; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: center; }
        
        .over-highlight { background-color: #e6f4ea; font-weight: bold; color: #1e8e3e; }
        .under-highlight { background-color: #fce8e6; font-weight: bold; color: #d93025; }
    </style>
</head>
<body>

<div class="container">
    <h1>Herramienta Poisson & Over/Under</h1>
    
    <div class="grid">
        <div class="full-width">
            <label>Próximos Partidos:</label>
            <textarea id="matchesInput" placeholder="Fri 26 Dec Manchester Utd 14:00 Newcastle Utd..."></textarea>
        </div>
        <div>
            <label>Estadística Local:</label>
            <textarea id="homeStatsInput"></textarea>
        </div>
        <div>
            <label>Estadística Visitante:</label>
            <textarea id="awayStatsInput"></textarea>
        </div>
        <div>
            <label>Goles Promedio Local:</label>
            <input type="number" id="avgHomeGoals" step="0.01" value="1.61">
        </div>
        <div>
            <label>Goles Promedio Visita:</label>
            <input type="number" id="avgAwayGoals" step="0.01" value="1.22">
        </div>
    </div>

    <button onclick="calculatePoisson()">GENERAR ANÁLISIS</button>

    <div id="results"></div>
</div>

<script>
    function factorial(n) {
        let res = 1;
        for (let i = 2; i <= n; i++) res *= i;
        return res;
    }

    function poissonProb(lambda, x) {
        return (Math.exp(-lambda) * Math.pow(lambda, x)) / factorial(x);
    }

    function parseStats(text) {
        const stats = {};
        const lines = text.split('\n');
        lines.forEach(line => {
            const parts = line.trim().split(/\t|\s{2,}/);
            if (parts.length >= 7) {
                const teamName = parts[1].trim();
                stats[teamName] = { pj: parseFloat(parts[2]), gf: parseFloat(parts[6]), gc: parseFloat(parts[7]) };
            }
        });
        return stats;
    }

    function calculatePoisson() {
        const matchesText = document.getElementById('matchesInput').value.trim();
        const homeStats = parseStats(document.getElementById('homeStatsInput').value);
        const awayStats = parseStats(document.getElementById('awayStatsInput').value);
        const leagueAvgHome = parseFloat(document.getElementById('avgHomeGoals').value);
        const leagueAvgAway = parseFloat(document.getElementById('avgAwayGoals').value);

        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';

        matchesText.split('\n').forEach(line => {
            const parts = line.split(/\t|\s{2,}/);
            if (parts.length < 4) return;

            const homeTeam = parts[1].trim();
            const awayTeam = parts[3].trim();

            if (homeStats[homeTeam] && awayStats[awayTeam]) {
                const h = homeStats[homeTeam], a = awayStats[awayTeam];
                
                const lH = (h.gf/h.pj/leagueAvgHome) * (a.gc/a.pj/leagueAvgAway) * leagueAvgHome;
                const lA = (a.gf/a.pj/leagueAvgAway) * (h.gc/h.pj/leagueAvgHome) * leagueAvgAway;

                processMatch(homeTeam, awayTeam, lH, lA, resultsDiv);
            }
        });
    }

    function processMatch(home, away, lH, lA, container) {
        let matrix = [];
        let totalGoalsProb = { 0.5: 0, 1.5: 0, 2.5: 0, 3.5: 0 };
        
        // Generar matriz 6x6 para precisión
        for (let i = 0; i <= 6; i++) {
            for (let j = 0; j <= 6; j++) {
                const prob = poissonProb(lH, i) * poissonProb(lA, j);
                const totalG = i + j;
                if (totalG > 0.5) totalGoalsProb[0.5] += prob;
                if (totalG > 1.5) totalGoalsProb[1.5] += prob;
                if (totalG > 2.5) totalGoalsProb[2.5] += prob;
                if (totalG > 3.5) totalGoalsProb[3.5] += prob;
            }
        }

        const card = document.createElement('div');
        card.className = 'match-card';
        card.innerHTML = `
            <div class="match-header">
                <span>${home} vs ${away}</span>
                <span>xG Total: ${(lH + lA).toFixed(2)}</span>
            </div>
            <div class="tables-container">
                <div>
                    <strong>Probabilidades Over/Under</strong>
                    <table>
                        <tr><th>Mercado</th><th>Over (+)</th><th>Under (-)</th></tr>
                        <tr><td>0.5 Goles</td><td class="over-highlight">${(totalGoalsProb[0.5]*100).toFixed(1)}%</td><td>${((1-totalGoalsProb[0.5])*100).toFixed(1)}%</td></tr>
                        <tr><td>1.5 Goles</td><td class="over-highlight">${(totalGoalsProb[1.5]*100).toFixed(1)}%</td><td>${((1-totalGoalsProb[1.5])*100).toFixed(1)}%</td></tr>
                        <tr><td>2.5 Goles</td><td class="over-highlight">${(totalGoalsProb[2.5]*100).toFixed(1)}%</td><td>${((1-totalGoalsProb[2.5])*100).toFixed(1)}%</td></tr>
                        <tr><td>3.5 Goles</td><td class="over-highlight">${(totalGoalsProb[3.5]*100).toFixed(1)}%</td><td>${((1-totalGoalsProb[3.5])*100).toFixed(1)}%</td></tr>
                    </table>
                </div>
                <div>
                    <strong>Probabilidad de Goles Individual</strong>
                    <table>
                        <tr><th>Goles</th><th>${home} (L)</th><th>${away} (V)</th></tr>
                        ${[0,1,2,3].map(g => `
                            <tr>
                                <td>${g}</td>
                                <td>${(poissonProb(lH, g)*100).toFixed(1)}%</td>
                                <td>${(poissonProb(lA, g)*100).toFixed(1)}%</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            </div>
        `;
        container.appendChild(card);
    }
</script>

</body>
</html>
