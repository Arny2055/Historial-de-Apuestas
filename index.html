<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta Poisson Fútbol</title>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f0f2f5; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { color: #1a73e8; text-align: center; }
        .selector-group { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .selector-item { flex: 1; min-width: 250px; }
        select, button { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; margin-top: 5px; }
        button { background-color: #1a73e8; color: white; border: none; cursor: pointer; font-weight: bold; transition: background 0.3s; margin-top: 20px;}
        button:hover { background-color: #1557b0; }
        .result-card { margin-top: 30px; display: none; padding: 20px; border-radius: 8px; background-color: #f8f9fa; border: 1px solid #e1e4e8; }
        .xg-badge { font-size: 24px; font-weight: bold; color: #d93025; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .league-avg { font-size: 0.9em; color: #666; text-align: center; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Calculadora de Probabilidades Poisson</h2>
    [span_1](start_span)<p class="league-avg">Los datos se extraen automáticamente de "Tablas Poisson"[span_1](end_span)</p>
    
    <div class="selector-item">
        <label>Seleccionar Liga:</label>
        <select id="liga" onchange="fetchData()">
            <option value="ENG">Inglaterra - Premier League</option>
            <option value="ITA">Italia - Serie A</option>
            <option value="SPA">España - La Liga</option>
            <option value="FRA">Francia - Ligue 1</option>
            <option value="GER">Alemania - Bundesliga</option>
        </select>
    </div>

    <div class="selector-group" style="margin-top:20px;">
        <div class="selector-item">
            <label>Equipo Local (Columna B):</label>
            <select id="local"></select>
        </div>
        <div class="selector-item">
            <label>Equipo Visitante (Columna N):</label>
            <select id="visitante"></select>
        </div>
    </div>

    <button onclick="calcularPoisson()">GENERAR PRONÓSTICO</button>

    <div id="resultado" class="result-card">
        <div class="stats-grid">
            <div style="text-align: center;">
                <div id="nombreLocal" style="font-weight: bold; margin-bottom: 5px;">LOCAL</div>
                <div id="xgL" class="xg-badge">0.00</div>
                <div>xG Esperado</div>
            </div>
            <div style="text-align: center;">
                <div id="nombreVisita" style="font-weight: bold; margin-bottom: 5px;">VISITANTE</div>
                <div id="xgV" class="xg-badge">0.00</div>
                <div>xG Esperado</div>
            </div>
        </div>
    </div>
</div>

<script>
    const sheetId = '1lmUPv7SP0XYi9ns4jkj3RTCScxIN2pCfBJyMUp_kNRI';
    let rawData = [];
    let avgGfLiga = 0;

    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(fetchData);

    async function fetchData() {
        const league = document.getElementById('liga').value;
        // B=Local, F=GF_L, G=GC_L, N=Visita, R=GF_V, S=GC_V (basado en estructura común)
        const query = encodeURIComponent('SELECT B, F, G, N, R, S OFFSET 2'); 
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${league}&tq=${query}`;

        try {
            const response = await fetch(url);
            const text = await response.text();
            const data = JSON.parse(text.substr(47).slice(0, -2));
            rawData = data.table.rows.filter(r => r.c[0] && r.c[3]); // Filtrar filas vacías

            const localSel = document.getElementById('local');
            const visitaSel = document.getElementById('visitante');
            localSel.innerHTML = ""; visitaSel.innerHTML = "";

            let totalGoles = 0;
            let totalPartidos = 0;

            rawData.forEach((row, i) => {
                localSel.innerHTML += `<option value="${i}">${row.c[0].v}</option>`;
                visitaSel.innerHTML += `<option value="${i}">${row.c[3].v}</option>`;
                
                // Cálculo de promedio de liga para GF/GC
                totalGoles += (row.c[1].v + row.c[4].v);
                totalPartidos += 2; // (Estimación simplificada)
            });

            avgGfLiga = totalGoles / totalPartidos;

        } catch (e) { console.error("Error cargando datos", e); }
    }

    function calcularPoisson() {
        const localIdx = document.getElementById('local').value;
        const visitaIdx = document.getElementById('visitante').value;

        const rowL = rawData[localIdx].c;
        const rowV = rawData[visitaIdx].c;

        // Fórmulas solicitadas por el usuario:
        // 1. Promedio goles favor local / promedio liga
        const fuerzaAtaqueLocal = (rowL[1].v / 14) / avgGfLiga; // asumiendo 14 partidos jugados
        // 2. Promedio goles contra local / promedio liga
        const fuerzaDefensaLocal = (rowL[2].v / 14) / avgGfLiga;

        // 3. Visitante
        const fuerzaAtaqueVisita = (rowV[4].v / 14) / avgGfLiga;
        const fuerzaDefensaVisita = (rowV[5].v / 14) / avgGfLiga;

        // Cálculo xG Local: (Ataque Local / Liga) * (Defensa Visita / Liga) * Promedio Liga
        const xGLocal = fuerzaAtaqueLocal * fuerzaDefensaVisita * avgGfLiga;
        
        // Cálculo xG Visita: (Ataque Visita / Liga) * (Defensa Local / Liga) * Promedio Liga
        const xGVisita = fuerzaAtaqueVisita * fuerzaDefensaLocal * avgGfLiga;

        // Mostrar Resultados
        document.getElementById('nombreLocal').innerText = rowL[0].v;
        document.getElementById('nombreVisita').innerText = rowV[3].v;
        document.getElementById('xgL').innerText = xGLocal.toFixed(2);
        document.getElementById('xgV').innerText = xGVisita.toFixed(2);
        document.getElementById('resultado').style.display = "block";
    }
</script>

</body>
</html>
