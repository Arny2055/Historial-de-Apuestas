<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BETAGS - Deep Analytics</title>
    <style>
        :root {
            --bg-dark: #0b0e14;
            --bg-card: #151921;
            --primary: #4dabf7;
            --accent-green: #51cf66;
            --accent-red: #ff6b6b;
            --accent-yellow: #fcc419;
            --text-white: #e9ecef;
            --text-muted: #adb5bd;
            --border: #2c3440;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-white);
            margin: 0;
            padding: 0;
            display: flex; 
            justify-content: center;
            min-height: 100vh;
            text-align: center;
        }

        .container { 
            width: 100%; 
            max-width: 100%; 
            padding: 15px; 
            box-sizing: border-box;
            padding-bottom: 40px;
        }

        h1 { font-size: 1.4rem; color: var(--primary); text-align: center; margin: 20px 0; letter-spacing: 3px; font-weight: 900; }
        h1 span { color: var(--text-white); }

        .nav-header {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn-nav-roi, .btn-nav-xg {
            background: rgba(77, 171, 247, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 8px 15px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-nav-xg {
            border-color: var(--accent-green);
            color: var(--accent-green);
            background: rgba(81, 207, 102, 0.1);
        }

        .section-title { 
            font-size: 0.7rem; 
            color: var(--primary); 
            text-transform: uppercase; 
            margin-bottom: 12px; 
            display: flex; 
            justify-content: center;
            align-items: center; 
            gap: 8px; 
            font-weight: bold; 
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-grid { width: 100%; display: grid; grid-template-columns: 1fr; gap: 12px; }
        
        select, .input-new-sheet { 
            width: 100%; 
            padding: 14px; 
            border-radius: 10px; 
            border: 1px solid var(--border); 
            background: #0b0e14;
            color: white;
            font-size: 1rem;
            outline: none;
            text-align: center;
            box-sizing: border-box;
        }

        .add-league-box {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .btn-add-sheet {
            background: var(--primary);
            color: var(--bg-dark);
            border: none;
            padding: 0 15px;
            border-radius: 8px;
            font-weight: 900;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .btn-delete-sheet {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
            padding: 0 12px;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn-analyze-day {
            width: 100%;
            background: linear-gradient(90deg, #4dabf7, #339af0);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-weight: 900;
            font-size: 0.8rem;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(77, 171, 247, 0.3);
        }

        /* Tablas de resultados extendidas */
        .table-wrapper { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; }
        th { padding: 10px 4px; color: var(--text-muted); border-bottom: 1px solid var(--border); text-transform: uppercase; font-size: 0.55rem; }
        td { padding: 10px 4px; border-bottom: 1px solid var(--border); }

        .input-odds-small {
            width: 40px;
            background: #0b0e14;
            border: 1px solid var(--border);
            color: var(--accent-yellow);
            padding: 4px;
            border-radius: 4px;
            font-size: 0.7rem;
            text-align: center;
        }

        .value-badge {
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 900;
            font-size: 0.6rem;
        }
        .positive-value { background: rgba(81, 207, 102, 0.2); color: var(--accent-green); }
        .negative-value { background: rgba(255, 107, 107, 0.15); color: var(--accent-red); }

        .btn-send-small {
            background: var(--primary);
            color: var(--bg-dark);
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 800;
            cursor: pointer;
        }

        .league-tag {
            font-size: 0.6rem;
            background: rgba(77, 171, 247, 0.2);
            color: var(--primary);
            padding: 2px 5px;
            border-radius: 4px;
            display: block;
            margin-bottom: 2px;
        }

        #poissonResultsPanel { display: none; width: 100%; margin-top: 10px; }
        .loading-text { color: var(--primary); text-align: center; font-size: 0.9rem; display: none; margin-top: 30px; font-weight: bold; }
        #xgPanel { display: none; width: 100%; }

        .chart-container { width: 100%; height: 120px; display: flex; align-items: flex-end; justify-content: space-around; margin: 10px 0; }
        .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .bar { width: 80%; background: var(--primary); border-radius: 2px 2px 0 0; min-height: 1px; }
        .bar.away { background: var(--accent-green); }
    </style>
</head>
<body>

<div class="container">
    <h1>BETA<span>GS</span> ANALYTICS</h1>
    
    <div class="nav-header">
        <a href="roi2.html" class="btn-nav-roi"><span>üßÆ</span> ROI CALC</a>
        <a href="xg.html" class="btn-nav-xg"><span>‚öΩ</span> XG ANALYTICS</a>
    </div>

    <div class="section-title"><span>üìä</span> CONFIGURACI√ìN</div>
    <div class="card">
        <div class="input-grid">
            <select id="leagueSelect" onchange="cargarDatosLiga()"></select>
            <div class="add-league-box">
                <input type="text" id="newSheetName" class="input-new-sheet" placeholder="NUEVA HOJA...">
                <button class="btn-add-sheet" onclick="agregarNuevaLiga()">A√ëADIR</button>
                <button class="btn-delete-sheet" onclick="borrarLigaSeleccionada()">üóëÔ∏è</button>
            </div>
            <button class="btn-analyze-day" onclick="analizarTodaLaJornada()">
                üöÄ ANALIZAR TODOS LOS PARTIDOS (FULL SCAN)
            </button>
        </div>
    </div>

    <div id="loading" class="loading-text">ESCANEANDO TODAS LAS LIGAS...</div>

    <div id="poissonResultsPanel">
        <div class="section-title"><span>üìÖ</span> VALOR DETECTADO EN JORNADA</div>
        <div class="card" style="padding: 10px 2px;">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>PARTIDO</th>
                            <th>O/U 2.5</th>
                            <th>BTTS Y/N</th>
                            <th>xG L/V</th>
                            <th>CUOTA</th>
                            <th>VALOR</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="poissonItemsContainer"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="xgPanel">
        <div class="section-title"><span>üìà</span> AN√ÅLISIS INDIVIDUAL</div>
        <div class="card">
            <select id="homeTeamSelect" onchange="calcularXG()" style="margin-bottom:10px"></select>
            <select id="awayTeamSelect" onchange="calcularXG()"></select>
            <div class="chart-container" id="golesChart"></div>
            <div id="xg_local_val" style="display:none"></div>
            <div id="xg_away_val" style="display:none"></div>
        </div>
        <div id="individualMarkets">
             <div class="card"><div class="table-wrapper"><table><tbody id="marketsTable"></tbody></table></div></div>
        </div>
    </div>
</div>

<script>
    const DEFAULT_ID = '1lmUPv7SP0XYi9ns4jkj3RTCScxIN2pCfBJyMUp_kNRI';
    let leaguesData = {}; // Almacena data de todas las ligas
    let matchesDetected = [];

    function getSavedLeagues() {
        const saved = localStorage.getItem('betags_custom_leagues');
        return saved ? JSON.parse(saved) : [];
    }

    function renderLeagueSelect() {
        const select = document.getElementById('leagueSelect');
        const leagues = getSavedLeagues();
        select.innerHTML = leagues.map(l => `<option value="${l.sheet}">${l.name}</option>`).join('');
    }

    // L√≥gica Matem√°tica
    function poisson(k, lambda) { return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k); }
    function factorial(n) { if (n === 0) return 1; let res = 1; for (let i = 1; i <= n; i++) res *= i; return res; }

    // Funci√≥n Principal Mejorada: Analiza TODAS las ligas
    async function analizarTodaLaJornada() {
        const loading = document.getElementById('loading');
        const resultsPanel = document.getElementById('poissonResultsPanel');
        const container = document.getElementById('poissonItemsContainer');
        const leagues = getSavedLeagues();

        if (leagues.length === 0) return alert("No hay ligas configuradas.");

        loading.style.display = 'block';
        resultsPanel.style.display = 'none';
        container.innerHTML = '';
        matchesDetected = [];

        try {
            // 1. Obtener partidos del d√≠a
            const urlDaily = `https://docs.google.com/spreadsheets/d/${DEFAULT_ID}/gviz/tq?tqx=out:csv&sheet=PARTIDOS+DEL+DIA&range=D1:F100`;
            const respDaily = await fetch(urlDaily);
            const csvDaily = await respDaily.text();
            const dailyMatches = csvDaily.split('\n').map(l => l.split(',').map(c => c.replace(/"/g, '').trim()));

            // 2. Escanear cada liga guardada
            for (let league of leagues) {
                const urlLeague = `https://docs.google.com/spreadsheets/d/${DEFAULT_ID}/gviz/tq?tqx=out:csv&sheet=${league.sheet}&range=A1:W50`;
                const respL = await fetch(urlLeague);
                const csvL = await respL.text();
                const rows = csvL.split('\n').map(l => l.split(',').map(c => c.replace(/"/g, '').trim()));

                let leagueStats = { locales: [], visitantes: [], global: {} };
                let sGFL = 0, sGAL = 0, sPJL = 0, sGFV = 0, sGAV = 0, sPJV = 0;

                rows.forEach((cols, idx) => {
                    if (idx > 0 && cols[1] && !isNaN(parseFloat(cols[2]))) {
                        leagueStats.locales.push({ n: cols[1], gp: parseFloat(cols[2]), gf: parseFloat(cols[6]), ga: parseFloat(cols[7]) });
                        leagueStats.visitantes.push({ n: cols[13], gp: parseFloat(cols[14]), gf: parseFloat(cols[18]), ga: parseFloat(cols[19]) });
                        sGFL += parseFloat(cols[6]); sGAL += parseFloat(cols[7]); sPJL += parseFloat(cols[2]);
                        sGFV += parseFloat(cols[18]); sGAV += parseFloat(cols[19]); sPJV += parseFloat(cols[14]);
                    }
                });

                leagueStats.global = { gfl: sGFL/sPJL, gal: sGAL/sPJL, gfv: sGFV/sPJV, gav: sGAV/sPJV };

                // 3. Cruzar con partidos del d√≠a
                dailyMatches.forEach(m => {
                    const hName = m[0], vName = m[2];
                    const lData = leagueStats.locales.find(e => e.n.toUpperCase() === hName?.toUpperCase());
                    const vData = leagueStats.visitantes.find(e => e.n.toUpperCase() === vName?.toUpperCase());

                    if (lData && vData) {
                        const xGL = (lData.gf/lData.gp/leagueStats.global.gfl) * (vData.ga/vData.gp/leagueStats.global.gav) * leagueStats.global.gfl;
                        const xGV = (vData.gf/vData.gp/leagueStats.global.gfv) * (lData.ga/lData.gp/leagueStats.global.gal) * leagueStats.global.gfv;
                        
                        let pL = [], pV = [];
                        for(let i=0; i<=6; i++) { pL[i] = poisson(i, xGL); pV[i] = poisson(i, xGV); }
                        let u25 = 0;
                        for(let i=0; i<=2; i++) for(let j=0; j<=2; j++) if(i+j <= 2) u25 += pL[i]*pV[j];
                        const bttsY = 1 - (pL[0] + pV[0] - (pL[0]*pV[0]));

                        renderMatchRow(league.name, hName, vName, 1-u25, bttsY, xGL, xGV);
                    }
                });
            }

            resultsPanel.style.display = 'block';
        } catch (e) {
            console.error(e);
            alert("Error al procesar los datos.");
        } finally {
            loading.style.display = 'none';
        }
    }

    function renderMatchRow(liga, local, visita, ov25, btts, xgl, xgv) {
        const container = document.getElementById('poissonItemsContainer');
        const id = Date.now() + Math.random();
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="text-align:left">
                <span class="league-tag">${liga}</span>
                <strong>${local} vs ${visita}</strong>
            </td>
            <td><span style="color:var(--primary)">${(ov25*100).toFixed(0)}%</span></td>
            <td><span style="color:var(--accent-green)">${(btts*100).toFixed(0)}%</span></td>
            <td style="font-family:monospace">${xgl.toFixed(1)}|${xgv.toFixed(1)}</td>
            <td><input type="number" class="input-odds-small" id="odd_${id}" placeholder="1.90" oninput="checkValue('${id}', ${ov25})"></td>
            <td id="val_${id}">--</td>
            <td><button class="btn-send-small" onclick="sendToROI_FromList('${liga}', '${local}', '${visita}', ${ov25}, '${id}')">SEND</button></td>
        `;
        container.appendChild(tr);
    }

    function checkValue(id, prob) {
        const odd = parseFloat(document.getElementById(`odd_${id}`).value);
        const cell = document.getElementById(`val_${id}`);
        if (!odd || odd <= 1) { cell.innerHTML = '--'; return; }
        const edge = (prob * odd) - 1;
        const color = edge > 0 ? 'positive-value' : 'negative-value';
        cell.innerHTML = `<span class="value-badge ${color}">${(edge*100).toFixed(1)}%</span>`;
    }

    function sendToROI_FromList(liga, h, v, prob, id) {
        const odd = parseFloat(document.getElementById(`odd_${id}`).value);
        if (!odd) return alert("Pon una cuota primero");

        const pick = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            teams: `${liga}: ${h} vs ${v}`,
            market: 'OVER 2.5 FT',
            prob: prob,
            fair_odd: (1/prob).toFixed(2),
            odd: odd,
            edge: ((prob * odd - 1) * 100).toFixed(1) + '%',
            stake: 1,
            status: 'pending'
        };

        let current = JSON.parse(localStorage.getItem('betags_pre_match')) || [];
        current.push(pick);
        localStorage.setItem('betags_pre_match', JSON.stringify(current));
        alert("¬°Enviado a ROI!");
    }

    // --- FUNCIONES EXISTENTES (Mantenidas sin borrar) ---
    async function cargarDatosLiga() {
        const sheetKey = document.getElementById('leagueSelect').value;
        if (!sheetKey) return;
        const url = `https://docs.google.com/spreadsheets/d/${DEFAULT_ID}/gviz/tq?tqx=out:csv&sheet=${sheetKey}&range=A1:W50`;
        const response = await fetch(url);
        const csvText = await response.text();
        const filas = csvText.split('\n').map(linea => linea.split(',').map(celda => celda.replace(/"/g, '').trim()));
        
        let localArr = [], visitArr = [];
        filas.forEach((cols, index) => {
            if (index > 0 && cols[1] && !isNaN(parseFloat(cols[2]))) {
                localArr.push({ nombre: cols[1], gp: parseFloat(cols[2]), gf: parseFloat(cols[6]), ga: parseFloat(cols[7]) });
                visitArr.push({ nombre: cols[13], gp: parseFloat(cols[14]), gf: parseFloat(cols[18]), ga: parseFloat(cols[19]) });
            }
        });

        // Actualizar selectores
        const hS = document.getElementById('homeTeamSelect');
        const aS = document.getElementById('awayTeamSelect');
        hS.innerHTML = '<option value="">LOCAL...</option>';
        aS.innerHTML = '<option value="">VISITA...</option>';
        localArr.map(e => e.nombre).sort().forEach(n => {
            hS.options.add(new Option(n, n));
            aS.options.add(new Option(n, n));
        });
        
        window.currentLeagueData = { locales: localArr, visitantes: visitArr };
        document.getElementById('xgPanel').style.display = 'block';
    }

    function agregarNuevaLiga() {
        const input = document.getElementById('newSheetName');
        let name = input.value.trim().toUpperCase();
        if (!name) return;
        let leagues = getSavedLeagues();
        leagues.push({ name: name, sheet: name });
        localStorage.setItem('betags_custom_leagues', JSON.stringify(leagues));
        renderLeagueSelect();
        input.value = "";
    }

    function borrarLigaSeleccionada() {
        const val = document.getElementById('leagueSelect').value;
        let leagues = getSavedLeagues().filter(l => l.sheet !== val);
        localStorage.setItem('betags_custom_leagues', JSON.stringify(leagues));
        renderLeagueSelect();
    }

    window.onload = () => { renderLeagueSelect(); };
</script>
</body>
</html>
