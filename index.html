<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetAGS - Poisson Pro & Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .bg-bet-green { background-color: #006341; }
        .text-bet-yellow { color: #ffeb00; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <nav class="bg-bet-green text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold italic">Bet<span class="text-bet-yellow">AGS</span></h1>
            <div class="space-x-4">
                <button onclick="showTab('calc')" class="hover:text-bet-yellow font-semibold">Calculadora</button>
                <button onclick="showTab('control')" class="hover:text-bet-yellow font-semibold">Control de Gestión</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4">
        
        <div id="calc" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">Datos del Encuentro</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold">Local (GF Promedio)</label>
                            <input type="number" id="home_gf_avg" step="0.01" class="w-full border p-2 rounded" placeholder="Ej: 2.50">
                        </div>
                        <div>
                            <label class="block text-sm font-bold">Local (GC Promedio)</label>
                            <input type="number" id="home_gc_avg" step="0.01" class="w-full border p-2 rounded" placeholder="Ej: 1.50">
                        </div>
                        <div>
                            <label class="block text-sm font-bold">Visitante (GF Promedio)</label>
                            <input type="number" id="away_gf_avg" step="0.01" class="w-full border p-2 rounded" placeholder="Ej: 1.75">
                        </div>
                        <div>
                            <label class="block text-sm font-bold">Visitante (GC Promedio)</label>
                            <input type="number" id="away_gc_avg" step="0.01" class="w-full border p-2 rounded" placeholder="Ej: 1.13">
                        </div>
                    </div>
                    <button onclick="calcularPoisson()" class="mt-4 w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold">CALCULAR XG & PROBABILIDADES</button>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">Cuotas de la Casa de Apuestas</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm">Cuota Over 2.5</label>
                            <input type="number" id="odds_over" step="0.01" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm">Cuota Under 2.5</label>
                            <input type="number" id="odds_under" step="0.01" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm">Cuota BTTS Sí</label>
                            <input type="number" id="odds_btts_yes" step="0.01" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm">Cuota BTTS No</label>
                            <input type="number" id="odds_btts_no" step="0.01" class="w-full border p-2 rounded">
                        </div>
                    </div>
                </div>
            </div>

            <div id="results_area" class="mt-6 hidden">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4 text-center">Resultados de Poisson</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="p-2 border">Mercado</th>
                                    <th class="p-2 border">Prob %</th>
                                    <th class="p-2 border">Cuota Justa</th>
                                    <th class="p-2 border">Edge %</th>
                                    <th class="p-2 border">Stake Sugerido</th>
                                    <th class="p-2 border">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="table_body">
                                </tbody>
                        </table>
                    </div>
                    <div id="overround_info" class="mt-4 text-sm font-semibold"></div>
                </div>
            </div>
        </div>

        <div id="control" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h2 class="text-2xl font-bold mb-4">Dashboard de Rendimiento</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-500">Apuestas</p>
                        <p id="stat_count" class="text-xl font-bold">0</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-500">Profit</p>
                        <p id="stat_profit" class="text-xl font-bold text-green-600">$0.00</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-500">Yield</p>
                        <p id="stat_yield" class="text-xl font-bold">0%</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-500">ROI</p>
                        <p id="stat_roi" class="text-xl font-bold">0%</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-500">P-Value</p>
                        <p id="stat_pvalue" class="text-xl font-bold">0.000</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-800 text-white">
                            <th class="p-2">Fecha</th>
                            <th class="p-2">Mercado</th>
                            <th class="p-2">Cuota</th>
                            <th class="p-2">Stake</th>
                            <th class="p-2">Edge</th>
                            <th class="p-2">Overround</th>
                            <th class="p-2">CLV</th>
                            <th class="p-2">Resultado</th>
                            <th class="p-2">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="control_table_body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configuración Liga (Promedios según tu tabla)
        const LEAGUE_HOME_AVG = 1.81;
        const LEAGUE_AWAY_AVG = 1.45;
        const BANKROLL_BASE = 100;

        let bets = JSON.parse(localStorage.getItem('bets')) || [];

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(tabId === 'control') updateControlTable();
        }

        function factorial(n) {
            return n <= 1 ? 1 : n * factorial(n - 1);
        }

        function poisson(k, lambda) {
            return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
        }

        function calcularPoisson() {
            const h_gf = parseFloat(document.getElementById('home_gf_avg').value);
            const h_gc = parseFloat(document.getElementById('home_gc_avg').value);
            const a_gf = parseFloat(document.getElementById('away_gf_avg').value);
            const a_gc = parseFloat(document.getElementById('away_gc_avg').value);

            if (!h_gf || !h_gc || !a_gf || !a_gc) return alert("Completa los datos de goles");

            // Fuerza de Ataque y Defensa
            const home_attack = h_gf / LEAGUE_HOME_AVG;
            const home_defense = h_gc / LEAGUE_AWAY_AVG;
            const away_attack = a_gf / LEAGUE_AWAY_AVG;
            const away_defense = a_gc / LEAGUE_HOME_AVG;

            // xG proyectados
            const home_xg = home_attack * away_defense * LEAGUE_HOME_AVG;
            const away_xg = away_attack * home_defense * LEAGUE_AWAY_AVG;

            // Probabilidades de goles exactos (0 a 5)
            let prob_home = [], prob_away = [];
            for (let i = 0; i <= 10; i++) {
                prob_home.push(poisson(i, home_xg));
                prob_away.push(poisson(i, away_xg));
            }

            // 1. Over/Under 2.5
            let prob_u25 = 0;
            for (let h = 0; h <= 2; h++) {
                for (let a = 0; a <= (2 - h); a++) {
                    prob_u25 += prob_home[h] * prob_away[a];
                }
            }
            let prob_o25 = 1 - prob_u25;

            // 2. BTTS
            let prob_home_0 = prob_home[0];
            let prob_away_0 = prob_away[0];
            let prob_btts_yes = (1 - prob_home_0) * (1 - prob_away_0);
            let prob_btts_no = 1 - prob_btts_yes;

            renderTable(prob_o25, prob_u25, prob_btts_yes, prob_btts_no);
        }

        function renderTable(po25, pu25, pby, pbn) {
            const results = [
                { name: 'Over 2.5', prob: po25, odds_id: 'odds_over' },
                { name: 'Under 2.5', prob: pu25, odds_id: 'odds_under' },
                { name: 'BTTS Sí', prob: pby, odds_id: 'odds_btts_yes' },
                { name: 'BTTS No', prob: pbn, odds_id: 'odds_btts_no' }
            ];

            const overround = (1/parseFloat(document.getElementById('odds_over').value || 100) + 1/parseFloat(document.getElementById('odds_under').value || 100)) * 100;
            document.getElementById('overround_info').innerText = `Overround O/U: ${overround.toFixed(2)}%`;

            const tbody = document.getElementById('table_body');
            tbody.innerHTML = '';
            document.getElementById('results_area').classList.remove('hidden');

            results.forEach(res => {
                const bookieOdds = parseFloat(document.getElementById(res.odds_id).value) || 0;
                const fairOdds = 1 / res.prob;
                const edge = (bookieOdds * res.prob) - 1;
                
                let stake = 0;
                let passFilters = false;

                if (edge >= 0.03 && edge <= 0.15 && overround <= 108) { // 100 + 8%
                    // Kelly Fraccional 25%
                    stake = (edge / (bookieOdds - 1)) * 0.25 * BANKROLL_BASE;
                    passFilters = true;
                }

                const row = `
                    <tr class="${passFilters ? 'bg-green-50' : ''}">
                        <td class="p-2 border font-bold">${res.name}</td>
                        <td class="p-2 border">${(res.prob * 100).toFixed(2)}%</td>
                        <td class="p-2 border">${fairOdds.toFixed(2)}</td>
                        <td class="p-2 border ${edge > 0.03 ? 'text-green-600 font-bold' : ''}">${(edge * 100).toFixed(2)}%</td>
                        <td class="p-2 border font-bold text-blue-700">${stake > 0 ? '$' + stake.toFixed(2) : '-'}</td>
                        <td class="p-2 border">
                            <button onclick="saveBet('${res.name}', ${bookieOdds}, ${stake}, ${edge}, ${overround})" 
                                class="bg-black text-white px-2 py-1 rounded text-xs ${stake > 0 ? '' : 'opacity-50 pointer-events-none'}">
                                Enviar a Control
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function saveBet(market, odds, stake, edge, overround) {
            const bet = {
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                market,
                odds,
                stake,
                edge: (edge * 100).toFixed(2),
                overround: overround.toFixed(2),
                clv: 0,
                status: 'pending',
                profit: 0
            };
            bets.push(bet);
            localStorage.setItem('bets', JSON.stringify(bets));
            alert("Apuesta guardada en Control");
        }

        function updateControlTable() {
            const tbody = document.getElementById('control_table_body');
            tbody.innerHTML = '';
            
            let totalProfit = 0;
            let totalStaked = 0;
            let wins = 0;

            bets.forEach((bet, index) => {
                totalProfit += parseFloat(bet.profit);
                totalStaked += parseFloat(bet.stake);
                if(bet.status === 'win') wins++;

                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-2">${bet.date}</td>
                        <td class="p-2 font-bold">${bet.market}</td>
                        <td class="p-2">${bet.odds}</td>
                        <td class="p-2">$${bet.stake.toFixed(2)}</td>
                        <td class="p-2">${bet.edge}%</td>
                        <td class="p-2">${bet.overround}%</td>
                        <td class="p-2"><input type="number" step="0.01" class="w-16 border" onchange="updateCLV(${index}, this.value)" value="${bet.clv}"></td>
                        <td class="p-2">
                            <select onchange="resolveBet(${index}, this.value)" class="border rounded">
                                <option value="pending" ${bet.status === 'pending' ? 'selected' : ''}>Pendiente</option>
                                <option value="win" ${bet.status === 'win' ? 'selected' : ''}>Ganada</option>
                                <option value="loss" ${bet.status === 'loss' ? 'selected' : ''}>Perdida</option>
                            </select>
                        </td>
                        <td class="p-2 text-red-500 cursor-pointer" onclick="deleteBet(${index})">Eliminar</td>
                    </tr>
                `;
            });

            // Stats
            document.getElementById('stat_count').innerText = bets.length;
            document.getElementById('stat_profit').innerText = `$${totalProfit.toFixed(2)}`;
            document.getElementById('stat_profit').className = totalProfit >= 0 ? 'text-xl font-bold text-green-600' : 'text-xl font-bold text-red-600';
            
            const yieldVal = totalStaked > 0 ? (totalProfit / totalStaked) * 100 : 0;
            document.getElementById('stat_yield').innerText = `${yieldVal.toFixed(2)}%`;
            
            const roiVal = totalStaked > 0 ? ((totalProfit + totalStaked) / totalStaked * 100) - 100 : 0;
            document.getElementById('stat_roi').innerText = `${roiVal.toFixed(2)}%`;

            // P-Value simplificado (Z-score aproximado para apuestas)
            if (bets.length > 5) {
                const avgOdds = bets.reduce((a, b) => a + b.odds, 0) / bets.length;
                const p = 1 / avgOdds;
                const expectedWins = bets.length * p;
                const stdDev = Math.sqrt(bets.length * p * (1-p));
                const z = (wins - expectedWins) / stdDev;
                const pValue = 1 - 0.5 * (1 + Math.erf(z / Math.sqrt(2))); // Función error para distribución normal
                document.getElementById('stat_pvalue').innerText = pValue.toFixed(4);
            }
        }

        function resolveBet(index, status) {
            const bet = bets[index];
            bet.status = status;
            if (status === 'win') bet.profit = bet.stake * (bet.odds - 1);
            else if (status === 'loss') bet.profit = -bet.stake;
            else bet.profit = 0;
            
            localStorage.setItem('bets', JSON.stringify(bets));
            updateControlTable();
        }

        function updateCLV(index, val) {
            bets[index].clv = val;
            localStorage.setItem('bets', JSON.stringify(bets));
        }

        function deleteBet(index) {
            if(confirm("¿Eliminar apuesta?")) {
                bets.splice(index, 1);
                localStorage.setItem('bets', JSON.stringify(bets));
                updateControlTable();
            }
        }
    </script>
</body>
</html>
