<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Analizador Liga MX (encabezados sin sticky)</title>
<style>
  :root{
    --bg:#0e1020; --panel:#161a2e; --panel2:#1d2240; --muted:#a7acc8; --text:#e8eaf2;
    --border:#2a2e4a; --accent:#5dd4a4; --accent2:#7aa2ff; --warn:#ffb84d; --danger:#ff6b6b;
    --chip:#2a2f55; --table:#13172b;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}

  /* Header: NO sticky (para evitar solapamientos en cualquier dispositivo) */
  header{
    position:static; padding:14px 16px; border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(14,16,32,.98), rgba(14,16,32,.92))
  }
  header h1{margin:0 0 4px;font-size:18px}
  header .sub{color:var(--muted);font-size:12px}

  .wrap{max-width:1100px;margin:0 auto;padding:14px 12px 40px}
  .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .btn{background:var(--accent2);color:#0c1122;border:0;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer;touch-action:manipulation}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn.alt{background:var(--chip);color:var(--text);border:1px solid var(--border)}
  input[type=file]{display:none}
  .file-label{background:var(--accent2);color:#0c1122;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer;touch-action:manipulation}
  .grid{display:grid;gap:12px;grid-template-columns: repeat(12,1fr)}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
  .card h3{margin:0 0 10px;font-size:13px;color:var(--muted);letter-spacing:.02em;text-transform:uppercase}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:12px;color:var(--muted)}
  .field input,.field select{
    background:var(--panel2);color:var(--text);border:1px solid var(--border);
    border-radius:10px;padding:12px 11px;font-size:16px
  }
  .pill{font-weight:700;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:var(--muted);font-size:12px}
  .muted{color:var(--muted)} .small{font-size:12px}

  table{width:100%;border-collapse:separate;border-spacing:0;background:var(--table);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  /* Encabezados de tabla: SIN sticky y con fondo s√≥lido para legibilidad */
  thead th{
    position:static;                  /* <- clave: NO sticky */
    background:linear-gradient(180deg,#1a1f3a,#161b33);
    color:var(--muted);font-size:12px;text-align:left;padding:10px 8px;border-bottom:1px solid var(--border);
    white-space:nowrap
  }
  tbody td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:top}
  tbody tr:hover{background:#1a1f3a}
  .right{text-align:right}.center{text-align:center}
  .good{color:var(--accent)} .bad{color:var(--danger)}
  .chip{background:var(--chip);border:1px solid var(--border);padding:6px 8px;border-radius:999px;font-size:12px}
  .scroll-x{overflow:auto;-webkit-overflow-scrolling:touch}
  .tag{display:inline-block;padding:2px 6px;border-radius:6px;border:1px solid var(--border);background:var(--panel2);font-size:11px;color:var(--muted)}
  .rec-row strong{font-weight:800}

  /* M√≥vil: todo en una columna y controles accesibles */
  @media (max-width:700px){
    .grid{grid-template-columns: repeat(1,1fr)}
    .btn, .file-label{width:100%}
    .bar{gap:8px}
    .wrap{padding:12px 10px 24px}
    .card{padding:10px}
    .field input,.field select{padding:12px 12px;font-size:16px}
    table{font-size:14px}
    tbody td, thead th{padding:10px 10px}
  }
  @media (min-width:701px){
    .grid{grid-template-columns: repeat(12,1fr)}
  }
</style>
</head>
<body>
  <header>
    <h1>Analizador Liga MX (encabezados corregidos)</h1>
    <div class="sub">1) Carga el JSON ‚Ä¢ 2) Elige liga(s) ‚Ä¢ 3) Selecciona Local/Visitante ‚Ä¢ 4) Analiza</div>
    <div class="bar" style="margin-top:10px">
      <label class="file-label" for="fileInput">üìÇ Cargar JSON</label>
      <input type="file" id="fileInput" accept=".json,application/json">
      <button class="btn alt" id="btnPaste">Pegar JSON</button>
      <button class="btn ghost" id="btnReset">Limpiar</button>
      <span class="pill" id="pillCount">0 filas</span>
      <span class="pill" id="pillTeams">Equipos: 0</span>
      <span class="pill" id="pillRecs">Mercados: 0</span>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- Selecci√≥n de LIGA y PARTIDO -->
      <div class="card" style="grid-column: span 8;">
        <h3>Selecciona liga(s) y partido</h3>
        <div class="grid" style="gap:10px">
          <div class="field" style="grid-column: span 4;">
            <label>Liga(s)</label>
            <select id="league" multiple></select>
            <span class="small muted">‚Üí Local/Visitante se filtran por estas ligas</span>
          </div>
          <div class="field" style="grid-column: span 4;">
            <label>Local (filtrado por liga)</label>
            <select id="selHome"></select>
          </div>
          <div class="field" style="grid-column: span 4;">
            <label>Visitante (filtrado por liga)</label>
            <select id="selAway"></select>
          </div>

          <div class="field" style="grid-column: span 12;">
            <div class="bar" style="gap:8px; margin-bottom:6px">
              <div class="pill">Cuotas opcionales ‚Üí para EV</div>
            </div>
            <div class="grid" style="gap:10px;margin-top:4px">
              <div class="field" style="grid-column: span 2;"><label>Odd 1</label><input id="odd1" type="number" step="0.01" inputmode="decimal" placeholder="2.10"></div>
              <div class="field" style="grid-column: span 2;"><label>Odd X</label><input id="oddx" type="number" step="0.01" inputmode="decimal" placeholder="3.20"></div>
              <div class="field" style="grid-column: span 2;"><label>Odd 2</label><input id="odd2" type="number" step="0.01" inputmode="decimal" placeholder="3.50"></div>
              <div class="field" style="grid-column: span 2;"><label>Over 2.5</label><input id="oddo25" type="number" step="0.01" inputmode="decimal" placeholder="1.95"></div>
              <div class="field" style="grid-column: span 2;"><label>Under 2.5</label><input id="oddu25" type="number" step="0.01" inputmode="decimal" placeholder="1.85"></div>
              <div class="field" style="grid-column: span 2;"><label>BTTS S√≠</label><input id="oddbtts" type="number" step="0.01" inputmode="decimal" placeholder="1.90"></div>
            </div>
          </div>
        </div>
        <div class="bar" style="margin-top:10px">
          <button class="btn" id="btnRun">üîç Analizar partido</button>
          <button class="btn ghost" id="btnExportRecs">‚¨áÔ∏è Exportar mercados CSV</button>
          <span class="muted small">Si no ingresas cuotas, ver√°s probabilidades (EV = ‚Äî).</span>
        </div>
      </div>

      <!-- Par√°metros del modelo -->
      <div class="card" style="grid-column: span 4;">
        <h3>Par√°metros del modelo</h3>
        <div class="grid" style="gap:10px">
          <div class="field" style="grid-column: span 6;">
            <label>Partidos recientes (N)</label>
            <input id="paramN" type="number" min="3" max="30" step="1" value="10" inputmode="numeric">
          </div>
          <div class="field" style="grid-column: span 6;">
            <label>Peso recency (0‚Äì1)</label>
            <input id="paramAlpha" type="number" min="0" max="1" step="0.05" value="0.30" inputmode="decimal">
          </div>
          <div class="field" style="grid-column: span 6;">
            <label>M√°x. goles (gmax)</label>
            <input id="paramGMax" type="number" min="4" max="12" step="1" value="8" inputmode="numeric">
          </div>
          <div class="field" style="grid-column: span 6;">
            <label>Ventana rachas (M)</label>
            <input id="paramStreak" type="number" min="3" max="15" step="1" value="5" inputmode="numeric">
          </div>

          <div class="field" style="grid-column: span 6%;">
            <label>Prob. m√≠nima</label>
            <input id="paramPMin" type="number" step="0.01" value="0.45" inputmode="decimal">
          </div>
          <div class="field" style="grid-column: span 6;">
            <label>EV m√≠nimo</label>
            <input id="paramEVMin" type="number" step="0.01" value="0.02" inputmode="decimal">
          </div>
          <div class="field" style="grid-column: span 6;">
            <label>Mercados</label>
            <select id="paramMarkets" multiple size="5">
              <option selected value="1X2">1X2</option>
              <option selected value="O2.5">Over 2.5</option>
              <option selected value="U2.5">Under 2.5</option>
              <option selected value="BTTS">BTTS (GG)</option>
            </select>
          </div>
          <div class="field" style="grid-column: span 6;">
            <label>Medias H/A</label>
            <select id="paramHomeAway">
              <option value="1" selected>S√≠ (recomendado)</option>
              <option value="0">No (global)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Resultado del an√°lisis -->
      <div class="card" style="grid-column: span 12;">
        <h3>Resultados del partido</h3>
        <div id="resumen" class="small muted" style="margin-bottom:8px"></div>
        <div class="scroll-x">
          <table id="tblRecs">
            <thead><tr>
              <th>Partido</th><th>Mercado</th><th>Cuota</th><th>Prob.</th><th>EV</th><th>Modelo</th><th>Razonamiento</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Tabla base -->
      <div class="card" style="grid-column: span 12;">
        <h3>Partidos del JSON</h3>
        <div class="bar small muted">B√∫squeda: <input id="q" type="search" placeholder="Equipo, marcador, etiqueta‚Ä¶" style="margin-left:6px; padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--panel2); color:var(--text)"></div>
        <div class="scroll-x">
          <table id="tblBase">
            <thead id="theadBase"></thead>
            <tbody id="tbodyBase"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
(()=>{

// ===== Utilidades =====
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const MONTH_MAP = {"ene.":0,"feb.":1,"mar.":2,"abr.":3,"may.":4,"jun.":5,"jul.":6,"ago.":7,"sept.":8,"sep":8,"sep.":8,"oct.":9,"nov":10,"nov.":10,"dic.":11};
const WDAYS = ["lun.","mar.","mi√©.","mie.","jue.","vie.","s√°b.","sab.","dom."];

// Parseos y helpers
function parseSpanishDate(s){
  if(!s) return null;
  try{
    let str = String(s).trim().toLowerCase();
    for(const w of WDAYS){ if(str.startsWith(w)){ str = str.replace(w,"").replace(",","").trim(); break; } }
    const parts = str.split(/\s+/);
    if(parts.length>=3 && MONTH_MAP[parts[1]]!==undefined){
      const d = Number(parts[0]), m = MONTH_MAP[parts[1]], y = Number(parts[2]);
      let hh=0, mm=0; if(parts[3]){ [hh,mm] = parts[3].split(":").map(Number); }
      return new Date(y,m,d,hh||0,mm||0);
    }
    const dt = new Date(s);
    return isNaN(dt)? null: dt;
  }catch(e){ return null; }
}
const toNum = v => {
  if(v==null) return null;
  const s = String(v).replace("%","").replace(",",".").trim();
  if(s==="") return null;
  const n = Number(s);
  return Number.isFinite(n)? n : null;
}
const fmtProb = p=> (p==null? "‚Äî" : (p*100).toFixed(1)+"%");
const fmt2 = n=> n==null? "‚Äî" : Number(n).toFixed(2);
const csvEscape = s=>{
  if(s==null) return "";
  s = String(s);
  return (s.includes('"')||s.includes(",")||s.includes("\n"))? `"${s.replace(/"/g,'""')}"` : s;
}
function download(name, content, mime="text/csv;charset=utf-8"){
  const blob = new Blob([content],{type:mime});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
}

// ===== Estado =====
let DATA=[], PAST=[];
let sortBase = {key:"Date",dir:1};

// ===== Carga JSON =====
$("#fileInput").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const txt = await f.text(); loadFromText(txt);
});
$("#btnPaste").addEventListener("click", ()=>{
  const txt = prompt("Pega aqu√≠ el JSON (array de objetos):");
  if(!txt) return; loadFromText(txt);
});
$("#btnReset").addEventListener("click", ()=>{
  DATA=[]; PAST=[];
  $("#league").innerHTML="";
  $("#selHome").innerHTML=""; $("#selAway").innerHTML="";
  $("#tbodyBase").innerHTML=""; $("#tblRecs tbody").innerHTML="";
  $("#resumen").textContent="";
  $("#pillCount").textContent="0 filas"; $("#pillTeams").textContent="Equipos: 0"; $("#pillRecs").textContent="Mercados: 0";
  $("#q").value="";
});

function loadFromText(txt){
  try{
    const raw = JSON.parse(txt);
    DATA = raw.map(augmentRow).filter(Boolean);
    PAST = DATA.filter(r=> r._FT_H!=null && r._FT_A!=null);
    populateLeagues();
    refreshTeamLists();
    buildBaseTable(); renderBase();
    $("#pillCount").textContent = DATA.length+" filas";
  }catch(err){ alert("No se pudo parsear el JSON: "+err.message); }
}

function augmentRow(r){
  const row = {...r};
  if(row.Match && typeof row.Match==="string" && row.Match.includes(" - ")){
    const [h,a] = row.Match.split(" - ").map(s=>s.trim());
    row.Home = row.Home||h; row.Away = row.Away||a;
  }
  row._dt = parseSpanishDate(row.Date);
  const [hht,aht] = parseScore(row["Result HT"]);
  const [hft,aft] = parseScore(row["Result FT"]);
  row._HT_H=hht; row._HT_A=aht; row._FT_H=hft; row._FT_A=aft;

  ["Home Position","Away Position","Odd","Odd 1 PreMatch","Odd X PreMatch","Odd 2 PreMatch",
   "Home Total Shots at FT","Away Total Shots at FT",
   "Home Ball Possession at FT","Away Ball Possession at FT",
   "Home Corners at FT","Away Corners at FT"].forEach(k=> row[k]=toNum(row[k]));
  row["Success Rate"] = row["Success Rate"]??"";
  row["Overall ROI"]  = row["Overall ROI"]??"";
  return row;
}
function parseScore(s){
  if(!s) return [null,null];
  const m = String(s).trim().match(/^(\d+)\s*-\s*(\d+)$/);
  return m? [Number(m[1]),Number(m[2])] : [null,null];
}

// ===== Ligas ‚Üí Equipos dependientes =====
function populateLeagues(){
  const leagues = Array.from(new Set(DATA.map(x=>x.League).filter(Boolean)))
    .sort((a,b)=> String(a).localeCompare(String(b),'es'));
  fillSelect($("#league"), leagues);
}
function fillSelect(select, arr){
  select.innerHTML="";
  for(const v of arr){ const opt=document.createElement("option"); opt.value=v; opt.textContent=v; select.appendChild(opt); }
}
function getTeamsForLeagues(leaguesSel){
  const pool = (leaguesSel.length? DATA.filter(r=> leaguesSel.includes(r.League)) : DATA);
  const teams = Array.from(new Set(pool.flatMap(x=>[x.Home,x.Away]).filter(Boolean)))
    .sort((a,b)=> String(a).localeCompare(String(b),'es'));
  return teams;
}
function refreshTeamLists(){
  const leaguesSel = Array.from($("#league").selectedOptions).map(o=>o.value);
  const prevHome = $("#selHome").value || null;
  const prevAway = $("#selAway").value || null;

  const teams = getTeamsForLeagues(leaguesSel);
  fillSelect($("#selHome"), teams);
  fillSelect($("#selAway"), teams);

  if(prevHome && teams.includes(prevHome)) $("#selHome").value = prevHome;
  if(prevAway && teams.includes(prevAway)) $("#selAway").value = prevAway;

  $("#pillTeams").textContent = "Equipos: "+teams.length;
  renderBase();
}
$("#league").addEventListener("change", ()=>{ refreshTeamLists(); });

// ===== Tabla base (filtrada por liga y b√∫squeda) =====
const BASE_COLS = [
  {key:"Date",label:"Fecha"},
  {key:"League",label:"Liga"},
  {key:"Home",label:"Local"},
  {key:"Away",label:"Visitante"},
  {key:"Result HT",label:"HT"},
  {key:"Result FT",label:"FT"},
  {key:"Odd 1 PreMatch",label:"Odd 1",align:"right"},
  {key:"Odd X PreMatch",label:"Odd X",align:"right"},
  {key:"Odd 2 PreMatch",label:"Odd 2",align:"right"},
  {key:"Overall ROI",label:"ROI",align:"right"},
  {key:"Success Rate",label:"√âxito",align:"right"},
  {key:"Result",label:"Etiqueta"}
];
function buildBaseTable(){
  const thead=$("#theadBase"); thead.innerHTML="";
  const tr=document.createElement("tr");
  BASE_COLS.forEach(c=>{
    const th=document.createElement("th");
    th.textContent=c.label; if(c.align) th.classList.add(c.align);
    th.onclick=()=>{ sortBase.key=c.key; sortBase.dir*=-1; renderBase(); };
    tr.appendChild(th);
  });
  thead.appendChild(tr);
}
$("#q").addEventListener("input", renderBase);
function renderBase(){
  const q = $("#q").value?.trim().toLowerCase() || "";
  const leaguesSel = Array.from($("#league").selectedOptions).map(o=>o.value);
  let arr = DATA.filter(r=>{
    if(leaguesSel.length && !leaguesSel.includes(r.League)) return false;
    if(q){
      const blob = JSON.stringify(r).toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  });
  if(sortBase.key){
    const k=sortBase.key, dir=sortBase.dir;
    arr.sort((a,b)=>{
      const va = norm(a[k]); const vb = norm(b[k]);
      if(va<vb) return -1*dir; if(va>vb) return 1*dir; return 0;
    });
  }
  const tbody=$("#tbodyBase"); tbody.innerHTML="";
  for(const r of arr){
    const tr=document.createElement("tr");
    for(const c of BASE_COLS){
      const td=document.createElement("td");
      let v = r[c.key]; if(c.key==="Date" && r._dt) v = r._dt.toLocaleString();
      td.textContent = v==null? "" : v;
      if(c.align) td.classList.add(c.align);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}
function norm(v){
  if(v==null) return -Infinity;
  if(v instanceof Date) return v.getTime();
  const n = toNum(v); return n!=null? n : String(v).toLowerCase();
}

// ===== Motor estad√≠stico =====
function buildTeamIndex(pastRows){
  const idx = {};
  for(const r of pastRows){
    if(!r.Home || !r.Away) continue;
    if(!idx[r.Home]) idx[r.Home] = {home:[],away:[],all:[]};
    if(!idx[r.Away]) idx[r.Away] = {home:[],away:[],all:[]};
    idx[r.Home].home.push({...r,_side:"H"}); idx[r.Home].all.push({...r,_side:"H"});
    idx[r.Away].away.push({...r,_side:"A"}); idx[r.Away].all.push({...r,_side:"A"});
  }
  for(const t of Object.keys(idx)){
    ["home","away","all"].forEach(k=> idx[t][k].sort((a,b)=> a._dt-b._dt));
  }
  return idx;
}
function weightedGoalRates(rows, side, N, alpha){
  let arr = side==="H"? rows.home : side==="A"? rows.away : rows.all;
  if(!arr || !arr.length) return {gf:0.9, ga:0.9, n:0};
  arr = arr.slice(-N);
  const m = arr.length;
  let wsum=0, gf=0, ga=0;
  for(let i=0;i<m;i++){
    const r = arr[m-1-i];
    const w = Math.pow(1-alpha, i);
    const gfor  = r._side==="A"? r._FT_A : r._FT_H;
    const gagen = r._side==="A"? r._FT_H : r._FT_A;
    gf += w*gfor; ga += w*gagen; wsum += w;
  }
  if(wsum===0) return {gf:0.9,ga:0.9,n:arr.length};
  return {gf:gf/wsum, ga:ga/wsum, n:arr.length};
}
function leagueAverages(pastRows){
  let hGoals=0,aGoals=0,c=0;
  for(const r of pastRows){
    if(r._FT_H==null || r._FT_A==null) continue;
    hGoals+=r._FT_H; aGoals+=r._FT_A; c++;
  }
  const muH = c? hGoals/c : 1.2;
  const muA = c? aGoals/c : 1.0;
  return {muH, muA};
}
function poissonPmf(k, lambda){ return Math.exp(-lambda) * Math.pow(lambda, k) / factorial(k); }
const FACTS = [1];
function factorial(n){ for(let i=FACTS.length;i<=n;i++) FACTS[i]=FACTS[i-1]*i; return FACTS[n]; }
function matchDistribution(lh, la, gmax){
  const PX = Array.from({length:gmax+1},(_,x)=>poissonPmf(x,lh));
  const PY = Array.from({length:gmax+1},(_,y)=>poissonPmf(y,la));
  const M = Array.from({length:gmax+1},()=>Array(gmax+1).fill(0));
  for(let x=0;x<=gmax;x++) for(let y=0;y<=gmax;y++) M[x][y]=PX[x]*PY[y];
  const tailH = 1-PX.reduce((a,b)=>a+b,0);
  const tailA = 1-PY.reduce((a,b)=>a+b,0);
  for(let x=0;x<=gmax;x++) M[x][gmax]+=PX[x]*tailA;
  for(let y=0;y<=gmax;y++) M[gmax][y]+=PY[y]*tailH;
  M[gmax][gmax]+=tailH*tailA;
  return M;
}
function probFromMatrix(M, fn){
  let p=0; for(let x=0;x<M.length;x++) for(let y=0;y<M[x].length;y++) if(fn(x,y)) p+=M[x][y];
  return Math.min(Math.max(p,0),1);
}
function probsFromLambdas(lh, la, gmax){
  const M = matchDistribution(lh,la,gmax);
  const pH = probFromMatrix(M,(x,y)=>x>y);
  const pD = probFromMatrix(M,(x,y)=>x===y);
  const pA = probFromMatrix(M,(x,y)=>x<y);
  const pO25 = probFromMatrix(M,(x,y)=>x+y>=3);
  const pU25 = 1-pO25;
  const pBTTS = probFromMatrix(M,(x,y)=>x>0 && y>0);
  return {pH,pD,pA,pO25,pU25,pBTTS};
}
function streakStats(rowsAll, team, M){
  const arr = rowsAll.slice(-M);
  let over=0, btts=0, win=0, draw=0, lose=0;
  for(const r of arr){
    const tg = (r._FT_H??0)+(r._FT_A??0);
    if(tg>=3) over++;
    if((r._FT_H??0)>0 && (r._FT_A??0)>0) btts++;
    const isH = r._side==="H";
    if((isH && r._FT_H>r._FT_A) || (!isH && r._FT_A>r._FT_H)) win++;
    else if(r._FT_H===r._FT_A) draw++;
    else lose++;
  }
  return {overRate:arr.length?over/arr.length:0, bttsRate:arr.length?btts/arr.length:0, winRate:arr.length?win/arr.length:0, sample:arr.length};
}

// ===== Analizar partido seleccionado =====
$("#btnRun").addEventListener("click", analyzeSelectedMatch);

function analyzeSelectedMatch(){
  const home = $("#selHome").value;
  const away = $("#selAway").value;
  if(!home || !away){ alert("Selecciona Local y Visitante."); return; }
  if(home===away){ alert("Local y Visitante no pueden ser el mismo equipo."); return; }

  const N = Number($("#paramN").value)||10;
  const alpha = Number($("#paramAlpha").value)||0.3;
  const gmax = Math.max(5, Math.min(12, Number($("#paramGMax").value)||8));
  const Mstreak = Number($("#paramStreak").value)||5;
  const pMin = Number($("#paramPMin").value)||0.45;
  const evMin = Number($("#paramEVMin").value)||0.02;
  const useHA = $("#paramHomeAway").value==="1";
  const markets = Array.from($("#paramMarkets").selectedOptions).map(o=>o.value);

  const leaguesSel = Array.from($("#league").selectedOptions).map(o=>o.value);
  const past = leaguesSel.length? PAST.filter(r=>leaguesSel.includes(r.League)) : PAST;

  if(!past.length){ alert("No hay historial suficiente en las ligas seleccionadas."); return; }

  const idx = buildTeamIndex(past);
  const H = idx[home], A = idx[away];
  if(!H || !A){ alert("No hay historial suficiente para alguno de los equipos en esas ligas."); return; }

  const lg = leagueAverages(past);

  const sideH = useHA?"H":"ALL", sideA = useHA?"A":"ALL";
  const hFor = weightedGoalRates(H, sideH, N, alpha);
  const aFor = weightedGoalRates(A, sideA, N, alpha);

  const eps = 0.05;
  const offH = Math.max(hFor.gf, eps);
  const defA = Math.max(aFor.ga, eps);
  const offA = Math.max(aFor.gf, eps);
  const defH = Math.max(hFor.ga, eps);
  const lambdaH = offH * (defA) / (lg.muA || 1.0);
  const lambdaA = offA * (defH) / (lg.muH || 1.0);

  const probs = probsFromLambdas(lambdaH, lambdaA, gmax);
  const stH = streakStats(H.all, home, Mstreak);
  const stA = streakStats(A.all, away, Mstreak);

  // cuotas manuales
  const o1 = toNum($("#odd1").value);
  const ox = toNum($("#oddx").value);
  const o2 = toNum($("#odd2").value);
  const oO25 = toNum($("#oddo25").value);
  const oU25 = toNum($("#oddu25").value);
  const oBTTS = toNum($("#oddbtts").value);

  const cand = [];
  if(markets.includes("1X2")){
    pushEV(cand, home+" gana (1)", o1, probs.pH, pMin, evMin, `ŒªH=${lambdaH.toFixed(2)}, ŒªA=${lambdaA.toFixed(2)}`);
    pushEV(cand, "Empate (X)",   ox, probs.pD, pMin, evMin, `ŒªH=${lambdaH.toFixed(2)}, ŒªA=${lambdaA.toFixed(2)}`);
    pushEV(cand, away+" gana (2)", o2, probs.pA, pMin, evMin, `ŒªH=${lambdaH.toFixed(2)}, ŒªA=${lambdaA.toFixed(2)}`);
  }
  if(markets.includes("O2.5")){
    pushEV(cand, "Over 2.5", oO25, probs.pO25, pMin, evMin, `TG‚âà${(lambdaH+lambdaA).toFixed(2)}`);
  }
  if(markets.includes("U2.5")){
    pushEV(cand, "Under 2.5", oU25, probs.pU25, pMin, evMin, `TG‚âà${(lambdaH+lambdaA).toFixed(2)}`);
  }
  if(markets.includes("BTTS")){
    pushEV(cand, "BTTS S√≠", oBTTS, probs.pBTTS, pMin, evMin, `ŒªH=${lambdaH.toFixed(2)}, ŒªA=${lambdaA.toFixed(2)}`);
  }

  for(const c of cand){
    const reasons = [];
    reasons.push(`Rachas √∫ltimos ${Mstreak}: ${home} Over‚â•3 ${(stH.overRate*100).toFixed(0)}%, BTTS ${(stH.bttsRate*100).toFixed(0)}%`);
    reasons.push(`Rachas √∫ltimos ${Mstreak}: ${away} Over‚â•3 ${(stA.overRate*100).toFixed(0)}%, BTTS ${(stA.bttsRate*100).toFixed(0)}%`);
    if(lambdaH>lambdaA+0.2) reasons.push("Modelo favorece al local (ŒªH>ŒªA)");
    if(lambdaA>lambdaH+0.2) reasons.push("Modelo favorece al visitante (ŒªA>ŒªH)");
    if((stH.overRate+stA.overRate)/2>0.6) reasons.push("Tendencia Over en ambos");
    if((stH.bttsRate+stA.bttsRate)/2>0.6) reasons.push("Tendencia BTTS en ambos");
    c.reasons = reasons;
    c.match = `${home} vs ${away}`;
    c.model = `Poisson gmax=${gmax}, N=${N}, Œ±=${alpha}`;
  }

  cand.sort((a,b)=> (b.EV??-1) - (a.EV??-1));

  $("#resumen").innerHTML = `
    <span class="chip">ŒªH=${lambdaH.toFixed(2)}</span>
    <span class="chip">ŒªA=${lambdaA.toFixed(2)}</span>
    <span class="chip">P(1) ${fmtProb(probs.pH)}</span>
    <span class="chip">P(X) ${fmtProb(probs.pD)}</span>
    <span class="chip">P(2) ${fmtProb(probs.pA)}</span>
    <span class="chip">P(O2.5) ${fmtProb(probs.pO25)}</span>
    <span class="chip">P(BTTS) ${fmtProb(probs.pBTTS)}</span>
  `;

  renderRecs(cand);
}

function pushEV(list, market, odd, p, pMin, evMin, note){
  if(p==null || isNaN(p)) return;
  if(p < pMin) return;
  let EV=null;
  if(odd && odd>1) EV = p*odd - 1;
  if(odd==null){
    list.push({Market:market, Odd:"‚Äî", P:p, EV:null, Note:note});
    return;
  }
  if(EV>=evMin) list.push({Market:market, Odd:odd, P:p, EV:EV, Note:note});
}

function renderRecs(recs){
  const tbody = $("#tblRecs tbody"); tbody.innerHTML="";
  let count=0;
  for(const r of recs){
    const tr = document.createElement("tr"); tr.className="rec-row";
    tr.innerHTML = `
      <td><strong>${r.match||"‚Äî"}</strong></td>
      <td><span class="tag">${r.Market}</span></td>
      <td class="right">${r.Odd=="‚Äî"?"‚Äî":fmt2(r.Odd)}</td>
      <td class="right">${fmtProb(r.P)}</td>
      <td class="right ${r.EV!=null && r.EV>=0? "good":"bad"}">${r.EV==null?"‚Äî":fmt2(r.EV)}</td>
      <td class="small muted">${r.model||""}</td>
      <td class="small">${(r.reasons||[]).map(x=>`‚Ä¢ ${x}`).join("<br>")}${r.Note? `<br><span class="muted">(${r.Note})</span>`:""}</td>
    `;
    tbody.appendChild(tr); count++;
  }
  $("#pillRecs").textContent = "Mercados: "+count;
}

// ===== Exportar mercados =====
$("#btnExportRecs").addEventListener("click", ()=>{
  const rows = Array.from($("#tblRecs tbody").children).map(tr=>{
    const tds = Array.from(tr.children).map(td=>td.innerText);
    return tds;
  });
  if(!rows.length){ alert("No hay mercados para exportar."); return; }
  const headers = ["Partido","Mercado","Cuota","Prob.","EV","Modelo","Razonamiento"];
  const lines = [headers.map(csvEscape).join(",")];
  for(const r of rows) lines.push(r.map(csvEscape).join(","));
  download("mercados_partido.csv", lines.join("\n"));
});

})();</script>
</body>
</html>