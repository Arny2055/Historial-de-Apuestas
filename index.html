<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador BTTS por Varianza de Equipo</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .data-input { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 4px; }
        .team-stats { background-color: #ecf0f1; padding: 15px; margin-top: 20px; border-radius: 4px; }
        input[type="text"], input[type="file"] { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button.primary { background-color: #2ecc71; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; font-weight: bold; width: 100%; }
        button.primary:hover { background-color: #27ae60; }
        .recomendacion { margin-top: 20px; padding: 15px; border-left: 5px solid #ffc107; background-color: #fff3cd; }
        .recomendacion h4 { margin-top: 0; color: #ffc107; }
        .range-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .range-table th, .range-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .range-table th { background-color: #0056b3; color: white; }
        .error { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h2>‚öΩ Analizador de Varianza de Equipos para BTTS</h2>
        <p>Carga tu historial de partidos BTTS. La herramienta analizar√° la varianza ofensiva/defensiva de un equipo para sugerir rangos de cuotas BTTS.</p>

        <div class="data-input">
            <h4>Paso 1: Carga y Configuraci√≥n</h4>
            <input type="file" id="jsonFile" accept=".json">
            
            <label for="targetTeamName">Nombre Exacto del Equipo a Analizar:</label>
            <input type="text" id="targetTeamName" placeholder="Ej: Luton Town">
            
            <button class="primary" onclick="iniciarAnalisisArchivo()">Analizar Varianza y Sugerir Cuotas BTTS</button>
        </div>
        
        <div id="fileAnalysisOutput" class="team-stats">
            <h4>An√°lisis de Varianza del Equipo (Resultados)</h4>
            <p>Los resultados se mostrar√°n aqu√≠ despu√©s de la carga.</p>
        </div>
    </div>

    <script>
        // --- FUNCIONES DE C√ÅLCULO ESTAD√çSTICO ---
        
        function calcularMedia(datos) {
            if (datos.length === 0) return 0;
            const suma = datos.reduce((acc, val) => acc + val, 0);
            return suma / datos.length;
        }

        function calcularVarianza(datos) {
            const n = datos.length;
            if (n < 2) return 0;
            const media = calcularMedia(datos);
            
            const sumatoria = datos.reduce((acc, val) => {
                const diferencia = val - media;
                return acc + (diferencia * diferencia);
            }, 0);
            
            return sumatoria / (n - 1); // Varianza Muestral
        }

        // --- L√ìGICA DE CARGA Y PROCESAMIENTO ---

        function iniciarAnalisisArchivo() {
            const fileInput = document.getElementById('jsonFile');
            const targetTeam = document.getElementById('targetTeamName').value.trim();
            const outputDiv = document.getElementById('fileAnalysisOutput');
            
            outputDiv.innerHTML = '<h4>An√°lisis de Varianza del Equipo (Resultados)</h4>';
            
            if (fileInput.files.length === 0 || !targetTeam) {
                outputDiv.innerHTML += '<p class="error">‚ùå Por favor, selecciona un archivo y escribe el nombre exacto del equipo.</p>';
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    procesarDatosArchivo(data, targetTeam, outputDiv);
                } catch (error) {
                    outputDiv.innerHTML += `<p class="error">‚ùå Error al parsear JSON: ${error.message}</p>`;
                }
            };

            reader.onerror = function() {
                outputDiv.innerHTML += '<p class="error">‚ùå Error al leer el archivo.</p>';
            };

            reader.readAsText(file);
        }

        function procesarDatosArchivo(data, targetTeam, outputDiv) {
            
            const gaArray = []; // Goles Anotados
            const grArray = []; // Goles Recibidos
            const bttsOdds = []; // Cuotas BTTS (para analizar la media hist√≥rica de aciertos)

            data.forEach(item => {
                const match = item['Match'];
                const resultFT = item['Result FT'];
                const result = item['Result']; // 'Winning' o 'Losing'
                
                if (!match || !resultFT) return;
                
                const [scoreLocalStr, scoreAwayStr] = resultFT.split('-').map(s => s.trim());
                const scoreLocal = parseInt(scoreLocalStr);
                const scoreAway = parseInt(scoreAwayStr);

                if (isNaN(scoreLocal) || isNaN(scoreAway)) return;
                
                // 1. Recopilar Goles para Varianza
                if (match.startsWith(targetTeam)) { // Era Local
                    gaArray.push(scoreLocal);
                    grArray.push(scoreAway);
                } else if (match.includes(targetTeam)) { // Era Visitante (usando includes para ser m√°s tolerante)
                    gaArray.push(scoreAway);
                    grArray.push(scoreLocal);
                }

                // 2. Recopilar Cuotas de Apuestas Ganadoras (BTTS)
                if (result === 'Winning') {
                    const odd = parseFloat(item['Odd']);
                    if (!isNaN(odd)) {
                        bttsOdds.push(odd);
                    }
                }
            });

            if (gaArray.length < 2) {
                outputDiv.innerHTML += `<p class="error">‚ùå No se encontraron suficientes partidos (N < 2) para el equipo "${targetTeam}".</p>`;
                return;
            }

            // 3. C√°lculos de Varianza y Estad√≠sticas
            const varGA = calcularVarianza(gaArray);
            const varGR = calcularVarianza(grArray);
            const mediaGA = calcularMedia(gaArray);
            const mediaGR = calcularMedia(grArray);
            const mediaOdd = calcularMedia(bttsOdds);
            const desvEstOdd = calcularVarianza(bttsOdds) > 0 ? Math.sqrt(calcularVarianza(bttsOdds)) : 0;
            
            // 4. Mostrar Resultados y Recomendaci√≥n BTTS
            mostrarRecomendacion(targetTeam, gaArray.length, varGA, varGR, mediaGA, mediaGR, mediaOdd, desvEstOdd, outputDiv);
        }

        // --- FUNCI√ìN DE RECOMENDACI√ìN DE CUOTAS BTTS ---

        function mostrarRecomendacion(teamName, N, varGA, varGR, mediaGA, mediaGR, mediaOdd, desvEstOdd, outputDiv) {
            const varGA_f = varGA.toFixed(3);
            const varGR_f = varGR.toFixed(3);
            const mediaOdd_f = mediaOdd.toFixed(3);
            const desvEstOdd_f = desvEstOdd.toFixed(3);

            const altaVarianzaOfensiva = varGA > 1.0;
            const altaVarianzaDefensiva = varGR > 1.0;
            
            // Rango de Oro de BTTS (donde el modelo es hist√≥ricamente fuerte)
            const rangoMin = mediaOdd - desvEstOdd;
            const rangoMax = mediaOdd + desvEstOdd;

            let conclusionVarianza = '';
            let estrategiaBTTS = '';
            
            if (altaVarianzaOfensiva && altaVarianzaDefensiva) {
                conclusionVarianza = `El equipo es **Altamente Vol√°til** (Ofensiva y Defensiva Inconsistentes).`;
                estrategiaBTTS = `Busca **BTTS S√ç** en partidos donde el rival sea Consistente pero con defensas vulnerables. El alto promedio de goles (Media GA: ${mediaGA.toFixed(2)}) sugiere que siempre buscar√°n anotar, lo que impulsa el 'S√≠'.`;
            } else if (altaVarianzaOfensiva) {
                conclusionVarianza = `El equipo tiene una **Ofensiva Vol√°til** y una Defensa Consistente.`;
                estrategiaBTTS = `Busca **BTTS NO** en partidos contra rivales d√©biles (defensas fuertes). Busca **BTTS S√ç** en partidos con rivales fuertes (defensas d√©biles), ya que su ataque es impredecible y puede explotar agujeros.`;
            } else if (altaVarianzaDefensiva) {
                conclusionVarianza = `El equipo tiene una **Defensa Vol√°til** y una Ofensiva Consistente.`;
                estrategiaBTTS = `Este es un candidato ideal para **BTTS S√ç** si su ataque (Media GA: ${mediaGA.toFixed(2)}) compensa la defensa inestable. El valor estar√° en el 'S√≠' cuando las cuotas de 'BTTS S√ç' sean altas debido a un rival con ataque d√©bil.`;
            } else {
                conclusionVarianza = `El equipo es **Muy Consistente** (Ofensiva y Defensiva Estables).`;
                estrategiaBTTS = `Apu√©stale a **BTTS S√ç** solo cuando las cuotas de BTTS S√ç sean altas (subvaloradas), o a **BTTS NO** cuando las cuotas sean bajas (sobrevaloradas), ya que la consistencia reduce el riesgo.`;
            }

            outputDiv.innerHTML = `
                <h4>An√°lisis de Varianza de ${teamName} (${N} Partidos)</h4>
                <p><strong>Media Goles Anotados (GA):</strong> ${mediaGA.toFixed(2)} | <strong>Varianza Ofensiva:</strong> <strong>${varGA_f}</strong></p>
                <p><strong>Media Goles Recibidos (GR):</strong> ${mediaGR.toFixed(2)} | <strong>Varianza Defensiva:</strong> <strong>${varGR_f}</strong></p>
                <hr>
                
                <div class="recomendacion">
                    <h4>üéØ Estrategia BTTS para ${teamName}</h4>
                    <p><strong>Conclusi√≥n:</strong> ${conclusionVarianza}</p>
                    <p><strong>Estrategia Clave:</strong> ${estrategiaBTTS}</p>
                    
                    <h4 style="margin-top: 20px;">Rango de Cuotas BTTS Sugeridas (Tu Zona de Edge)</h4>
                    <p>Tu modelo tiene mayor ventaja hist√≥rica en cuotas alrededor de ${mediaOdd_f}.</p>
                    <p><strong>Media de Cuotas Ganadoras:</strong> ${mediaOdd_f}</p>
                    <p><strong>Desviaci√≥n Est√°ndar:</strong> ${desvEstOdd_f}</p>
                    
                    <table class="range-table">
                        <thead>
                            <tr>
                                <th>Rango Estad√≠stico</th>
                                <th>Cuotas Sugeridas</th>
                                <th>Acci√≥n Estrat√©gica</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>**Rango de Consistencia ($\pm 1s$)**</td>
                                <td>**${rangoMin.toFixed(2)}** a **${rangoMax.toFixed(2)}**</td>
                                <td>**Busca el Edge aqu√≠.** Este es tu rango de "Oro". El 68% de tus aciertos caen aqu√≠.</td>
                            </tr>
                            <tr>
                                <td>**Valor Superior (High Edge)**</td>
                                <td>Cuotas **superiores a ${rangoMax.toFixed(2)}**</td>
                                <td>Ideal para **BTTS S√ç** en partidos con varianza alta. La cuota es mayor, el riesgo es mayor, pero el potencial de retorno es superior.</td>
                            </tr>
                            <tr>
                                <td>**Cuotas a Evitar**</td>
                                <td>Cuotas inferiores a **${rangoMin.toFixed(2)}**</td>
                                <td>Tu *backtesting* sugiere poco valor (*Edge* negativo) en este rango, ya sea para BTTS S√ç o NO.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
        }

        window.onload = function() {
            // Inicializaci√≥n opcional si se requiere
        };
    </script>
</body>
</html>