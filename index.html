<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Analizador Profesional de Rentabilidad por Equipo</title>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; background: #f4f4f9; padding: 20px; }
.container { max-width: 1150px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,.1); }
h1 { text-align: center; color: #4caf50; border-bottom: 2px solid #4caf50; padding-bottom: 10px; }
.controls { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px; }
select, input, button { padding:10px; border:1px solid #ccc; border-radius:4px; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { border:1px solid #ddd; padding:10px; }
th { background:#4caf50; color:white; }
.rentable { color:#2e7d32; font-weight:bold; }
.no-rentable { color:#d32f2f; font-weight:bold; }
.neutral { color:#555; font-weight:bold; }
button { cursor:pointer; background:#4caf50; color:white; border:none; transition:.3s; }
button:hover { background:#388e3c; }
</style>
</head>

<body>
<div class="container">
<h1>⚽ Analizador Profesional de Equipos</h1>

<div class="controls">
<input type="file" id="fileInput" accept=".xlsx">

<select id="filtroPosicion">
    <option value="all">Local + Visitante</option>
    <option value="home">Solo Local</option>
    <option value="away">Solo Visitante</option>
</select>

<select id="filtroLiga">
    <option value="all">Todas las Ligas</option>
</select>

<select id="filtroLimite">
    <option value="0">Histórico completo</option>
    <option value="15">Últimos 15 partidos por equipo</option>
</select>

<button onclick="exportarExcel()">Exportar a Excel</button>
</div>

<div id="resultados"></div>
</div>

<script>
let datosGlobales = [];
let rankingFinal = [];

document.getElementById('fileInput').addEventListener('change', cargarArchivo);
document.querySelectorAll('select').forEach(e => e.addEventListener('change', recalcular));

function parseFechaSeguro(fecha) {
    if (!fecha) return new Date(0);
    if (typeof fecha === "number") return XLSX.SSF.parse_date_code(fecha);
    const partes = String(fecha).split("/");
    if (partes.length === 3) {
        return new Date(`${partes[2]}-${partes[1]}-${partes[0]}`);
    }
    return new Date(fecha);
}

function esWinSeguro(valor) {
    const v = String(valor).toUpperCase().trim();
    return ["WIN","WINNING","1","W","TRUE","SI"].includes(v);
}

function cargarArchivo(e) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        datosGlobales = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        datosGlobales.sort((a,b)=> parseFechaSeguro(a.Date) - parseFechaSeguro(b.Date));

        cargarLigas();
        recalcular();
    };
    reader.readAsArrayBuffer(e.target.files[0]);
}

function cargarLigas() {
    const ligas = [...new Set(datosGlobales.map(r => r.League).filter(l => l && l.trim() !== ''))];
    const select = document.getElementById("filtroLiga");
    select.innerHTML = '<option value="all">Todas las Ligas</option>';
    ligas.forEach(l => {
        const opt = document.createElement("option");
        opt.value = l;
        opt.textContent = l;
        select.appendChild(opt);
    });
}

function recalcular() {
    const posicion = document.getElementById("filtroPosicion").value;
    const liga = document.getElementById("filtroLiga").value;
    const limite = Number(document.getElementById("filtroLimite").value);

    let datos = [...datosGlobales];
    if (liga !== "all") datos = datos.filter(d => String(d.League) === liga);

    procesarDatos(datos, posicion, limite);
}

function procesarDatos(data, posicion, limite) {
    const porEquipo = {};

    data.forEach(row => {
        if (!row.Match || !String(row.Match).includes("-")) return;

        const [home, away] = String(row.Match).split("-").map(t => t.trim());
        const odd = Math.max(parseFloat(row.Odd) || 1, 1);
        const isWin = esWinSeguro(row.Result);

        if (!porEquipo[home]) porEquipo[home] = [];
        if (!porEquipo[away]) porEquipo[away] = [];

        porEquipo[home].push({ tipo: "home", isWin, odd });
        porEquipo[away].push({ tipo: "away", isWin, odd });
    });

    const resultados = {};

    Object.entries(porEquipo).forEach(([team, partidos]) => {

        let partidosUsados = limite > 0 ? partidos.slice(-limite) : partidos;
        let usados = partidosUsados.filter(p => posicion === "all" || p.tipo === posicion);

        if (!usados.length) return;

        let profit = 0, aciertos = 0;

        usados.forEach(p => {
            profit += p.isWin ? (p.odd - 1) : -1;
            if (p.isWin) aciertos++;
        });

        resultados[team] = {
            Partidos: usados.length,
            Aciertos: aciertos,
            Profit: profit,
            ROI: (profit / usados.length) * 100
        };
    });

    rankingFinal = Object.entries(resultados).map(([Equipo, d]) => ({
        Equipo,
        Partidos: d.Partidos,
        Aciertos: d.Aciertos,
        WinRate: ((d.Aciertos / d.Partidos) * 100).toFixed(1),
        Profit: d.Profit.toFixed(2),
        ROI: d.ROI.toFixed(2)
    })).sort((a,b)=> parseFloat(b.Profit) - parseFloat(a.Profit));

    mostrarTabla();
}

function mostrarTabla() {
    let html = `<table>
    <tr>
        <th>Equipo</th><th>Partidos</th><th>Aciertos</th><th>Win%</th>
        <th>Profit</th><th>ROI%</th><th>Estado</th>
    </tr>`;

    rankingFinal.forEach(e => {
        const p = parseFloat(e.Profit);
        const estado = p > 0 ? "Rentable" : p < 0 ? "Pérdida" : "Neutro";
        const clase = p > 0 ? "rentable" : p < 0 ? "no-rentable" : "neutral";

        html += `
        <tr>
            <td>${e.Equipo}</td>
            <td>${e.Partidos}</td>
            <td>${e.Aciertos}</td>
            <td>${e.WinRate}%</td>
            <td class="${clase}">${e.Profit} u</td>
            <td class="${clase}">${e.ROI}%</td>
            <td class="${clase}">${estado}</td>
        </tr>`;
    });

    html += "</table>";
    document.getElementById("resultados").innerHTML = html;
}

function exportarExcel() {
    if (!rankingFinal.length) {
        alert("No hay datos para exportar.");
        return;
    }
    const ws = XLSX.utils.json_to_sheet(rankingFinal);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ranking Equipos");
    XLSX.writeFile(wb, "ranking_rentabilidad_equipos.xlsx");
}
</script>
</body>
</html>