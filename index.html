<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poisson Ultra Fix</title>
    <style>
        :root { --primary: #00ff85; --secondary: #3d195a; --bg: #f0f0f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 450px; margin: auto; background: white; padding: 15px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .log { background: #1c1c1e; color: #00ff85; padding: 10px; border-radius: 10px; font-family: monospace; font-size: 10px; margin: 10px 0; white-space: pre-wrap; height: 80px; overflow-y: auto; }
        .btn-main { width: 100%; padding: 18px; background: var(--secondary); color: white; border: none; border-radius: 15px; font-weight: bold; font-size: 16px; }
        .match-card { background: white; border: 1px solid #ddd; border-radius: 12px; margin-top: 10px; padding: 12px; border-left: 5px solid var(--primary); }
        .input-box { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <h3 style="text-align:center; margin-top:0;">Import Poisson Pro</h3>
    
    <div id="config-area">
        <label style="font-size:10px; font-weight:bold;">URL STATS (HOME/AWAY):</label>
        <input id="urlStats" class="input-box" value="https://www.soccerstats.com/homeaway.asp?league=england">
        
        <label style="font-size:10px; font-weight:bold;">URL CALENDARIO:</label>
        <input id="urlCal" class="input-box" value="https://www.soccerstats.com/results.asp?league=england">
    </div>

    <button class="btn-main" onclick="processData()">EJECUTAR IMPORTACIÓN</button>
    
    <div id="statusLog" class="log">Estado: Esperando...</div>
    <div id="results"></div>
</div>

<script>
    const norm = (t) => t.toLowerCase().replace(/[^a-z]/g, "").trim();

    async function fetchData(url) {
        // Usamos un proxy diferente para evitar el error de patrón
        const proxy = "https://api.codetabs.com/v1/proxy?quest=";
        const response = await fetch(proxy + encodeURIComponent(url));
        if (!response.ok) throw new Error("Error en Proxy");
        return await response.text();
    }

    async function processData() {
        const log = document.getElementById('statusLog');
        const res = document.getElementById('results');
        const urlS = document.getElementById('urlStats').value.trim();
        const urlC = document.getElementById('urlCal').value.trim();
        
        log.innerHTML = "> Iniciando descarga...";
        res.innerHTML = "";

        try {
            // 1. Obtener Stats
            const htmlStats = await fetchData(urlS);
            const parser = new DOMParser();
            const docS = parser.parseFromString(htmlStats, "text/html");
            const rowsS = docS.querySelectorAll('tr.odd, tr.even');
            
            let statsMap = {};
            rowsS.forEach(r => {
                const c = r.cells;
                if(c && c.length >= 8) {
                    const name = c[1].innerText.trim();
                    const pj = parseFloat(c[2].innerText);
                    if(!isNaN(pj)) {
                        statsMap[norm(name)] = {
                            display: name,
                            pj: pj,
                            gf: parseFloat(c[6].innerText),
                            gc: parseFloat(c[7].innerText)
                        };
                    }
                }
            });

            log.innerHTML += `\n> Equipos leídos: ${Object.keys(statsMap).length}`;

            // 2. Obtener Calendario
            const htmlCal = await fetchData(urlC);
            const docC = parser.parseFromString(htmlCal, "text/html");
            const rowsC = docC.querySelectorAll('tr[height="34"]');

            let count = 0;
            rowsC.forEach(r => {
                const c = r.cells;
                if(c && c.length >= 4) {
                    const hN = norm(c[1].innerText);
                    const aN = norm(c[3].innerText);
                    
                    if(statsMap[hN] && statsMap[aN]) {
                        count++;
                        const p = calcPoisson(statsMap[hN], statsMap[aN]);
                        if(p >= 60) {
                            res.innerHTML += `
                            <div class="match-card">
                                <b>${statsMap[hN].display} vs ${statsMap[aN].display}</b><br>
                                <span style="color:#008a4e; font-weight:bold;">Over 2.5: ${p}%</span>
                            </div>`;
                        }
                    }
                }
            });

            log.innerHTML += `\n> Partidos analizados: ${count}`;
            log.innerHTML += `\n> ✅ Proceso Finalizado.`;

        } catch (e) {
            log.innerHTML += "\n> ❌ ERROR: " + e.message;
            console.error(e);
        }
    }

    function calcPoisson(h, a) {
        const avH = 1.61, avA = 1.22;
        const lH = (h.gf/h.pj/avH) * (a.gc/a.pj/avH) * avH;
        const lA = (a.gf/a.pj/avA) * (h.gc/h.pj/avA) * avA;
        let o25 = 0;
        const f = n => { let r=1; for(let i=2; i<=n; i++) r*=i; return r; };
        const p = (l,x) => (Math.exp(-l)*Math.pow(l,x))/f(x);
        for(let i=0; i<=5; i++) for(let j=0; j<=5; j++) if(i+j > 2.5) o25 += p(lH,i)*p(lA,j);
        return (o25*100).toFixed(1);
    }
</script>
</body>
</html>
