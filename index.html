<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BETAGS - Deep Analytics Pro</title>
    <style>
        :root {
            --bg-dark: #0b0e14;
            --bg-card: #151921;
            --primary: #4dabf7;
            --accent-green: #51cf66;
            --accent-red: #ff6b6b;
            --accent-yellow: #fcc419;
            --text-white: #e9ecef;
            --text-muted: #adb5bd;
            --border: #2c3440;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-white);
            margin: 0;
            padding: 0;
            display: flex; 
            justify-content: center;
            min-height: 100vh;
            text-align: center;
        }

        .container { 
            width: 100%; 
            max-width: 100%; 
            padding: 15px; 
            box-sizing: border-box;
            padding-bottom: 40px;
        }

        h1 { font-size: 1.4rem; color: var(--primary); text-align: center; margin: 20px 0; letter-spacing: 3px; font-weight: 900; }
        h1 span { color: var(--text-white); }

        .nav-header {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn-nav-roi, .btn-nav-xg {
            background: rgba(77, 171, 247, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 8px 15px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-nav-xg {
            border-color: var(--accent-green);
            color: var(--accent-green);
            background: rgba(81, 207, 102, 0.1);
        }

        .section-title { 
            font-size: 0.7rem; 
            color: var(--primary); 
            text-transform: uppercase; 
            margin-bottom: 12px; 
            display: flex; 
            justify-content: center;
            align-items: center; 
            gap: 8px; 
            font-weight: bold; 
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-grid { width: 100%; display: grid; grid-template-columns: 1fr; gap: 12px; }
        
        select, .input-new-sheet { 
            width: 100%; 
            padding: 14px; 
            border-radius: 10px; 
            border: 1px solid var(--border); 
            background: #0b0e14;
            color: white;
            font-size: 1rem;
            outline: none;
            text-align: center;
            text-align-last: center;
            box-sizing: border-box;
        }

        .add-league-box {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .btn-add-sheet {
            background: var(--primary);
            color: var(--bg-dark);
            border: none;
            padding: 0 15px;
            border-radius: 8px;
            font-weight: 900;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .btn-delete-sheet {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
            padding: 0 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .btn-analyze-day {
            width: 100%;
            background: linear-gradient(90deg, #fcc419, #f59f00);
            color: #000;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-weight: 900;
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(252, 196, 25, 0.3);
            text-transform: uppercase;
        }

        /* Tabla de Escaneo Global */
        .global-table-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 10px;
        }

        .global-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
            min-width: 600px;
        }

        .global-table th {
            background: rgba(255,255,255,0.05);
            padding: 10px 5px;
            color: var(--primary);
            text-transform: uppercase;
            border-bottom: 2px solid var(--border);
        }

        .global-table td {
            padding: 10px 5px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .league-badge {
            background: var(--primary);
            color: #000;
            padding: 2px 5px;
            border-radius: 4px;
            font-weight: 900;
            font-size: 0.6rem;
        }

        .xg-cell {
            font-family: monospace;
            color: var(--accent-yellow);
            font-weight: bold;
        }

        .input-odds-mini {
            width: 45px;
            background: #000;
            border: 1px solid var(--primary);
            color: var(--accent-yellow);
            border-radius: 4px;
            text-align: center;
            font-size: 0.75rem;
            padding: 4px;
        }

        .btn-send-mini {
            background: var(--accent-green);
            border: none;
            color: #000;
            padding: 5px 8px;
            border-radius: 4px;
            font-weight: 900;
            font-size: 0.6rem;
            cursor: pointer;
        }

        /* Estilos Originales Preservados */
        .chart-container {
            width: 100%; height: 160px; display: flex; align-items: flex-end; justify-content: space-around; gap: 6px; margin: 10px 0;
        }
        .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end; }
        .bar { width: 80%; background: var(--primary); border-radius: 3px 3px 0 0; transition: height 0.6s ease; min-height: 2px; }
        .bar.away { background: var(--accent-green); }
        .bar-label { font-size: 0.7rem; color: var(--text-muted); margin-top: 8px; }

        .xg-info-display { display: flex; justify-content: center; gap: 20px; width: 100%; padding-top: 15px; border-top: 1px solid var(--border); }
        .xg-badge { display: flex; flex-direction: column; align-items: center; }
        .xg-badge .value { font-size: 1.2rem; font-weight: 900; }
        .xg-badge.local .value { color: var(--primary); }
        .xg-badge.away .value { color: var(--accent-green); }

        .probs-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .summary-box { border: 1px solid var(--border); border-radius: 12px; padding: 12px 5px; background: rgba(255,255,255,0.02); }
        .summary-box.blue { border-top: 3px solid var(--primary); }
        .summary-box.green { border-top: 3px solid var(--accent-green); }
        .summary-box.yellow { border-top: 3px solid var(--accent-yellow); }

        .summary-val { font-size: 1.1rem; font-weight: 800; margin: 6px 0; }
        .value-badge { padding: 4px 6px; border-radius: 6px; font-weight: 900; font-size: 0.65rem; }
        .positive-value { background: rgba(81, 207, 102, 0.2); color: var(--accent-green); }
        .negative-value { background: rgba(255, 107, 107, 0.15); color: var(--accent-red); }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 40px; height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #xgPanel, #globalAnalysisPanel { display: none; animation: fadeIn 0.5s ease; width: 100%; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p id="loadingMsg" style="margin-top: 15px; color: var(--primary); font-weight: bold;">ESCANEANDO LIGAS...</p>
</div>

<div class="container">
    <h1>BETA<span>GS</span> ANALYTICS</h1>
    
    <div class="nav-header">
        <a href="roi2.html" class="btn-nav-roi"><span>üßÆ</span> ROI CALC</a>
        <a href="xg.html" class="btn-nav-xg"><span>‚öΩ</span> XG ANALYTICS</a>
    </div>

    <div class="section-title"><span>üåç</span> ESCANEO MULTI-LIGA</div>
    <div class="card">
        <div class="input-grid">
            <button class="btn-analyze-day" onclick="analizarTodo()">
                üöÄ ANALIZAR TODAS LAS LIGAS
            </button>
            
            <div style="display: flex; gap: 10px; width: 100%; align-items: center;">
                <select id="leagueSelect" onchange="cargarDatosLiga()"></select>
                <button class="btn-delete-sheet" onclick="borrarLigaSeleccionada()">üóëÔ∏è</button>
            </div>

            <div class="add-league-box">
                <input type="text" id="newSheetName" class="input-new-sheet" placeholder="A√ëADIR HOJA...">
                <button class="btn-add-sheet" onclick="agregarNuevaLiga()">+ LIGA</button>
            </div>
        </div>
    </div>

    <div id="globalAnalysisPanel">
        <div class="section-title"><span>üìä</span> PARTIDOS ENCONTRADOS</div>
        <div class="card" style="padding: 5px;">
            <div class="global-table-container">
                <table class="global-table">
                    <thead>
                        <tr>
                            <th>LIGA</th>
                            <th>PARTIDO</th>
                            <th>xG L/V</th>
                            <th>O 2.5</th>
                            <th>BTTS Y</th>
                            <th>CUOTAS</th>
                            <th>VALUE</th>
                            <th>ACCION</th>
                        </tr>
                    </thead>
                    <tbody id="globalResultsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="section-title"><span>üéØ</span> AN√ÅLISIS INDIVIDUAL</div>
    <div class="card">
        <div class="input-grid">
            <select id="homeTeamSelect" onchange="calcularXG()">
                <option value="">EQUIPO LOCAL...</option>
            </select>
            <select id="awayTeamSelect" onchange="calcularXG()">
                <option value="">EQUIPO VISITANTE...</option>
            </select>
        </div>
    </div>

    <div id="xgPanel">
        <div class="section-title"><span>üìà</span> DISTRIBUCI√ìN POISSON</div>
        <div class="card">
            <div class="chart-container" id="golesChart"></div>
            <div class="xg-info-display">
                <div class="xg-badge local"><span class="label">xG LOCAL</span><span class="value" id="xg_local_val">0.00</span></div>
                <div class="xg-badge away"><span class="label">xG VISITA</span><span class="value" id="xg_away_val">0.00</span></div>
            </div>
        </div>

        <div class="probs-summary">
            <div class="summary-box blue"><div class="summary-title">OVER 0.5 HT</div><div class="summary-val" id="ov05ht_val">0%</div><div class="summary-odds" id="ov05ht_odds">CJ: 0.00</div></div>
            <div class="summary-box green"><div class="summary-title">OVER 2.5 FT</div><div class="summary-val" id="ov25ft_val">0%</div><div class="summary-odds" id="ov25ft_odds">CJ: 0.00</div></div>
            <div class="summary-box yellow"><div class="summary-title">BTTS YES</div><div class="summary-val" id="btts_val">0%</div><div class="summary-odds" id="btts_odds">CJ: 0.00</div></div>
        </div>

        <div class="card" style="padding: 10px 5px;">
            <div class="table-wrapper">
                <table style="width: 100%; font-size: 0.75rem;">
                    <thead>
                        <tr><th>MERCADO</th><th>PROB</th><th>JUSTA</th><th>CASA</th><th>VALUE</th><th>ACTION</th></tr>
                    </thead>
                    <tbody id="marketsTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const DEFAULT_ID = '1lmUPv7SP0XYi9ns4jkj3RTCScxIN2pCfBJyMUp_kNRI';
    let dataGlobal = { locales: [], visitantes: [], liga: {} };
    let databaseLigas = {}; 
    let currentMarkets = [];

    function getSavedLeagues() {
        const saved = localStorage.getItem('betags_custom_leagues');
        return saved ? JSON.parse(saved) : [];
    }

    function renderLeagueSelect() {
        const select = document.getElementById('leagueSelect');
        const leagues = getSavedLeagues();
        if (leagues.length === 0) {
            select.innerHTML = '<option value="">SIN LIGAS</option>';
            return;
        }
        leagues.sort((a, b) => a.name.localeCompare(b.name));
        select.innerHTML = leagues.map(l => `<option value="${l.sheet}">${l.name}</option>`).join('');
    }

    function agregarNuevaLiga() {
        const input = document.getElementById('newSheetName');
        let sheetName = input.value.trim().toUpperCase();
        if (!sheetName) return;
        const leagues = getSavedLeagues();
        if (leagues.some(l => l.sheet === sheetName)) return;
        leagues.push({ name: sheetName, sheet: sheetName });
        localStorage.setItem('betags_custom_leagues', JSON.stringify(leagues));
        renderLeagueSelect();
        input.value = "";
        cargarDatosLiga();
    }

    function borrarLigaSeleccionada() {
        const sheet = document.getElementById('leagueSelect').value;
        if (!sheet || !confirm(`¬øEliminar ${sheet}?`)) return;
        let leagues = getSavedLeagues();
        leagues = leagues.filter(l => l.sheet !== sheet);
        localStorage.setItem('betags_custom_leagues', JSON.stringify(leagues));
        renderLeagueSelect();
        cargarDatosLiga();
    }

    function poisson(k, lambda) {
        return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k);
    }

    function factorial(n) {
        let res = 1;
        for (let i = 2; i <= n; i++) res *= i;
        return res;
    }

    async function fetchSheetData(sheetName) {
        const url = `https://docs.google.com/spreadsheets/d/${DEFAULT_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}&range=A1:W50`;
        const response = await fetch(url);
        const csvText = await response.text();
        const filas = csvText.split('\n').map(linea => linea.split(',').map(celda => celda.replace(/^"(.*)"$/, '$1').trim()));
        
        let locales = [], visitantes = [];
        filas.forEach((cols, index) => {
            if (index > 0 && cols[1] && !isNaN(parseFloat(cols[2]))) {
                locales.push({ nombre: cols[1], gp: parseFloat(cols[2]), gf: parseFloat(cols[6]), ga: parseFloat(cols[7]) });
                if (cols[13]) {
                    visitantes.push({ nombre: cols[13], gp: parseFloat(cols[14]), gf: parseFloat(cols[18]), ga: parseFloat(cols[19]) });
                }
            }
        });

        let sumaGFL = 0, sumaGAL = 0, sumaPJL = 0, sumaGFV = 0, sumaGAV = 0, sumaPJV = 0;
        locales.forEach(e => { sumaGFL += e.gf; sumaGAL += e.ga; sumaPJL += e.gp; });
        visitantes.forEach(e => { sumaGFV += e.gf; sumaGAV += e.ga; sumaPJV += e.gp; });

        return {
            locales, visitantes,
            liga: { gfl: sumaGFL/sumaPJL, gal: sumaGAL/sumaPJL, gfv: sumaGFV/sumaPJV, gav: sumaGAV/sumaPJV }
        };
    }

    async function cargarDatosLiga() {
        const sheet = document.getElementById('leagueSelect').value;
        if (!sheet) return;
        document.getElementById('loadingOverlay').style.display = 'flex';
        try {
            dataGlobal = await fetchSheetData(sheet);
            actualizarSelectoresEquipos();
        } catch (e) { alert("Error al cargar liga"); }
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function actualizarSelectoresEquipos() {
        const hS = document.getElementById('homeTeamSelect');
        const aS = document.getElementById('awayTeamSelect');
        hS.innerHTML = '<option value="">EQUIPO LOCAL...</option>';
        aS.innerHTML = '<option value="">EQUIPO VISITANTE...</option>';
        const nombres = dataGlobal.locales.map(e => e.nombre).sort();
        nombres.forEach(n => {
            hS.options.add(new Option(n, n));
            aS.options.add(new Option(n, n));
        });
    }

    // --- NUEVO SISTEMA DE ANALISIS GLOBAL ---

    async function analizarTodo() {
        const overlay = document.getElementById('loadingOverlay');
        const msg = document.getElementById('loadingMsg');
        const leagues = getSavedLeagues();
        const container = document.getElementById('globalResultsBody');
        
        if (leagues.length === 0) return alert("No tienes ligas configuradas.");

        overlay.style.display = 'flex';
        container.innerHTML = '';
        databaseLigas = {};

        try {
            // 1. Cargar todas las ligas en memoria
            for (let l of leagues) {
                msg.innerText = `CARGANDO: ${l.name}...`;
                databaseLigas[l.name] = await fetchSheetData(l.sheet);
            }

            // 2. Obtener Partidos del D√≠a
            msg.innerText = `BUSCANDO PARTIDOS DEL DIA...`;
            const urlDay = `https://docs.google.com/spreadsheets/d/${DEFAULT_ID}/gviz/tq?tqx=out:csv&sheet=PARTIDOS+DEL+DIA&range=D1:F100`;
            const resDay = await fetch(urlDay);
            const csvDay = await resDay.text();
            const filasPartidos = csvDay.split('\n').map(linea => linea.split(',').map(c => c.replace(/^"(.*)"$/, '$1').trim()));

            let encontrados = 0;

            // 3. Cruzar datos
            filasPartidos.forEach((cols, idx) => {
                const homeN = cols[0];
                const awayN = cols[2];
                if (!homeN || homeN === "LOCAL") return;

                // Buscar en qu√© liga est√°n estos equipos
                for (let leagueName in databaseLigas) {
                    const db = databaseLigas[leagueName];
                    const loc = db.locales.find(e => e.nombre.toUpperCase() === homeN.toUpperCase());
                    const vis = db.visitantes.find(e => e.nombre.toUpperCase() === awayN.toUpperCase());

                    if (loc && vis) {
                        encontrados++;
                        const stats = calcularMetricasPoisson(loc, vis, db.liga);
                        agregarFilaGlobal(leagueName, homeN, awayN, stats, idx);
                    }
                }
            });

            if (encontrados === 0) {
                container.innerHTML = '<tr><td colspan="8">No se encontraron partidos para tus ligas guardadas.</td></tr>';
            }
            
            document.getElementById('globalAnalysisPanel').style.display = 'block';
            document.getElementById('globalAnalysisPanel').scrollIntoView({behavior: 'smooth'});

        } catch (e) {
            console.error(e);
            alert("Error en el escaneo global.");
        } finally {
            overlay.style.display = 'none';
        }
    }

    function calcularMetricasPoisson(loc, vis, liga) {
        const xGL = ((loc.gf/loc.gp)/liga.gfl) * ((vis.ga/vis.gp)/liga.gav) * liga.gfl;
        const xGV = ((vis.gf/vis.gp)/liga.gfv) * ((loc.ga/loc.gp)/liga.gal) * liga.gfv;

        let pL = [], pV = [];
        for(let i=0; i<=6; i++) { pL[i] = poisson(i, xGL); pV[i] = poisson(i, xGV); }

        let u25 = 0;
        for(let i=0; i<=2; i++) for(let j=0; j<=2; j++) if(i+j <= 2) u25 += pL[i]*pV[j];
        
        const bttsY = 1 - (pL[0] + pV[0] - (pL[0]*pV[0]));
        const ov25 = 1 - u25;

        return { xGL, xGV, ov25, bttsY };
    }

    function agregarFilaGlobal(liga, local, visita, stats, idx) {
        const container = document.getElementById('globalResultsBody');
        const row = document.createElement('tr');
        
        const fairO25 = (1/stats.ov25).toFixed(2);
        const fairBTTS = (1/stats.bttsY).toFixed(2);

        row.innerHTML = `
            <td><span class="league-badge">${liga}</span></td>
            <td style="text-align:left"><strong>${local}</strong><br>${visita}</td>
            <td class="xg-cell">${stats.xGL.toFixed(1)} - ${stats.xGV.toFixed(1)}</td>
            <td><div class="prob-cell">${(stats.ov25*100).toFixed(0)}%</div><div style="font-size:0.6rem">J: ${fairO25}</div></td>
            <td><div class="prob-cell">${(stats.bttsY*100).toFixed(0)}%</div><div style="font-size:0.6rem">J: ${fairBTTS}</div></td>
            <td>
                <input type="number" placeholder="O2.5" class="input-odds-mini" id="house_o_${idx}" oninput="calcValGlobal(${idx}, ${stats.ov25}, 'o')">
                <input type="number" placeholder="BTTS" class="input-odds-mini" id="house_b_${idx}" oninput="calcValGlobal(${idx}, ${stats.bttsY}, 'b')">
            </td>
            <td id="val_global_${idx}"><span class="value-badge">--</span></td>
            <td><button class="btn-send-mini" onclick="sendGlobal('${liga}', '${local}', '${visita}', ${idx}, ${stats.ov25}, ${stats.bttsY})">SEND</button></td>
        `;
        container.appendChild(row);
    }

    function calcValGlobal(idx, prob, type) {
        const odd = parseFloat(document.getElementById(`house_${type}_${idx}`).value);
        const display = document.getElementById(`val_global_${idx}`);
        if (!odd || odd <= 1) return;

        const edge = (prob * odd) - 1;
        const color = edge > 0 ? 'positive-value' : 'negative-value';
        display.innerHTML = `<span class="value-badge ${color}">${(edge*100).toFixed(1)}%</span>`;
    }

    // --- FUNCIONES DE ANALISIS INDIVIDUAL (PRESERVADAS) ---

    function calcularXG() {
        const h = document.getElementById('homeTeamSelect').value;
        const a = document.getElementById('awayTeamSelect').value;
        if (!h || !a) return;

        const loc = dataGlobal.locales.find(e => e.nombre === h);
        const vis = dataGlobal.visitantes.find(e => e.nombre === a);
        const stats = calcularMetricasPoisson(loc, vis, dataGlobal.liga);

        document.getElementById('xg_local_val').innerText = stats.xGL.toFixed(2);
        document.getElementById('xg_away_val').innerText = stats.xGV.toFixed(2);

        let pL = [], pV = [];
        for(let i=0; i<=6; i++) { pL[i] = poisson(i, stats.xGL); pV[i] = poisson(i, stats.xGV); }
        renderChart(pL, pV);

        updateIndividualUI(stats);
        document.getElementById('xgPanel').style.display = 'block';
    }

    function renderChart(pL, pV) {
        const container = document.getElementById('golesChart');
        container.innerHTML = '';
        for(let i=0; i<=6; i++) {
            const group = document.createElement('div');
            group.className = 'bar-group';
            group.innerHTML = `<div style="display:flex; gap:3px; height:100%; align-items:flex-end;"><div class="bar" style="height:${pL[i]*150}%"></div><div class="bar away" style="height:${pV[i]*150}%"></div></div><div class="bar-label">${i}</div>`;
            container.appendChild(group);
        }
    }

    function updateIndividualUI(stats) {
        const ov05ht = 1 - Math.exp(-(stats.xGL + stats.xGV) * 0.45);
        document.getElementById('ov05ht_val').innerText = (ov05ht*100).toFixed(1) + '%';
        document.getElementById('ov25ft_val').innerText = (stats.ov25*100).toFixed(1) + '%';
        document.getElementById('btts_val').innerText = (stats.bttsY*100).toFixed(1) + '%';
        
        document.getElementById('ov05ht_odds').innerText = 'CJ: ' + (1/ov05ht).toFixed(2);
        document.getElementById('ov25ft_odds').innerText = 'CJ: ' + (1/stats.ov25).toFixed(2);
        document.getElementById('btts_odds').innerText = 'CJ: ' + (1/stats.bttsY).toFixed(2);

        currentMarkets = [
            {id: 'm1', n: 'OVER 0.5 HT', p: ov05ht},
            {id: 'm2', n: 'OVER 2.5 FT', p: stats.ov25},
            {id: 'm4', n: 'BTTS YES', p: stats.bttsY}
        ];
        renderMarketsTable();
    }

    function renderMarketsTable() {
        document.getElementById('marketsTable').innerHTML = currentMarkets.map(m => `
            <tr>
                <td><strong>${m.n}</strong></td>
                <td>${(m.p*100).toFixed(0)}%</td>
                <td>${(1/m.p).toFixed(2)}</td>
                <td><input type="number" class="input-odds-mini" id="ind_in_${m.id}" oninput="calcValInd('${m.id}', ${m.p})"></td>
                <td id="ind_val_${m.id}">--</td>
                <td><button class="btn-send-mini" onclick="sendInd('${m.n}', ${m.p})">SEND</button></td>
            </tr>
        `).join('');
    }

    function calcValInd(id, p) {
        const odd = parseFloat(document.getElementById(`ind_in_${id}`).value);
        const res = document.getElementById(`ind_val_${id}`);
        if (!odd) return;
        const edge = (p * odd) - 1;
        res.innerHTML = `<span class="value-badge ${edge > 0 ? 'positive-value' : 'negative-value'}">${(edge*100).toFixed(1)}%</span>`;
    }

    // --- SISTEMA DE ENVIO A ROI ---

    function saveToROI(pick) {
        const STORAGE_KEY = 'betags_pre_match';
        let currentBets = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        currentBets.push(pick);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(currentBets));
        alert("¬°Enviado a ROI con √©xito!");
    }

    function sendGlobal(liga, local, visita, idx, pO, pB) {
        const oddO = parseFloat(document.getElementById(`house_o_${idx}`).value);
        const oddB = parseFloat(document.getElementById(`house_b_${idx}`).value);
        
        let selectedOdd = oddO || oddB;
        let selectedProb = oddO ? pO : pB;
        let marketName = oddO ? 'OVER 2.5 FT' : 'BTTS YES';

        if (!selectedOdd) return alert("Pon una cuota primero");

        saveToROI({
            id: Date.now(),
            date: new Date().toLocaleDateString(),
            teams: `[${liga}] ${local} vs ${visita}`,
            market: marketName,
            prob: selectedProb,
            fair_odd: (1/selectedProb).toFixed(2),
            odd: selectedOdd,
            edge: ((selectedProb * selectedOdd - 1) * 100).toFixed(1) + '%',
            status: 'pending'
        });
    }

    function sendInd(market, p) {
        const h = document.getElementById('homeTeamSelect').value;
        const a = document.getElementById('awayTeamSelect').value;
        const liga = document.getElementById('leagueSelect').value;
        const odd = 2.0; // Simplificado para el ejemplo

        saveToROI({
            id: Date.now(),
            date: new Date().toLocaleDateString(),
            teams: `${liga}: ${h} vs ${a}`,
            market: market,
            prob: p,
            fair_odd: (1/p).toFixed(2),
            odd: odd,
            edge: '0%',
            status: 'pending'
        });
    }

    window.onload = () => {
        renderLeagueSelect();
        cargarDatosLiga();
    };
</script>
</body>
</html>