<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Historial de Apuestas Profesional</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  /* --- Reset y base --- */
  *, *::before, *::after { box-sizing: border-box; }
  body {
    margin: 0; padding: 0;
    font-family: 'Inter', sans-serif;
    background-color: #121214; color: #e1e1e6;
    min-height: 100vh; display: flex; flex-direction: column; align-items: center;
  }
  main { max-width: 1200px; width: 95%; margin: 20px auto 40px auto; flex-grow: 1; }
  h1, h2 { font-weight: 600; margin-bottom: 0.5rem; color: #8257e6; }

  /* --- Formulario de apuesta --- */
  form#formApuesta{
    background-color:#202024; padding:25px 30px; border-radius:10px;
    box-shadow:0 6px 12px rgba(0,0,0,0.4);
    display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:20px 24px; margin-bottom:40px;
  }
  form#formApuesta label{display:block;font-weight:600;font-size:0.95rem;margin-bottom:6px;color:#c4c4cc;}
  form#formApuesta input[type="text"],
  form#formApuesta input[type="number"],
  form#formApuesta select{
    width:100%; padding:10px 14px; font-size:1rem; border-radius:8px; border:none;
    background-color:#121214; color:#e1e1e6; box-shadow:inset 0 0 5px rgb(255 255 255 / 0.1);
    transition: box-shadow 0.25s ease;
  }
  form#formApuesta input[type="text"]:focus,
  form#formApuesta input[type="number"]:focus,
  form#formApuesta select:focus{outline:none; box-shadow:inset 0 0 8px #8257e6;}
  form#formApuesta input[readonly]{background-color:#2a2a30; cursor:not-allowed;}
  form#formApuesta button[type="submit"]{
    grid-column:1 / -1; background-color:#8257e6; color:#fff; font-weight:700; font-size:1.2rem;
    padding:14px 20px; border:none; border-radius:10px; cursor:pointer; transition:background-color 0.3s ease;
    box-shadow:0 6px 10px #6a40d6;
  }
  form#formApuesta button[type="submit"]:hover{background-color:#6a40d6;}

  /* --- Sección filtros --- */
  section.filtros{
    margin-bottom:30px; display:flex; flex-wrap:wrap; gap:15px 18px;
    align-items: center;
  }
  section.filtros input[type="text"],
  section.filtros input[type="number"],
  section.filtros input[type="date"],
  section.filtros select{
    min-width:160px; padding:9px 14px; border-radius:8px; border:none;
    background-color:#121214; color:#e1e1e6; box-shadow:inset 0 0 5px rgb(255 255 255 / 0.1);
    transition: box-shadow 0.25s ease;
  }
  section.filtros input:focus,
  section.filtros select:focus{outline:none; box-shadow:inset 0 0 8px #8257e6;}
  #btnLimpiarFiltros{
    background-color:#ef4444; color:#fff; font-weight:700; border:none; border-radius:10px;
    cursor:pointer; padding:8px 14px; transition:background-color 0.3s ease;
  }
  #btnLimpiarFiltros:hover{background-color:#dc2626;}

  /* --- Botones export/import --- */
  .botones-utiles{margin-bottom:35px; display:flex; gap:18px; flex-wrap:wrap;}
  .botones-utiles button{
    background-color:#8257e6; color:#fff; font-weight:600; border:none; border-radius:10px;
    cursor:pointer; padding:12px 20px; box-shadow:0 4px 8px #6b45d9; transition:background-color 0.3s ease;
  }
  .botones-utiles button:hover{background-color:#6b45d9;}
  .botones-utiles .btn-danger{background-color:#ef4444; box-shadow:0 4px 8px rgba(239,68,68,.4);}
  .botones-utiles .btn-danger:hover{background-color:#dc2626;}
  input[type="file"]{display:none;}

  /* --- Tabla --- */
  #tablaWrapper{
    overflow-x:auto; overflow-y:auto; max-height:580px;
    box-shadow:0 6px 12px rgba(0,0,0,0.4); border-radius:12px;
  }
  table#tablaHistorial{width:100%; border-collapse:separate; border-spacing:0 5px; min-width:900px; font-size:0.9rem;}
  thead th{
    position:sticky; top:0; background-color:#29292e; color:#bbb; font-weight:700; text-align:left;
    padding:14px 18px; user-select:none; white-space:nowrap;
  }
  tbody tr{background-color:#202024; transition:background-color 0.3s ease;}
  tbody tr:hover{background-color:#333339;}
  tbody td{padding:14px 18px; color:#ddd; vertical-align:middle; white-space:nowrap;}
  .acciones button{background:none; border:none; font-size:1.2rem; margin:0 4px; cursor:pointer; color:#aaa; transition:color 0.2s ease;}
  .acciones button:hover{color:#8257e6;}
  .status-pendiente{color:#fbbf24; font-weight:600;}
  .status-ganada{color:#4caf50; font-weight:600;}
  .status-perdida{color:#ef4444; font-weight:600;}

  /* --- Resumen estadísticas --- */
  #resumen{
    margin-top:40px; background-color:#29292e; border-radius:10px; padding:22px 26px; color:#d4d4d8;
    font-size:1.05rem; font-weight:600; display:flex; flex-wrap:wrap; gap:28px; justify-content:space-around;
  }
  #resumen > div{min-width:140px;}
  #resumen > div strong{display:block; font-size:1.15rem; color:#8257e6; margin-bottom:6px;}

  /* --- Gráficas --- */
  #graficas{margin-top:45px; display:flex; flex-direction:column; gap:40px;}
  canvas{background-color:#202024; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,0.5); max-width:100%; height:320px !important;}

  /* --- Responsive --- */
  @media (max-width: 900px){
    form#formApuesta{grid-template-columns:1fr !important;}
    section.filtros{flex-direction:column !important; gap:15px !important;}
    .botones-utiles{flex-direction:column; gap:15px;}
    #resumen{flex-direction:column; gap:20px; text-align:center;}
    tbody td, thead th{font-size:0.8rem; padding:10px 12px;}
  }
</style>
</head>
<body>
<main>
  <h1 style="text-align:center;">Historial Profesional de Apuestas</h1>

  <!-- FORMULARIO -->
  <form id="formApuesta" autocomplete="off" novalidate aria-label="Formulario para agregar apuesta">
    <div>
      <label for="liga">Liga *</label>
      <input type="text" id="liga" name="liga" placeholder="Ej: LaLiga" required aria-required="true" />
    </div>
    <div>
      <label for="local">Equipo Local *</label>
      <input type="text" id="local" name="local" placeholder="Ej: Real Madrid" required aria-required="true" />
    </div>
    <div>
      <label for="visita">Equipo Visitante *</label>
      <input type="text" id="visita" name="visita" placeholder="Ej: Barcelona" required aria-required="true" />
    </div>
    <div>
      <label for="mercado">Mercado *</label>
      <select id="mercado" name="mercado" required aria-required="true">
        <option value="" disabled selected>Selecciona mercado</option>
        <option value="Over 2.5 FT">Over 2.5 FT</option>
        <option value="Under 2.5 FT">Under 2.5 FT</option>
        <option value="Ambos Anotan">Ambos Anotan</option>
        <option value="BTTS NO">BTTS NO</option>
        <option value="Hándicap">Hándicap</option>
      </select>
    </div>
    <div>
      <label for="probabilidad">Probabilidad (%) *</label>
      <input type="number" id="probabilidad" name="probabilidad" min="0.01" max="100" step="0.01" placeholder="Ej: 60" required aria-required="true" aria-describedby="descProbabilidad" />
      <small id="descProbabilidad" style="color:#c4c4cc; font-size:0.8rem;">Ingresa probabilidad estimada entre 0 y 100</small>
    </div>
    <div>
      <label for="cuotaImplicita">Cuota Implícita (calculada automáticamente)</label>
      <input type="number" id="cuotaImplicita" name="cuotaImplicita" step="0.01" readonly aria-readonly="true" placeholder="Ej: 1.66" />
    </div>
    <div>
      <label for="cuotaBookie">Cuota Bookie (decimal) *</label>
      <input type="number" id="cuotaBookie" name="cuotaBookie" min="1.01" step="0.01" placeholder="Ej: 1.80" required aria-required="true" />
    </div>
    <div>
      <label for="bankroll">Bankroll *</label>
      <input type="number" id="bankroll" name="bankroll" min="0.01" step="0.01" placeholder="Ej: 100" value="100" required aria-required="true" />
    </div>
    <div>
      <label for="kellyFrac">Fracción Kelly *</label>
      <select id="kellyFrac" name="kellyFrac" required aria-required="true">
        <option value="0.10">10%</option>
        <option value="0.25" selected>25%</option>
        <option value="0.33">33%</option>
        <option value="0.50">50%</option>
        <option value="1.00">100%</option>
      </select>
    </div>
    <div>
      <label for="stakePreview">Stake sugerido (preview)</label>
      <input type="number" id="stakePreview" readonly placeholder="0.00" />
    </div>
    <div style="align-self:end;">
      <button type="submit" aria-label="Agregar apuesta">Agregar apuesta</button>
    </div>
  </form>

  <!-- FILTROS -->
  <section class="filtros" aria-label="Filtros para el historial de apuestas">
    <input type="text" id="filtroLiga" placeholder="Filtrar por liga..." aria-label="Filtro por liga" />
    <input type="text" id="filtroLocal" placeholder="Filtrar por local..." aria-label="Filtro por equipo local" />
    <input type="text" id="filtroVisita" placeholder="Filtrar por visita..." aria-label="Filtro por equipo visitante" />

    <select id="filtroMercado" aria-label="Filtro por mercado">
      <option value="">Todos los mercados</option>
      <option value="Over 2.5 FT">Over 2.5 FT</option>
      <option value="Under 2.5 FT">Under 2.5 FT</option>
      <option value="Ambos Anotan">Ambos Anotan</option>
      <option value="BTTS NO">BTTS NO</option>
      <option value="Hándicap">Hándicap</option>
    </select>

    <select id="filtroEstado" aria-label="Filtro por estado de apuesta">
      <option value="">Todos los estados</option>
      <option value="pendiente">Pendiente</option>
      <option value="ganada">Ganada</option>
      <option value="perdida">Perdida</option>
    </select>

    <!-- NUEVOS: filtros por probabilidad -->
    <input type="number" id="filtroProbMin" placeholder="Prob. mín (%)" min="0" max="100" step="0.01" aria-label="Filtro por probabilidad mínima" />
    <input type="number" id="filtroProbMax" placeholder="Prob. máx (%)" min="0" max="100" step="0.01" aria-label="Filtro por probabilidad máxima" />

    <!-- Filtros por fecha -->
    <input type="date" id="filtroFechaInicio" aria-label="Filtro por fecha inicio" />
    <input type="date" id="filtroFechaFin" aria-label="Filtro por fecha fin" />

    <button id="btnLimpiarFiltros" title="Limpiar filtros" aria-label="Limpiar filtros">✖</button>
  </section>

  <!-- BOTONES UTILES -->
  <section class="botones-utiles" aria-label="Exportar o importar historial de apuestas">
    <button id="btnExportarCSV" title="Exportar historial a CSV">Exportar CSV</button>
    <button id="btnImportarJSON" title="Importar historial desde archivo JSON">Importar JSON</button>
    <input type="file" id="inputImportJSON" accept=".json" aria-label="Seleccionar archivo JSON para importar" />
    <button onclick="location.href='historial_ligas.html'" title="Ver historial por ligas">Historial por Ligas</button>
    <button onclick="location.href='probabilidades.html'" title="Ver estadísticas por probabilidad">Probabilidades</button>
    <!-- NUEVO: borrar todo -->
    <button id="btnEliminarTodo" class="btn-danger" title="Eliminar todo el historial">Eliminar todo</button>
  </section>

  <!-- TABLA -->
  <section aria-label="Historial de apuestas registradas">
    <div id="tablaWrapper">
      <table role="grid" aria-describedby="tableDescription" id="tablaHistorial" tabindex="0">
        <caption id="tableDescription" style="text-align:left; margin-bottom:12px; font-weight:700; font-size:1.2rem;">
          Historial de apuestas agregadas
        </caption>
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Fecha</th>
            <th scope="col">Liga</th>
            <th scope="col">Local</th>
            <th scope="col">Visita</th>
            <th scope="col">Mercado</th>
            <th scope="col">Prob (%)</th>
            <th scope="col">Cuota Implícita</th>
            <th scope="col">Cuota Bookie</th>
            <th scope="col">EV (%)</th>
            <th scope="col">Kelly FULL (%)</th>
            <th scope="col">Stake sugerido</th>
            <th scope="col">Estado</th>
            <th scope="col" aria-label="Acciones">⚙</th>
          </tr>
        </thead>
        <tbody><!-- Contenido generado por JS --></tbody>
      </table>
    </div>
  </section>

  <!-- RESUMEN -->
  <section id="resumen" aria-label="Resumen estadístico de apuestas">
    <div><strong>Bankroll inicial:</strong> <span id="resumenBankroll">-</span></div>
    <div><strong>Número apuestas:</strong> <span id="resumenNumApuestas">0</span></div>
    <div><strong>Apuestas ganadas:</strong> <span id="resumenGanadas">0</span></div>
    <div><strong>Apuestas perdidas:</strong> <span id="resumenPerdidas">0</span></div>
    <div><strong>Yield (%):</strong> <span id="resumenYield">0.00%</span></div>
    <div><strong>ROI (%):</strong> <span id="resumenROI">0.00%</span></div>
    <div><strong>Tasa de éxito (%):</strong> <span id="resumenTasaExito">0.00%</span></div>
    <div><strong>Unidades ganadas:</strong> <span id="resumenUnidades">0.00</span></div>
  </section>

  <!-- GRAFICAS -->
  <section id="graficas" aria-label="Gráficas de evolución del bankroll y Kelly">
    <canvas id="graficaBankroll" aria-label="Gráfica de evolución de bankroll"></canvas>
    <canvas id="graficaKelly" aria-label="Gráfica de Kelly Full"></canvas>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  'use strict';

  // Constantes y variables
  const STORAGE_KEY = 'historialApuestasProfesionalCompleto';

  // Elementos DOM
  const form = document.getElementById('formApuesta');
  const cuotaImplicitaInput = document.getElementById('cuotaImplicita');

  const filtroLiga = document.getElementById('filtroLiga');
  const filtroLocal = document.getElementById('filtroLocal');
  const filtroVisita = document.getElementById('filtroVisita');
  const filtroMercado = document.getElementById('filtroMercado');
  const filtroEstado = document.getElementById('filtroEstado');
  const filtroProbMin = document.getElementById('filtroProbMin');
  const filtroProbMax = document.getElementById('filtroProbMax');
  const filtroFechaInicio = document.getElementById('filtroFechaInicio');
  const filtroFechaFin = document.getElementById('filtroFechaFin');
  const btnLimpiarFiltros = document.getElementById('btnLimpiarFiltros');

  const tablaBody = document.querySelector('#tablaHistorial tbody');

  const resumenBankroll = document.getElementById('resumenBankroll');
  const resumenNumApuestas = document.getElementById('resumenNumApuestas');
  const resumenGanadas = document.getElementById('resumenGanadas');
  const resumenPerdidas = document.getElementById('resumenPerdidas');
  const resumenYield = document.getElementById('resumenYield');
  const resumenROI = document.getElementById('resumenROI');
  const resumenTasaExito = document.getElementById('resumenTasaExito');
  const resumenUnidades = document.getElementById('resumenUnidades');

  const btnExportarCSV = document.getElementById('btnExportarCSV');
  const btnImportarJSON = document.getElementById('btnImportarJSON');
  const inputImportJSON = document.getElementById('inputImportJSON');
  const btnEliminarTodo = document.getElementById('btnEliminarTodo');

  const ctxBankroll = document.getElementById('graficaBankroll').getContext('2d');
  const ctxKelly = document.getElementById('graficaKelly').getContext('2d');

  // Variables para gráficos
  let graficaBankroll = null;
  let graficaKelly = null;

  // Array para guardar apuestas
  let historial = [];

  // ------------------ Funciones auxiliares base ------------------
  function calcularCuotaImplicita(prob) {
    if (!(prob > 0)) return '';
    return (100 / prob).toFixed(2);
  }
  function calcularEV(prob, cuotaBookie) {
    if (!(prob > 0 && cuotaBookie > 1)) return 0;
    const p = prob / 100;
    return p * cuotaBookie - 1; // decimal (0.05 = 5%)
  }
  function calcularKelly(prob, cuotaBookie) {
    if (!(prob > 0 && cuotaBookie > 1)) return 0;
    const p = prob / 100;
    const b = cuotaBookie - 1;
    return (p * b - (1 - p)) / b; // decimal (0.05 = 5%)
  }
  function stakeSugerido(bankroll, kellyFull, kellyFrac) {
    if (!(bankroll > 0 && kellyFull > 0 && kellyFrac > 0)) return 0;
    const stake = bankroll * kellyFull * kellyFrac;
    return stake > bankroll ? bankroll : stake;
  }

  // ------------------ Utilidades de normalización para import ------------------
  const removeDiacritics = (s) => s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  const normalizeKey = (k) => removeDiacritics(String(k)).toLowerCase().replace(/[^a-z0-9]+/g,'');
  function getVal(obj, candidates) {
    const map = new Map(Object.keys(obj).map(k => [normalizeKey(k), k]));
    for (const c of candidates) {
      const nk = normalizeKey(c);
      if (map.has(nk)) return obj[map.get(nk)];
    }
    return undefined;
  }
  function toNumber(val) {
    if (typeof val === 'number') return val;
    if (val === null || val === undefined) return NaN;
    let s = String(val).trim();
    s = s.replace(/%/g,'').replace(/\s+/g,'').replace(/,/g,'.');
    if (s === '') return NaN;
    const n = parseFloat(s);
    return isNaN(n) ? NaN : n;
  }
  const monthMap = {
    ene:0, enero:0,
    feb:1, febrero:1,
    mar:2, marzo:2,
    abr:3, abril:3,
    may:4, mayo:4,
    jun:5, junio:5,
    jul:6, julio:6,
    ago:7, agosto:7,
    sep:8, set:8, sept:8, septiembre:8, setiembre:8,
    oct:9, octubre:9,
    nov:10, noviembre:10,
    dic:11, diciembre:11
  };
  function parseSpanishDate(str) {
    if (!str) return new Date();
    const raw = removeDiacritics(String(str)).toLowerCase().replace(/\./g,' ').replace(/,/g,' ').replace(/\s+/g,' ').trim();
    // Intenta "20 sept 2023 12:15"
    const m = raw.match(/(\d{1,2})\s+([a-z]+)\s+(\d{4})(?:\s+(\d{1,2}):(\d{2}))?/);
    if (m) {
      const day = parseInt(m[1],10);
      const monToken = m[2];
      const monKey = (monthMap[monToken] !== undefined) ? monToken
                      : monthMap[monToken.slice(0,4)] !== undefined ? monToken.slice(0,4)
                      : monthMap[monToken.slice(0,3)] !== undefined ? monToken.slice(0,3)
                      : null;
      const month = monKey !== null ? monthMap[monKey] : undefined;
      if (month !== undefined) {
        const year = parseInt(m[3],10);
        const hh = m[4] ? parseInt(m[4],10) : 12;
        const mm = m[5] ? parseInt(m[5],10) : 0;
        return new Date(year, month, day, hh, mm, 0);
      }
    }
    const d2 = new Date(str);
    return isNaN(d2) ? new Date() : d2;
  }
  function splitMatch(what) {
    if (!what) return ['', ''];
    const s = String(what).replace(/vs\.?|v\.s\.?/gi, '-');
    const parts = s.split('-');
    if (parts.length >= 2) return [parts[0].trim(), parts.slice(1).join('-').trim()];
    return [String(what).trim(), ''];
  }
  function mapOutcome(x) {
    const s = String(x || '').toLowerCase();
    if (/gg\b|btts\s*si|btts\s*s[ií]|ambos/.test(s)) return 'Ambos Anotan';
    if (/ng\b|btts\s*no/.test(s)) return 'BTTS NO';
    if ((/over/.test(s) || /\bo\d+(\.\d+)?\b/.test(s)) && /2(\.|,)?5/.test(s)) return 'Over 2.5 FT';
    if ((/under/.test(s) || /\bu\d+(\.\d+)?\b/.test(s)) && /2(\.|,)?5/.test(s)) return 'Under 2.5 FT';
    if (/handicap|h.ndicap/i.test(s)) return 'Hándicap';
    return x || '';
  }
  function mapEstado(x) {
  const s = String(x || '').trim().toLowerCase();

  // GANADA
  if (
    /\bwin(n?ing)?\b/.test(s) ||   // win, winning
    /\bwon\b/.test(s) ||
    /ganad[ao]s?/.test(s) ||       // ganada, ganadas, ganado, ganados
    /\bgreen\b/.test(s)            // a veces usan "green"
  ) return 'ganada';

  // PERDIDA
  if (
    /\blos(e|ing|t)\b/.test(s) ||  // lose, losing, lost
    /\bloss\b/.test(s) ||
    /perdid[ao]s?/.test(s) ||      // perdida, perdidas, perdido, perdidos
    /\bred\b/.test(s)              // a veces usan "red"
  ) return 'perdida';

  // NULA / CANCELADA → lo dejamos como pendiente en este sistema
  if (
    /\bvoid(ed)?\b/.test(s) ||
    /cancel(l?ed|ar|ada)/.test(s) ||
    /\bpush\b/.test(s) ||
    /\brefund(ed)?\b/.test(s) ||
    /nula|anulada/.test(s)
  ) return 'pendiente';

  // Desconocido → pendiente
  return 'pendiente';
}

  function recordFromExternal(rec) {
    // Lee valores
    const rawDate = getVal(rec, ['Date','Fecha']);
    const rawLeague = getVal(rec, ['League','Liga']);
    const rawMatch  = getVal(rec, ['Match','Partido']);
    const rawOutcome = getVal(rec, ['Desired Outcome','Outcome','Mercado']);
    let prob = toNumber(getVal(rec, ['Prob(%)','Prob','Probability','Probabilidad']));
    const implied = toNumber(getVal(rec, ['Cuota Implícita','Cuota Implicita','Cuota Impl�cita','Implied Odds']));
    const odd = toNumber(getVal(rec, ['Odd','Cuota','Cuota Bookie','Precio','Decimal Odds']));
    const result = getVal(rec, ['Result','Estado','Resultado']);

    // Si no viene probabilidad, intenta desde cuota implícita
    if (!(prob > 0) && implied > 0) prob = 100 / implied;

    // Parseos
    const fechaISO = parseSpanishDate(rawDate).toISOString();
    const liga = (rawLeague ? String(rawLeague) : 'Sin liga').trim();
    const [local, visita] = splitMatch(rawMatch);
    const mercado = mapOutcome(rawOutcome);

    // Parámetros actuales de stake
    const bankrollActual = parseFloat(document.getElementById('bankroll').value) || 100;
    const kellyFracActual = parseFloat(document.getElementById('kellyFrac').value) || 0.25;

    // Cálculos
    const cuotaImplicitaCalc = prob > 0 ? parseFloat((100 / prob).toFixed(2)) : '';
    const ev = calcularEV(prob, odd);
    const kellyFull = calcularKelly(prob, odd);

    return {
      id: Date.now() + Math.random(),
      fecha: fechaISO,
      liga, local, visita, mercado,
      probabilidad: prob > 0 ? prob : 0,
      cuotaImplicita: cuotaImplicitaCalc || '',
      cuotaBookie: odd > 0 ? odd : 0,
      ev, kellyFull,
      bankroll: bankrollActual,
      kellyFrac: kellyFracActual,
      estado: mapEstado(result)
    };
  }

  // Guardar y cargar localStorage
  function guardarHistorial() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(historial));
  }
  function cargarHistorial() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (data) {
      try { historial = JSON.parse(data); } catch { historial = []; }
    }
  }

  // Limpiar filtros
  function limpiarFiltros() {
    filtroLiga.value = '';
    filtroLocal.value = '';
    filtroVisita.value = '';
    filtroMercado.value = '';
    filtroEstado.value = '';
    filtroProbMin.value = '';
    filtroProbMax.value = '';
    filtroFechaInicio.value = '';
    filtroFechaFin.value = '';
  }

  // Filtrar apuestas
  function filtrarHistorial() {
    return historial.filter(a => {
      if (filtroLiga.value && !a.liga.toLowerCase().includes(filtroLiga.value.toLowerCase())) return false;
      if (filtroLocal.value && !a.local.toLowerCase().includes(filtroLocal.value.toLowerCase())) return false;
      if (filtroVisita.value && !a.visita.toLowerCase().includes(filtroVisita.value.toLowerCase())) return false;
      if (filtroMercado.value && a.mercado !== filtroMercado.value) return false;
      if (filtroEstado.value && a.estado !== filtroEstado.value) return false;

      const p = Number(a.probabilidad) || 0;
      const min = filtroProbMin.value !== '' ? parseFloat(filtroProbMin.value) : null;
      const max = filtroProbMax.value !== '' ? parseFloat(filtroProbMax.value) : null;
      if (min !== null && p < min) return false;
      if (max !== null && p > max) return false;

      if (filtroFechaInicio.value) {
        const fechaIni = new Date(filtroFechaInicio.value);
        if (new Date(a.fecha) < fechaIni) return false;
      }
      if (filtroFechaFin.value) {
        const fechaFin = new Date(filtroFechaFin.value);
        fechaFin.setHours(23, 59, 59, 999);
        if (new Date(a.fecha) > fechaFin) return false;
      }
      return true;
    });
  }

  // Renderizar tabla
  function renderizarTabla() {
    const apuestas = filtrarHistorial().slice().reverse();
    tablaBody.innerHTML = '';
    apuestas.forEach((a, i) => {
      const tr = document.createElement('tr');

      const tdIndex = document.createElement('td'); tdIndex.textContent = i + 1; tr.appendChild(tdIndex);

      const tdFecha = document.createElement('td');
      tdFecha.textContent = new Date(a.fecha).toLocaleDateString();
      tr.appendChild(tdFecha);

      const tdLiga = document.createElement('td');
      tdLiga.textContent = a.liga;
      tdLiga.addEventListener('dblclick', () => {
        const input = document.createElement('input');
        input.type = 'text'; input.value = a.liga; input.style.width = "100%";
        tdLiga.textContent = ''; tdLiga.appendChild(input); input.focus();
        input.addEventListener('blur', () => { a.liga = input.value.trim() || a.liga; guardarHistorial(); actualizarVista(); });
        input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); });
      });
      tr.appendChild(tdLiga);

      const tdLocal = document.createElement('td'); tdLocal.textContent = a.local; tr.appendChild(tdLocal);
      const tdVisita = document.createElement('td'); tdVisita.textContent = a.visita; tr.appendChild(tdVisita);
      const tdMercado = document.createElement('td'); tdMercado.textContent = a.mercado; tr.appendChild(tdMercado);

      const tdProb = document.createElement('td'); tdProb.textContent = (Number(a.probabilidad) || 0).toFixed(2); tr.appendChild(tdProb);

      const tdCuotaImpl = document.createElement('td');
      const impl = a.cuotaImplicita !== '' && a.cuotaImplicita !== null ? a.cuotaImplicita : calcularCuotaImplicita(a.probabilidad);
      tdCuotaImpl.textContent = impl !== '' ? Number(impl).toFixed(2) : '-';
      tr.appendChild(tdCuotaImpl);

      const tdCuotaBookie = document.createElement('td'); tdCuotaBookie.textContent = (Number(a.cuotaBookie) || 0).toFixed(2); tr.appendChild(tdCuotaBookie);

      const tdEV = document.createElement('td');
      tdEV.textContent = ((a.ev || 0) * 100).toFixed(2);
      tdEV.style.color = (a.ev || 0) >= 0 ? '#4caf50' : '#ef4444';
      tr.appendChild(tdEV);

      const tdKelly = document.createElement('td');
      tdKelly.textContent = a.kellyFull ? (a.kellyFull * 100).toFixed(2) : '-';
      tdKelly.style.color = a.kellyFull && a.kellyFull > 0 ? '#4caf50' : '#c4c4cc';
      tr.appendChild(tdKelly);

      const stake = stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac);
      const tdStake = document.createElement('td'); tdStake.textContent = stake.toFixed(2); tr.appendChild(tdStake);

      const tdEstado = document.createElement('td');
      tdEstado.textContent = a.estado; tdEstado.className = `status-${a.estado}`; tr.appendChild(tdEstado);

      const tdAcciones = document.createElement('td'); tdAcciones.className = 'acciones';
      const btnGanada = document.createElement('button'); btnGanada.title='Marcar como ganada'; btnGanada.innerHTML='✅';
      btnGanada.addEventListener('click', () => cambiarEstado(a.id, 'ganada'));
      const btnPerdida = document.createElement('button'); btnPerdida.title='Marcar como perdida'; btnPerdida.innerHTML='❌';
      btnPerdida.addEventListener('click', () => cambiarEstado(a.id, 'perdida'));
      const btnPendiente = document.createElement('button'); btnPendiente.title='Marcar como pendiente'; btnPendiente.innerHTML='⏳';
      btnPendiente.addEventListener('click', () => cambiarEstado(a.id, 'pendiente'));
      const btnBorrar = document.createElement('button'); btnBorrar.title='Eliminar apuesta'; btnBorrar.innerHTML='🗑️';
      btnBorrar.addEventListener('click', () => eliminarApuesta(a.id));
      tdAcciones.append(btnGanada, btnPerdida, btnPendiente, btnBorrar);
      tr.appendChild(tdAcciones);

      tablaBody.appendChild(tr);
    });
  }

  // Cambiar estado apuesta
  function cambiarEstado(id, nuevoEstado) {
    const index = historial.findIndex(a => a.id === id);
    if (index !== -1) {
      historial[index].estado = nuevoEstado;
      guardarHistorial();
      actualizarVista();
    }
  }

  // Eliminar apuesta
  function eliminarApuesta(id) {
    if (!confirm('¿Estás seguro de eliminar esta apuesta?')) return;
    historial = historial.filter(a => a.id !== id);
    guardarHistorial();
    actualizarVista();
  }

// ---- Eliminar TODO el historial ----
btnEliminarTodo.addEventListener('click', () => {
  if (!confirm('⚠️ ¿Seguro que quieres eliminar TODO el historial? Esta acción no se puede deshacer.')) return;
  
  historial = []; // vaciar array
  localStorage.removeItem(STORAGE_KEY); // borrar del storage
  actualizarVista(); // refrescar tabla, resumen y gráficas

  // por si había archivo seleccionado en el input de importación
  inputImportJSON.value = '';

  alert('Historial eliminado ✅');
});

  // Actualizar resumen estadístico
  function actualizarResumen() {
    const apuestasFiltradas = filtrarHistorial();
    if (apuestasFiltradas.length === 0) {
      resumenBankroll.textContent = '-';
      resumenNumApuestas.textContent = '0';
      resumenGanadas.textContent = '0';
      resumenPerdidas.textContent = '0';
      resumenYield.textContent = '0.00%';
      resumenROI.textContent = '0.00%';
      resumenTasaExito.textContent = '0.00%';
      resumenUnidades.textContent = '0.00';
      return;
    }

    const bankrollInicial = apuestasFiltradas[0].bankroll || 0;
    resumenBankroll.textContent = bankrollInicial.toFixed(2);

    const numApuestas = apuestasFiltradas.length;
    resumenNumApuestas.textContent = numApuestas;

    const ganadas = apuestasFiltradas.filter(a => a.estado === 'ganada').length;
    const perdidas = apuestasFiltradas.filter(a => a.estado === 'perdida').length;
    resumenGanadas.textContent = ganadas;
    resumenPerdidas.textContent = perdidas;

    const tasaExito = numApuestas > 0 ? (ganadas / numApuestas) * 100 : 0;
    resumenTasaExito.textContent = tasaExito.toFixed(2) + '%';

    // Yield y ROI usando stakes calculados
    let totalGanado = 0;
    let totalApostado = 0;
    apuestasFiltradas.forEach(a => {
      const stake = stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac);
      totalApostado += stake;
      if (a.estado === 'ganada') totalGanado += stake * a.cuotaBookie;
      if (a.estado === 'perdida') totalGanado += 0;
    });
    const neto = totalGanado - totalApostado;
    const yieldPct = totalApostado > 0 ? (neto / totalApostado) * 100 : 0;
    resumenYield.textContent = yieldPct.toFixed(2) + '%';

    const roiPct = bankrollInicial > 0 ? (neto / bankrollInicial) * 100 : 0;
    resumenROI.textContent = roiPct.toFixed(2) + '%';
    resumenUnidades.textContent = neto.toFixed(2);
  }

  // Actualizar gráficas
  function actualizarGraficas() {
    const apuestasFiltradas = filtrarHistorial();

    if (graficaBankroll) graficaBankroll.destroy();
    if (graficaKelly) graficaKelly.destroy();

    if (apuestasFiltradas.length === 0) return;

    // Datos para gráfica de bankroll
    let bankInicial = apuestasFiltradas[0].bankroll || 100;
    let bankData = [bankInicial];
    let labels = ['Inicio'];

    apuestasFiltradas.forEach((a, i) => {
      const stake = stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac);
      let lastBank = bankData[bankData.length - 1];
      let nuevoBank = lastBank;
      if (a.estado === 'ganada') {
        nuevoBank += stake * (a.cuotaBookie - 1);
      } else if (a.estado === 'perdida') {
        nuevoBank -= stake;
      }
      bankData.push(nuevoBank);
      labels.push(`Apuesta ${i + 1}`);
    });

    graficaBankroll = new Chart(ctxBankroll, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Bankroll',
          data: bankData,
          borderColor: '#8257e6',
          backgroundColor: 'rgba(130, 87, 230, 0.3)',
          fill: true,
          tension: 0.3,
          pointRadius: 3,
          pointHoverRadius: 6,
          borderWidth: 3,
        }]
      },
      options: {
        responsive: true,
        interaction: { mode: 'nearest', intersect: false },
        plugins: {
          legend: { labels: { color: '#ddd', font: { size: 14, weight: '600' } } },
          tooltip: { callbacks: { label: ctx => `Bankroll: ${ctx.parsed.y.toFixed(2)}` } }
        },
        scales: {
          y: { beginAtZero: false, ticks: { color: '#ddd' }, grid: { color: '#444' } },
          x: { ticks: { color: '#ddd' }, grid: { color: '#444' } }
        }
      }
    });

    // Datos para gráfica Kelly Full
    let kellyData = apuestasFiltradas.map(a => a.kellyFull ? a.kellyFull * 100 : 0);

    graficaKelly = new Chart(ctxKelly, {
      type: 'bar',
      data: {
        labels: labels.slice(1),
        datasets: [{ label: 'Kelly FULL (%)', data: kellyData, backgroundColor: '#ffba08', borderRadius: 4 }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, max: 100, ticks: { color: '#ddd' }, grid: { color: '#444' } },
          x: { ticks: { color: '#ddd' }, grid: { color: '#444' } }
        },
        plugins: { legend: { labels: { color: '#ddd', font: { size: 14, weight: '600' } } } }
      }
    });
  }

  // Actualizar toda la vista
  function actualizarVista() {
    renderizarTabla();
    actualizarResumen();
    actualizarGraficas();
  }

  // Envío de formulario
  form.addEventListener('submit', e => {
    e.preventDefault();
    const formData = new FormData(form);
    try {
      // Validaciones
      const liga = formData.get('liga').trim();
      const local = formData.get('local').trim();
      const visita = formData.get('visita').trim();
      const mercado = formData.get('mercado');
      const prob = parseFloat(formData.get('probabilidad'));
      const cuotaBookie = parseFloat(formData.get('cuotaBookie'));
      const bankroll = parseFloat(formData.get('bankroll'));
      const kellyFrac = parseFloat(formData.get('kellyFrac'));

      if (!liga) throw new Error('La liga es requerida');
      if (!local) throw new Error('Equipo local es requerido');
      if (!visita) throw new Error('Equipo visitante es requerido');
      if (!mercado) throw new Error('Selecciona un mercado');
      if (!(prob > 0 && prob <= 100)) throw new Error('Probabilidad debe estar entre 0 y 100');
      if (!(cuotaBookie > 1)) throw new Error('Cuota bookie debe ser mayor que 1');
      if (!(bankroll > 0)) throw new Error('Bankroll debe ser mayor que 0');
      if (!(kellyFrac > 0 && kellyFrac <= 1)) throw new Error('Fracción Kelly inválida');

      const cuotaImplicitaCalc = parseFloat(calcularCuotaImplicita(prob));
      const ev = calcularEV(prob, cuotaBookie);
      const kellyFull = calcularKelly(prob, cuotaBookie);

      const apuesta = {
        id: Date.now(),
        fecha: new Date().toISOString(),
        liga, local, visita, mercado,
        probabilidad: prob,
        cuotaImplicita: cuotaImplicitaCalc,
        cuotaBookie, ev, kellyFull,
        bankroll, kellyFrac,
        estado: 'pendiente'
      };

      historial.push(apuesta);
      guardarHistorial();
      form.reset();
      cuotaImplicitaInput.value = '';
      actualizarVista();
      alert('Apuesta agregada correctamente');
    } catch (error) {
      alert('Error al agregar apuesta: ' + error.message);
    }
  });

  // Calcular cuota implícita al cambiar probabilidad
  document.getElementById('probabilidad').addEventListener('input', e => {
    const valorProb = parseFloat(e.target.value);
    cuotaImplicitaInput.value = calcularCuotaImplicita(valorProb);
  });

  // Preview de stake sugerido
  const cuotaBookieInput = document.getElementById('cuotaBookie');
  const bankrollInput = document.getElementById('bankroll');
  const kellyFracInput = document.getElementById('kellyFrac');
  const stakePreviewInput = document.getElementById('stakePreview');

  function actualizarStakePreview() {
    const prob = parseFloat(document.getElementById('probabilidad').value);
    const cuotaBookie = parseFloat(cuotaBookieInput.value);
    const bankroll = parseFloat(bankrollInput.value);
    const kellyFrac = parseFloat(kellyFracInput.value);
    if (!(prob > 0 && cuotaBookie > 1 && bankroll > 0 && kellyFrac > 0)) { stakePreviewInput.value = ""; return; }
    const kellyFull = calcularKelly(prob, cuotaBookie);
    const stake = stakeSugerido(bankroll, kellyFull, kellyFrac);
    stakePreviewInput.value = stake.toFixed(2);
  }

  ['input','change'].forEach(evt => {
    document.getElementById('probabilidad').addEventListener(evt, actualizarStakePreview);
    cuotaBookieInput.addEventListener(evt, actualizarStakePreview);
    bankrollInput.addEventListener(evt, actualizarStakePreview);
    kellyFracInput.addEventListener(evt, actualizarStakePreview);
  });

  // Filtros
  [filtroLiga, filtroLocal, filtroVisita, filtroMercado, filtroEstado,
   filtroProbMin, filtroProbMax, filtroFechaInicio, filtroFechaFin].forEach(el => {
    el.addEventListener('input', actualizarVista);
    el.addEventListener('change', actualizarVista);
  });

  btnLimpiarFiltros.addEventListener('click', e => {
    e.preventDefault();
    limpiarFiltros();
    actualizarVista();
  });

  // --------- Exportar CSV ----------
  btnExportarCSV.addEventListener('click', () => {
    if (historial.length === 0) { alert('No hay datos para exportar'); return; }
    const csvRows = [];
    const headers = [
      'id','fecha','liga','local','visita','mercado',
      'probabilidad','cuotaImplicita','cuotaBookie','ev','kellyFull','bankroll','kellyFrac','estado'
    ];
    csvRows.push(headers.join(','));

    historial.forEach(a => {
      csvRows.push([
        a.id, a.fecha,
        `"${a.liga}"`, `"${a.local}"`, `"${a.visita}"`,
        `"${a.mercado}"`, a.probabilidad, a.cuotaImplicita, a.cuotaBookie,
        a.ev, a.kellyFull, a.bankroll, a.kellyFrac, a.estado
      ].join(','));
    });

    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url; link.download = 'historial_apuestas.csv';
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
  });

  // ---------- Importar JSON (con mapeo y cálculos) ----------
  btnImportarJSON.addEventListener('click', () => inputImportJSON.click());

  inputImportJSON.addEventListener('change', (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        let data = JSON.parse(event.target.result);

        // Acepta objeto único
        if (!Array.isArray(data)) data = [data];

        // Detecta si ya está en formato interno (tiene 'liga' y 'cuotaBookie') o es externo
        let importados = 0;
        data.forEach(item => {
          let apuesta;
          const isInternal =
            ('liga' in item) && ('cuotaBookie' in item) && ('probabilidad' in item);

          if (isInternal) {
            // Normaliza mínimos
            apuesta = {
              id: item.id || Date.now() + Math.random(),
              fecha: item.fecha || new Date().toISOString(),
              liga: item.liga || 'Sin liga',
              local: item.local || '',
              visita: item.visita || '',
              mercado: item.mercado || '',
              probabilidad: Number(item.probabilidad) || 0,
              cuotaImplicita: item.cuotaImplicita !== undefined ? item.cuotaImplicita : (Number(item.probabilidad) ? Number((100/Number(item.probabilidad)).toFixed(2)) : ''),
              cuotaBookie: Number(item.cuotaBookie) || 0,
              ev: (typeof item.ev === 'number') ? item.ev : calcularEV(Number(item.probabilidad)||0, Number(item.cuotaBookie)||0),
              kellyFull: (typeof item.kellyFull === 'number') ? item.kellyFull : calcularKelly(Number(item.probabilidad)||0, Number(item.cuotaBookie)||0),
              bankroll: Number(item.bankroll) || (parseFloat(bankrollInput.value)||100),
              kellyFrac: Number(item.kellyFrac) || (parseFloat(kellyFracInput.value)||0.25),
              estado: item.estado || 'pendiente'
            };
          } else {
            // Formato externo (como el ejemplo del usuario)
            apuesta = recordFromExternal(item);
          }

          historial.push(apuesta);
          importados++;
        });

        guardarHistorial();
        actualizarVista();
        alert(`Importación exitosa ✅  Registros añadidos: ${importados}`);
        inputImportJSON.value = '';
      } catch (err) {
        console.error(err);
        alert('Error al importar el archivo JSON. Verifica el formato.');
      }
    };
    reader.readAsText(file);
  });

  // Inicialización
  function init() {
    cargarHistorial();
    actualizarVista();
  }
  init();

})();
</script>
</body>
</html>
