<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poisson Predictor Pro</title>
    <style>
        :root { --primary: #003049; --accent: #d62828; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--primary); margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .league-selector { text-align: center; margin-bottom: 25px; }
        .grid-selects { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .team-box { background: #f1f3f5; padding: 20px; border-radius: 10px; border-left: 5px solid var(--primary); }
        select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; margin-top: 10px; }
        button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #00507a; transform: translateY(-2px); }
        #loading { text-align: center; color: var(--accent); font-weight: bold; display: none; }
        .results-panel { margin-top: 40px; display: none; animation: fadeIn 0.5s; }
        .score-display { text-align: center; font-size: 48px; font-weight: bold; color: var(--primary); margin: 20px 0; }
        .prob-bar-container { height: 30px; display: flex; border-radius: 15px; overflow: hidden; margin: 20px 0; border: 1px solid #ddd; }
        .prob-bar { display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: bold; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1>Calculadora de Poisson Automatizada</h1>

    <div class="league-selector">
        <label>Seleccionar Liga:</label><br>
        <select id="sheetSelect" onchange="cambiarLiga()">
            <option value="ESP">España (La Liga)</option>
            <option value="ENG">Inglaterra (Premier League)</option>
            <option value="ITA">Italia (Serie A)</option>
            <option value="FRA">Francia (Ligue 1)</option>
            <option value="GER">Alemania (Bundesliga)</option>
        </select>
    </div>

    <div id="loading">Actualizando datos desde el archivo...</div>

    <div class="grid-selects">
        <div class="team-box">
            <label><strong>Local</strong></label>
            <select id="localSelect"></select>
        </div>
        <div class="team-box">
            <label><strong>Visitante</strong></label>
            <select id="visitanteSelect"></select>
        </div>
    </div>

    <button onclick="predecir()">GENERAR PREDICCIÓN</button>

    <div id="results" class="results-panel">
        <div class="score-display" id="marcadorFinal">0 - 0</div>
        
        <h3 style="text-align: center; color: #666;">Probabilidades 1 X 2</h3>
        <div class="prob-bar-container">
            <div id="barL" class="prob-bar" style="background: #2a9d8f;">L</div>
            <div id="barE" class="prob-bar" style="background: #e9c46a;">X</div>
            <div id="barV" class="prob-bar" style="background: #e76f51;">V</div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center; margin-top: 20px;">
            <div style="background: #eee; padding: 15px; border-radius: 8px;">
                <strong>Expectativa Goles</strong><br>
                <span id="expGoles"></span>
            </div>
            <div style="background: #eee; padding: 15px; border-radius: 8px;">
                <strong>Ambos Anotan</strong><br>
                <span id="bttsProb"></span>
            </div>
        </div>
    </div>
</div>

<script>
const SHEET_ID = '1lmUPv7SP0XYi9ns4jkj3RTCScxIN2pCfBJyMUp_kNRI';
let datosLiga = { locales: {}, visitantes: {}, avgL: 0, avgV: 0 };

async function cargarDatos(pestaña) {
    document.getElementById('loading').style.display = 'block';
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${pestaña}`;
    
    try {
        const response = await fetch(url);
        const csv = await response.text();
        const filas = csv.split('\n').map(r => r.split(',').map(c => c.replace(/"/g, '')));

        datosLiga.locales = {};
        datosLiga.visitantes = {};
        let tGL = 0, tGV = 0, tPJL = 0, tPJV = 0;

        // El formato detectado tiene el nombre en col index 1
        filas.forEach((cols, i) => {
            if (i > 0 && cols[1] && !isNaN(parseFloat(cols[2]))) {
                const nombre = cols[1].trim();
                const pj = parseFloat(cols[2]);
                const gf = parseFloat(cols[6]);
                const ga = parseFloat(cols[7]);

                // Identificamos si es la tabla de la izquierda (Local) o derecha (Visitante)
                // En tu archivo están una al lado de la otra o debajo.
                // Esta lógica asume el procesamiento secuencial del CSV:
                if (!datosLiga.locales[nombre]) {
                    datosLiga.locales[nombre] = { pj, gf, ga };
                    tGL += gf; tPJL += pj;
                } else {
                    datosLiga.visitantes[nombre] = { pj, gf, ga };
                    tGV += gf; tPJV += pj;
                }
            }
        });

        datosLiga.avgL = tGL / tPJL;
        datosLiga.avgV = tGV / tPJV;

        poblarMenu();
        document.getElementById('loading').style.display = 'none';
    } catch (e) {
        alert("Error al conectar con los datos. Asegúrate de que el Sheets sea público.");
    }
}

function poblarMenu() {
    const sL = document.getElementById('localSelect');
    const sV = document.getElementById('visitanteSelect');
    sL.innerHTML = ""; sV.innerHTML = "";
    
    Object.keys(datosLiga.locales).sort().forEach(equipo => {
        sL.add(new Option(equipo, equipo));
        sV.add(new Option(equipo, equipo));
    });
}

function cambiarLiga() {
    cargarDatos(document.getElementById('sheetSelect').value);
}

function factorial(n) { return n <= 1 ? 1 : n * factorial(n - 1); }
function poisson(k, lambda) { return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k); }

function predecir() {
    const nL = document.getElementById('localSelect').value;
    const nV = document.getElementById('visitanteSelect').value;

    const loc = datosLiga.locales[nL];
    const vis = datosLiga.visitantes[nV];

    // Cálculo interno de Lambdas
    const lambdaL = (loc.gf / loc.pj / datosLiga.avgL) * (vis.ga / vis.pj / datosLiga.avgV) * datosLiga.avgL;
    const lambdaV = (vis.gf / vis.pj / datosLiga.avgV) * (loc.ga / loc.pj / datosLiga.avgL) * datosLiga.avgV;

    let pL = 0, pE = 0, pV = 0, btts = 0;
    
    for (let i = 0; i < 8; i++) {
        for (let j = 0; j < 8; j++) {
            let p = poisson(i, lambdaL) * poisson(j, lambdaV);
            if (i > j) pL += p; else if (i === j) pE += p; else pV += p;
            if (i > 0 && j > 0) btts += p;
        }
    }

    // Mostrar resultados
    document.getElementById('results').style.display = 'block';
    document.getElementById('marcadorFinal').innerText = `${Math.round(lambdaL)} - ${Math.round(lambdaV)}`;
    document.getElementById('expGoles').innerText = `${lambdaL.toFixed(2)} vs ${lambdaV.toFixed(2)}`;
    document.getElementById('bttsProb').innerText = `${(btts * 100).toFixed(1)}%`;

    document.getElementById('barL').style.width = (pL * 100) + "%";
    document.getElementById('barL').innerText = `L: ${(pL * 100).toFixed(0)}%`;
    document.getElementById('barE').style.width = (pE * 100) + "%";
    document.getElementById('barE').innerText = `X: ${(pE * 100).toFixed(0)}%`;
    document.getElementById('barV').style.width = (pV * 100) + "%";
    document.getElementById('barV').innerText = `V: ${(pV * 100).toFixed(0)}%`;
}

// Carga inicial
cargarDatos('ESP');
</script>

</body>
</html>
