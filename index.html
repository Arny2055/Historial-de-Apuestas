<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetAGS - Poisson Pro Dark</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* PersonalizaciÃ³n de colores de marca y modo oscuro */
        :root {
            --bet-green: #006341;
            --bet-yellow: #ffeb00;
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --dark-border: #334155;
        }
        body { background-color: var(--dark-bg); color: #f8fafc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .bg-bet-green { background-color: var(--bet-green); }
        .text-bet-yellow { color: var(--bet-yellow); }
        .border-bet-dark { border-color: var(--dark-border); }
        
        /* Estilos de inputs para modo oscuro */
        input, select {
            background-color: #334155 !important;
            color: white !important;
            border-color: #475569 !important;
        }
        input:focus {
            outline: 2px solid var(--bet-yellow) !important;
            border-color: transparent !important;
        }
        .highlight-row {
            background-color: rgba(0, 99, 65, 0.2);
            border-left: 4px solid var(--bet-yellow);
        }
    </style>
</head>
<body class="font-sans">

    <nav class="bg-bet-green text-white p-4 shadow-2xl border-b border-yellow-500/30">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold italic tracking-tighter">Bet<span class="text-bet-yellow">AGS</span> <span class="text-xs font-normal uppercase opacity-70 ml-2 italic">Pro Dark Mode</span></h1>
            <div class="space-x-4">
                <button onclick="showTab('calc')" class="hover:text-bet-yellow font-semibold transition-colors">Calculadora</button>
                <button onclick="showTab('control')" class="hover:text-bet-yellow font-semibold transition-colors">GestiÃ³n de Bank</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-6xl">
        
        <div id="calc" class="tab-content active space-y-6">
            
            <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-bet-yellow">
                    <span class="bg-bet-green p-1 rounded">ðŸ“Š</span> Promedios de la Liga
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-400 mb-1">League Home AVG (Goles Local)</label>
                        <input type="number" id="league_home_avg" step="0.01" class="w-full p-3 rounded-lg border" value="1.81">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-400 mb-1">League Away AVG (Goles Visitante)</label>
                        <input type="number" id="league_away_avg" step="0.01" class="w-full p-3 rounded-lg border" value="1.45">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
                    <h2 class="text-lg font-bold mb-4 border-b border-slate-700 pb-2">Datos del Encuentro</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2 text-xs font-bold text-blue-400 uppercase">Local</div>
                        <div>
                            <label class="block text-xs mb-1">GF Promedio</label>
                            <input type="number" id="home_gf_avg" step="0.01" class="w-full p-2 rounded" placeholder="2.50">
                        </div>
                        <div>
                            <label class="block text-xs mb-1">GC Promedio</label>
                            <input type="number" id="home_gc_avg" step="0.01" class="w-full p-2 rounded" placeholder="1.20">
                        </div>
                        <div class="col-span-2 text-xs font-bold text-orange-400 uppercase mt-2">Visitante</div>
                        <div>
                            <label class="block text-xs mb-1">GF Promedio</label>
                            <input type="number" id="away_gf_avg" step="0.01" class="w-full p-2 rounded" placeholder="1.50">
                        </div>
                        <div>
                            <label class="block text-xs mb-1">GC Promedio</label>
                            <input type="number" id="away_gc_avg" step="0.01" class="w-full p-2 rounded" placeholder="1.10">
                        </div>
                    </div>
                    <button onclick="calcularPoisson()" class="mt-6 w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold transition-all shadow-lg active:scale-95">
                        GENERAR PRONÃ“STICO XG
                    </button>
                </div>

                <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
                    <h2 class="text-lg font-bold mb-4 border-b border-slate-700 pb-2">Cuotas Actuales (Bookie)</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs mb-1 text-slate-400">Over 2.5</label>
                            <input type="number" id="odds_over" step="0.01" class="w-full p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-400">Under 2.5</label>
                            <input type="number" id="odds_under" step="0.01" class="w-full p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-400">BTTS SÃ­</label>
                            <input type="number" id="odds_btts_yes" step="0.01" class="w-full p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-400">BTTS No</label>
                            <input type="number" id="odds_btts_no" step="0.01" class="w-full p-2 rounded">
                        </div>
                    </div>
                    <div class="mt-8 p-4 bg-slate-900 rounded-lg border border-slate-700">
                        <p class="text-sm text-center italic text-slate-400">"El criterio de Kelly se activarÃ¡ al 25% si el Edge estÃ¡ entre 3% y 15%."</p>
                    </div>
                </div>
            </div>

            <div id="results_area" class="mt-6 hidden animate-in fade-in duration-500">
                <div class="bg-slate-800 p-6 rounded-xl shadow-2xl border border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">AnÃ¡lisis de Probabilidades</h2>
                        <div id="overround_info" class="px-3 py-1 bg-slate-900 rounded-full text-xs font-mono text-bet-yellow border border-bet-yellow/30"></div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-900 text-bet-yellow uppercase text-xs">
                                    <th class="p-3 border-b border-slate-700">Mercado</th>
                                    <th class="p-3 border-b border-slate-700">Prob %</th>
                                    <th class="p-3 border-b border-slate-700">Cuota Justa</th>
                                    <th class="p-3 border-b border-slate-700">Edge %</th>
                                    <th class="p-3 border-b border-slate-700">Stake Suggested</th>
                                    <th class="p-3 border-b border-slate-700 text-center">AcciÃ³n</th>
                                </tr>
                            </thead>
                            <tbody id="table_body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="control" class="tab-content space-y-6">
            <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
                <h2 class="text-2xl font-bold mb-6 text-bet-yellow">Rendimiento HistÃ³rico</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="p-4 bg-slate-900 rounded-lg border border-slate-700">
                        <p class="text-xs text-slate-400 uppercase">Total Picks</p>
                        <p id="stat_count" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="p-4 bg-slate-900 rounded-lg border border-slate-700">
                        <p class="text-xs text-slate-400 uppercase">Profit Neto</p>
                        <p id="stat_profit" class="text-2xl font-bold">$0.00</p>
                    </div>
                    <div class="p-4 bg-slate-900 rounded-lg border border-slate-700">
                        <p class="text-xs text-slate-400 uppercase">Yield</p>
                        <p id="stat_yield" class="text-2xl font-bold">0%</p>
                    </div>
                    <div class="p-4 bg-slate-900 rounded-lg border border-slate-700">
                        <p class="text-xs text-slate-400 uppercase">ROI</p>
                        <p id="stat_roi" class="text-2xl font-bold">0%</p>
                    </div>
                    <div class="p-4 bg-slate-900 rounded-lg border border-slate-700">
                        <p class="text-xs text-slate-400 uppercase">P-Value</p>
                        <p id="stat_pvalue" class="text-2xl font-bold text-blue-400">0.000</p>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800 rounded-xl shadow-lg border border-slate-700 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-900 text-slate-400 uppercase text-xs">
                            <tr>
                                <th class="p-4">Fecha</th>
                                <th class="p-4">Mercado</th>
                                <th class="p-4">Cuota</th>
                                <th class="p-4">Stake</th>
                                <th class="p-4">Edge</th>
                                <th class="p-4">OV</th>
                                <th class="p-4">CLV</th>
                                <th class="p-4">Resultado</th>
                                <th class="p-4">Control</th>
                            </tr>
                        </thead>
                        <tbody id="control_table_body" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BANKROLL_BASE = 100;
        let bets = JSON.parse(localStorage.getItem('bets')) || [];

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(tabId === 'control') updateControlTable();
        }

        function factorial(n) {
            if (n === 0) return 1;
            let res = 1;
            for (let i = 2; i <= n; i++) res *= i;
            return res;
        }

        function poisson(k, lambda) {
            return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
        }

        function calcularPoisson() {
            const league_h_avg = parseFloat(document.getElementById('league_home_avg').value);
            const league_a_avg = parseFloat(document.getElementById('league_away_avg').value);
            const h_gf = parseFloat(document.getElementById('home_gf_avg').value);
            const h_gc = parseFloat(document.getElementById('home_gc_avg').value);
            const a_gf = parseFloat(document.getElementById('away_gf_avg').value);
            const a_gc = parseFloat(document.getElementById('away_gc_avg').value);

            if (!h_gf || !h_gc || !a_gf || !a_gc) return alert("Ingresa los promedios de los equipos.");

            const home_xg = (h_gf / league_h_avg) * (a_gc / league_h_avg) * league_h_avg;
            const away_xg = (a_gf / league_a_avg) * (h_gc / league_a_avg) * league_a_avg;

            let prob_home = [], prob_away = [];
            for (let i = 0; i <= 10; i++) {
                prob_home.push(poisson(i, home_xg));
                prob_away.push(poisson(i, away_xg));
            }

            let prob_u25 = 0;
            for (let h = 0; h <= 2; h++) {
                for (let a = 0; a <= (2 - h); a++) {
                    prob_u25 += prob_home[h] * prob_away[a];
                }
            }
            let prob_o25 = 1 - prob_u25;
            let prob_btts_yes = (1 - prob_home[0]) * (1 - prob_away[0]);
            let prob_btts_no = 1 - prob_btts_yes;

            renderTable(prob_o25, prob_u25, prob_btts_yes, prob_btts_no);
        }

        function renderTable(po25, pu25, pby, pbn) {
            const results = [
                { name: 'Over 2.5', prob: po25, odds_id: 'odds_over' },
                { name: 'Under 2.5', prob: pu25, odds_id: 'odds_under' },
                { name: 'BTTS SÃ­', prob: pby, odds_id: 'odds_btts_yes' },
                { name: 'BTTS No', prob: pbn, odds_id: 'odds_btts_no' }
            ];

            const o_val = parseFloat(document.getElementById('odds_over').value) || 0;
            const u_val = parseFloat(document.getElementById('odds_under').value) || 0;
            const overround = o_val > 0 && u_val > 0 ? ((1/o_val) + (1/u_val)) * 100 : 0;
            
            document.getElementById('overround_info').innerText = `Overround O/U: ${overround.toFixed(2)}%`;
            const tbody = document.getElementById('table_body');
            tbody.innerHTML = '';
            document.getElementById('results_area').classList.remove('hidden');

            results.forEach(res => {
                const bookieOdds = parseFloat(document.getElementById(res.odds_id).value) || 0;
                const fairOdds = 1 / res.prob;
                const edge = bookieOdds > 0 ? (bookieOdds * res.prob) - 1 : 0;
                
                let stake = 0;
                let isValuable = false;

                // CRITERIO: Edge entre 3% y 15%, Overround <= 108%
                if (edge >= 0.03 && edge <= 0.15 && overround <= 108) { 
                    stake = (edge / (bookieOdds - 1)) * 0.25 * BANKROLL_BASE;
                    isValuable = true;
                }

                const row = `
                    <tr class="${isValuable ? 'highlight-row' : 'border-b border-slate-700'}">
                        <td class="p-3 font-bold text-slate-200">${res.name}</td>
                        <td class="p-3 text-slate-400">${(res.prob * 100).toFixed(2)}%</td>
                        <td class="p-3 font-mono text-slate-300">${fairOdds.toFixed(2)}</td>
                        <td class="p-3 ${edge > 0.03 ? 'text-green-400 font-bold' : 'text-slate-500'}">${(edge * 100).toFixed(2)}%</td>
                        <td class="p-3 font-bold ${isValuable ? 'text-bet-yellow' : 'text-slate-600'}">${stake > 0 ? '$' + stake.toFixed(2) : '--'}</td>
                        <td class="p-3 text-center">
                            <button onclick="saveBet('${res.name}', ${bookieOdds}, ${stake}, ${edge}, ${overround})" 
                                class="px-4 py-2 rounded-lg font-bold text-xs transition-all ${isValuable ? 'bg-bet-yellow text-black hover:scale-105 shadow-yellow-500/20 shadow-lg' : 'bg-slate-700 text-slate-400 cursor-not-allowed opacity-50'}">
                                ${isValuable ? 'âš¡ COLOCAR APUESTA' : 'SIN VALOR'}
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function saveBet(market, odds, stake, edge, overround) {
            const bet = {
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                market,
                odds,
                stake,
                edge: (edge * 100).toFixed(2),
                overround: overround.toFixed(2),
                clv: 0,
                status: 'pending',
                profit: 0
            };
            bets.push(bet);
            localStorage.setItem('bets', JSON.stringify(bets));
            alert("âœ“ Apuesta enviada al panel de control");
        }

        function updateControlTable() {
            const tbody = document.getElementById('control_table_body');
            tbody.innerHTML = '';
            let totalProfit = 0, totalStaked = 0, wins = 0;

            bets.forEach((bet, index) => {
                totalProfit += parseFloat(bet.profit);
                totalStaked += parseFloat(bet.stake);
                if(bet.status === 'win') wins++;

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-700/50 transition-colors">
                        <td class="p-4 text-slate-400">${bet.date}</td>
                        <td class="p-4 font-bold text-bet-yellow">${bet.market}</td>
                        <td class="p-4 text-slate-300">${bet.odds}</td>
                        <td class="p-4">$${bet.stake.toFixed(2)}</td>
                        <td class="p-4 text-green-500 text-xs">${bet.edge}%</td>
                        <td class="p-4 text-slate-500 text-xs">${bet.overround}%</td>
                        <td class="p-4"><input type="number" step="0.01" class="w-16 p-1 rounded bg-slate-900 text-xs" onchange="updateCLV(${index}, this.value)" value="${bet.clv}"></td>
                        <td class="p-4">
                            <select onchange="resolveBet(${index}, this.value)" class="p-1 rounded bg-slate-900 text-xs">
                                <option value="pending" ${bet.status === 'pending' ? 'selected' : ''}>Pendiente</option>
                                <option value="win" ${bet.status === 'win' ? 'selected' : ''}>Ganada</option>
                                <option value="loss" ${bet.status === 'loss' ? 'selected' : ''}>Perdida</option>
                            </select>
                        </td>
                        <td class="p-4 text-red-500 hover:text-red-300 cursor-pointer text-xs uppercase font-bold" onclick="deleteBet(${index})">Eliminar</td>
                    </tr>
                `;
            });

            document.getElementById('stat_count').innerText = bets.length;
            document.getElementById('stat_profit').innerText = `$${totalProfit.toFixed(2)}`;
            document.getElementById('stat_profit').className = totalProfit >= 0 ? 'text-2xl font-bold text-green-400' : 'text-2xl font-bold text-red-400';
            
            const yieldVal = totalStaked > 0 ? (totalProfit / totalStaked) * 100 : 0;
            document.getElementById('stat_yield').innerText = `${yieldVal.toFixed(2)}%`;
            
            const roiVal = totalStaked > 0 ? ((totalProfit + totalStaked) / totalStaked * 100) - 100 : 0;
            document.getElementById('stat_roi').innerText = `${roiVal.toFixed(2)}%`;

            // CÃ¡lculo simplificado de P-Value para validaciÃ³n de suerte vs habilidad
            if (bets.length > 5) {
                const avgOdds = bets.reduce((a, b) => a + b.odds, 0) / bets.length;
                const p = 1 / avgOdds;
                const expectedWins = bets.length * p;
                const stdDev = Math.sqrt(bets.length * p * (1-p));
                const z = (wins - expectedWins) / stdDev;
                const pValue = 1 - 0.5 * (1 + Math.erf(z / Math.sqrt(2))); 
                document.getElementById('stat_pvalue').innerText = pValue.toFixed(4);
            }
        }

        function resolveBet(index, status) {
            const bet = bets[index];
            bet.status = status;
            bet.profit = status === 'win' ? bet.stake * (bet.odds - 1) : (status === 'loss' ? -bet.stake : 0);
            localStorage.setItem('bets', JSON.stringify(bets));
            updateControlTable();
        }

        function updateCLV(index, val) {
            bets[index].clv = val;
            localStorage.setItem('bets', JSON.stringify(bets));
        }

        function deleteBet(index) {
            if(confirm("Â¿Seguro que deseas eliminar este registro?")) {
                bets.splice(index, 1);
                localStorage.setItem('bets', JSON.stringify(bets));
                updateControlTable();
            }
        }
    </script>
</body>
</html>
