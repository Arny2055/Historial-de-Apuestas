<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poisson Predictor Pro</title>
    <style>
        :root {
            --primary: #00ff85; 
            --secondary: #3d195a;
            --bg: #f4f4f9;
        }
        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background-color: var(--bg); 
            margin: 0; 
            padding: 15px; 
            color: #333; 
        }
        .container { 
            max-width: 500px; 
            margin: auto; 
            background: white; 
            padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            box-sizing: border-box;
        }
        h1 { text-align: center; color: var(--secondary); font-size: 1.5rem; margin-top: 0; }
        
        .input-group { margin-bottom: 15px; }
        label { font-weight: 700; display: block; margin-bottom: 6px; font-size: 0.85rem; color: #555; text-transform: uppercase; }
        textarea { 
            width: 100%; 
            height: 90px; 
            border: 1px solid #ddd; 
            border-radius: 12px; 
            padding: 12px; 
            font-size: 13px; 
            box-sizing: border-box;
            background: #fdfdfd;
            font-family: monospace;
        }
        .avg-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 12px; 
            box-sizing: border-box;
            font-size: 16px; /* Evita zoom automático en iOS */
        }
        
        button { 
            width: 100%; 
            padding: 18px; 
            background-color: var(--secondary); 
            color: white; 
            border: none; 
            border-radius: 15px; 
            font-size: 1rem; 
            font-weight: bold; 
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(61, 25, 90, 0.3);
        }
        button:active { transform: scale(0.96); }

        .match-card { 
            border: none; 
            padding: 0; 
            margin-top: 25px; 
            border-radius: 15px; 
            background: #fff; 
            overflow: hidden;
            border: 1px solid #eee;
        }
        .match-header { 
            background: var(--secondary);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
            font-weight: bold;
        }
        
        .btts-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #e8f0fe;
            font-weight: bold;
            border-bottom: 1px solid #dce4f5;
        }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #fcfcfc; padding: 12px; border-bottom: 2px solid #eee; color: #666; }
        td { padding: 12px; border-bottom: 1px solid #f9f9f9; text-align: center; }
        
        .highlight-over { color: #008a4e; font-weight: 800; background: #f0fff4; }
        .highlight-under { color: #a80000; font-weight: 500; }

        .xg-badge {
            background: var(--primary);
            color: var(--secondary);
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Poisson Predictor</h1>
    
    <div class="input-group">
        <label>Partidos:</label>
        <textarea id="matchesInput" placeholder="Pega aquí los próximos encuentros..."></textarea>
    </div>
    
    <div class="input-group">
        <label>Estadísticas Local:</label>
        <textarea id="homeStatsInput"></textarea>
    </div>
    
    <div class="input-group">
        <label>Estadísticas Visitante:</label>
        <textarea id="awayStatsInput"></textarea>
    </div>

    <div class="avg-grid">
        <div>
            <label>Prom. Local:</label>
            <input type="number" id="avgHomeGoals" step="0.01" value="1.61">
        </div>
        <div>
            <label>Prom. Visita:</label>
            <input type="number" id="avgAwayGoals" step="0.01" value="1.22">
        </div>
    </div>

    <button onclick="calculatePoisson()">CALCULAR PRONÓSTICO</button>

    <div id="results"></div>
</div>

<script>
    function factorial(n) {
        let res = 1;
        for (let i = 2; i <= n; i++) res *= i;
        return res;
    }

    function poissonProb(lambda, x) {
        return (Math.exp(-lambda) * Math.pow(lambda, x)) / factorial(x);
    }

    function parseStats(text) {
        const stats = {};
        const lines = text.split('\n');
        lines.forEach(line => {
            const parts = line.trim().split(/\t|\s{2,}/);
            if (parts.length >= 7) {
                const teamName = parts[1].trim();
                stats[teamName] = { pj: parseFloat(parts[2]), gf: parseFloat(parts[6]), gc: parseFloat(parts[7]) };
            }
        });
        return stats;
    }

    function calculatePoisson() {
        const matchesText = document.getElementById('matchesInput').value.trim();
        const homeStats = parseStats(document.getElementById('homeStatsInput').value);
        const awayStats = parseStats(document.getElementById('awayStatsInput').value);
        const leagueAvgHome = parseFloat(document.getElementById('avgHomeGoals').value);
        const leagueAvgAway = parseFloat(document.getElementById('avgAwayGoals').value);

        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';

        matchesText.split('\n').forEach(line => {
            const parts = line.split(/\t|\s{2,}/);
            if (parts.length < 4) return;

            const homeTeam = parts[1].trim();
            const awayTeam = parts[3].trim();

            if (homeStats[homeTeam] && awayStats[awayTeam]) {
                const h = homeStats[homeTeam], a = awayStats[awayTeam];
                
                const lH = (h.gf/h.pj/leagueAvgHome) * (a.gc/a.pj/leagueAvgAway) * leagueAvgHome;
                const lA = (a.gf/a.pj/leagueAvgAway) * (h.gc/h.pj/leagueAvgHome) * leagueAvgAway;

                processMatch(homeTeam, awayTeam, lH, lA, resultsDiv);
            }
        });
    }

    function processMatch(home, away, lH, lA, container) {
        let overProbs = { 0.5: 0, 1.5: 0, 2.5: 0, 3.5: 0 };
        
        const probHomeZero = poissonProb(lH, 0);
        const probAwayZero = poissonProb(lA, 0);
        const probBTTS = (1 - probHomeZero) * (1 - probAwayZero) * 100;

        for (let i = 0; i <= 8; i++) {
            for (let j = 0; j <= 8; j++) {
                const p = poissonProb(lH, i) * poissonProb(lA, j);
                const total = i + j;
                if (total > 0.5) overProbs[0.5] += p;
                if (total > 1.5) overProbs[1.5] += p;
                if (total > 2.5) overProbs[2.5] += p;
                if (total > 3.5) overProbs[3.5] += p;
            }
        }

        const card = document.createElement('div');
        card.className = 'match-card';
        card.innerHTML = `
            <div class="match-header">
                <span>${home} - ${away}</span>
                <span class="xg-badge">xG: ${(lH+lA).toFixed(2)}</span>
            </div>
            
            <div class="btts-row">
                <span>AMBOS ANOTAN</span>
                <span style="color:#1a73e8">${probBTTS.toFixed(1)}%</span>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Mercado</th>
                        <th>Over (+)</th>
                        <th>Under (-)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>0.5 Goles</td>
                        <td class="highlight-over">${(overProbs[0.5]*100).toFixed(1)}%</td>
                        <td class="highlight-under">${((1-overProbs[0.5])*100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td>1.5 Goles</td>
                        <td class="highlight-over">${(overProbs[1.5]*100).toFixed(1)}%</td>
                        <td class="highlight-under">${((1-overProbs[1.5])*100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td>2.5 Goles</td>
                        <td class="highlight-over">${(overProbs[2.5]*100).toFixed(1)}%</td>
                        <td class="highlight-under">${((1-overProbs[2.5])*100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td>3.5 Goles</td>
                        <td class="highlight-over">${(overProbs[3.5]*100).toFixed(1)}%</td>
                        <td class="highlight-under">${((1-overProbs[3.5])*100).toFixed(1)}%</td>
                    </tr>
                </tbody>
            </table>
        `;
        container.appendChild(card);
    }
</script>

</body>
</html>
