<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador BTTS por Varianza (Final)</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .data-input { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 4px; }
        .team-stats { background-color: #ecf0f1; padding: 15px; margin-top: 20px; border-radius: 4px; }
        input[type="file"], select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .recomendacion { margin-top: 20px; padding: 15px; border-left: 5px solid #ffc107; background-color: #fff3cd; }
        .recomendacion h4 { margin-top: 0; color: #ffc107; }
        .range-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .range-table th, .range-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .range-table th { background-color: #0056b3; color: white; }
        .error { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h2>‚öΩ Analizador de Varianza de Equipos para BTTS</h2>
        <p>Carga tu historial de partidos. La herramienta analizar√° la **Varianza Ofensiva/Defensiva** del equipo seleccionado y sugerir√° los rangos de cuotas BTTS (Ambos Anotan) m√°s rentables.</p>

        <div class="data-input">
            <h4>Paso 1: Carga el Archivo JSON</h4>
            <input type="file" id="jsonFile" accept=".json" onchange="extractTeams()">
            
            <div id="teamSelectionArea" style="margin-top: 15px; display: none;">
                <h4>Paso 2: Selecciona el Equipo a Analizar</h4>
                <label for="targetTeamSelect">Equipo:</label>
                <select id="targetTeamSelect" onchange="executeAnalysis()"></select>
                <small>Selecciona un equipo para ver su an√°lisis de varianza BTTS y recomendaci√≥n de cuotas.</small>
            </div>
            
        </div>
        
        <div id="fileAnalysisOutput" class="team-stats">
            <h4>An√°lisis de Varianza del Equipo (Resultados)</h4>
            <p>Por favor, carga un archivo JSON (con campos 'Match', 'Result FT', 'Odd' y 'Result') para comenzar.</p>
        </div>
    </div>

    <script>
        // Variable global para guardar los datos del archivo una vez cargado
        let globalMatchData = [];

        // --- FUNCIONES DE C√ÅLCULO ESTAD√çSTICO ---
        
        function calcularMedia(datos) {
            if (datos.length === 0) return 0;
            const suma = datos.reduce((acc, val) => acc + val, 0);
            return suma / datos.length;
        }

        function calcularVarianza(datos) {
            const n = datos.length;
            if (n < 2) return 0;
            const media = calcularMedia(datos);
            
            const sumatoria = datos.reduce((acc, val) => {
                const diferencia = val - media;
                return acc + (diferencia * diferencia);
            }, 0);
            
            return sumatoria / (n - 1); // Varianza Muestral
        }

        // --- L√ìGICA DE CARGA Y EXTRACCI√ìN DE EQUIPOS ---

        function extractTeams() {
            const fileInput = document.getElementById('jsonFile');
            const outputDiv = document.getElementById('fileAnalysisOutput');
            
            outputDiv.innerHTML = '<h4>Analizando Archivo...</h4>';
            document.getElementById('teamSelectionArea').style.display = 'none';

            if (fileInput.files.length === 0) return;

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    globalMatchData = data;
                    populateTeamSelect(data, outputDiv);
                } catch (error) {
                    outputDiv.innerHTML = `<p class="error">‚ùå Error al cargar/parsear JSON: ${error.message}</p>`;
                }
            };

            reader.onerror = function() {
                outputDiv.innerHTML = '<p class="error">‚ùå Error al leer el archivo.</p>';
            };

            reader.readAsText(fileInput.files[0]);
        }

        function populateTeamSelect(data, outputDiv) {
            const teams = new Set();
            
            data.forEach(item => {
                const match = item['Match'];
                if (match) {
                    // Asumimos el formato "Equipo Local - Equipo Visitante"
                    const parts = match.split('-');
                    if (parts.length >= 2) {
                        teams.add(parts[0].trim());
                        teams.add(parts[1].trim());
                    }
                }
            });

            const selectElement = document.getElementById('targetTeamSelect');
            selectElement.innerHTML = '<option value="">-- Selecciona un Equipo --</option>';

            if (teams.size === 0) {
                outputDiv.innerHTML = '<p class="error">‚ùå No se encontraron equipos. Aseg√∫rate de que el campo "Match" est√© en formato "Local - Visitante".</p>';
                return;
            }
            
            Array.from(teams).sort().forEach(teamName => {
                selectElement.appendChild(new Option(teamName, teamName));
            });

            document.getElementById('teamSelectionArea').style.display = 'block';
            outputDiv.innerHTML = '<p>‚úÖ Archivo cargado. Selecciona un equipo para el an√°lisis BTTS.</p>';
        }

        // --- L√ìGICA PRINCIPAL DE AN√ÅLISIS ---

        function executeAnalysis() {
            const targetTeam = document.getElementById('targetTeamSelect').value;
            const outputDiv = document.getElementById('fileAnalysisOutput');
            
            if (!targetTeam) return;

            const data = globalMatchData;
            
            const gaArray = []; // Goles Anotados
            const grArray = []; // Goles Recibidos
            const bttsOdds = []; // Cuotas BTTS ganadoras (asumimos que 'Odd' es la cuota BTTS)

            data.forEach(item => {
                const match = item['Match'];
                const resultFT = item['Result FT'];
                const result = item['Result']; 

                if (!match || !resultFT) return;
                
                const [scoreLocalStr, scoreAwayStr] = resultFT.split('-').map(s => s.trim());
                const scoreLocal = parseInt(scoreLocalStr);
                const scoreAway = parseInt(scoreAwayStr);

                if (isNaN(scoreLocal) || isNaN(scoreAway)) return;
                
                // 1. Recopilar Goles para Varianza (Revisi√≥n estricta de la posici√≥n)
                if (match.startsWith(targetTeam + ' -')) { 
                    gaArray.push(scoreLocal);
                    grArray.push(scoreAway);
                } else if (match.endsWith('- ' + targetTeam)) {
                    gaArray.push(scoreAway);
                    grArray.push(scoreLocal);
                }

                // 2. Recopilar Cuotas de Apuestas Ganadoras (BTTS)
                if (result === 'Winning') {
                    const odd = parseFloat(item['Odd']);
                    if (!isNaN(odd)) {
                        bttsOdds.push(odd);
                    }
                }
            });

            if (gaArray.length < 2) {
                outputDiv.innerHTML = `<p class="error">‚ùå No se encontraron suficientes partidos (N < 2) para calcular la varianza de "${targetTeam}".</p>`;
                return;
            }

            // 3. C√°lculos de Varianza y Estad√≠sticas
            const varGA = calcularVarianza(gaArray);
            const varGR = calcularVarianza(grArray);
            const mediaGA = calcularMedia(gaArray);
            const mediaGR = calcularMedia(grArray);
            const mediaOdd = calcularMedia(bttsOdds);
            const varianzaOdd = calcularVarianza(bttsOdds);
            const desvEstOdd = varianzaOdd > 0 ? Math.sqrt(varianzaOdd) : 0;
            
            // 4. Mostrar Resultados y Recomendaci√≥n BTTS
            mostrarRecomendacion(targetTeam, gaArray.length, varGA, varGR, mediaGA, mediaGR, mediaOdd, desvEstOdd, outputDiv);
        }

        // --- FUNCI√ìN DE RECOMENDACI√ìN DE CUOTAS BTTS ---

        function mostrarRecomendacion(teamName, N, varGA, varGR, mediaGA, mediaGR, mediaOdd, desvEstOdd, outputDiv) {
            const varGA_f = varGA.toFixed(3);
            const varGR_f = varGR.toFixed(3);
            const mediaOdd_f = mediaOdd.toFixed(3);
            const desvEstOdd_f = desvEstOdd.toFixed(3);

            const altaVarianzaOfensiva = varGA > 1.0;
            const altaVarianzaDefensiva = varGR > 1.0;
            
            // Rango de Oro de BTTS (donde el modelo es hist√≥ricamente fuerte)
            const rangoMin = mediaOdd - desvEstOdd;
            const rangoMax = mediaOdd + desvEstOdd;

            let conclusionVarianza = '';
            let estrategiaBTTS = '';
            
            if (altaVarianzaOfensiva && altaVarianzaDefensiva) {
                conclusionVarianza = `El equipo es **Altamente Vol√°til** (Ofensiva y Defensiva Inconsistentes).`;
                estrategiaBTTS = `Busca **BTTS S√ç** sistem√°ticamente. Su alta varianza y promedio de goles (${mediaGA.toFixed(2)} GA / ${mediaGR.toFixed(2)} GR) lo hacen propenso a partidos abiertos.`;
            } else if (altaVarianzaOfensiva) {
                conclusionVarianza = `El equipo tiene una **Ofensiva Vol√°til** y una Defensa Consistente.`;
                estrategiaBTTS = `Prioriza **BTTS S√ç** contra rivales d√©biles o con defensas inestables. La volatilidad de su ataque puede generar goles inesperados.`;
            } else if (altaVarianzaDefensiva) {
                conclusionVarianza = `El equipo tiene una **Defensa Vol√°til** y una Ofensiva Consistente.`;
                estrategiaBTTS = `Es un candidato ideal para **BTTS S√ç**. Su ataque (${mediaGA.toFixed(2)} GA) es confiable, y su defensa inestable (${mediaGR.toFixed(2)} GR) casi garantiza el gol del rival.`;
            } else {
                conclusionVarianza = `El equipo es **Muy Consistente** (Ofensiva y Defensiva Estables).`;
                estrategiaBTTS = `Apu√©stale a **BTTS NO** cuando la cuota de 'BTTS S√ç' sea alta (el mercado puede estar sobrevalorando los goles en sus partidos). La consistencia reduce las sorpresas.`;
            }

            outputDiv.innerHTML = `
                <h4>An√°lisis de Varianza de ${teamName} (${N} Partidos)</h4>
                <p><strong>Media Goles Anotados (GA):</strong> ${mediaGA.toFixed(2)} | <strong>Varianza Ofensiva:</strong> <strong>${varGA_f}</strong></p>
                <p><strong>Media Goles Recibidos (GR):</strong> ${mediaGR.toFixed(2)} | <strong>Varianza Defensiva:</strong> <strong>${varGR_f}</strong></p>
                <hr>
                
                <div class="recomendacion">
                    <h4>üéØ Estrategia BTTS para ${teamName}</h4>
                    <p><strong>Conclusi√≥n:</strong> ${conclusionVarianza}</p>
                    <p><strong>Estrategia Clave:</strong> ${estrategiaBTTS}</p>
                    
                    <h4 style="margin-top: 20px;">Rango de Cuotas BTTS Sugeridas (Tu Zona de Edge)</h4>
                    <p>Tu modelo tiene mayor ventaja hist√≥rica en cuotas alrededor de ${mediaOdd_f}.</p>
                    <p><strong>Media de Cuotas Ganadoras:</strong> ${mediaOdd_f}</p>
                    <p><strong>Desviaci√≥n Est√°ndar ($s$):</strong> ${desvEstOdd_f}</p>
                    
                    <table class="range-table">
                        <thead>
                            <tr>
                                <th>Rango Estad√≠stico</th>
                                <th>Cuotas Sugeridas</th>
                                <th>Acci√≥n Estrat√©gica</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>**Rango de Consistencia ($\bar{x} \pm 1s$)**</td>
                                <td>**${rangoMin.toFixed(2)}** a **${rangoMax.toFixed(2)}**</td>
                                <td>**Busca el Edge aqu√≠.** Este es tu rango de "Oro". El 68% de tus aciertos caen aqu√≠.</td>
                            </tr>
                            <tr>
                                <td>**Valor Superior ($\bar{x} + 1s$ a $\bar{x} + 2s$)**</td>
                                <td>Cuotas **superiores a ${rangoMax.toFixed(2)}**</td>
                                <td>Ideal para **BTTS S√ç** en partidos con alta varianza, buscando un alto retorno.</td>
                            </tr>
                            <tr>
                                <td>**Cuotas a Evitar**</td>
                                <td>Cuotas inferiores a **${rangoMin.toFixed(2)}**</td>
                                <td>Tu *backtesting* sugiere poco valor (*Edge* negativo) en este rango.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
        }
    </script>
</body>
</html>