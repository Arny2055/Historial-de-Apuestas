<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador BTTS por Varianza (Estrat√©gico)</title>
    <style>
        /* --- ESTILOS M√ìVILES OPTIMIZADOS --- */
        body { 
            font-family: sans-serif; 
            margin: 0; padding: 10px; background-color: #f4f7f6; font-size: 16px; 
        }
        .container { 
            width: 100%; max-width: none; margin: 0 auto; background: white; 
            padding: 15px; border-radius: 0; box-shadow: none; 
        }
        h2 { 
            color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 8px; font-size: 1.5em; 
        }
        
        /* --- ESTILOS DE ENTRADA Y SELECCI√ìN --- */
        .data-input { padding: 10px; border: 1px solid #ccc; }
        .match-setup { flex-direction: column; align-items: stretch; }
        .match-setup select { width: 100%; margin-bottom: 10px; padding: 12px 10px; font-size: 1em; }
        input[type="file"] { padding: 12px 10px; font-size: 1em; }
        
        /* --- COMPARACI√ìN DE EQUIPOS Y RESULTADOS --- */
        .analysis-output { background-color: #f0f8ff; padding: 15px; border: 1px solid #ddd; }
        .team-comparison { flex-direction: column; gap: 15px; margin-top: 15px; }
        .team-box { width: 100%; padding: 10px; border: 1px solid #3498db; border-radius: 4px; background-color: white; font-size: 0.95em; }
        .recommendation { margin-top: 20px; padding: 15px; border-left: 5px solid #ffc107; background-color: #fff3cd; }
        .recommendation h4 { margin-top: 0; color: #ffc107; }
        
        /* --- TABLA ESTRAT√âGICA --- */
        .range-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; display: block; overflow-x: auto; }
        .range-table th, .range-table td { padding: 6px; border: 1px solid #ddd; text-align: left; word-break: break-word; }
        .range-table th { background-color: #0056b3; color: white; }
        .error { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h2>‚öîÔ∏è Comparador de Varianza de Equipos (BTTS)</h2>
        <p>Analiza un enfrentamiento espec√≠fico (Local vs Visitante) y calcula la probabilidad de Ambos Anotan (BTTS) bas√°ndose en la varianza de cada equipo.</p>

        <div class="data-input">
            <h4>Paso 1: Carga el Archivo JSON</h4>
            <input type="file" id="jsonFile" accept=".json" onchange="extractTeams()">
            
            <div id="teamSelectionArea" style="margin-top: 15px; display: none;">
                <h4>Paso 2: Selecciona el Enfrentamiento</h4>
                <div class="match-setup">
                    <select id="localTeamSelect" onchange="executeComparison()">
                        <option value="">-- Selecciona Local --</option>
                    </select>
                    <span>**VS**</span>
                    <select id="awayTeamSelect" onchange="executeComparison()">
                        <option value="">-- Selecciona Visitante --</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div id="analysisOutput" class="analysis-output">
            <h4>Resultados de la Comparaci√≥n</h4>
            <p>Por favor, carga un archivo y selecciona los dos equipos.</p>
        </div>
    </div>

    <script>
        let globalMatchData = [];

        // --- FUNCIONES DE C√ÅLCULO ESTAD√çSTICO ---
        function calcularMedia(datos) {
            if (datos.length === 0) return 0;
            const suma = datos.reduce((acc, val) => acc + val, 0);
            return suma / datos.length;
        }

        function calcularVarianza(datos) {
            const n = datos.length;
            if (n < 2) return 0;
            const media = calcularMedia(datos);
            const sumatoria = datos.reduce((acc, val) => acc + Math.pow(val - media, 2), 0);
            return sumatoria / (n - 1);
        }

        // --- L√ìGICA DE CARGA Y EXTRACCI√ìN DE EQUIPOS ---

        function extractTeams() {
            const fileInput = document.getElementById('jsonFile');
            const outputDiv = document.getElementById('analysisOutput');
            outputDiv.innerHTML = '<h4>Analizando Archivo...</h4>';
            document.getElementById('teamSelectionArea').style.display = 'none';

            if (fileInput.files.length === 0) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    globalMatchData = data;
                    populateTeamSelect(data, outputDiv);
                } catch (error) {
                    outputDiv.innerHTML = `<p class="error">‚ùå Error al cargar/parsear JSON: ${error.message}</p>`;
                }
            };
            reader.onerror = function() {
                outputDiv.innerHTML = '<p class="error">‚ùå Error al leer el archivo.</p>';
            };
            reader.readAsText(fileInput.files[0]);
        }

        function populateTeamSelect(data, outputDiv) {
            const teams = new Set();
            data.forEach(item => {
                const match = item['Match'];
                if (match) {
                    const parts = match.split('-');
                    if (parts.length >= 2) {
                        teams.add(parts[0].trim());
                        teams.add(parts[1].trim());
                    }
                }
            });

            const localSelect = document.getElementById('localTeamSelect');
            const awaySelect = document.getElementById('awayTeamSelect');
            localSelect.innerHTML = '<option value="">-- Selecciona Local --</option>';
            awaySelect.innerHTML = '<option value="">-- Selecciona Visitante --</option>';

            if (teams.size === 0) {
                outputDiv.innerHTML = '<p class="error">‚ùå No se encontraron equipos. Verifica el formato "Local - Visitante".</p>';
                return;
            }
            
            Array.from(teams).sort().forEach(teamName => {
                localSelect.appendChild(new Option(teamName, teamName));
                awaySelect.appendChild(new Option(teamName, teamName));
            });

            document.getElementById('teamSelectionArea').style.display = 'flex';
            outputDiv.innerHTML = '<p>‚úÖ Archivo cargado. Selecciona los equipos para comparar.</p>';
        }

        // --- FUNCI√ìN DE AN√ÅLISIS POR EQUIPO (Datos extra√≠dos del JSON) ---

        function getTeamStats(teamName, data) {
            const gaArray = []; 
            const grArray = []; 
            const bttsOdds = []; 

            data.forEach(item => {
                const match = item['Match'];
                const resultFT = item['Result FT'];
                const result = item['Result']; 

                if (!match || !resultFT) return;
                
                const [scoreLocalStr, scoreAwayStr] = resultFT.split('-').map(s => s.trim());
                const scoreLocal = parseInt(scoreLocalStr);
                const scoreAway = parseInt(scoreAwayStr);

                if (isNaN(scoreLocal) || isNaN(scoreAway)) return;
                
                if (match.startsWith(teamName + ' -')) { 
                    gaArray.push(scoreLocal);
                    grArray.push(scoreAway);
                } else if (match.endsWith('- ' + teamName)) {
                    gaArray.push(scoreAway);
                    grArray.push(scoreLocal);
                }

                if (result === 'Winning') {
                    const odd = parseFloat(item['Odd']);
                    if (!isNaN(odd)) {
                        bttsOdds.push(odd);
                    }
                }
            });

            if (gaArray.length < 2) {
                return null;
            }

            const varGA = calcularVarianza(gaArray);
            const varGR = calcularVarianza(grArray);
            const mediaOdd = calcularMedia(bttsOdds);
            const desvEstOdd = calcularVarianza(bttsOdds) > 0 ? Math.sqrt(calcularVarianza(bttsOdds)) : 0;

            return {
                name: teamName,
                N: gaArray.length,
                mediaGA: calcularMedia(gaArray),
                mediaGR: calcularMedia(grArray),
                varGA: varGA,
                varGR: varGR,
                mediaOdd: mediaOdd,
                desvEstOdd: desvEstOdd
            };
        }

        // --- L√ìGICA PRINCIPAL DE COMPARACI√ìN ---

        function executeComparison() {
            const localName = document.getElementById('localTeamSelect').value;
            const awayName = document.getElementById('awayTeamSelect').value;
            const outputDiv = document.getElementById('analysisOutput');

            if (!localName || !awayName) return;
            if (localName === awayName) {
                outputDiv.innerHTML = '<p class="error">‚ùå No puedes comparar el mismo equipo.</p>';
                return;
            }

            const localStats = getTeamStats(localName, globalMatchData);
            const awayStats = getTeamStats(awayName, globalMatchData);

            if (!localStats || !awayStats) {
                outputDiv.innerHTML = '<p class="error">‚ùå No hay suficientes datos (m√≠nimo 2 partidos) para uno o ambos equipos seleccionados.</p>';
                return;
            }

            // 1. Calcular la Probabilidad BTTS (S√ç)
            
            const probLocalScores = (localStats.mediaGA * awayStats.mediaGR) / (localStats.mediaGA + awayStats.mediaGR); 
            const probAwayScores = (awayStats.mediaGA * localStats.mediaGR) / (awayStats.mediaGA + localStats.mediaGR);

            const varFactor = ((localStats.varGA + awayStats.varGR) / 2 + (awayStats.varGA + localStats.varGR) / 2) / 4;
            const varianzaAdjustment = (varFactor > 1.0) ? 0.05 * varFactor : 0; 

            let probBTTS = (probLocalScores / (probLocalScores + probAwayScores)) * 0.75 + (probAwayScores / (probLocalScores + probAwayScores)) * 0.75;
            
            probBTTS = Math.min(0.85, Math.max(0.40, probBTTS));
            probBTTS += varianzaAdjustment;
            probBTTS = Math.min(0.95, probBTTS);

            const cuotaJustaBTTS = 1 / probBTTS;

            // 2. Mostrar Resultados
            mostrarComparacion(localStats, awayStats, probBTTS, cuotaJustaBTTS, outputDiv);
        }

        // --- FUNCI√ìN DE VISUALIZACI√ìN Y RECOMENDACI√ìN ESTRAT√âGICA ---

        function mostrarComparacion(local, away, probBTTS, cuotaJustaBTTS, outputDiv) {
            
            const localVolatil = local.varGA > 1.0 || local.varGR > 1.0;
            const awayVolatil = away.varGA > 1.0 || away.varGR > 1.0;

            const rangoMin = cuotaJustaBTTS * 1.05; // 5% Edge
            const rangoMax = cuotaJustaBTTS * 1.15; // 15% Edge
            
            // --- DIAGN√ìSTICO DEL PARTIDO ---
            let diagnosticoClave = '';
            let explicacionPronostico = `La probabilidad del **BTTS S√ç** (${(probBTTS * 100).toFixed(2)}%) es alta porque la **Fuerza Ofensiva** del Local (${local.mediaGA.toFixed(2)} GA) es efectiva contra la **Debilidad Defensiva** del Visitante (${away.mediaGR.toFixed(2)} GR), y viceversa.`;

            if (localVolatil && awayVolatil) {
                diagnosticoClave = 'üî• Partido de ALTA VOLATILIDAD';
                explicacionPronostico += ` ADVERTENCIA: La alta varianza de ambos equipos sugiere que, aunque la probabilidad BTTS es alta, el marcador final puede ser at√≠pico. Busca BTTS S√ç.`;
            } else if (!localVolatil && !awayVolatil) {
                diagnosticoClave = 'üõ°Ô∏è Partido de ALTA CONSISTENCIA';
                explicacionPronostico += ` √âNFASIS: La baja varianza indica que si tu modelo da BTTS S√ç, es muy fiable, pero la cuota de la casa podr√≠a ser muy baja. Busca Edge estricto.`;
            } else if (localVolatil) {
                diagnosticoClave = '‚ö° Local Vol√°til vs Visitante Consistente';
                explicacionPronostico += ` OPORTUNIDAD: El ataque/defensa impredecible del Local (${local.name}) a menudo genera goles inesperados. Ideal para BTTS S√ç cuando la cuota est√° infravalorada.`;
            } else { // awayVolatil
                diagnosticoClave = 'üõ°Ô∏è Local Consistente vs Visitante Vol√°til';
                explicacionPronostico += ` OPORTUNIDAD: La debilidad defensiva vol√°til del Visitante (${away.name}) sugiere que el Local anote, y la varianza Visitante aumenta la posibilidad de que ellos tambi√©n sorprendan con un gol.`;
            }

            outputDiv.innerHTML = `
                <h4>An√°lisis del Enfrentamiento: ${local.name} vs ${away.name}</h4>
                <div class="team-comparison">
                    <div class="team-box">
                        <h5>Equipo Local: ${local.name}</h5>
                        <p>GA Media: ${local.mediaGA.toFixed(2)} | Varianza GA: **${local.varGA.toFixed(3)}**</p>
                        <p>GR Media: ${local.mediaGR.toFixed(2)} | Varianza GR: **${local.varGR.toFixed(3)}**</p>
                        <p style="color: ${local.varGA > 1.0 || local.varGR > 1.0 ? '#c0392b' : '#27ae60'}">${localVolatil ? 'üî¥ Equipo Vol√°til' : 'üü¢ Equipo Consistente'}</p>
                    </div>
                    <div class="team-box">
                        <h5>Equipo Visitante: ${away.name}</h5>
                        <p>GA Media: ${away.mediaGA.toFixed(2)} | Varianza GA: **${away.varGA.toFixed(3)}**</p>
                        <p>GR Media: ${away.mediaGR.toFixed(2)} | Varianza GR: **${away.varGR.toFixed(3)}**</p>
                        <p style="color: ${away.varGA > 1.0 || away.varGR > 1.0 ? '#c0392b' : '#27ae60'}">${awayVolatil ? 'üî¥ Equipo Vol√°til' : 'üü¢ Equipo Consistente'}</p>
                    </div>
                </div>
                <hr>

                <div class="recommendation">
                    <h4>Diagn√≥stico del Partido: ${diagnosticoClave}</h4>
                    
                    <p>Probabilidad de Ambos Anoten (BTTS S√ç) seg√∫n tu modelo: **${(probBTTS * 100).toFixed(2)}%**</p>
                    <p>Cuota Justa Impl√≠cita (Valor Real): **${cuotaJustaBTTS.toFixed(2)}**</p>
                    
                    <p style="font-weight: bold;">Explicaci√≥n del Pron√≥stico:</p>
                    <p>${explicacionPronostico}</p>
                    
                    
                    <h4 style="margin-top: 15px;">Estrategia de Apuesta: Rango de Edge (Ventaja)</h4>
                    
                    <table class="range-table">
                        <thead>
                            <tr>
                                <th>Nivel de Edge</th>
                                <th>Cuotas BTTS S√ç a Buscar</th>
                                <th>Significado Estrat√©gico</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>**Edge M√≠nimo (5%+)**</td>
                                <td>**${rangoMin.toFixed(2)}** o **superior**</td>
                                <td>**ENTRADA EST√ÅNDAR.** Apuesta rentable a largo plazo con riesgo moderado.</td>
                            </tr>
                            <tr>
                                <td>**Edge Alto (15%+)**</td>
                                <td>**${rangoMax.toFixed(2)}** o **superior**</td>
                                <td>**APUESTA DE VALOR.** La casa ha infravalorado enormemente la probabilidad. Usar alta unidad de apuesta (criterio de Kelly).</td>
                            </tr>
                            <tr>
                                <td>**Sin Edge**</td>
                                <td>Cuotas inferiores a **${rangoMin.toFixed(2)}**</td>
                                <td>**EVITAR.** Estar√≠as apostando a cuotas que no superan la cuota justa de tu modelo.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            // Llama a una imagen para ilustrar el concepto central (BTTS vs Varianza)
            
        }
    </script>
</body>
</html>