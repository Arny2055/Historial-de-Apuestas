<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Historial por Ligas — Perfiles</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  :root{--bg:#121214;--panel:#202024;--panel2:#29292e;--text:#e1e1e6;--muted:#c4c4cc;--accent:#8257e6;--danger:#ef4444;--ok:#4caf50;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;display:flex;justify-content:center}
  main{max-width:1200px;width:95%;margin:20px auto 40px auto}
  h1{color:var(--accent);margin:.2rem 0 1rem}
  .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;background:var(--panel);padding:12px 16px;border-radius:10px;box-shadow:0 6px 12px rgba(0,0,0,.35)}
  .bar select,.bar input{min-width:180px;padding:10px 14px;border-radius:8px;border:none;background:#121214;color:var(--text);box-shadow:inset 0 0 5px rgb(255 255 255 / .1)}
  .bar button{background:var(--accent);border:none;color:#fff;font-weight:600;border-radius:10px;padding:10px 16px;cursor:pointer;box-shadow:0 4px 8px #6b45d9}
  .bar button:hover{filter:brightness(.95)}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
  .chip{background:var(--panel2);padding:6px 10px;border-radius:999px;font-size:.85rem;color:#ddd}
  #tablaWrap{overflow:auto;border-radius:12px;box-shadow:0 6px 12px rgba(0,0,0,.4)}
  table{width:100%;border-collapse:separate;border-spacing:0 6px;min-width:860px}
  thead th{position:sticky;top:0;background:var(--panel2);padding:12px 14px;text-align:left;color:#bbb}
  tbody tr{background:var(--panel);transition:.2s}
  tbody tr:hover{background:#2a2a30}
  td{padding:12px 14px;white-space:nowrap}
  .pos{color:var(--ok);font-weight:700}
  .neg{color:var(--danger);font-weight:700}
  canvas{background:var(--panel);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.5);height:360px !important;margin-top:22px}
  .links{margin-top:14px}
  .links a{color:#fff;background:#3b82f6;text-decoration:none;padding:8px 12px;border-radius:8px;margin-right:8px;display:inline-block}
</style>
</head>
<body>
<main>
  <h1>Historial por Ligas</h1>

  <section class="bar" aria-label="Perfiles y filtros">
    <strong>Perfil:</strong>
    <select id="selectPerfil"></select>
    <input id="filtroLiga" placeholder="Filtrar por liga..." />
    <button id="btnExportCSV">Exportar CSV</button>
    <button id="btnVolver">⬅ Volver</button>
    <span id="info" style="opacity:.85"></span>
  </section>

  <div class="chips" id="chips"></div>

  <div id="tablaWrap">
    <table id="tabla">
      <thead>
        <tr>
          <th>#</th>
          <th>Liga</th>
          <th>Apuestas</th>
          <th>Ganadas</th>
          <th>Perdidas</th>
          <th>Pendientes</th>
          <th>Winrate %</th>
          <th>Yield %</th>
          <th>Unidades</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <canvas id="grafica"></canvas>

  <div class="links" id="links"></div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(()=>{'use strict';
  /* ========== Perfiles base ========= */
  const STORAGE_ROOT='HAPC';
  const PROFILE_LIST_KEY=STORAGE_ROOT+'_profiles';
  const CURRENT_PROFILE_KEY=STORAGE_ROOT+'_currentProfile';
  const dataKeyFor=p=>`${STORAGE_ROOT}_data_${p}`;
  const getProfiles=()=>{try{const a=JSON.parse(localStorage.getItem(PROFILE_LIST_KEY)||'[]');return Array.isArray(a)?a:[]}catch{return[]}};
  const getCurrent=()=>localStorage.getItem(CURRENT_PROFILE_KEY)||'default';
  const setCurrent=p=>localStorage.setItem(CURRENT_PROFILE_KEY,p);

  const qs=id=>document.getElementById(id);
  const sel=qs('selectPerfil'); const info=qs('info'); const filtroLiga=qs('filtroLiga');
  const tbody=document.querySelector('#tabla tbody'); const chips=qs('chips'); const links=qs('links');
  const btnCSV=qs('btnExportCSV'); const btnVolver=qs('btnVolver');
  const ctx=qs('grafica').getContext('2d');
  let chart=null, perfil='default', data=[];

  function refreshSelect(){
    const list=getProfiles(); perfil=getUrlPerfil()||getCurrent();
    if(!list.includes(perfil)){ if(list.length){perfil=list[0];} else {perfil='default';} setCurrent(perfil); }
    sel.innerHTML=''; list.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; if(p===perfil)o.selected=true; sel.appendChild(o); });
    info.textContent=`(${list.length} perfil${list.length===1?'':'es'})`;
  }
  function getUrlPerfil(){ const p=new URLSearchParams(location.search).get('perfil'); return p && p.trim()? p.trim(): null; }
  function load(){ data=JSON.parse(localStorage.getItem(dataKeyFor(perfil))||'[]'); }
  function save(){ localStorage.setItem(dataKeyFor(perfil), JSON.stringify(data)); }

  /* ========= Cálculos ========= */
  const stakeSug=(bank, kFull, kFrac)=> (bank>0 && kFull>0 && kFrac>0)? Math.min(bank, bank*kFull*kFrac) : 0;
  function agruparPorLiga(rows){
    const map=new Map();
    rows.forEach(a=>{
      const key=(a.liga||'Sin liga').trim();
      const stake=stakeSug(a.bankroll, a.kellyFull, a.kellyFrac);
      let m=map.get(key); if(!m) m={liga:key, n:0, g:0, p:0, pen:0, apostado:0, ganado:0};
      m.n++; m.apostado += stake;
      if(a.estado==='ganada') { m.g++; m.ganado += stake * (a.cuotaBookie||0);}
      else if(a.estado==='perdida'){ m.p++; /* ganado += 0 */}
      else { m.pen++; }
      map.set(key,m);
    });
    // métricas
    return [...map.values()].map(m=>{
      const neto = m.ganado - m.apostado;
      const winrate = m.n? (m.g/m.n*100):0;
      const yieldPct = m.apostado? (neto/m.apostado*100):0;
      return {...m, neto, winrate, yieldPct};
    }).sort((a,b)=> b.neto - a.neto);
  }

  function render(){
    const filtro=(filtroLiga.value||'').toLowerCase();
    const agg=agruparPorLiga(data.filter(a=> a.liga && a.liga.toLowerCase().includes(filtro)));
    // chips
    chips.innerHTML='';
    const total=agg.reduce((s,x)=>s+x.n,0);
    const totGan=agg.reduce((s,x)=>s+x.g,0);
    const totPer=agg.reduce((s,x)=>s+x.p,0);
    const neto=agg.reduce((s,x)=>s+x.neto,0);
    const c1=document.createElement('span'); c1.className='chip'; c1.textContent=`Apuestas: ${total}`;
    const c2=document.createElement('span'); c2.className='chip'; c2.textContent=`Ganadas: ${totGan}`;
    const c3=document.createElement('span'); c3.className='chip'; c3.textContent=`Perdidas: ${totPer}`;
    const c4=document.createElement('span'); c4.className='chip'; c4.innerHTML=`Unidades: <strong class="${neto>=0?'pos':'neg'}">${neto.toFixed(2)}</strong>`;
    chips.append(c1,c2,c3,c4);

    // tabla
    tbody.innerHTML='';
    agg.forEach((m,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td>
        <td>${m.liga}</td>
        <td>${m.n}</td>
        <td>${m.g}</td>
        <td>${m.p}</td>
        <td>${m.pen}</td>
        <td>${m.winrate.toFixed(2)}</td>
        <td>${m.yieldPct.toFixed(2)}</td>
        <td class="${m.neto>=0?'pos':'neg'}">${m.neto.toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });

    // gráfica (Top 10 por unidades)
    if(chart) chart.destroy();
    const top = agg.slice(0,10);
    chart = new Chart(ctx,{
      type:'bar',
      data:{ labels: top.map(x=>x.liga), datasets:[{label:'Unidades por liga', data: top.map(x=>x.neto)}]},
      options:{responsive:true, scales:{x:{ticks:{color:'#ddd'},grid:{color:'#444'}},y:{ticks:{color:'#ddd'},grid:{color:'#444'}}},
               plugins:{legend:{labels:{color:'#ddd'}}}}
    });

    // Links navegación conservando perfil
    links.innerHTML='';
    const mk=(href,txt)=>{const a=document.createElement('a'); a.href=href; a.textContent=txt; return a;}
    links.append(
      mk(`index.html?perfil=${encodeURIComponent(perfil)}`,'Dashboard'),
      mk(`historial_equipos_rol.html?perfil=${encodeURIComponent(perfil)}`,'Historial por Equipos (Rol)'),
      mk(`probabilidades.html?perfil=${encodeURIComponent(perfil)}`,'Probabilidades')
    );
  }

  // eventos
  sel.addEventListener('change',()=>{ setCurrent(sel.value); perfil=sel.value; load(); render(); });
  filtroLiga.addEventListener('input', render);
  btnCSV.addEventListener('click', ()=>{
    // exportar agregados
    const rows=[['Liga','Apuestas','Ganadas','Perdidas','Pendientes','Winrate %','Yield %','Unidades']];
    const agg=agruparPorLiga(data);
    agg.forEach(m=> rows.push([m.liga,m.n,m.g,m.p,m.pen,m.winrate.toFixed(2),m.yieldPct.toFixed(2),m.neto.toFixed(2)]));
    const csv=rows.map(r=>r.join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`ligas_${perfil}.csv`; document.body.appendChild(a); a.click(); a.remove();
  });
  btnVolver.addEventListener('click',()=> location.href=`index.html?perfil=${encodeURIComponent(perfil)}`);

  // init
  (function init(){
    if(getProfiles().length===0){ localStorage.setItem(PROFILE_LIST_KEY, JSON.stringify(['default'])); localStorage.setItem(dataKeyFor('default'), '[]'); }
    refreshSelect(); load(); render();
  })();
})();
</script>
</body>
</html>