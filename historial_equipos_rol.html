<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Historial por Equipos (Rol) — Perfiles</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  :root{--bg:#121214;--panel:#202024;--panel2:#29292e;--text:#e1e1e6;--muted:#c4c4cc;--accent:#8257e6;--ok:#4caf50;--danger:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;display:flex;justify-content:center}
  main{max-width:1200px;width:95%;margin:20px auto 40px}
  h1{color:var(--accent);margin:.2rem 0 1rem}
  .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;background:var(--panel);padding:12px 16px;border-radius:10px;box-shadow:0 6px 12px rgba(0,0,0,.35)}
  .bar select,.bar input{min-width:160px;padding:10px 14px;border:none;border-radius:8px;background:#121214;color:var(--text);box-shadow:inset 0 0 5px rgb(255 255 255 / .1)}
  .bar button{background:var(--accent);border:none;color:#fff;font-weight:600;border-radius:10px;padding:10px 16px;cursor:pointer;box-shadow:0 4px 8px #6b45d9}
  .bar button:hover{filter:brightness(.95)}
  #tablaWrap{overflow:auto;border-radius:12px;box-shadow:0 6px 12px rgba(0,0,0,.4);margin-top:10px}
  table{width:100%;border-collapse:separate;border-spacing:0 6px;min-width:900px}
  thead th{position:sticky;top:0;background:var(--panel2);padding:12px 14px;color:#bbb;text-align:left}
  tbody tr{background:var(--panel);transition:.2s}
  tbody tr:hover{background:#2a2a30}
  td{padding:12px 14px;white-space:nowrap}
  .pos{color:var(--ok);font-weight:700}
  .neg{color:var(--danger);font-weight:700}
  canvas{background:var(--panel);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.5);height:360px !important;margin-top:22px}
  .links{margin-top:14px}
  .links a{color:#fff;background:#3b82f6;text-decoration:none;padding:8px 12px;border-radius:8px;margin-right:8px;display:inline-block}
</style>
</head>
<body>
<main>
  <h1>Historial por Equipos (Rol)</h1>

  <section class="bar" aria-label="Perfiles y filtros">
    <strong>Perfil:</strong>
    <select id="selectPerfil"></select>
    <input id="filtroEquipo" placeholder="Filtrar equipo..." />
    <select id="filtroRol">
      <option value="">Todos los roles</option>
      <option value="Local">Local</option>
      <option value="Visita">Visita</option>
    </select>
    <input id="filtroLiga" placeholder="Filtrar liga..." />
    <button id="btnExportCSV">Exportar CSV</button>
    <button id="btnVolver">⬅ Volver</button>
  </section>

  <div id="tablaWrap">
    <table id="tabla">
      <thead>
        <tr>
          <th>#</th>
          <th>Equipo</th>
          <th>Rol</th>
          <th>Liga</th>
          <th>Apuestas</th>
          <th>Ganadas</th>
          <th>Perdidas</th>
          <th>Winrate %</th>
          <th>Yield %</th>
          <th>Unidades</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <canvas id="grafica"></canvas>

  <div class="links" id="links"></div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(()=>{'use strict';
  // Perfiles
  const STORAGE_ROOT='HAPC', PROFILE_LIST_KEY=STORAGE_ROOT+'_profiles', CURRENT_PROFILE_KEY=STORAGE_ROOT+'_currentProfile';
  const dataKeyFor=p=>`${STORAGE_ROOT}_data_${p}`;
  const getProfiles=()=>{try{const a=JSON.parse(localStorage.getItem(PROFILE_LIST_KEY)||'[]');return Array.isArray(a)?a:[]}catch{return[]}};
  const getCurrent=()=>localStorage.getItem(CURRENT_PROFILE_KEY)||'default';
  const setCurrent=p=>localStorage.setItem(CURRENT_PROFILE_KEY,p);
  const getUrlPerfil=()=>{const s=new URLSearchParams(location.search).get('perfil'); return s&&s.trim()?s.trim():null;}

  // DOM
  const sel=document.getElementById('selectPerfil');
  const fEq=document.getElementById('filtroEquipo');
  const fRol=document.getElementById('filtroRol');
  const fLiga=document.getElementById('filtroLiga');
  const tbody=document.querySelector('#tabla tbody');
  const ctx=document.getElementById('grafica').getContext('2d');
  const btnCSV=document.getElementById('btnExportCSV');
  const btnVolver=document.getElementById('btnVolver');
  const links=document.getElementById('links');

  let perfil='default', data=[], chart=null;

  function refreshSelect(){
    const list=getProfiles(); perfil=getUrlPerfil()||getCurrent();
    if(!list.includes(perfil)){ if(list.length){perfil=list[0];} else {perfil='default';} setCurrent(perfil); }
    sel.innerHTML=''; list.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; if(p===perfil)o.selected=true; sel.appendChild(o); });
  }
  function load(){ data=JSON.parse(localStorage.getItem(dataKeyFor(perfil))||'[]'); }
  const stake=(b,kf,kfr)=> (b>0&&kf>0&&kfr>0)? Math.min(b, b*kf*kfr):0;

  function agrupar(rows){
    // clave: liga|equipo|rol
    const map=new Map();
    rows.forEach(a=>{
      const liga=(a.liga||'Sin liga').trim();
      const eqLocal=(a.local||'').trim();
      const eqVisita=(a.visita||'').trim();

      // Local
      {
        const key=`${liga}|${eqLocal}|Local`;
        const st=stake(a.bankroll,a.kellyFull,a.kellyFrac);
        let m=map.get(key)||{liga, equipo:eqLocal, rol:'Local', n:0,g:0,p:0,apostado:0,ganado:0};
        m.n++; m.apostado+=st;
        if(a.estado==='ganada'){m.g++; m.ganado += st*(a.cuotaBookie||0);}
        else if(a.estado==='perdida'){m.p++;}
        map.set(key,m);
      }
      // Visita
      {
        const key=`${liga}|${eqVisita}|Visita`;
        const st=stake(a.bankroll,a.kellyFull,a.kellyFrac);
        let m=map.get(key)||{liga, equipo:eqVisita, rol:'Visita', n:0,g:0,p:0,apostado:0,ganado:0};
        m.n++; m.apostado+=st;
        if(a.estado==='ganada'){m.g++; m.ganado += st*(a.cuotaBookie||0);}
        else if(a.estado==='perdida'){m.p++;}
        map.set(key,m);
      }
    });
    return [...map.values()].map(m=>{
      const neto=m.ganado - m.apostado;
      const wr=m.n? m.g/m.n*100:0;
      const yld=m.apostado? neto/m.apostado*100:0;
      return {...m, neto, wr, yld};
    });
  }

  function render(){
    const fEqv=(fEq.value||'').toLowerCase();
    const fLigaV=(fLiga.value||'').toLowerCase();
    const fRolV=fRol.value||'';
    const agg=agrupar(data).filter(m=>{
      if(fEqv && !m.equipo.toLowerCase().includes(fEqv)) return false;
      if(fLigaV && !m.liga.toLowerCase().includes(fLigaV)) return false;
      if(fRolV && m.rol!==fRolV) return false;
      return true;
    }).sort((a,b)=> b.neto - a.neto);

    tbody.innerHTML='';
    agg.forEach((m,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td>
        <td>${m.equipo}</td>
        <td>${m.rol}</td>
        <td>${m.liga}</td>
        <td>${m.n}</td>
        <td>${m.g}</td>
        <td>${m.p}</td>
        <td>${m.wr.toFixed(2)}</td>
        <td>${m.yld.toFixed(2)}</td>
        <td class="${m.neto>=0?'pos':'neg'}">${m.neto.toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });

    // Gráfica: Top 12 equipos por unidades (filtrados)
    if(chart) chart.destroy();
    const top=agg.slice(0,12);
    chart=new Chart(ctx,{
      type:'bar',
      data:{labels:top.map(x=>`${x.equipo} (${x.rol[0]})`), datasets:[{label:'Unidades por equipo/rol', data:top.map(x=>x.neto)}]},
      options:{responsive:true, scales:{x:{ticks:{color:'#ddd'},grid:{color:'#444'}},y:{ticks:{color:'#ddd'},grid:{color:'#444'}}},
               plugins:{legend:{labels:{color:'#ddd'}}}}
    });

    // Links
    links.innerHTML='';
    const mk=(href,txt)=>{const a=document.createElement('a'); a.href=href; a.textContent=txt; return a;}
    links.append(
      mk(`index.html?perfil=${encodeURIComponent(perfil)}`,'Dashboard'),
      mk(`historial_ligas.html?perfil=${encodeURIComponent(perfil)}`,'Historial por Ligas'),
      mk(`probabilidades.html?perfil=${encodeURIComponent(perfil)}`,'Probabilidades')
    );
  }

  // eventos
  sel.addEventListener('change',()=>{ setCurrent(sel.value); perfil=sel.value; load(); render(); });
  [fEq,fRol,fLiga].forEach(el=>el.addEventListener('input',render));
  btnCSV.addEventListener('click', ()=>{
    const agg=agrupar(data).sort((a,b)=> b.neto - a.neto);
    const rows=[['Equipo','Rol','Liga','Apuestas','Ganadas','Perdidas','Winrate %','Yield %','Unidades']];
    agg.forEach(m=> rows.push([m.equipo,m.rol,m.liga,m.n,m.g,m.p,m.wr.toFixed(2),m.yld.toFixed(2),m.neto.toFixed(2)]));
    const csv=rows.map(r=>r.join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`equipos_rol_${perfil}.csv`; document.body.appendChild(a); a.click(); a.remove();
  });
  btnVolver.addEventListener('click',()=> location.href=`index.html?perfil=${encodeURIComponent(perfil)}`);

  // init
  (function init(){
    if(getProfiles().length===0){ localStorage.setItem(PROFILE_LIST_KEY, JSON.stringify(['default'])); localStorage.setItem(dataKeyFor('default'),'[]'); }
    refreshSelect(); load(); render();
  })();
})();
</script>
</body>
</html>