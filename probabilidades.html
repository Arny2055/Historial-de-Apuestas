<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Probabilidades - Desglose</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  *, *::before, *::after { box-sizing: border-box; }
  body {
    margin: 0; padding: 0;
    font-family: 'Inter', sans-serif;
    background-color: #121214; color: #e1e1e6;
    min-height: 100vh; display: flex; flex-direction: column; align-items: center;
  }
  main { max-width: 1000px; width: 95%; margin: 20px auto 40px auto; }
  h1 { color: #8257e6; margin: 10px 0 20px; text-align:center; }
  .toolbar {
    display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px; justify-content:center;
  }
  .toolbar button {
    background-color:#8257e6; color:#fff; border:none; border-radius:10px; padding:10px 16px;
    cursor:pointer; font-weight:600; box-shadow:0 4px 8px #6b45d9;
  }
  .toolbar button:hover { background:#6b45d9; }

  #tablaWrapper {
    overflow-x:auto; overflow-y:auto; max-height: 70vh;
    box-shadow:0 6px 12px rgba(0,0,0,0.4); border-radius:12px; background:#202024;
  }
  table { width:100%; border-collapse:separate; border-spacing:0; min-width:720px; }
  thead th {
    position: sticky; top: 0; background:#29292e; color:#cfcfe4;
    text-align:left; padding:14px 16px; font-weight:700; white-space:nowrap;
  }
  tbody td {
    padding:12px 16px; border-top:1px solid #2c2c32; white-space:nowrap;
  }
  tfoot td {
    padding:14px 16px; background:#1c1c21; font-weight:700; border-top:2px solid #3a3a46;
  }
  .num { text-align:right; }
  .pos { color:#4caf50; font-weight:600; }
  .neg { color:#ef4444; font-weight:600; }
  .muted { color:#a1a1aa; }
</style>
</head>
<body>
<main>
  <h1>Desglose por Probabilidad (valor exacto)</h1>

  <div class="toolbar">
    <button onclick="history.back()">← Volver</button>
    <button id="btnExportarCSV">Exportar CSV</button>
  </div>

  <div id="tablaWrapper" role="region" aria-label="Tabla de probabilidades">
    <table id="tablaProb">
      <thead>
        <tr>
          <th>Probabilidad (%)</th>
          <th class="num"># Apuestas</th>
          <th class="num">Ganadas</th>
          <th class="num">Perdidas</th>
          <th class="num">Yield (%)</th>
          <th class="num">ROI (%)</th>
        </tr>
      </thead>
      <tbody><!-- JS --></tbody>
      <tfoot>
        <tr>
          <td>Total</td>
          <td class="num" id="tApuestas">0</td>
          <td class="num" id="tGanadas">0</td>
          <td class="num" id="tPerdidas">0</td>
          <td class="num" id="tYield">0.00%</td>
          <td class="num" id="tROI">0.00%</td>
        </tr>
      </tfoot>
    </table>
  </div>
</main>

<script>
(() => {
  'use strict';

  const STORAGE_KEY = 'historialApuestasProfesionalCompleto';

  // --- Utilidades (mismas fórmulas que tu página principal) ---
  function stakeSugerido(bankroll, kellyFull, kellyFrac) {
    if (!(bankroll > 0 && kellyFull > 0 && kellyFrac > 0)) return 0;
    const stake = bankroll * kellyFull * kellyFrac;
    return stake > bankroll ? bankroll : stake;
  }

  // Carga historial
  function cargar() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }

  // Agrupa EXACTAMENTE por probabilidad ingresada (formato 2 decimales)
  function agruparPorProb(historial) {
    const grupos = new Map();
    historial.forEach(a => {
      const key = Number(a.probabilidad).toFixed(2); // EXACTO a 2 decimales
      if (!grupos.has(key)) grupos.set(key, []);
      grupos.get(key).push(a);
    });
    return grupos;
  }

  // Calcula métricas por grupo (yield y ROI solo con liquidadas)
  function calcularGrupo(apuestas) {
    const totalApuestas = apuestas.length;
    const ganadas = apuestas.filter(a => a.estado === 'ganada').length;
    const perdidas = apuestas.filter(a => a.estado === 'perdida').length;

    let totalApostado = 0;   // solo liquidadas
    let totalGanadoBruto = 0;

    // Para ROI: tomamos el primer bankroll del grupo (consistente con tu página)
    const bankrollInicial = apuestas.length ? (apuestas[0].bankroll || 0) : 0;

    apuestas.forEach(a => {
      if (a.estado !== 'ganada' && a.estado !== 'perdida') return; // ignorar pendientes
      const stake = stakeSugerido(a.bankroll, a.kellyFull, a.kellyFrac);
      totalApostado += stake;
      if (a.estado === 'ganada') {
        totalGanadoBruto += stake * a.cuotaBookie;
      } else if (a.estado === 'perdida') {
        // no suma al bruto, solo resta vía neto
      }
    });

    const neto = totalGanadoBruto - totalApostado;
    const yieldPct = totalApostado > 0 ? (neto / totalApostado) * 100 : 0;
    const roiPct = bankrollInicial > 0 ? (neto / bankrollInicial) * 100 : 0;

    return {
      totalApuestas, ganadas, perdidas,
      yieldPct, roiPct,
      // para totales globales:
      _totalApostado: totalApostado,
      _neto: neto,
      _bankrollInicial: bankrollInicial
    };
  }

  // Render
  function render() {
    const tbody = document.querySelector('#tablaProb tbody');
    const tApuestas = document.getElementById('tApuestas');
    const tGanadas = document.getElementById('tGanadas');
    const tPerdidas = document.getElementById('tPerdidas');
    const tYield = document.getElementById('tYield');
    const tROI = document.getElementById('tROI');

    const historial = cargar();
    const grupos = agruparPorProb(historial);

    // ordenar por prob asc
    const keys = Array.from(grupos.keys()).sort((a,b) => parseFloat(a) - parseFloat(b));

    tbody.innerHTML = '';

    // acumuladores globales
    let gApuestas = 0, gGanadas = 0, gPerdidas = 0;
    let gTotalApostado = 0, gNeto = 0, gBankrollBase = 0;

    keys.forEach(k => {
      const stats = calcularGrupo(grupos.get(k));
      gApuestas += stats.totalApuestas;
      gGanadas  += stats.ganadas;
      gPerdidas += stats.perdidas;
      gTotalApostado += stats._totalApostado;
      gNeto += stats._neto;
      gBankrollBase += stats._bankrollInicial; // suma simple para global (aprox.)

      const tr = document.createElement('tr');

      const tdProb = document.createElement('td');
      tdProb.textContent = k;

      const tdN = document.createElement('td'); tdN.className = 'num';
      tdN.textContent = stats.totalApuestas;

      const tdW = document.createElement('td'); tdW.className = 'num';
      tdW.textContent = stats.ganadas;

      const tdL = document.createElement('td'); tdL.className = 'num';
      tdL.textContent = stats.perdidas;

      const tdYield = document.createElement('td'); tdYield.className = 'num ' + (stats.yieldPct >= 0 ? 'pos':'neg');
      tdYield.textContent = stats.yieldPct.toFixed(2) + '%';

      const tdROI = document.createElement('td'); tdROI.className = 'num ' + (stats.roiPct >= 0 ? 'pos':'neg');
      tdROI.textContent = stats.roiPct.toFixed(2) + '%';

      tr.append(tdProb, tdN, tdW, tdL, tdYield, tdROI);
      tbody.appendChild(tr);
    });

    // Totales globales
    tApuestas.textContent = gApuestas;
    tGanadas.textContent  = gGanadas;
    tPerdidas.textContent = gPerdidas;
    const gYield = gTotalApostado > 0 ? (gNeto / gTotalApostado) * 100 : 0;
    const gROI   = gBankrollBase > 0 ? (gNeto / gBankrollBase) * 100 : 0;
    tYield.textContent = gYield.toFixed(2) + '%';
    tYield.className = 'num ' + (gYield >= 0 ? 'pos' : 'neg');
    tROI.textContent = gROI.toFixed(2) + '%';
    tROI.className = 'num ' + (gROI >= 0 ? 'pos' : 'neg');
  }

  // Export CSV
  function exportarCSV() {
    const tabla = document.getElementById('tablaProb');
    const filas = [...tabla.querySelectorAll('thead tr, tbody tr, tfoot tr')];
    const csv = filas.map(tr => {
      const celdas = [...tr.children];
      return celdas.map(td => `"${String(td.textContent).replace(/"/g,'""')}"`).join(',');
    }).join('\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'probabilidades_desglose.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // Init
  document.getElementById('btnExportarCSV').addEventListener('click', exportarCSV);
  render();
})();
</script>
</body>
</html>