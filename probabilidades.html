<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Probabilidades — Perfiles</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  :root{--bg:#121214;--panel:#202024;--panel2:#29292e;--text:#e1e1e6;--muted:#c4c4cc;--accent:#8257e6;--ok:#4caf50;--danger:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;display:flex;justify-content:center}
  main{max-width:1200px;width:95%;margin:20px auto 40px}
  h1{color:var(--accent);margin:.2rem 0 1rem}
  .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;background:var(--panel);padding:12px 16px;border-radius:10px;box-shadow:0 6px 12px rgba(0,0,0,.35)}
  .bar select,.bar input{min-width:160px;padding:10px 14px;border:none;border-radius:8px;background:#121214;color:var(--text);box-shadow:inset 0 0 5px rgb(255 255 255 / .1)}
  .bar button{background:var(--accent);border:none;color:#fff;font-weight:600;border-radius:10px;padding:10px 16px;cursor:pointer;box-shadow:0 4px 8px #6b45d9}
  .bar button:hover{filter:brightness(.95)}
  #tablaWrap{overflow:auto;border-radius:12px;box-shadow:0 6px 12px rgba(0,0,0,.4);margin-top:10px}
  table{width:100%;border-collapse:separate;border-spacing:0 6px;min-width:900px}
  thead th{position:sticky;top:0;background:var(--panel2);padding:12px 14px;color:#bbb;text-align:left}
  tbody tr{background:var(--panel);transition:.2s}
  tbody tr:hover{background:#2a2a30}
  td{padding:12px 14px;white-space:nowrap}
  .pos{color:var(--ok);font-weight:700}
  .neg{color:var(--danger);font-weight:700}
  canvas{background:var(--panel);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.5);height:380px !important;margin-top:22px}
  .links{margin-top:14px}
  .links a{color:#fff;background:#3b82f6;text-decoration:none;padding:8px 12px;border-radius:8px;margin-right:8px;display:inline-block}
</style>
</head>
<body>
<main>
  <h1>Probabilidades (rangos)</h1>

  <section class="bar" aria-label="Perfiles y filtros">
    <strong>Perfil:</strong>
    <select id="selectPerfil"></select>
    <input id="filtroLiga" placeholder="Filtrar liga (opcional)..." />
    <select id="rangoCustom">
      <option value="">Rangos estándar</option>
      <option value="45,55">45–55</option>
      <option value="50,60">50–60</option>
      <option value="60,70">60–70</option>
      <option value="70,80">70–80</option>
    </select>
    <button id="btnCSV">Exportar CSV</button>
    <button id="btnVolver">⬅ Volver</button>
  </section>

  <div id="tablaWrap">
    <table id="tabla">
      <thead>
        <tr>
          <th>#</th>
          <th>Rango Prob. (%)</th>
          <th>Muestras</th>
          <th>Winrate %</th>
          <th>EV medio %</th>
          <th>Kelly FULL medio %</th>
          <th>Unidades</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <canvas id="grafica"></canvas>

  <div class="links" id="links"></div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(()=>{'use strict';
  // Perfiles
  const STORAGE_ROOT='HAPC', PROFILE_LIST_KEY=STORAGE_ROOT+'_profiles', CURRENT_PROFILE_KEY=STORAGE_ROOT+'_currentProfile';
  const dataKeyFor=p=>`${STORAGE_ROOT}_data_${p}`;
  const getProfiles=()=>{try{const a=JSON.parse(localStorage.getItem(PROFILE_LIST_KEY)||'[]');return Array.isArray(a)?a:[]}catch{return[]}};
  const getCurrent=()=>localStorage.getItem(CURRENT_PROFILE_KEY)||'default';
  const setCurrent=p=>localStorage.setItem(CURRENT_PROFILE_KEY,p);
  const getUrlPerfil=()=>{const s=new URLSearchParams(location.search).get('perfil'); return s&&s.trim()?s.trim():null;}

  // DOM
  const sel=document.getElementById('selectPerfil');
  const fLiga=document.getElementById('filtroLiga');
  const rangoCustom=document.getElementById('rangoCustom');
  const tbody=document.querySelector('#tabla tbody');
  const ctx=document.getElementById('grafica').getContext('2d');
  const btnCSV=document.getElementById('btnCSV');
  const btnVolver=document.getElementById('btnVolver');
  const links=document.getElementById('links');

  let perfil='default', data=[], chart=null;

  function refreshSelect(){
    const list=getProfiles(); perfil=getUrlPerfil()||getCurrent();
    if(!list.includes(perfil)){ if(list.length){perfil=list[0];} else {perfil='default';} setCurrent(perfil); }
    sel.innerHTML=''; list.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; if(p===perfil)o.selected=true; sel.appendChild(o); });
  }
  function load(){ data=JSON.parse(localStorage.getItem(dataKeyFor(perfil))||'[]'); }

  const stake=(b,kf,kfr)=> (b>0&&kf>0&&kfr>0)? Math.min(b,b*kf*kfr):0;

  function bucketize(rows){
    // Construye buckets
    let buckets;
    if(rangoCustom.value){
      const [lo,hi]=rangoCustom.value.split(',').map(Number);
      buckets=[{from:lo,to:hi,label:`${lo}-${hi}`}];
    }else{
      buckets=[
        {from:0,to:40,label:'0-40'},
        {from:40,to:50,label:'40-50'},
        {from:50,to:60,label:'50-60'},
        {from:60,to:70,label:'60-70'},
        {from:70,to:80,label:'70-80'},
        {from:80,to:90,label:'80-90'},
        {from:90,to:100,label:'90-100'}
      ];
    }

    const agg=buckets.map(b=>({label:b.label, from:b.from, to:b.to, n:0, g:0, evSum:0, kellySum:0, apostado:0, ganado:0}));
    rows.forEach(a=>{
      const p = Number(a.probabilidad)||0;
      const b = agg.find(x=> p>=x.from && p<=(x===agg.at(-1)? x.to : x.to)); // incluye el extremo superior en el último
      if(!b) return;
      const st = stake(a.bankroll,a.kellyFull,a.kellyFrac);
      b.n++; if(a.estado==='ganada') { b.g++; b.ganado += st*(a.cuotaBookie||0); }
      else if(a.estado==='perdida'){ /* ganado += 0 */ }
      b.apostado += st;
      b.evSum += (a.ev||0)*100;              // a.ev ya es decimal -> %
      b.kellySum += (a.kellyFull||0)*100;    // kelly decimal -> %
    });

    return agg.map(b=>{
      const winrate = b.n? b.g/b.n*100:0;
      const evMedio = b.n? b.evSum/b.n:0;
      const kMedio  = b.n? b.kellySum/b.n:0;
      const neto    = b.ganado - b.apostado;
      return {...b, winrate, evMedio, kMedio, neto};
    });
  }

  function render(){
    const ligaF=(fLiga.value||'').toLowerCase();
    const rows = ligaF? data.filter(a=> (a.liga||'').toLowerCase().includes(ligaF)) : data;
    const agg=bucketize(rows);

    tbody.innerHTML='';
    agg.forEach((b,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td>
        <td>${b.label}</td>
        <td>${b.n}</td>
        <td>${b.winrate.toFixed(2)}</td>
        <td>${b.evMedio.toFixed(2)}</td>
        <td>${b.kMedio.toFixed(2)}</td>
        <td class="${b.neto>=0?'pos':'neg'}">${b.neto.toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });

    if(chart) chart.destroy();
    chart = new Chart(ctx,{
      data:{
        labels: agg.map(b=>b.label),
        datasets:[
          {type:'bar', label:'Unidades', data: agg.map(b=>b.neto), yAxisID:'y'},
          {type:'line', label:'Winrate %', data: agg.map(b=>b.winrate), yAxisID:'y1', tension:.3, pointRadius:3, borderWidth:3}
        ]
      },
      options:{
        responsive:true,
        plugins:{legend:{labels:{color:'#ddd'}}},
        scales:{
          x:{ticks:{color:'#ddd'},grid:{color:'#444'}},
          y:{position:'left',ticks:{color:'#ddd'},grid:{color:'#444'}},
          y1:{position:'right',ticks:{color:'#ddd'},grid:{drawOnChartArea:false}}
        }
      }
    });

    // Links
    links.innerHTML='';
    const mk=(href,txt)=>{const a=document.createElement('a'); a.href=href; a.textContent=txt; return a;}
    links.append(
      mk(`index.html?perfil=${encodeURIComponent(perfil)}`,'Dashboard'),
      mk(`historial_ligas.html?perfil=${encodeURIComponent(perfil)}`,'Historial por Ligas'),
      mk(`historial_equipos_rol.html?perfil=${encodeURIComponent(perfil)}`,'Historial por Equipos (Rol)')
    );
  }

  // eventos
  sel.addEventListener('change',()=>{ setCurrent(sel.value); perfil=sel.value; load(); render(); });
  [fLiga, rangoCustom].forEach(el=> el.addEventListener('input', render));
  btnCSV.addEventListener('click', ()=>{
    const rows=(fLiga.value? data.filter(a=>(a.liga||'').toLowerCase().includes(fLiga.value.toLowerCase())): data);
    const agg=bucketize(rows);
    const hdr=['Rango','Muestras','Winrate %','EV medio %','Kelly FULL medio %','Unidades'];
    const csv=[hdr.join(',')].concat(agg.map(b=>[b.label,b.n,b.winrate.toFixed(2),b.evMedio.toFixed(2),b.kMedio.toFixed(2),b.neto.toFixed(2)].join(','))).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`probabilidades_${perfil}.csv`; document.body.appendChild(a); a.click(); a.remove();
  });
  btnVolver.addEventListener('click',()=> location.href=`index.html?perfil=${encodeURIComponent(perfil)}`);

  // init
  (function init(){
    if(getProfiles().length===0){ localStorage.setItem(PROFILE_LIST_KEY, JSON.stringify(['default'])); localStorage.setItem(dataKeyFor('default'),'[]'); }
    refreshSelect(); load(); render();
  })();
})();
</script>
</body>
</html>